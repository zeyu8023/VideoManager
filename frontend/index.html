<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f1f5f9; color: #334155; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: #1e293b; color: #94a3b8; flex-shrink: 0; transition: width 0.2s; }
        .sidebar-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: #334155; color: white; }
        .sidebar-item.active { background: #334155; color: white; border-left-color: #3b82f6; }
        
        /* ç§»åŠ¨ç«¯ä¾§è¾¹æ é€‚é… */
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar-text { display: none; }
            .sidebar-title { display: none; }
            .sidebar-logo { justify-content: center; }
            .sidebar-item { justify-content: center; padding: 16px 0; }
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { font-size: 14px; font-weight: 700; color: #475569; padding: 16px 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* è¡Œå†…ç¼–è¾‘ */
        .table-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; outline: none; background: white; }
        .table-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .editing { background: #eff6ff !important; }
        .new-row { background: #f0fdf4 !important; } /* æ–°å¢è¡Œé«˜äº® */

        /* å¤šé€‰èœå• */
        .multi-menu { position: absolute; z-index: 50; background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 8px; width: 200px; max-height: 240px; overflow-y: auto; display: none; }
        .multi-menu.show { display: block; }
        .multi-option { display: flex; items-center; gap: 8px; padding: 8px; cursor: pointer; font-size: 13px; }
        .multi-option:hover { background: #f1f5f9; }

        /* ç­›é€‰é¢æ¿ */
        #filter-panel { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; background: white; border-bottom: 1px solid #e2e8f0; }
        #filter-panel.open { max-height: 600px; }

        /* æ ‡ç­¾ */
        .pill { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; border: 1px solid transparent; }
        
        /* ç»Ÿè®¡å›¾è¡¨ */
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="sidebar flex flex-col">
        <div class="h-16 flex items-center px-6 sidebar-logo gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shrink-0">V</div>
            <h1 class="text-lg font-bold text-white sidebar-title">VideoHub</h1>
        </div>
        <nav class="flex-1 py-4 space-y-1">
            <div class="sidebar-item active" onclick="switchView('assets', this)">
                <span class="text-xl">ğŸ“¦</span> <span class="sidebar-text">èµ„äº§ç®¡ç†</span>
            </div>
            <div class="sidebar-item" onclick="switchView('stats', this)">
                <span class="text-xl">ğŸ“Š</span> <span class="sidebar-text">æ•°æ®ç»Ÿè®¡</span>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-700 text-xs text-slate-500 text-center sidebar-text">V10.0 Pro</div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        
        <header class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-30">
            <div class="flex items-center gap-4 w-full max-w-2xl">
                <h2 class="text-lg font-bold text-slate-800" id="page-title">èµ„äº§åº“</h2>
                <div class="relative flex-1 max-w-md hidden md:block">
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input id="global-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢: ç¼–å· / æ ‡é¢˜ / å¤‡æ³¨" class="pl-10 pr-4 py-2 w-full bg-slate-100 border-transparent rounded-lg text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleFilters()" class="text-slate-500 hover:text-blue-600 p-2 rounded hover:bg-slate-100" title="ç­›é€‰"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg></button>
                <button onclick="openSettings()" class="text-slate-500 hover:text-blue-600 p-2 rounded hover:bg-slate-100" title="é…ç½®"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
            </div>
        </header>

        <div id="view-assets" class="flex-1 flex flex-col overflow-hidden h-full">
            
            <div id="filter-panel" class="shrink-0 px-6">
                <div class="py-5 grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">ç¼–å·</label><input id="s-pid" list="dl-pids" class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">æ ‡é¢˜</label><input id="s-title" class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">ç±»å‹</label><select id="s-cat" class="table-input"></select></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">ä¸»æ’­</label><select id="s-host" class="table-input"></select></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">çŠ¶æ€</label><select id="s-status" class="table-input"></select></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">å¹³å°</label><select id="s-plat" class="table-input"></select></div>
                    <div class="col-span-6 flex justify-end gap-2 border-t pt-3 mt-1">
                        <button onclick="resetFilters()" class="px-4 py-2 bg-white border rounded text-sm text-slate-600">é‡ç½®</button>
                        <button onclick="loadData(1)" class="px-6 py-2 bg-slate-800 text-white rounded text-sm font-bold">æŸ¥è¯¢</button>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 flex justify-between items-center shrink-0">
                <div class="text-sm text-slate-500">å…± <b id="total-count" class="text-slate-900">0</b> æ¡æ•°æ®</div>
                <div class="flex gap-3">
                    <button onclick="openImport()" class="text-blue-600 text-sm hover:underline font-bold">æ‰¹é‡å¯¼å…¥</button>
                    <button onclick="addNewRow()" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold px-4 py-2 rounded-lg shadow flex items-center gap-1">
                        <span>+</span> æ–°å¢ä¸€è¡Œ
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative w-full px-6 pb-6">
                <div class="absolute inset-0 table-container">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 z-20 shadow-sm">
                            <tr>
                                <th class="w-14 text-center">å›¾</th>
                                <th onclick="sortBy('product_id')" class="w-24">ç¼–å· â†•</th>
                                <th onclick="sortBy('title')" style="width: 240px">è§†é¢‘æ ‡é¢˜ â†•</th>
                                <th onclick="sortBy('category')" class="w-24">ç±»å‹ â†•</th>
                                <th onclick="sortBy('finish_time')" class="w-28">å®Œæˆæ—¶é—´ â†•</th>
                                <th onclick="sortBy('video_type')" class="w-24">è§†ç±» â†•</th>
                                <th onclick="sortBy('host')" class="w-32">ä¸»æ’­ â†•</th>
                                <th onclick="sortBy('status')" class="w-24 text-center">çŠ¶æ€ â†•</th>
                                <th onclick="sortBy('platform')" class="w-32">å¹³å° â†•</th>
                                <th onclick="sortBy('publish_time')" class="w-32">å‘å¸ƒæ—¶é—´ â†•</th>
                                <th onclick="sortBy('remark')" class="w-32">å¤‡æ³¨ â†•</th>
                                <th class="w-20 text-center sticky right-0 bg-slate-50 border-l">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="h-12 bg-white border-t border-slate-200 px-6 flex justify-end items-center shrink-0 gap-2">
                <button onclick="changePage(-1)" id="btn-prev" class="px-3 py-1 bg-slate-100 rounded disabled:opacity-50 text-sm">â—€</button>
                <span id="page-info" class="text-sm font-mono">1/1</span>
                <button onclick="changePage(1)" id="btn-next" class="px-3 py-1 bg-slate-100 rounded disabled:opacity-50 text-sm">â–¶</button>
            </div>
        </div>

        <div id="view-stats" class="hidden flex-1 overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">æ•°æ®é©¾é©¶èˆ±</h2>
                <div class="flex bg-white rounded-lg border border-slate-200 p-1">
                    <button onclick="loadReport('day')" class="px-3 py-1 text-sm rounded hover:bg-slate-50 active-dim">æŒ‰æ—¥</button>
                    <button onclick="loadReport('week')" class="px-3 py-1 text-sm rounded hover:bg-slate-50 active-dim">æŒ‰å‘¨</button>
                    <button onclick="loadReport('month')" class="px-3 py-1 text-sm rounded bg-blue-50 text-blue-600 font-bold active-dim">æŒ‰æœˆ</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-card col-span-1 lg:col-span-2">
                    <h3 class="font-bold text-slate-600 mb-4">å…¥åº“ vs å‘å¸ƒ è¶‹åŠ¿</h3>
                    <div id="chart-trend" style="height: 350px;"></div>
                </div>
                <div class="chart-card">
                    <h3 class="font-bold text-slate-600 mb-4">å¹³å°å‘å¸ƒå æ¯”</h3>
                    <div id="chart-plat" style="height: 300px;"></div>
                </div>
                <div class="chart-card flex flex-col justify-center gap-4">
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <div class="text-xs text-blue-500 font-bold uppercase">æœ¬æœŸå…¥åº“</div>
                        <div class="text-3xl font-black text-blue-700" id="stat-in">-</div>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl">
                        <div class="text-xs text-emerald-500 font-bold uppercase">æœ¬æœŸå‘å¸ƒ</div>
                        <div class="text-3xl font-black text-emerald-700" id="stat-out">-</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh] max-w-[95vw] object-contain"></div>
    <div id="multi-menu" class="multi-menu"></div>
    <datalist id="dl-pids"></datalist><datalist id="dl-host"></datalist><datalist id="dl-plat"></datalist>

    <div id="import-modal" class="modal">
        <div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl">
            <h3 class="font-bold text-xl mb-4">æ‰¹é‡å¯¼å…¥</h3>
            <p class="text-sm text-slate-500 mb-6">è¯·ç¡®è®¤æ–‡ä»¶å·²åœ¨ NAS çš„ temp_uploads ç›®å½•</p>
            <div class="progress-bar mb-4" id="prog-bar"><div class="progress-val" id="prog-val"></div></div>
            <button onclick="startImport()" class="w-full bg-slate-800 text-white py-3 rounded font-bold">å¼€å§‹æ‰«æ</button>
            <button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs">å…³é—­</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="bg-white rounded-xl w-[400px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">å…¨å±€é…ç½®</h3>
            <textarea id="set-hosts" class="table-input h-20 mb-3" placeholder="ä¸»æ’­..."></textarea>
            <input id="set-cats" class="table-input mb-3" placeholder="ç±»å‹...">
            <input id="set-plats" class="table-input mb-3" placeholder="å¹³å°...">
            <input id="set-types" class="table-input mb-4" placeholder="è§†é¢‘ç±»å‹...">
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">ä¿å­˜</button>
            <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-sm text-slate-400">å…³é—­</button>
        </div>
    </div>

    <script>
        let currPage = 1, totalPages = 1, currentSort = { col: 'id', order: 'desc' };
        let globalOptions = {}, editingId = null, globalData = [];
        let chartTrend, chartPlat;

        // åˆå§‹åŒ–
        (async () => {
            await loadOptions();
            await loadData(1);
            
            // ç»‘å®šå¤šé€‰å…³é—­
            document.addEventListener('click', e => {
                if(!e.target.closest('.multi-menu') && !e.target.closest('.multi-trigger')) {
                    document.getElementById('multi-menu').classList.remove('show');
                }
            });
        })();

        // --- è§†å›¾åˆ‡æ¢ ---
        function switchView(view, btn) {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('view-assets').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.getElementById('page-title').innerText = view === 'assets' ? 'èµ„äº§åº“' : 'æ•°æ®ç»Ÿè®¡';
            
            if(view === 'stats') loadReport('month'); // é»˜è®¤æŒ‰æœˆåŠ è½½
        }

        // --- æ ¸å¿ƒæ•°æ® ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            // å¡«å……ç­›é€‰
            const fill = (id, list) => document.getElementById(id).innerHTML = `<option value="">å…¨éƒ¨</option>` + list.map(i=>`<option value="${i}">${i}</option>`).join('');
            fill('s-cat', globalOptions.categories); fill('s-host', globalOptions.hosts);
            fill('s-status', globalOptions.statuses); fill('s-plat', globalOptions.platforms);
            // Datalist
            const dl = (id, list) => document.getElementById(id).innerHTML = list.map(i=>`<option value="${i}">`).join('');
            dl('dl-pids', globalOptions.product_ids); dl('dl-host', globalOptions.hosts); dl('dl-plat', globalOptions.platforms);
        }

        async function loadData(p) {
            currPage = p || currPage;
            // æ”¶é›†å‚æ•°ç•¥ (åŒV9)... è¿™é‡Œç›´æ¥å¤ç”¨é€»è¾‘
            const params = new URLSearchParams({
                page: currPage, size: 100, sort_by: currentSort.col, order: currentSort.order,
                keyword: document.getElementById('global-search').value,
                product_id: document.getElementById('s-pid').value,
                title: document.getElementById('s-title').value,
                host: document.getElementById('s-host').value,
                status: document.getElementById('s-status').value,
                category: document.getElementById('s-cat').value,
                platform: document.getElementById('s-plat').value
            });
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('total-count').innerText = data.total;
            document.getElementById('page-info').innerText = `${data.page}/${data.total_pages}`;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);
            
            renderTable(data.items);
        }

        // --- æ¸²æŸ“è¡¨æ ¼ (çœŸÂ·è¡Œå†…æ–°å¢) ---
        function addNewRow() {
            // åœ¨æ•°æ®æœ€å‰é¢æ’ä¸€ä¸ªç©ºå¯¹è±¡ï¼ŒID='new'
            const newRow = { id: 'new', product_id: '', title: '', isNew: true };
            globalData.unshift(newRow);
            editingId = 'new';
            renderTable(globalData);
        }

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const isEdit = (v.id === editingId);
                const cln = s => (s && s!=='nan' && s!=='None') ? s : '';
                const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';

                if (isEdit) {
                    const sel = (k, list) => `<select id="ed-${k}" class="table-input bg-blue-50">${list.map(o => `<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                    const multi = (k, type) => `<input id="ed-${k}" class="table-input bg-blue-50 multi-trigger cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this, '${type}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                    
                    return `
                    <tr class="editing ${v.isNew?'new-row':''}">
                        <td class="p-2 text-center">
                            <div class="img-zone mx-auto" onclick="document.getElementById('row-file-${v.id}').click()">
                                <img src="${img}" id="prev-${v.id}" class="w-full h-full object-cover">
                            </div>
                            <input type="file" id="row-file-${v.id}" class="hidden" onchange="uploadRowFile(this, '${v.id}')">
                            <input type="hidden" id="ed-img" value="${cln(v.image_url)}">
                        </td>
                        <td><input id="ed-pid" class="table-input" value="${cln(v.product_id)}" placeholder="ç¼–å·"></td>
                        <td><input id="ed-title" class="table-input font-bold" value="${cln(v.title)}" placeholder="æ ‡é¢˜"></td>
                        <td>${sel('cat', globalOptions.categories)}</td>
                        <td><input id="ed-fin" type="date" class="table-input" value="${cln(v.finish_time)}"></td>
                        <td>${sel('type', globalOptions.video_types)}</td>
                        <td>${multi('host', 'hosts')}</td>
                        <td>${sel('status', globalOptions.statuses)}</td>
                        <td>${multi('plat', 'platforms')}</td>
                        <td><input id="ed-pub" type="datetime-local" class="table-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="table-input" value="${cln(v.remark)}"></td>
                        <td class="text-center sticky right-0 bg-blue-50 border-l">
                            <button onclick="saveRow('${v.id}')" class="text-white bg-blue-600 px-3 py-1 rounded text-xs font-bold shadow hover:bg-blue-700">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1 hover:text-slate-600">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }
                
                // æ­£å¸¸è¡Œ (ä»£ç ç•¥ç®€åŒ–ï¼Œä¿æŒV9é£æ ¼)
                return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                    <td class="p-2 text-center"><div class="w-10 h-10 rounded mx-auto bg-slate-200 overflow-hidden cursor-pointer" onclick="showBigImg('${img}')"><img src="${img}" class="w-full h-full object-cover"></div></td>
                    <td class="font-mono text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 truncate" style="max-width: 240px" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td><span class="pill bg-slate-100 text-slate-600">${cln(v.category)}</span></td>
                    <td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td>
                    <td><span class="pill bg-slate-100 text-slate-600">${cln(v.video_type)}</span></td>
                    <td>${cln(v.host)}</td>
                    <td class="text-center"><span class="pill ${v.status==='å·²å‘å¸ƒ'?'bg-emerald-100 text-emerald-700':'bg-orange-50 text-orange-600'}">${cln(v.status)}</span></td>
                    <td>${cln(v.platform)}</td>
                    <td class="text-xs text-slate-400 font-mono">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-xs text-slate-400 truncate max-w-[100px]">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l">
                        <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- é€»è¾‘å‡½æ•° ---
        function startEdit(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; loadData(); } // é‡æ–°åŠ è½½æ¸…é™¤æ–°å¢è¡Œ
        
        async function saveRow(id) {
            const fd = new FormData();
            if (id !== 'new') fd.append('id', id); // æ–°å¢æ—¶ä¸ä¼ IDæˆ–ä¼ ç©º
            
            const ids = ['pid','title','cat','fin','type','host','status','plat','pub','rem'];
            const keys = ['product_id','title','category','finish_time','video_type','host','status','platform','publish_time','remark'];
            ids.forEach((eid, i) => fd.append(keys[i], document.getElementById('ed-'+eid).value.replace('T',' ')));
            
            // å›¾ç‰‡å•ç‹¬å¤„ç†
            const imgVal = document.getElementById('ed-img').value;
            if(imgVal) fd.append('image_url', imgVal);

            await fetch('/api/video/save', {method:'POST', body:fd});
            editingId = null; loadData();
        }

        // ç®€æ˜“å›¾ç‰‡ä¸Šä¼  (è¡Œå†…)
        async function uploadRowFile(input, id) {
            if(!input.files[0]) return;
            const fd = new FormData(); fd.append('file', input.files[0]);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            document.getElementById(`prev-${id}`).src = d.url;
            document.getElementById('ed-img').value = d.url;
        }

        // --- ç»Ÿè®¡å›¾è¡¨ (ECharts) ---
        async function loadReport(dim) {
            // æŒ‰é’®é«˜äº®å¤„ç†
            document.querySelectorAll('.active-dim').forEach(b => b.className = 'px-3 py-1 text-sm rounded hover:bg-slate-50');
            event.target.className = 'px-3 py-1 text-sm rounded bg-blue-50 text-blue-600 font-bold active-dim';

            const res = await fetch(`/api/report?dim=${dim}`);
            const data = await res.json();
            
            document.getElementById('stat-in').innerText = data.trend.in.reduce((a,b)=>a+b, 0);
            document.getElementById('stat-out').innerText = data.trend.out.reduce((a,b)=>a+b, 0);

            // 1. è¶‹åŠ¿å›¾
            if(!chartTrend) chartTrend = echarts.init(document.getElementById('chart-trend'));
            chartTrend.setOption({
                tooltip: { trigger: 'axis' },
                legend: { data: ['å…¥åº“', 'å‘å¸ƒ'] },
                xAxis: { type: 'category', data: data.trend.dates },
                yAxis: { type: 'value' },
                series: [
                    { name: 'å…¥åº“', type: 'line', data: data.trend.in, smooth: true, itemStyle: {color:'#3b82f6'} },
                    { name: 'å‘å¸ƒ', type: 'bar', data: data.trend.out, itemStyle: {color:'#10b981'} }
                ]
            });

            // 2. é¥¼å›¾
            if(!chartPlat) chartPlat = echarts.init(document.getElementById('chart-plat'));
            chartPlat.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie', radius: ['40%', '70%'],
                    data: data.platform,
                    itemStyle: { borderRadius: 5 }
                }]
            });
            
            // å“åº”å¼é‡ç»˜
            window.onresize = () => { chartTrend.resize(); chartPlat.resize(); };
        }

        // --- å…¶ä»–å·¥å…·å‡½æ•° (å¤šé€‰/æ’åº/å¼¹çª—) ä¿æŒä¸å˜ ---
        function openMulti(input, type) { /* ...åŒV9... */ 
            const menu = document.getElementById('multi-menu');
            const rect = input.getBoundingClientRect();
            const opts = globalOptions[type] || [];
            const current = input.value.split(/[,ï¼Œ]/).map(s => s.trim());
            menu.innerHTML = opts.map(o => {
                const isChk = current.includes(o);
                return `<div class="multi-option" onclick="toggleOption('${input.id}', '${o}')">
                    <span class="${isChk?'text-blue-600':'text-slate-300'} font-bold w-4">${isChk?'âœ“':''}</span> ${o}
                </div>`;
            }).join('');
            menu.style.top = (rect.bottom + window.scrollY) + 'px';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.classList.add('show');
        }
        function toggleOption(inputId, val) { /* ...åŒV9... */ 
            const input = document.getElementById(inputId);
            let vals = input.value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            if(vals.includes(val)) vals = vals.filter(v => v !== val); else vals.push(val);
            input.value = vals.join(', ');
            openMulti(input, inputId.includes('host')?'hosts':'platforms');
        }
        function toggleFilters() { document.getElementById('filter-panel').classList.toggle('open'); }
        function showBigImg(src) { document.getElementById('big-img').src=src; document.getElementById('preview-modal').classList.add('active'); }
        function openImport() { document.getElementById('import-modal').classList.add('active'); }
        function openSettings() { 
            document.getElementById('settings-modal').classList.add('active'); 
            document.getElementById('set-hosts').value = globalOptions.hosts.join(',');
            document.getElementById('set-cats').value = globalOptions.categories.join(',');
            document.getElementById('set-plats').value = globalOptions.platforms.join(',');
            document.getElementById('set-types').value = globalOptions.video_types.join(',');
        }
        async function saveSettings() {
            const fd = new FormData();
            const save = (k, v) => fetch('/api/settings', {method:'POST', body: new URLSearchParams({key:k, value:v})});
            await save('hosts', document.getElementById('set-hosts').value);
            await save('platforms', document.getElementById('set-plats').value);
            await save('categories', document.getElementById('set-cats').value);
            await save('video_types', document.getElementById('set-types').value);
            document.getElementById('settings-modal').classList.remove('active'); loadOptions();
        }
        async function startImport() {
            document.getElementById('prog-bar').style.display='block';
            document.getElementById('prog-val').style.width='50%';
            await fetch('/api/import/local', {method:'POST'});
            document.getElementById('prog-val').style.width='100%';
            setTimeout(() => { alert('ä»»åŠ¡å·²å¯åŠ¨'); document.getElementById('import-modal').classList.remove('active'); }, 500);
        }
        function resetFilters() { document.querySelectorAll('#filter-panel input, #filter-panel select').forEach(e => e.value=''); loadData(1); }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        function sortBy(col) { currentSort.col = col; currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc'; loadData(1); }
        async function delVideo(id) { if(confirm('åˆ ?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); } }
    </script>
</body>
</html>