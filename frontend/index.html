<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub | èµ„äº§åº“å­˜ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è¡¨æ ¼äº¤äº’ */
        tr.hover-row:hover td { background-color: #f8fafc; }
        
        /* å¼¹çª—åŠ¨ç”» */
        .modal-enter { animation: modalIn 0.2s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center shrink-0 z-20">
        <div class="flex items-center space-x-3">
            <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-slate-800">VideoHub <span class="text-xs font-normal text-slate-400 ml-1">v2.0</span></h1>
        </div>
        <div class="flex items-center space-x-4">
            <div class="hidden md:flex items-center space-x-6 mr-4 text-sm">
                <div class="flex flex-col items-end">
                    <span class="text-xs text-slate-400 uppercase font-bold">Total Assets</span>
                    <span class="font-bold text-slate-800" id="stat-total">--</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-xs text-slate-400 uppercase font-bold">Pending</span>
                    <span class="font-bold text-orange-500" id="stat-pending">--</span>
                </div>
            </div>
            <div class="h-8 w-px bg-slate-200 mx-2"></div>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-xs font-bold text-slate-600">
                    ZY
                </div>
                <span class="text-sm font-medium text-slate-600 hidden sm:block">zeyu8023</span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col p-6 overflow-hidden">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4 shrink-0">
            <div class="flex items-center space-x-3 w-full md:w-auto">
                <div class="relative group w-full md:w-64">
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="keyword" 
                           onkeydown="if(event.key==='Enter') loadData(1)"
                           placeholder="æœç´¢æ ‡é¢˜ / ç¼–å· / ä¸»æ’­" 
                           class="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm shadow-sm transition-all">
                </div>
                
                <select id="status-filter" onchange="loadData(1)" class="py-2 pl-3 pr-8 rounded-lg border border-slate-300 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer shadow-sm hover:border-blue-400 transition-colors">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="å¾…å‘å¸ƒ">ğŸŸ  å¾…å‘å¸ƒ</option>
                    <option value="å·²å‘å¸ƒ">ğŸŸ¢ å·²å‘å¸ƒ</option>
                </select>

                <button onclick="loadData(1)" class="bg-white border border-slate-300 text-slate-600 hover:text-blue-600 hover:border-blue-500 px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm">
                    åˆ·æ–°
                </button>
            </div>

            <div class="flex space-x-3">
                <button onclick="scanLocal()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition-transform active:scale-95 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    æ‰«æå¯¼å…¥
                </button>
                <button onclick="toggleModal(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-blue-200 transition-transform active:scale-95 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    æ–°å¢èµ„äº§
                </button>
            </div>
        </div>

        <div class="flex-1 bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden">
            <div class="overflow-x-auto flex-1">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-20">å°é¢</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-32">ç¼–å·</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">æ ‡é¢˜</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-24">ä¸»æ’­</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-24">åˆ†ç±»</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-28">çŠ¶æ€</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider w-24">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            
            <div class="bg-white border-t border-slate-200 px-6 py-3 flex items-center justify-between shrink-0">
                <div class="text-xs text-slate-500">
                    ç¬¬ <span id="page-current" class="font-bold text-slate-800">1</span> / <span id="page-total">1</span> é¡µ
                    <span class="mx-2 text-slate-300">|</span>
                    å…± <span id="item-total">0</span> æ¡è®°å½•
                </div>
                <div class="flex space-x-2">
                    <button id="btn-prev" onclick="changePage(-1)" class="px-3 py-1 border border-slate-200 rounded text-xs font-medium text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        ä¸Šä¸€é¡µ
                    </button>
                    <button id="btn-next" onclick="changePage(1)" class="px-3 py-1 border border-slate-200 rounded text-xs font-medium text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        ä¸‹ä¸€é¡µ
                    </button>
                </div>
            </div>
        </div>

    </main>

    <div id="modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl modal-enter overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">å½•å…¥æ–°è§†é¢‘</h3>
                <button onclick="toggleModal(false)" class="text-slate-400 hover:text-red-500 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="addForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">äº§å“ç¼–å·</label>
                        <input name="product_id" placeholder="ä¾‹å¦‚: 2024-001" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ä¸»æ’­</label>
                        <input name="host" placeholder="ä¾‹å¦‚: å°æ¢¨" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">è§†é¢‘æ ‡é¢˜</label>
                    <input name="title" placeholder="è¯·è¾“å…¥è§†é¢‘å®Œæ•´æ ‡é¢˜" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">çŠ¶æ€</label>
                        <select name="status" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
                            <option>å¾…å‘å¸ƒ</option>
                            <option>å·²å‘å¸ƒ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">åˆ†ç±»</label>
                        <input name="category" placeholder="çƒæœ / çƒé‹" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
                    </div>
                </div>
                <div class="pt-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">å°é¢å›¾ç‰‡</label>
                    <input type="file" name="image" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-all"/>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal(false)" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-lg">ç¡®è®¤ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 20; // æ¯é¡µ20æ¡ï¼Œé€‚åˆè¡¨æ ¼è§†å›¾

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData(1);
            updateStats();
        });

        // åŠ è½½æ•°æ® (åˆ†é¡µ+æœç´¢+ç­›é€‰)
        async function loadData(page) {
            currentPage = page;
            const keyword = document.getElementById('keyword').value;
            const status = document.getElementById('status-filter').value;
            const tbody = document.getElementById('table-body');
            
            // Loading çŠ¶æ€
            tbody.innerHTML = `<tr><td colspan="7" class="py-20 text-center"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></td></tr>`;

            try {
                const params = new URLSearchParams({ page, size: pageSize, keyword, status });
                const res = await fetch(`/api/videos?${params}`);
                const data = await res.json();
                
                renderTable(data.items);
                updatePagination(data);
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="7" class="py-10 text-center text-red-500 font-bold">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</td></tr>`;
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            if (!items || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="py-20 text-center text-slate-400">æš‚æ— åŒ¹é…æ•°æ®</td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(v => `
                <tr class="hover-row transition-colors border-b border-slate-50 last:border-b-0">
                    <td class="px-6 py-3 whitespace-nowrap">
                        <div class="relative h-10 w-10 group">
                            <img class="h-10 w-10 rounded object-cover bg-slate-100 border border-slate-200 cursor-pointer" 
                                 src="${v.image_url}" 
                                 onerror="this.src='https://via.placeholder.com/40?text=NA'"
                                 onclick="window.open('${v.image_url}', '_blank')">
                            <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50 w-48 shadow-2xl rounded-lg overflow-hidden border border-white">
                                <img src="${v.image_url}" class="w-full bg-white">
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-bold text-slate-700 font-mono">${v.product_id}</td>
                    <td class="px-6 py-3 text-sm text-slate-600 font-medium max-w-xs truncate" title="${v.title}">${v.title}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-slate-500">
                        <div class="flex items-center"><div class="w-1.5 h-1.5 rounded-full bg-slate-300 mr-2"></div>${v.host}</div>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-slate-400 font-mono text-xs uppercase">${v.category || '-'}</td>
                    <td class="px-6 py-3 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold border ${getStatusStyle(v.status)}">
                            ${v.status}
                        </span>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-slate-400 hover:text-blue-600 transition-colors">ç¼–è¾‘</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusStyle(status) {
            if (status === 'å¾…å‘å¸ƒ') return 'bg-orange-50 text-orange-600 border-orange-100';
            if (status === 'å·²å‘å¸ƒ') return 'bg-emerald-50 text-emerald-600 border-emerald-100';
            return 'bg-slate-50 text-slate-600 border-slate-100';
        }

        // åˆ†é¡µæ›´æ–°
        function updatePagination(data) {
            totalPages = data.total_pages;
            document.getElementById('page-current').innerText = data.page;
            document.getElementById('page-total').innerText = data.total_pages;
            document.getElementById('item-total').innerText = data.total;
            
            document.getElementById('btn-prev').disabled = data.page <= 1;
            document.getElementById('btn-next').disabled = data.page >= data.total_pages;
        }

        function changePage(delta) {
            const target = currentPage + delta;
            if (target > 0 && target <= totalPages) loadData(target);
        }

        // ç»Ÿè®¡æ›´æ–°
        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const s = await res.json();
                document.getElementById('stat-total').innerText = s.total;
                document.getElementById('stat-pending').innerText = s.pending;
            } catch(e) { console.error("Stats error"); }
        }

        // ç›®å½•æ‰«æå¯¼å…¥
        async function scanLocal() {
            if(!confirm("ç¡®è®¤è¦æ‰«æ NAS ä¸Šçš„ temp_uploads ç›®å½•å¹¶å¯¼å…¥å—ï¼Ÿ")) return;
            try {
                const res = await fetch('/api/import/local', {method:'POST'});
                const d = await res.json();
                alert(d.message);
            } catch(e) { alert("æ‰«æå¯åŠ¨å¤±è´¥"); }
        }

        // å¼¹çª—é€»è¾‘
        function toggleModal(show) {
            const m = document.getElementById('modal');
            m.classList.toggle('hidden', !show);
            m.classList.toggle('flex', show);
        }

        // æ–°å¢æäº¤
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            const fd = new FormData(e.target);
            try {
                const res = await fetch('/api/video/add', {method:'POST', body:fd});
                if(res.ok) {
                    toggleModal(false);
                    e.target.reset();
                    loadData(1);
                    updateStats();
                } else { alert("ä¿å­˜å¤±è´¥"); }
            } catch(err) { alert("ç½‘ç»œé”™è¯¯"); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>