<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; min-width: 1600px; }
        th { font-size: 13px; font-weight: 700; color: #475569; padding: 12px 10px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; text-align: left; cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; color: #1e293b; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* ç­›é€‰å™¨æ ·å¼ */
        .filter-input { padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; width: 100%; outline: none; background: white; transition: border 0.2s; }
        .filter-input:focus { border-color: #3b82f6; ring: 2px; }
        .filter-label { font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 4px; display: block; }

        /* å½©è‰²èƒ¶å›Š */
        .pill { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; border: 1px solid transparent; white-space: nowrap; }
        
        /* å›¾ç‰‡åŒº */
        .img-zone { width: 44px; height: 44px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f1f5f9; overflow: hidden; cursor: pointer; position: relative; }
        .img-zone:hover::after { content: '+'; position: absolute; inset: 0; background: rgba(0,0,0,0.4); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; }

        /* æ¨¡æ€æ¡† */
        .modal { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        /* æ’åºå›¾æ ‡ */
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; opacity: 0.5; }
        th.active .sort-icon { opacity: 1; color: #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-30">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow">V</div>
            <h1 class="text-lg font-bold text-slate-800">VideoHub <span class="text-xs text-slate-400 font-normal">V5.0</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="openSettings()" class="text-xs font-bold text-slate-500 hover:text-blue-600 bg-slate-50 px-3 py-1.5 rounded border border-slate-100">âš™ï¸ å…¨å±€é…ç½®</button>
            <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-500">ZY</div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-4 z-20 shrink-0">
        <div class="grid grid-cols-3 gap-6 max-w-[1200px]">
            <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-slate-400 uppercase">æ€»èµ„äº§</div><div class="text-3xl font-black text-slate-800" id="st-total">-</div></div>
                <div class="text-3xl">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-orange-400 uppercase">å¾…å‘å¸ƒ</div><div class="text-3xl font-black text-orange-500" id="st-pending">-</div></div>
                <div class="text-3xl">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-emerald-400 uppercase">æœ¬æœˆåŠ³æ¨¡</div><div class="text-3xl font-black text-emerald-600" id="st-host">-</div></div>
                <div class="text-3xl">ğŸ†</div>
            </div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-3 z-20 shrink-0">
        <div class="grid grid-cols-6 gap-3 items-end">
            <div><label class="filter-label">äº§å“ç¼–å·</label><input id="s-pid" class="filter-input" placeholder="è¾“å…¥ç¼–å·..."></div>
            <div><label class="filter-label">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="filter-input" placeholder="è¾“å…¥æ ‡é¢˜..."></div>
            <div><label class="filter-label">äº§å“ç±»å‹</label><select id="s-cat" class="filter-input"></select></div>
            <div><label class="filter-label">è§†é¢‘ç±»å‹</label><select id="s-type" class="filter-input"></select></div>
            <div><label class="filter-label">å½“å‰çŠ¶æ€</label><select id="s-status" class="filter-input"></select></div>
            <div><label class="filter-label">å¤‡æ³¨</label><input id="s-rem" class="filter-input" placeholder="è¾“å…¥å¤‡æ³¨..."></div>
            
            <div><label class="filter-label">ä¸»æ’­ (å¤šé€‰)</label><select id="s-host" class="filter-input"></select></div>
            <div><label class="filter-label">å‘å¸ƒå¹³å°</label><select id="s-plat" class="filter-input"></select></div>
            <div class="col-span-2">
                <label class="filter-label">å®Œæˆæ—¶é—´èŒƒå›´</label>
                <div class="flex gap-2"><input type="date" id="s-fin-start" class="filter-input"><input type="date" id="s-fin-end" class="filter-input"></div>
            </div>
            <div class="col-span-2">
                <label class="filter-label">å‘å¸ƒæ—¶é—´èŒƒå›´</label>
                <div class="flex gap-2"><input type="date" id="s-pub-start" class="filter-input"><input type="date" id="s-pub-end" class="filter-input"></div>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-3 pt-3 border-t border-slate-100">
            <button onclick="resetFilter()" class="text-xs font-bold text-slate-400 hover:text-slate-600 px-3 py-1.5">é‡ç½®æ¡ä»¶</button>
            <button onclick="loadData(1)" class="bg-blue-600 text-white text-xs font-bold px-5 py-1.5 rounded hover:bg-blue-700">ç«‹å³æŸ¥è¯¢</button>
            <div class="w-px h-6 bg-slate-200 mx-2"></div>
            <button onclick="openImport()" class="bg-slate-800 text-white text-xs font-bold px-4 py-1.5 rounded hover:bg-black">å¯¼å…¥æ•°æ®</button>
            <button onclick="openAdd()" class="bg-emerald-600 text-white text-xs font-bold px-4 py-1.5 rounded hover:bg-emerald-700">æ–°å¢èµ„äº§</button>
        </div>
    </div>

    <div class="flex-1 bg-slate-50 overflow-hidden w-full relative">
        <div class="absolute inset-0 overflow-auto">
            <table class="w-full text-left">
                <thead class="sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="w-16 text-center">å›¾</th>
                        <th onclick="sortBy('product_id')" class="w-32">äº§å“ç¼–å· <span class="sort-icon" id="icon-product_id">â†•</span></th>
                        <th onclick="sortBy('title')" style="width:300px">è§†é¢‘æ ‡é¢˜ <span class="sort-icon" id="icon-title">â†•</span></th>
                        <th onclick="sortBy('category')" class="w-24">äº§å“ç±»å‹ <span class="sort-icon" id="icon-category">â†•</span></th>
                        <th onclick="sortBy('finish_time')" class="w-28">å®Œæˆæ—¶é—´ <span class="sort-icon" id="icon-finish_time">â†•</span></th>
                        <th onclick="sortBy('video_type')" class="w-24">è§†é¢‘ç±»å‹ <span class="sort-icon" id="icon-video_type">â†•</span></th>
                        <th onclick="sortBy('host')" class="w-28">ä¸»æ’­ <span class="sort-icon" id="icon-host">â†•</span></th>
                        <th onclick="sortBy('status')" class="w-24 text-center">çŠ¶æ€ <span class="sort-icon" id="icon-status">â†•</span></th>
                        <th onclick="sortBy('platform')" class="w-28">å¹³å° <span class="sort-icon" id="icon-platform">â†•</span></th>
                        <th onclick="sortBy('publish_time')" class="w-32">å‘å¸ƒæ—¶é—´ <span class="sort-icon" id="icon-publish_time">â†•</span></th>
                        <th onclick="sortBy('remark')" class="w-40">å¤‡æ³¨ <span class="sort-icon" id="icon-remark">â†•</span></th>
                        <th class="w-24 text-center sticky right-0 bg-slate-100 border-l">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-200 bg-white"></tbody>
            </table>
        </div>
    </div>
    
    <div class="h-10 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0 text-xs text-slate-500 font-medium z-30">
        <span>å…± <b id="total-count" class="text-slate-800">0</b> æ¡æ•°æ® Â· æ¯é¡µ 100 æ¡</span>
        <div class="flex gap-2 items-center">
            <button id="btn-prev" onclick="changePage(-1)" class="hover:text-blue-600 disabled:opacity-50">â—€ ä¸Šä¸€é¡µ</button>
            <span id="page-info">1 / 1</span>
            <button id="btn-next" onclick="changePage(1)" class="hover:text-blue-600 disabled:opacity-50">ä¸‹ä¸€é¡µ â–¶</button>
        </div>
    </div>

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black/95 flex items-center justify-center cursor-zoom-out" onclick="this.classList.add('hidden')">
        <img id="big-img" src="" class="max-h-[90vh] max-w-[90vw] object-contain shadow-2xl">
    </div>

    <div id="edit-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[700px] p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold mb-4 text-lg" id="modal-title">èµ„äº§ä¿¡æ¯</h3>
            <form id="editForm" class="grid grid-cols-3 gap-4">
                <input type="hidden" name="id" id="f-id">
                
                <div class="col-span-1 row-span-4 border-2 border-dashed border-slate-200 rounded-lg flex flex-col items-center justify-center bg-slate-50 cursor-pointer relative overflow-hidden group"
                     onclick="document.getElementById('file-input').click()"
                     ondragover="event.preventDefault(); this.style.borderColor='#3b82f6'"
                     ondragleave="this.style.borderColor='#e2e8f0'"
                     ondrop="handleFormDrop(event)">
                    <img id="f-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div class="text-center text-slate-400 group-hover:text-blue-500">
                        <div class="text-3xl mb-2">ğŸ“·</div>
                        <div class="text-xs">ç‚¹å‡» / æ‹–æ‹½ / ç²˜è´´</div>
                    </div>
                    <input type="file" id="file-input" class="hidden" onchange="uploadFile(this.files[0])">
                    <input type="hidden" name="image_url" id="f-img-val">
                </div>

                <div class="col-span-2 grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label class="filter-label">è§†é¢‘æ ‡é¢˜ *</label><input name="title" id="f-title" class="filter-input" required></div>
                    <div><label class="filter-label">äº§å“ç¼–å· *</label><input name="product_id" id="f-pid" class="filter-input" required></div>
                    <div><label class="filter-label">äº§å“ç±»å‹</label><input name="category" id="f-cat" class="filter-input" list="dl-cat"></div>
                    <div><label class="filter-label">ä¸»æ’­ (å¤šé€‰)</label><input name="host" id="f-host" class="filter-input" list="dl-host"></div>
                    <div><label class="filter-label">å‘å¸ƒçŠ¶æ€</label><select name="status" id="f-status" class="filter-input"></select></div>
                    <div><label class="filter-label">å‘å¸ƒå¹³å°</label><input name="platform" id="f-plat" class="filter-input" list="dl-plat"></div>
                    <div><label class="filter-label">è§†é¢‘ç±»å‹</label><input name="video_type" id="f-type" class="filter-input" list="dl-type"></div>
                    <div><label class="filter-label">å®Œæˆæ—¶é—´</label><input name="finish_time" id="f-fin" class="filter-input" type="date"></div>
                    <div><label class="filter-label">å‘å¸ƒæ—¶é—´</label><input name="publish_time" id="f-pub" class="filter-input" type="datetime-local"></div>
                    <div class="col-span-2"><label class="filter-label">å¤‡æ³¨</label><input name="remark" id="f-rem" class="filter-input"></div>
                </div>

                <div class="col-span-3 pt-4 border-t flex justify-end gap-2">
                    <button type="button" onclick="closeModal('edit-modal')" class="px-4 py-2 text-slate-500 text-sm font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded text-sm font-bold">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[400px] p-6 text-center">
            <h3 class="font-bold mb-4">å¯¼å…¥æ•°æ® (NAS)</h3>
            <p class="text-sm text-slate-500 mb-6">ç³»ç»Ÿå°†è‡ªåŠ¨æ‰«æ <code class="bg-slate-100 px-1">temp_uploads</code> ç›®å½•ä¸‹çš„ Excel æ–‡ä»¶ã€‚</p>
            <button onclick="startImport()" class="bg-slate-800 text-white px-6 py-2 rounded font-bold w-full">å¼€å§‹æ‰«æå¯¼å…¥</button>
            <button onclick="closeModal('import-modal')" class="mt-3 text-slate-400 text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <datalist id="dl-cat"></datalist><datalist id="dl-host"></datalist><datalist id="dl-plat"></datalist><datalist id="dl-type"></datalist>

    <script>
        let currPage = 1, totalPages = 1, currentSort = { col: 'id', order: 'desc' };
        let globalOptions = {};

        // åˆå§‹åŒ–
        (async () => {
            await loadOptions();
            await loadData(1);
            updateStats();
            
            // ç»‘å®šå…¨å±€ç²˜è´´
            document.addEventListener('paste', e => {
                if(document.getElementById('edit-modal').classList.contains('active')) {
                    if(e.clipboardData.files.length) uploadFile(e.clipboardData.files[0]);
                }
            });
        })();

        // --- æ ¸å¿ƒæ•°æ®é€»è¾‘ ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            
            // å¡«å……æ‰€æœ‰ä¸‹æ‹‰æ¡†
            const setupSelect = (id, items) => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = `<option value="">å…¨éƒ¨</option>` + items.map(i=>`<option value="${i}">${i}</option>`).join('');
            };
            const setupDL = (id, items) => document.getElementById(id).innerHTML = items.map(i=>`<option value="${i}">`).join('');

            // ç­›é€‰æ 
            setupSelect('s-cat', globalOptions.categories);
            setupSelect('s-type', globalOptions.video_types);
            setupSelect('s-status', globalOptions.statuses);
            setupSelect('s-host', globalOptions.hosts);
            setupSelect('s-plat', globalOptions.platforms);

            // å¼¹çª—
            setupSelect('f-status', globalOptions.statuses); // çŠ¶æ€åªèƒ½å•é€‰
            setupDL('dl-cat', globalOptions.categories);
            setupDL('dl-host', globalOptions.hosts);
            setupDL('dl-plat', globalOptions.platforms);
            setupDL('dl-type', globalOptions.video_types);
        }

        async function loadData(p) {
            currPage = p || currPage;
            // æ”¶é›†æ‰€æœ‰ç­›é€‰å‚æ•°
            const params = new URLSearchParams({
                page: currPage, size: 100,
                sort_by: currentSort.col, order: currentSort.order,
                product_id: v('s-pid'), title: v('s-title'), remark: v('s-rem'),
                category: v('s-cat'), video_type: v('s-type'), status: v('s-status'),
                host: v('s-host'), platform: v('s-plat'),
                fin_start: v('s-fin-start'), fin_end: v('s-fin-end'),
                pub_start: v('s-pub-start'), pub_end: v('s-pub-end')
            });

            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            totalPages = data.total_pages;
            
            // æ›´æ–°åˆ†é¡µ UI
            document.getElementById('total-count').innerText = data.total;
            document.getElementById('page-info').innerText = `${data.page} / ${data.total_pages}`;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);

            renderTable(data.items);
        }
        function v(id) { return document.getElementById(id).value; }

        // --- æ’åºé€»è¾‘ ---
        function sortBy(col) {
            if(currentSort.col === col) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.col = col;
                currentSort.order = 'desc';
            }
            // æ›´æ–°å›¾æ ‡
            document.querySelectorAll('.sort-icon').forEach(el => el.innerText = 'â†•');
            document.querySelectorAll('th').forEach(el => el.classList.remove('active'));
            document.getElementById('icon-'+col).innerText = currentSort.order === 'asc' ? 'â¬†' : 'â¬‡';
            
            loadData(1);
        }

        // --- æ¸²æŸ“è¡¨æ ¼ (å…¨å½© Pill) ---
        const getColor = (str, type) => {
            if(!str || str==='nan') return {bg:'#f1f5f9', t:'#94a3b8'};
            if(type === 'status') {
                if(str.includes('å·²å‘å¸ƒ')) return {bg:'#dcfce7', t:'#166534'};
                if(str.includes('å¾…å‘å¸ƒ')) return {bg:'#fff7ed', t:'#c2410c'};
                return {bg:'#f1f5f9', t:'#475569'};
            }
            const colors = [{bg:'#fee2e2',t:'#991b1b'}, {bg:'#dbeafe',t:'#1e40af'}, {bg:'#fef3c7',t:'#92400e'}, {bg:'#f3e8ff',t:'#6b21a8'}];
            let hash=0; for(let i=0;i<str.length;i++) hash=str.charCodeAt(i)+((hash<<5)-hash);
            return colors[Math.abs(hash)%colors.length];
        };

        const pill = (str, type) => {
            if(!str || str==='nan') return '-';
            return str.split(/[,ï¼Œ]/).map(s => {
                const c = getColor(s.trim(), type);
                return `<span class="pill" style="background:${c.bg};color:${c.t}">${s.trim()}</span>`;
            }).join('');
        };

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                const cln = (s) => (s && s!=='nan' && s!=='NaT' && s!=='None') ? s : '';
                
                return `
                <tr class="hover:bg-slate-50 group transition-colors">
                    <td class="p-2 text-center">
                        <div class="img-zone mx-auto" onclick="showBigImg('${img}')" onpaste="handleRowPaste(event,${v.id})" ondrop="handleRowDrop(event,${v.id})" ondragover="event.preventDefault()">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td class="font-mono text-xs text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 text-sm truncate max-w-[240px]" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td>${pill(cln(v.category))}</td>
                    <td class="text-xs text-slate-400 whitespace-nowrap">${cln(v.finish_time)}</td>
                    <td>${pill(cln(v.video_type))}</td>
                    <td>${pill(cln(v.host))}</td>
                    <td class="text-center">${pill(cln(v.status), 'status')}</td>
                    <td>${pill(cln(v.platform))}</td>
                    <td class="text-xs text-slate-400 font-mono whitespace-nowrap">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-xs text-slate-400 truncate max-w-[120px]" title="${cln(v.remark)}">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 shadow-l border-l">
                        <button onclick='editRow(${JSON.stringify(v).replace(/'/g,"&apos;")})' class="text-blue-600 font-bold text-xs mr-2 hover:underline">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- ç¼–è¾‘é€»è¾‘ (å¤ç”¨å¼¹çª—) ---
        function openAdd() { 
            document.getElementById('edit-modal').classList.add('active');
            document.getElementById('editForm').reset();
            document.getElementById('f-id').value = '';
            document.getElementById('modal-title').innerText = "æ–°å¢èµ„äº§";
            resetPreview();
        }
        function editRow(v) {
            openAdd();
            document.getElementById('modal-title').innerText = "ç¼–è¾‘èµ„äº§";
            document.getElementById('f-id').value = v.id;
            const set = (id, val) => document.getElementById(id).value = (val && val!=='nan' ? val : '');
            set('f-pid', v.product_id); set('f-title', v.title); set('f-cat', v.category);
            set('f-host', v.host); set('f-status', v.status); set('f-plat', v.platform);
            set('f-type', v.video_type); set('f-fin', v.finish_time); 
            set('f-pub', (v.publish_time||'').replace(' ','T')); set('f-rem', v.remark);
            if(v.image_url && v.image_url.length > 5) showFormPreview(v.image_url);
        }

        // --- å›¾ç‰‡å¤„ç† ---
        function showBigImg(src) { document.getElementById('big-img').src=src; document.getElementById('preview-modal').classList.remove('hidden'); }
        async function uploadFile(file) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const data = await res.json();
            showFormPreview(data.url);
        }
        function showFormPreview(url) {
            const img = document.getElementById('f-preview');
            img.src = url; img.classList.remove('hidden');
            document.getElementById('f-img-val').value = url;
        }
        function resetPreview() {
            document.getElementById('f-preview').classList.add('hidden');
            document.getElementById('f-img-val').value = '';
        }
        function handleFormDrop(e) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0]); }
        
        // è¡¨æ ¼è¡Œå†…å›¾ç‰‡æ›´æ–°
        async function handleRowDrop(e, id) { 
            e.preventDefault(); 
            if(e.dataTransfer.files[0]) {
                const fd = new FormData(); fd.append('file', e.dataTransfer.files[0]);
                const res = await fetch('/api/upload', {method:'POST', body:fd});
                const d = await res.json();
                // ä»…æ›´æ–°å›¾ç‰‡
                const sfd = new FormData(); sfd.append('id', id); sfd.append('image_url', d.url);
                await fetch('/api/video/save', {method:'POST', body:sfd});
                loadData();
            }
        }

        // --- æäº¤ä¸åˆ é™¤ ---
        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            if(fd.get('publish_time')) fd.set('publish_time', fd.get('publish_time').replace('T',' '));
            await fetch('/api/video/save', {method:'POST', body:fd});
            closeModal('edit-modal'); loadData(); updateStats();
        };
        async function delVideo(id) { if(confirm('ç¡®å®šåˆ é™¤?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); } }

        // --- æ‚é¡¹ ---
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function resetFilter() { document.querySelectorAll('.filter-input').forEach(e=>e.value=''); loadData(1); }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        function openImport() { document.getElementById('import-modal').classList.add('active'); }
        async function startImport() { 
            await fetch('/api/import/local', {method:'POST'}); 
            alert('åå°å·²å¯åŠ¨ï¼Œè¯·ç¨ååˆ·æ–°'); 
            closeModal('import-modal'); 
        }
        async function updateStats() { try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;document.getElementById('st-host').innerText=d.host;}catch{} }
    </script>
</body>
</html>