<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub Pro | æ•°å­—åŒ–èµ„äº§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        /* ç´§å‡‘è¡¨æ ¼æ ·å¼ */
        td { padding: 8px 12px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        th { padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .table-input { width: 100%; background: transparent; border: 1px solid transparent; padding: 4px; border-radius: 4px; transition: all 0.2s; }
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡†æ ·å¼ */
        .editing .table-input { background: white; border: 1px solid #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; white-space: nowrap; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <div class="bg-white border-b border-slate-200 px-6 py-4 shadow-sm z-20 sticky top-0">
        <div class="max-w-[2400px] mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">V</div>
                    <h1 class="text-2xl font-bold text-slate-900">VideoHub <span class="text-sm font-normal text-slate-400">Pro</span></h1>
                </div>
                <div class="flex gap-3">
                     <button onclick="scanLocal()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-bold shadow flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        æ‰«æå¯¼å…¥ (NAS)
                    </button>
                    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        æ‰‹åŠ¨æ–°å¢
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-slate-400 text-xs font-bold uppercase">æ€»è§†é¢‘èµ„äº§</div>
                        <div class="text-3xl font-black text-slate-800" id="st-total">--</div>
                    </div>
                    <div class="text-2xl">ğŸ“¦</div>
                </div>
                <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-orange-600/70 text-xs font-bold uppercase">å¾…å‘å¸ƒåº“å­˜</div>
                        <div class="text-3xl font-black text-orange-500" id="st-pending">--</div>
                    </div>
                    <div class="text-2xl">ğŸ”¥</div>
                </div>
                <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-emerald-600/70 text-xs font-bold uppercase">æœ¬æœˆåŠ³æ¨¡</div>
                        <div class="text-3xl font-black text-emerald-600" id="st-host">--</div>
                    </div>
                    <div class="text-2xl">ğŸ†</div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 p-6 max-w-[2400px] mx-auto w-full overflow-hidden flex flex-col">
        
        <div class="flex flex-wrap items-center gap-2 mb-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm shrink-0">
            <input id="q-key" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="æœç´¢ç¼–å·/æ ‡é¢˜" class="px-3 py-2 w-48 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
            
            <select id="q-host" onchange="loadData(1)" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer min-w-[100px]">
                <option value="">å…¨éƒ¨ä¸»æ’­</option>
            </select>
            
            <select id="q-status" onchange="loadData(1)" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer min-w-[100px]">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
            </select>

            <select id="q-cat" onchange="loadData(1)" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer min-w-[100px]">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
            </select>

            <div class="flex items-center gap-1 border-l pl-3 ml-1">
                <span class="text-xs font-bold text-slate-400">å‘å¸ƒæ—¶é—´:</span>
                <input type="date" id="q-start" onchange="loadData(1)" class="px-2 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none text-slate-600">
                <span class="text-slate-400">-</span>
                <input type="date" id="q-end" onchange="loadData(1)" class="px-2 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none text-slate-600">
            </div>

            <button onclick="loadData(1)" class="ml-auto px-5 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 shadow">æŸ¥è¯¢</button>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col flex-1 overflow-hidden">
            <div class="overflow-auto flex-1 relative">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 sticky top-0 z-10 text-xs font-bold text-slate-500 uppercase">
                        <tr>
                            <th class="w-16">é¢„è§ˆ</th>
                            <th class="w-32">äº§å“ç¼–å·</th>
                            <th class="min-w-[200px]">è§†é¢‘æ ‡é¢˜</th>
                            <th>ç±»å‹</th>
                            <th class="w-32">å®Œæˆæ—¶é—´</th>
                            <th class="w-24">ä¸»æ’­</th>
                            <th class="w-24 text-center">çŠ¶æ€</th>
                            <th>å¹³å°</th>
                            <th class="w-40">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-48">å¤‡æ³¨</th>
                            <th class="w-32 text-center sticky right-0 bg-slate-50 shadow-l">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            <div class="border-t border-slate-200 px-4 py-2 flex justify-between items-center bg-slate-50 shrink-0 text-sm">
                <span class="text-slate-500">å…± <span id="total-count">0</span> æ¡ (æ¯é¡µ100æ¡)ï¼Œç¬¬ <span id="curr-page">1</span> é¡µ</span>
                <div class="space-x-2">
                    <button onclick="changePage(-1)" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100">ä¸Šä¸€é¡µ</button>
                    <button onclick="changePage(1)" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-[600px] shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4">æ‰‹åŠ¨æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-2 gap-4">
                <div class="col-span-2"><input name="title" placeholder="è§†é¢‘æ ‡é¢˜" class="w-full p-2 border rounded" required></div>
                <div><input name="product_id" placeholder="äº§å“ç¼–å·" class="w-full p-2 border rounded" required></div>
                <div><input name="host" placeholder="ä¸»æ’­" class="w-full p-2 border rounded" required list="host-list"></div>
                <div><input name="category" placeholder="åˆ†ç±»" class="w-full p-2 border rounded"></div>
                <div><select name="status" class="w-full p-2 border rounded"><option>å¾…å‘å¸ƒ</option><option>å·²å‘å¸ƒ</option></select></div>
                <div class="col-span-2 pt-2 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded font-bold">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    <datalist id="host-list"></datalist>

    <script>
        let currPage = 1, totalPages = 1;
        let globalData = [];
        let editingRowId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„è¡ŒID

        // åˆå§‹åŒ–
        (async function init() {
            await loadOptions();
            await loadData(1);
            updateStats();
        })();

        // 1. åŠ è½½é€‰é¡¹
        async function loadOptions() {
            const res = await fetch('/api/options');
            const data = await res.json();
            fillSelect('q-host', data.hosts, 'å…¨éƒ¨ä¸»æ’­');
            fillSelect('q-status', data.statuses, 'å…¨éƒ¨çŠ¶æ€');
            fillSelect('q-cat', data.categories, 'å…¨éƒ¨åˆ†ç±»');
            
            document.getElementById('host-list').innerHTML = data.hosts.map(h => `<option value="${h}">`).join('');
        }

        function fillSelect(id, items, def) {
            document.getElementById(id).innerHTML = `<option value="">${def}</option>` + items.map(i => `<option value="${i}">${i}</option>`).join('');
        }

        // 2. åŠ è½½è¡¨æ ¼æ•°æ®
        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100, // é»˜è®¤100æ¡
                keyword: document.getElementById('q-key').value,
                host: document.getElementById('q-host').value,
                status: document.getElementById('q-status').value,
                category: document.getElementById('q-cat').value,
                pub_start: document.getElementById('q-start').value, // æ—¶é—´ç­›é€‰
                pub_end: document.getElementById('q-end').value
            });

            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;

            document.getElementById('total-count').innerText = data.total;
            document.getElementById('curr-page').innerText = data.page;
            renderTable();
        }

        // 3. æ¸²æŸ“è¡¨æ ¼ (åŒºåˆ†ç¼–è¾‘æ¨¡å¼)
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = globalData.map(v => {
                const isEditing = (v.id === editingRowId);
                const clean = (val) => (val && val !== 'nan' && val !== 'NaT' && val !== 'None') ? val : '';
                
                // å¤„ç†æ—¶é—´æ ¼å¼ï¼Œä»¥ä¾¿æ”¾å…¥ input type="datetime-local"
                // æ•°æ®åº“å¦‚æœæ˜¯ "2026/02/08 12:00:00" æˆ– "2026-02-08 12:00:00"
                const fmtDate = (val) => {
                    if (!val) return '';
                    // ç®€å•å°è¯•æ›¿æ¢ / ä¸º - å¹¶å–å‰16ä½ (YYYY-MM-DDTHH:MM)
                    let d = val.replace(/\//g, '-').replace(' ', 'T');
                    return d.substring(0, 16);
                };

                // ç¼–è¾‘æ¨¡å¼ä¸‹çš„è¡Œ
                if (isEditing) {
                    return `
                    <tr class="bg-blue-50/50 editing border-l-4 border-blue-500">
                        <td class="px-4 py-2"><span class="text-xs text-slate-400">ä¸å¯æ”¹å›¾</span></td>
                        <td><input id="edit-pid-${v.id}" class="table-input" value="${clean(v.product_id)}"></td>
                        <td><input id="edit-title-${v.id}" class="table-input" value="${clean(v.title)}"></td>
                        <td><input id="edit-cat-${v.id}" class="table-input" value="${clean(v.category)}"></td>
                        <td><input id="edit-finish-${v.id}" type="datetime-local" class="table-input" value="${fmtDate(clean(v.finish_time))}"></td>
                        <td><input id="edit-host-${v.id}" class="table-input" value="${clean(v.host)}" list="host-list"></td>
                        <td>
                            <select id="edit-status-${v.id}" class="table-input">
                                <option ${v.status==='å¾…å‘å¸ƒ'?'selected':''}>å¾…å‘å¸ƒ</option>
                                <option ${v.status==='å·²å‘å¸ƒ'?'selected':''}>å·²å‘å¸ƒ</option>
                            </select>
                        </td>
                        <td><input id="edit-plat-${v.id}" class="table-input" value="${clean(v.platform)}"></td>
                        <td><input id="edit-pub-${v.id}" type="datetime-local" class="table-input" value="${fmtDate(clean(v.publish_time))}"></td>
                        <td><input id="edit-remark-${v.id}" class="table-input" value="${clean(v.remark)}"></td>
                        <td class="text-center sticky right-0 bg-blue-50 shadow-l">
                            <button onclick="saveRow(${v.id})" class="text-white bg-blue-600 px-3 py-1 rounded text-xs font-bold mr-2 hover:bg-blue-700">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-500 text-xs font-bold hover:text-slate-700">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                // æ­£å¸¸å±•ç¤ºæ¨¡å¼
                const imgUrl = (v.image_url && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                let stClass = "bg-slate-100 text-slate-600";
                if(clean(v.status) === 'å¾…å‘å¸ƒ') stClass = "bg-orange-50 text-orange-600 border border-orange-100";
                if(clean(v.status) === 'å·²å‘å¸ƒ') stClass = "bg-emerald-50 text-emerald-600 border border-emerald-100";

                return `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td>
                        <img src="${imgUrl}" class="w-10 h-10 object-cover rounded border border-slate-200" onerror="this.src='/assets/default.png'">
                    </td>
                    <td class="font-mono font-bold text-blue-600 text-xs">${clean(v.product_id)}</td>
                    <td class="font-medium text-slate-700 text-xs truncate max-w-[200px]" title="${clean(v.title)}">${clean(v.title)}</td>
                    <td class="text-slate-500 text-xs">${clean(v.category)}</td>
                    <td class="text-slate-400 text-xs whitespace-nowrap">${clean(v.finish_time).replace('T', ' ')}</td>
                    <td class="font-bold text-slate-600 text-xs">${clean(v.host)}</td>
                    <td class="text-center"><span class="status-badge ${stClass}">${clean(v.status)}</span></td>
                    <td class="text-slate-500 text-xs truncate max-w-[100px]">${clean(v.platform)}</td>
                    <td class="text-slate-400 text-xs whitespace-nowrap">${clean(v.publish_time).replace('T', ' ')}</td>
                    <td class="text-slate-400 text-xs truncate max-w-[150px]">${clean(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 shadow-l">
                        <button onclick="editRow(${v.id})" class="text-blue-600 hover:text-blue-800 font-bold text-xs mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 hover:text-red-600 font-bold text-xs">åˆ é™¤</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- è¡Œå†…ç¼–è¾‘é€»è¾‘ ---
        function editRow(id) {
            editingRowId = id;
            renderTable(); // é‡æ–°æ¸²æŸ“ï¼Œå‘½ä¸­ id çš„è¡Œä¼šå˜è¾“å…¥æ¡†
        }

        function cancelEdit() {
            editingRowId = null;
            renderTable();
        }

        async function saveRow(id) {
            // æ”¶é›†æ•°æ®
            const fd = new FormData();
            fd.append('id', id);
            fd.append('product_id', document.getElementById(`edit-pid-${id}`).value);
            fd.append('title', document.getElementById(`edit-title-${id}`).value);
            fd.append('category', document.getElementById(`edit-cat-${id}`).value);
            fd.append('finish_time', document.getElementById(`edit-finish-${id}`).value.replace('T', ' '));
            fd.append('host', document.getElementById(`edit-host-${id}`).value);
            fd.append('status', document.getElementById(`edit-status-${id}`).value);
            fd.append('platform', document.getElementById(`edit-plat-${id}`).value);
            fd.append('publish_time', document.getElementById(`edit-pub-${id}`).value.replace('T', ' '));
            fd.append('remark', document.getElementById(`edit-remark-${id}`).value);

            try {
                const res = await fetch('/api/video/save', {method: 'POST', body: fd});
                if(res.ok) {
                    editingRowId = null; // é€€å‡ºç¼–è¾‘æ¨¡å¼
                    loadData(); // åˆ·æ–°æ•°æ®
                    updateStats();
                } else { alert("ä¿å­˜å¤±è´¥"); }
            } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        // --- å…¶ä»–é€»è¾‘ ---
        function changePage(d) {
            if(currPage + d > 0 && currPage + d <= totalPages) loadData(currPage + d);
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const s = await res.json();
                document.getElementById('st-total').innerText = s.total;
                document.getElementById('st-pending').innerText = s.pending;
                document.getElementById('st-host').innerText = s.host;
            } catch(e){}
        }

        // å¼¹çª—é€»è¾‘ (ä»…ç”¨äºæ–°å¢)
        function openModal() { document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').classList.add('flex'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex'); }
        
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            await fetch('/api/video/save', {method:'POST', body:fd});
            closeModal();
            loadData();
        };

        async function delVideo(id) {
            if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
            await fetch(`/api/video/${id}`, {method:'DELETE'});
            loadData();
        }

        async function scanLocal() {
            if(!confirm("æ‰«æå¯¼å…¥ï¼Ÿ")) return;
            fetch('/api/import/local', {method:'POST'});
            alert("åå°å¯¼å…¥ä¸­...");
        }
    </script>
</body>
</html>