<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 1. å­—ä½“ä¸åŸºç¡€å¸ƒå±€ */
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* 2. è¡¨æ ¼æ ·å¼ (å…¨å±æµå¼) */
        table { border-collapse: collapse; table-layout: fixed; width: 100%; }
        th { font-size: 13px; font-weight: 700; color: #475569; padding: 12px 10px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; position: relative; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr:hover td { background: #f8fafc; }
        
        /* æ‹–æ‹½æ‰‹æŸ„ */
        .resizer { position: absolute; top: 0; right: 0; width: 4px; cursor: col-resize; height: 100%; z-index: 10; opacity: 0; transition: opacity 0.2s; }
        th:hover .resizer { opacity: 1; background: #94a3b8; }
        .resizing { background: #3b82f6 !important; opacity: 1; }

        /* è¾“å…¥æ¡† & ä¸‹æ‹‰æ¡† */
        .table-input { width: 100%; border: 1px solid transparent; background: transparent; padding: 4px; border-radius: 4px; font-size: 13px; color: inherit; }
        .editing .table-input { background: white; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        /* å›¾ç‰‡åŒº */
        .img-zone { position: relative; overflow: hidden; cursor: pointer; border-radius: 6px; border: 1px solid #e2e8f0; background: #f1f5f9; transition: transform 0.1s; }
        .img-zone:hover { transform: scale(1.05); border-color: #cbd5e1; }
        .img-zone:hover::after { content: 'æ›¿æ¢'; position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; }

        /* å½©è‰²èƒ¶å›Š */
        .pill { padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 600; border: 1px solid transparent; display: inline-block; }
        
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal { transition: opacity 0.2s; opacity: 0; pointer-events: none; z-index: 50; }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        /* å›¾ç‰‡å¤§å›¾é¢„è§ˆ */
        #preview-modal img { max-height: 90vh; max-width: 90vw; object-fit: contain; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow">V</div>
            <h1 class="text-lg font-bold text-slate-800">VideoHub <span class="text-xs font-normal text-slate-400">V3.0</span></h1>
        </div>
        <div class="flex gap-4">
            <button onclick="openSettings()" class="text-xs font-bold text-slate-500 hover:text-blue-600 flex items-center gap-1 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                âš™ï¸ å…¨å±€é…ç½®
            </button>
            <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-500">ZY</div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-4 z-20 shrink-0">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
            <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-slate-400 uppercase">æ€»è§†é¢‘èµ„äº§</div><div class="text-3xl font-black text-slate-800" id="st-total">-</div></div>
                <div class="text-3xl">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-orange-400 uppercase">å¾…å‘å¸ƒåº“å­˜</div><div class="text-3xl font-black text-orange-500" id="st-pending">-</div></div>
                <div class="text-3xl">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-emerald-400 uppercase">æœ¬æœˆåŠ³æ¨¡</div><div class="text-3xl font-black text-emerald-600" id="st-host">-</div></div>
                <div class="text-3xl">ğŸ†</div>
            </div>
        </div>
    </div>

    <div class="flex-1 p-4 overflow-hidden flex flex-col w-full">
        <div class="flex flex-wrap items-center gap-2 mb-3 bg-white p-2 rounded-lg border border-slate-200 shadow-sm shrink-0">
            <input id="q-key" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="ğŸ” æœç´¢..." class="px-3 py-1.5 w-48 bg-slate-50 border border-slate-200 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <select id="q-host" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none min-w-[100px]"></select>
            <select id="q-status" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none min-w-[100px]"></select>
            <select id="q-cat" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none min-w-[100px]"></select>
            
            <div class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded border border-slate-200">
                <span class="text-xs text-slate-400 font-bold">å‘å¸ƒæ—¶é—´:</span>
                <input type="date" id="q-start" onchange="loadData(1)" class="bg-transparent text-xs outline-none w-28">
                <span class="text-slate-300">-</span>
                <input type="date" id="q-end" onchange="loadData(1)" class="bg-transparent text-xs outline-none w-28">
            </div>

            <button onclick="resetFilters()" class="px-3 py-1.5 text-slate-500 hover:bg-slate-100 rounded text-sm font-bold ml-auto">é‡ç½®</button>
            <button onclick="loadData(1)" class="px-4 py-1.5 bg-blue-600 text-white font-bold text-sm rounded hover:bg-blue-700 shadow-sm">æŸ¥è¯¢</button>
            <button onclick="scanLocal()" class="px-3 py-1.5 bg-slate-700 text-white font-bold text-sm rounded hover:bg-slate-800 shadow-sm">å¯¼å…¥</button>
            <button onclick="openAddModal()" class="px-3 py-1.5 bg-emerald-600 text-white font-bold text-sm rounded hover:bg-emerald-700 shadow-sm">æ–°å¢</button>
        </div>

        <div class="bg-white border border-slate-200 rounded-lg shadow-sm flex flex-col flex-1 overflow-hidden relative w-full">
            <div class="overflow-auto flex-1 w-full h-full" id="table-container">
                <table id="main-table">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th data-key="img" style="width: 60px">å›¾</th>
                            <th data-key="pid" contenteditable="true" onblur="saveHeader(this)" style="width: 100px">ç¼–å·<div class="resizer"></div></th>
                            <th data-key="title" contenteditable="true" onblur="saveHeader(this)" style="width: auto; min-width: 200px">è§†é¢‘æ ‡é¢˜<div class="resizer"></div></th>
                            <th data-key="cat" contenteditable="true" onblur="saveHeader(this)" style="width: 80px">äº§å“ç±»å‹<div class="resizer"></div></th>
                            <th data-key="fin" contenteditable="true" onblur="saveHeader(this)" style="width: 100px">å®Œæˆæ—¶é—´<div class="resizer"></div></th>
                            <th data-key="type" contenteditable="true" onblur="saveHeader(this)" style="width: 90px">è§†é¢‘ç±»å‹<div class="resizer"></div></th>
                            <th data-key="host" contenteditable="true" onblur="saveHeader(this)" style="width: 90px">ä¸»æ’­<div class="resizer"></div></th>
                            <th data-key="status" contenteditable="true" onblur="saveHeader(this)" style="width: 90px">å½“å‰çŠ¶æ€<div class="resizer"></div></th>
                            <th data-key="plat" contenteditable="true" onblur="saveHeader(this)" style="width: 100px">å‘å¸ƒå¹³å°<div class="resizer"></div></th>
                            <th data-key="pub" contenteditable="true" onblur="saveHeader(this)" style="width: 120px">å‘å¸ƒæ—¶é—´<div class="resizer"></div></th>
                            <th data-key="rem" contenteditable="true" onblur="saveHeader(this)" style="width: 150px">å¤‡æ³¨<div class="resizer"></div></th>
                            <th data-key="op" style="width: 90px; text-align: center;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="border-t border-slate-200 px-4 py-2 flex justify-between items-center bg-slate-50 shrink-0 text-sm">
                <span class="text-slate-500">å…± <b id="total-count">0</b> æ¡ï¼Œç¬¬ <b id="curr-page">1</b> / <span id="total-pages">1</span> é¡µ</span>
                <div class="space-x-1">
                    <button id="btn-prev" onclick="changePage(-1)" class="px-2 py-1 border rounded bg-white hover:bg-slate-100 disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button id="btn-next" onclick="changePage(1)" class="px-2 py-1 border rounded bg-white hover:bg-slate-100 disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center cursor-zoom-out" onclick="this.classList.add('hidden')">
        <img id="preview-img" src="" alt="Preview">
    </div>

    <div id="settings-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[400px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">å…¨å±€é…ç½® (é€—å·åˆ†éš”)</h3>
            <div class="space-y-3">
                <textarea id="set-hosts" class="w-full p-2 border rounded text-sm h-16" placeholder="ä¸»æ’­..."></textarea>
                <input id="set-cats" class="w-full p-2 border rounded text-sm" placeholder="äº§å“ç±»å‹...">
                <input id="set-plats" class="w-full p-2 border rounded text-sm" placeholder="å¹³å°...">
                <input id="set-stats" class="w-full p-2 border rounded text-sm" placeholder="çŠ¶æ€...">
            </div>
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold mt-4">ä¿å­˜é…ç½®</button>
            <button onclick="closeSettings()" class="w-full mt-2 text-slate-400 text-sm">å…³é—­</button>
        </div>
    </div>
    
    <div id="add-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[600px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">æ‰‹åŠ¨æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-2 gap-3">
                <input name="product_id" placeholder="ç¼–å· *" required class="p-2 border rounded text-sm">
                <input name="title" placeholder="è§†é¢‘æ ‡é¢˜ *" required class="p-2 border rounded text-sm">
                <select name="host" id="add-host" class="p-2 border rounded text-sm"></select>
                <select name="category" id="add-cat" class="p-2 border rounded text-sm"></select>
                <select name="status" id="add-status" class="p-2 border rounded text-sm"></select>
                <select name="platform" id="add-plat" class="p-2 border rounded text-sm"></select>
                <input name="video_type" placeholder="è§†é¢‘ç±»å‹" class="p-2 border rounded text-sm">
                <input name="finish_time" placeholder="å®Œæˆæ—¶é—´" onfocus="(this.type='date')" class="p-2 border rounded text-sm">
                <input name="publish_time" placeholder="å‘å¸ƒæ—¶é—´" onfocus="(this.type='datetime-local')" class="p-2 border rounded text-sm">
                <input name="remark" placeholder="å¤‡æ³¨" class="p-2 border rounded text-sm">
                <div class="col-span-2 pt-2 border-t flex justify-end gap-2">
                    <button type="button" onclick="closeAddModal()" class="text-slate-500 text-sm font-bold px-4">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded font-bold text-sm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currPage = 1, totalPages = 1, globalData = [], globalOptions = {}, editingId = null;

        // åˆå§‹åŒ–
        (async () => {
            initResizers();
            loadHeaderLabels(); // å¼ºåˆ¶æ¢å¤è¡¨å¤´åå­—
            await loadOptions();
            await loadData(1);
            updateStats();
        })();

        // --- æ ¸å¿ƒé€»è¾‘ ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            
            // å¡«å……ç­›é€‰ä¸‹æ‹‰
            fillSel('q-host', globalOptions.hosts, 'å…¨éƒ¨ä¸»æ’­');
            fillSel('q-status', globalOptions.statuses, 'å…¨éƒ¨çŠ¶æ€');
            fillSel('q-cat', globalOptions.categories, 'å…¨éƒ¨åˆ†ç±»');
            
            // å¡«å……æ–°å¢ä¸‹æ‹‰
            fillSel('add-host', globalOptions.hosts, 'é€‰æ‹©ä¸»æ’­');
            fillSel('add-cat', globalOptions.categories, 'é€‰æ‹©ç±»å‹');
            fillSel('add-status', globalOptions.statuses, 'é€‰æ‹©çŠ¶æ€');
            fillSel('add-plat', globalOptions.platforms, 'é€‰æ‹©å¹³å°');
        }

        function fillSel(id, items, def) {
            const el = document.getElementById(id);
            if(el) el.innerHTML = `<option value="">${def}</option>` + (items||[]).map(i=>`<option value="${i}">${i}</option>`).join('');
        }

        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                keyword: document.getElementById('q-key').value,
                host: document.getElementById('q-host').value,
                status: document.getElementById('q-status').value,
                category: document.getElementById('q-cat').value,
                pub_start: document.getElementById('q-start').value,
                pub_end: document.getElementById('q-end').value
            });
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('total-count').innerText = data.total;
            document.getElementById('curr-page').innerText = data.page;
            document.getElementById('total-pages').innerText = data.total_pages;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);

            renderTable(data.items);
        }

        // --- é¢œè‰²ç®—æ³• ---
        const getColor = (str) => {
            if(!str || str==='nan') return {bg:'#f1f5f9', text:'#64748b'};
            const colors = [
                {bg:'#fee2e2',t:'#991b1b'}, {bg:'#fef3c7',t:'#92400e'}, {bg:'#dcfce7',t:'#166534'},
                {bg:'#dbeafe',t:'#1e40af'}, {bg:'#f3e8ff',t:'#6b21a8'}, {bg:'#ffedd5',t:'#9a3412'}
            ];
            let hash = 0;
            for (let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                const isEdit = (v.id === editingId);
                const cln = (s) => (s && s!=='nan' && s!=='NaT' && s!=='None') ? s : '';
                const hCol = getColor(cln(v.host));
                const pCol = getColor(cln(v.platform));

                if(isEdit) {
                    // ç¼–è¾‘è¡Œ
                    const sel = (k, val, opts) => `<select id="ed-${k}" class="table-input bg-white border border-blue-300">${opts.map(o => `<option ${o===val?'selected':''}>${o}</option>`).join('')}</select>`;
                    return `
                    <tr class="bg-blue-50 editing">
                        <td class="text-center text-xs text-slate-400">å›¾</td>
                        <td><input id="ed-pid" class="table-input" value="${cln(v.product_id)}"></td>
                        <td><input id="ed-title" class="table-input font-bold" value="${cln(v.title)}"></td>
                        <td>${sel('cat', v.category, globalOptions.categories)}</td>
                        <td><input id="ed-fin" class="table-input" value="${cln(v.finish_time)}" type="date"></td>
                        <td><input id="ed-type" class="table-input" value="${cln(v.video_type)}"></td>
                        <td>${sel('host', v.host, globalOptions.hosts)}</td>
                        <td>${sel('status', v.status, globalOptions.statuses)}</td>
                        <td>${sel('plat', v.platform, globalOptions.platforms)}</td>
                        <td><input id="ed-pub" class="table-input" value="${cln(v.publish_time).replace(' ','T')}" type="datetime-local"></td>
                        <td><input id="ed-rem" class="table-input" value="${cln(v.remark)}"></td>
                        <td class="text-center">
                            <button onclick="saveRow(${v.id})" class="text-blue-600 font-bold text-xs mr-2">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                // æ­£å¸¸è¡Œ (å½©è‰²èƒ¶å›Š)
                return `
                <tr class="hover:bg-slate-50 group border-b border-slate-100 last:border-0">
                    <td class="p-1 text-center">
                        <div class="w-10 h-10 rounded bg-slate-100 border border-slate-200 overflow-hidden relative img-zone mx-auto"
                             onclick="showPreview('${img}')"
                             onpaste="handlePaste(event, ${v.id})" 
                             ondrop="handleDrop(event, ${v.id})" 
                             ondragover="event.preventDefault()"
                             title="ç‚¹å‡»é¢„è§ˆ / æ‹–æ‹½æ›¿æ¢">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td class="font-mono text-xs text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 text-sm truncate" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td class="text-xs text-slate-500">${cln(v.category)}</td>
                    <td class="text-xs text-slate-400 whitespace-nowrap">${cln(v.finish_time)}</td>
                    <td class="text-xs text-slate-500">${cln(v.video_type)}</td>
                    <td><span class="pill" style="background:${hCol.bg};color:${hCol.t}">${cln(v.host)}</span></td>
                    <td class="text-center"><span class="pill" style="background:${v.status==='å·²å‘å¸ƒ'?'#dcfce7':'#fff7ed'};color:${v.status==='å·²å‘å¸ƒ'?'#166534':'#c2410c'}">${cln(v.status)}</span></td>
                    <td><span class="pill" style="background:${pCol.bg};color:${pCol.t}">${cln(v.platform)}</span></td>
                    <td class="text-xs text-slate-400 font-mono">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-xs text-slate-400 truncate" title="${cln(v.remark)}">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 shadow-l border-l border-slate-100">
                        <button onclick="editRow(${v.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- å›¾ç‰‡é€»è¾‘ ---
        function showPreview(url) {
            document.getElementById('preview-img').src = url;
            document.getElementById('preview-modal').classList.remove('hidden');
        }
        
        async function uploadImg(file, id) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const data = await res.json();
            
            // å…¨é‡ä¿å­˜ï¼Œé˜²æ­¢ä¸¢å¤±æ•°æ®
            const oldRow = globalData.find(v => v.id === id);
            const saveFd = new FormData();
            saveFd.append('id', id);
            saveFd.append('image_url', data.url);
            saveFd.append('product_id', oldRow.product_id); // å¿…å¡«æ ¡éªŒ
            
            await fetch('/api/video/save', {method:'POST', body:saveFd});
            loadData();
        }
        function handleDrop(e, id) { e.preventDefault(); e.stopPropagation(); if(e.dataTransfer.files[0]) uploadImg(e.dataTransfer.files[0], id); }
        function handlePaste(e, id) { e.stopPropagation(); if(e.clipboardData.files[0]) uploadImg(e.clipboardData.files[0], id); }

        // --- å¸¸è§„é€»è¾‘ ---
        function editRow(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        
        async function saveRow(id) {
            const fd = new FormData();
            fd.append('id', id);
            // æ”¶é›†æ‰€æœ‰ç¼–è¾‘æ¡†æ•°æ®
            const fields = {
                'ed-pid': 'product_id', 'ed-title': 'title', 'ed-cat': 'category',
                'ed-fin': 'finish_time', 'ed-type': 'video_type', 'ed-host': 'host',
                'ed-status': 'status', 'ed-plat': 'platform', 'ed-pub': 'publish_time', 'ed-rem': 'remark'
            };
            for(let [eid, key] of Object.entries(fields)) {
                const el = document.getElementById(eid);
                if(el) fd.append(key, el.value.replace('T', ' '));
            }
            await fetch('/api/video/save', {method:'POST', body:fd});
            cancelEdit(); loadData(); updateStats();
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function saveHeader(el) {
            const key = el.parentElement.getAttribute('data-key');
            const saved = JSON.parse(localStorage.getItem('headerNames') || '{}');
            saved[key] = el.innerText.trim();
            localStorage.setItem('headerNames', JSON.stringify(saved));
        }
        function loadHeaderLabels() {
            const saved = JSON.parse(localStorage.getItem('headerNames') || '{}');
            document.querySelectorAll('th[data-key]').forEach(th => {
                const key = th.getAttribute('data-key');
                if(saved[key]) th.childNodes[0].textContent = saved[key];
            });
        }
        function initResizers() {
            const ths = document.querySelectorAll('th');
            const saved = JSON.parse(localStorage.getItem('colWidths') || '{}');
            ths.forEach(th => {
                const key = th.getAttribute('data-key');
                if(key && saved[key]) th.style.width = saved[key];
                // æ‹–æ‹½é€»è¾‘ç•¥(ä¿æŒä¸Šä¸€ç‰ˆç¨³å®šä»£ç )
                const resizer = th.querySelector('.resizer');
                if(!resizer) return;
                let x=0, w=0;
                resizer.addEventListener('mousedown', e => {
                    x = e.pageX; w = th.offsetWidth;
                    document.onmousemove = (e) => th.style.width = w + (e.pageX - x) + 'px';
                    document.onmouseup = () => {
                        document.onmousemove = null;
                        const s = JSON.parse(localStorage.getItem('colWidths') || '{}');
                        s[key] = th.style.width;
                        localStorage.setItem('colWidths', JSON.stringify(s));
                    };
                });
            });
        }

        // --- è®¾ç½®/æ–°å¢ ---
        async function loadSettingsData() {
            const r = await fetch('/api/settings'); const d = await r.json();
            document.getElementById('set-hosts').value = d.hosts.join(',');
            document.getElementById('set-cats').value = d.categories.join(',');
            document.getElementById('set-plats').value = d.platforms.join(',');
            document.getElementById('set-stats').value = d.statuses.join(',');
        }
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); loadSettingsData(); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
        async function saveSettings() {
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'hosts', value:document.getElementById('set-hosts').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'categories', value:document.getElementById('set-cats').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'platforms', value:document.getElementById('set-plats').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'statuses', value:document.getElementById('set-stats').value})});
            closeSettings(); loadOptions();
        }
        
        function openAddModal() { document.getElementById('add-modal').classList.add('active'); }
        function closeAddModal() { document.getElementById('add-modal').classList.remove('active'); }
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/api/video/save', {method:'POST', body:new FormData(e.target)});
            closeAddModal(); loadData(1); updateStats();
        };

        function resetFilters() { document.querySelectorAll('input, select').forEach(e => e.value=''); loadData(1); }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        async function delVideo(id) { if(confirm('åˆ ?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); }}
        async function scanLocal() { if(confirm('æ‰«æå¯¼å…¥?')) { fetch('/api/import/local', {method:'POST'}); alert('å¯¼å…¥ä¸­'); }}
        async function updateStats() { try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;document.getElementById('st-host').innerText=d.host;}catch{} }
    </script>
</body>
</html>