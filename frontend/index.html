<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* 1. å“åº”å¼ä¸è¡¨æ ¼ */
        .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; } /* ä¿è¯æ‰‹æœºä¸Šä¸æŒ¤ï¼Œå¯æ»‘åŠ¨ */
        th { font-size: 12px; font-weight: 700; color: #475569; padding: 10px 8px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; text-align: left; cursor: pointer; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* 2. è¡Œå†…ç¼–è¾‘ç»„ä»¶ */
        .table-input { width: 100%; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; background: white; outline: none; transition: all 0.2s; height: 30px; }
        .table-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .editing { background: #eff6ff !important; }

        /* 3. å¤šé€‰å¼¹å‡ºèœå• (Checkbox Menu) */
        .multi-menu { position: absolute; z-index: 50; background: white; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 6px; padding: 4px; width: 180px; max-height: 200px; overflow-y: auto; display: none; }
        .multi-menu.show { display: block; }
        .multi-option { display: flex; items-center; gap: 6px; padding: 6px; cursor: pointer; font-size: 12px; border-radius: 4px; }
        .multi-option:hover { background: #f1f5f9; }
        .multi-option input { pointer-events: none; } /* è®©ç‚¹å‡»æ•´ä¸ªè¡Œéƒ½è§¦å‘ */

        /* 4. ç­›é€‰é¢æ¿åŠ¨ç”» */
        #filter-panel { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; background: white; border-bottom: 1px solid #e2e8f0; }
        #filter-panel.open { max-height: 500px; }

        /* 5. è§†è§‰å…ƒç´  */
        .pill { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; display: inline-block; margin-right: 2px; border: 1px solid transparent; white-space: nowrap; }
        .img-zone { width: 40px; height: 40px; border-radius: 4px; border: 1px solid #e2e8f0; background: #fff; overflow: hidden; cursor: pointer; position: relative; }
        .img-zone:hover::after { content: '+'; position: absolute; inset: 0; background: rgba(0,0,0,0.4); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; }

        /* 6. æ¨¡æ€æ¡† (æ–°å¢/å¯¼å…¥) */
        .modal { opacity: 0; pointer-events: none; transition: opacity 0.2s; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 60; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 12px; shadow: 2xl; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-50">

    <div class="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-4 md:px-6 shrink-0 z-40">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow">V</div>
            <h1 class="text-lg font-bold text-slate-800 hidden md:block">VideoHub <span class="text-slate-400 font-normal text-xs">V8.0</span></h1>
        </div>
        
        <div class="flex gap-2 items-center">
            <div class="relative">
                <svg class="absolute left-2.5 top-2.5 w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input id="global-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="æœç´¢..." class="pl-8 pr-3 py-1.5 w-32 md:w-64 bg-slate-100 border-transparent rounded-lg text-sm focus:bg-white focus:border-blue-500 focus:ring-2 outline-none transition-all">
            </div>
            <button onclick="toggleFilters()" class="text-slate-500 hover:text-blue-600 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg></button>
            <button onclick="openAddModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-blue-700 whitespace-nowrap">+ æ–°å¢</button>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-4 py-4 shrink-0 z-30">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-6">
            <div class="bg-slate-50 border border-slate-100 p-3 rounded-xl flex items-center justify-between">
                <div><div class="text-[10px] font-bold text-slate-400 uppercase">æ€»èµ„äº§</div><div class="text-2xl font-black text-slate-800" id="st-total">-</div></div>
                <div class="text-2xl opacity-50">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-3 rounded-xl flex items-center justify-between">
                <div><div class="text-[10px] font-bold text-orange-400 uppercase">å¾…å‘å¸ƒ</div><div class="text-2xl font-black text-orange-500" id="st-pending">-</div></div>
                <div class="text-2xl opacity-50">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-3 rounded-xl flex items-center justify-between hidden md:flex">
                <div><div class="text-[10px] font-bold text-emerald-400 uppercase">æœ¬æœˆåŠ³æ¨¡</div><div class="text-2xl font-black text-emerald-600" id="st-host">-</div></div>
                <div class="text-2xl opacity-50">ğŸ†</div>
            </div>
        </div>
    </div>

    <div id="filter-panel" class="shrink-0 px-4 md:px-6">
        <div class="py-4 grid grid-cols-2 md:grid-cols-6 gap-3">
            <div><label class="text-[10px] text-slate-400 font-bold block mb-1">äº§å“ç¼–å·</label><input id="s-pid" list="dl-pids" class="table-input" placeholder="è¾“å…¥..."></div>
            <div><label class="text-[10px] text-slate-400 font-bold block mb-1">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="table-input" placeholder="è¾“å…¥..."></div>
            <div><label class="text-[10px] text-slate-400 font-bold block mb-1">ä¸»æ’­</label><select id="s-host" class="table-input"></select></div>
            <div><label class="text-[10px] text-slate-400 font-bold block mb-1">çŠ¶æ€</label><select id="s-status" class="table-input"></select></div>
            <div><label class="text-[10px] text-slate-400 font-bold block mb-1">å¹³å°</label><select id="s-plat" class="table-input"></select></div>
            <div><label class="text-[10px] text-slate-400 font-bold block mb-1">ç±»å‹</label><select id="s-cat" class="table-input"></select></div>
            <div class="col-span-2"><label class="text-[10px] text-slate-400 font-bold block mb-1">å‘å¸ƒæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="table-input"><input type="date" id="s-pub-end" class="table-input"></div></div>
            <div class="col-span-2 flex items-end gap-2">
                <button onclick="loadData(1)" class="bg-slate-800 text-white text-xs font-bold py-2 px-4 rounded w-full">åº”ç”¨ç­›é€‰</button>
                <button onclick="resetFilters()" class="bg-white border border-slate-300 text-slate-600 text-xs font-bold py-2 px-4 rounded">é‡ç½®</button>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-hidden relative w-full">
        <div class="absolute inset-0 table-container">
            <table class="w-full text-left">
                <thead class="sticky top-0 z-20 shadow-sm">
                    <tr>
                        <th class="w-14 text-center">å›¾</th>
                        <th onclick="sortBy('product_id')" class="w-24">ç¼–å· â†•</th>
                        <th onclick="sortBy('title')" style="width: 240px">è§†é¢‘æ ‡é¢˜ â†•</th>
                        <th onclick="sortBy('category')" class="w-24">ç±»å‹ â†•</th>
                        <th onclick="sortBy('finish_time')" class="w-28">å®Œæˆæ—¶é—´ â†•</th>
                        <th onclick="sortBy('video_type')" class="w-24">è§†ç±» â†•</th>
                        <th onclick="sortBy('host')" class="w-32">ä¸»æ’­(å¤šé€‰) â†•</th>
                        <th onclick="sortBy('status')" class="w-24 text-center">çŠ¶æ€ â†•</th>
                        <th onclick="sortBy('platform')" class="w-32">å¹³å°(å¤šé€‰) â†•</th>
                        <th onclick="sortBy('publish_time')" class="w-32">å‘å¸ƒæ—¶é—´ â†•</th>
                        <th onclick="sortBy('remark')" class="w-32">å¤‡æ³¨ â†•</th>
                        <th class="w-24 text-center sticky right-0 bg-slate-100 border-l">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-200 bg-white"></tbody>
            </table>
        </div>
    </div>

    <div class="h-10 bg-white border-t border-slate-200 px-4 flex justify-between items-center shrink-0 text-xs text-slate-500 z-30">
        <span id="page-info">0 æ¡</span>
        <div class="flex gap-2">
            <button onclick="changePage(-1)" id="btn-prev" class="px-2 py-1 bg-slate-100 rounded disabled:opacity-50">â—€</button>
            <button onclick="changePage(1)" id="btn-next" class="px-2 py-1 bg-slate-100 rounded disabled:opacity-50">â–¶</button>
        </div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content p-6">
            <h3 class="font-bold mb-4 text-lg">æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="col-span-1 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center bg-slate-50 h-40 md:h-full cursor-pointer relative"
                     onclick="document.getElementById('add-file').click()"
                     ondragover="event.preventDefault()" ondrop="handleAddDrop(event)">
                    <img id="add-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg">
                    <div class="text-center text-slate-400 pointer-events-none">
                        <div class="text-2xl mb-1">ğŸ“·</div>
                        <div class="text-xs">ç‚¹å‡» / æ‹–æ‹½ / ç²˜è´´</div>
                    </div>
                    <input type="file" id="add-file" class="hidden" onchange="uploadAddFile(this.files[0])">
                    <input type="hidden" name="image_url" id="add-img-val">
                </div>

                <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-3">
                    <div class="col-span-2"><input name="title" placeholder="è§†é¢‘æ ‡é¢˜ *" required class="table-input border-slate-300 h-9"></div>
                    <div><input name="product_id" placeholder="äº§å“ç¼–å· *" required class="table-input border-slate-300 h-9"></div>
                    <div><input name="category" placeholder="ç±»å‹" list="dl-cat" class="table-input border-slate-300 h-9"></div>
                    <div><input name="host" placeholder="ä¸»æ’­ (é€—å·åˆ†éš”)" list="dl-host" class="table-input border-slate-300 h-9"></div>
                    <div><input name="platform" placeholder="å¹³å° (é€—å·åˆ†éš”)" list="dl-plat" class="table-input border-slate-300 h-9"></div>
                    <div><select name="status" id="add-status" class="table-input border-slate-300 h-9"></select></div>
                    <div><input name="finish_time" placeholder="å®Œæˆæ—¶é—´" type="date" class="table-input border-slate-300 h-9"></div>
                    <div><input name="publish_time" placeholder="å‘å¸ƒæ—¶é—´" type="datetime-local" class="table-input border-slate-300 h-9"></div>
                    <div><input name="remark" placeholder="å¤‡æ³¨" class="table-input border-slate-300 h-9"></div>
                </div>
                
                <div class="col-span-1 md:col-span-3 flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('add-modal')" class="text-slate-500 text-sm font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')">
        <img id="big-img" src="" class="max-h-[90vh] max-w-[95vw] object-contain">
    </div>

    <div id="multi-menu" class="multi-menu"></div>

    <datalist id="dl-pids"></datalist><datalist id="dl-host"></datalist><datalist id="dl-cat"></datalist><datalist id="dl-plat"></datalist>

    <script>
        let currPage = 1, totalPages = 1, currentSort = { col: 'id', order: 'desc' };
        let globalOptions = {}, editingId = null, globalData = [];

        // åˆå§‹åŒ–
        (async () => {
            await loadOptions();
            await loadData(1);
            updateStats();
            // å…¨å±€ç²˜è´´ç›‘å¬ (ç”¨äºæ–°å¢å¼¹çª—)
            document.addEventListener('paste', e => {
                if(document.getElementById('add-modal').classList.contains('active') && e.clipboardData.files.length) {
                    uploadAddFile(e.clipboardData.files[0]);
                }
            });
            // ç‚¹å‡»å¤–éƒ¨å…³é—­å¤šé€‰èœå•
            document.addEventListener('click', e => {
                if(!e.target.closest('.multi-menu') && !e.target.closest('.multi-trigger')) {
                    document.getElementById('multi-menu').classList.remove('show');
                }
            });
        })();

        // --- æ ¸å¿ƒé€»è¾‘ ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            
            const fill = (id, list) => document.getElementById(id).innerHTML = `<option value="">å…¨éƒ¨</option>` + list.map(i=>`<option value="${i}">${i}</option>`).join('');
            fill('s-host', globalOptions.hosts); fill('s-cat', globalOptions.categories);
            fill('s-status', globalOptions.statuses); fill('s-plat', globalOptions.platforms);
            
            // æ–°å¢å¼¹çª—çš„ä¸‹æ‹‰
            const fillReq = (id, list) => document.getElementById(id).innerHTML = list.map(i=>`<option value="${i}">${i}</option>`).join('');
            fillReq('add-status', globalOptions.statuses);
            
            // Datalists
            const fillDL = (id, list) => document.getElementById(id).innerHTML = list.map(i=>`<option value="${i}">`).join('');
            fillDL('dl-pids', globalOptions.product_ids); fillDL('dl-host', globalOptions.hosts);
            fillDL('dl-cat', globalOptions.categories); fillDL('dl-plat', globalOptions.platforms);
        }

        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                sort_by: currentSort.col, order: currentSort.order,
                keyword: document.getElementById('global-search').value,
                product_id: document.getElementById('s-pid').value,
                title: document.getElementById('s-title').value,
                host: document.getElementById('s-host').value,
                status: document.getElementById('s-status').value,
                category: document.getElementById('s-cat').value,
                platform: document.getElementById('s-plat').value,
                pub_start: document.getElementById('s-pub-start').value,
                pub_end: document.getElementById('s-pub-end').value
            });
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('page-info').innerText = `${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);
            
            renderTable(data.items);
        }

        // --- æ¸²æŸ“ ---
        const getColor = (str, type) => {
            if(!str || str==='nan') return {bg:'#f1f5f9', t:'#94a3b8'};
            if(type==='status') return str.includes('å·²') ? {bg:'#dcfce7',t:'#166534'} : {bg:'#fff7ed',t:'#c2410c'};
            const c=[{bg:'#fee2e2',t:'#991b1b'},{bg:'#dbeafe',t:'#1e40af'},{bg:'#fef3c7',t:'#92400e'},{bg:'#f3e8ff',t:'#6b21a8'}];
            let h=0; for(let i=0;i<str.length;i++) h=str.charCodeAt(i)+((h<<5)-h);
            return c[Math.abs(h)%c.length];
        };
        const pill = (s,t) => !s||s==='nan'?'-':s.split(/[,ï¼Œ]/).map(x=>`<span class="pill" style="background:${getColor(x.trim(),t).bg};color:${getColor(x.trim(),t).t}">${x.trim()}</span>`).join('');
        const cln = s => (s && s!=='nan' && s!=='NaT' && s!=='None') ? s : '';

        function renderTable(items) {
            document.getElementById('table-body').innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                
                if (v.id === editingId) {
                    // ç¼–è¾‘è¡Œ
                    const sel = (k, list) => `<select id="ed-${k}" class="table-input bg-blue-50">${list.map(o => `<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                    // å¤šé€‰è¾“å…¥æ¡†
                    const multi = (k, type) => `<input id="ed-${k}" class="table-input bg-blue-50 multi-trigger" value="${cln(v[k])}" readonly onclick="openMulti(this, '${type}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                    
                    return `
                    <tr class="editing border-b border-blue-200">
                        <td class="p-1 text-center"><div class="w-10 h-10 bg-slate-200 rounded mx-auto"></div></td>
                        <td><input id="ed-pid" class="table-input" value="${cln(v.product_id)}"></td>
                        <td><input id="ed-title" class="table-input font-bold" value="${cln(v.title)}"></td>
                        <td><input id="ed-cat" class="table-input" value="${cln(v.category)}" list="dl-cat"></td>
                        <td><input id="ed-fin" type="date" class="table-input" value="${cln(v.finish_time)}"></td>
                        <td><input id="ed-type" class="table-input" value="${cln(v.video_type)}"></td>
                        <td>${multi('host', 'hosts')}</td> <td>${sel('status', globalOptions.statuses)}</td>
                        <td>${multi('plat', 'platforms')}</td> <td><input id="ed-pub" type="datetime-local" class="table-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="table-input" value="${cln(v.remark)}"></td>
                        <td class="text-center sticky right-0 bg-blue-50 border-l">
                            <button onclick="saveRow(${v.id})" class="text-white bg-blue-600 px-2 py-1 rounded text-xs">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                return `
                <tr class="hover:bg-slate-50 group border-b border-slate-100 last:border-0">
                    <td class="p-1 text-center">
                        <div class="img-zone mx-auto" onclick="showBigImg('${img}')" onpaste="handleRowPaste(event,${v.id})" ondrop="handleRowDrop(event,${v.id})" ondragover="event.preventDefault()">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td class="font-mono text-slate-500 text-xs">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 text-sm truncate" style="max-width: 200px;" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td>${pill(cln(v.category))}</td>
                    <td class="text-slate-400 font-mono text-xs">${cln(v.finish_time)}</td>
                    <td>${pill(cln(v.video_type))}</td>
                    <td>${pill(cln(v.host))}</td>
                    <td class="text-center">${pill(cln(v.status), 'status')}</td>
                    <td>${pill(cln(v.platform))}</td>
                    <td class="text-slate-400 font-mono text-xs whitespace-nowrap">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-slate-400 truncate max-w-[100px] text-xs">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l">
                        <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- å¤šé€‰äº¤äº’é€»è¾‘ (ç‚¹å‡»å¼¹å‡ºèœå•) ---
        function openMulti(input, type) {
            const menu = document.getElementById('multi-menu');
            const rect = input.getBoundingClientRect();
            const opts = globalOptions[type] || [];
            const current = input.value.split(/[,ï¼Œ]/).map(s => s.trim());
            
            // ç”Ÿæˆå¤é€‰æ¡†åˆ—è¡¨
            menu.innerHTML = opts.map(o => {
                const isChk = current.includes(o);
                return `<div class="multi-option" onclick="toggleOption('${input.id}', '${o}')">
                    <span class="${isChk?'text-blue-600':'text-slate-300'} text-lg">${isChk?'â˜‘':'â˜'}</span> ${o}
                </div>`;
            }).join('');
            
            // å®šä½
            menu.style.top = (rect.bottom + window.scrollY) + 'px';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.classList.add('show');
        }

        function toggleOption(inputId, val) {
            const input = document.getElementById(inputId);
            let vals = input.value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            
            if(vals.includes(val)) vals = vals.filter(v => v !== val);
            else vals.push(val);
            
            input.value = vals.join(', ');
            openMulti(input, inputId.includes('host') ? 'hosts' : 'platforms'); // é‡æ–°æ¸²æŸ“ä¿æŒçŠ¶æ€
        }

        // --- æ–°å¢å›¾ç‰‡é€»è¾‘ ---
        async function uploadAddFile(file) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            document.getElementById('add-preview').src = d.url;
            document.getElementById('add-preview').classList.remove('hidden');
            document.getElementById('add-img-val').value = d.url;
        }
        function handleAddDrop(e) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadAddFile(e.dataTransfer.files[0]); }

        // --- è¡¨æ ¼å›¾ç‰‡é€»è¾‘ ---
        async function uploadRowImg(file, id) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            const row = globalData.find(v => v.id === id);
            const sfd = new FormData(); sfd.append('id', id); sfd.append('image_url', d.url); sfd.append('product_id', row.product_id);
            await fetch('/api/video/save', {method:'POST', body:sfd});
            loadData();
        }
        function handleRowDrop(e, id) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadRowImg(e.dataTransfer.files[0], id); }
        function handleRowPaste(e, id) { e.stopPropagation(); if(e.clipboardData.files[0]) uploadRowImg(e.clipboardData.files[0], id); }

        // --- ç¼–è¾‘ä¿å­˜ ---
        function startEdit(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        async function saveRow(id) {
            const fd = new FormData(); fd.append('id', id);
            const map = {'pid':'product_id', 'title':'title', 'cat':'category', 'fin':'finish_time', 
                         'type':'video_type', 'host':'host', 'status':'status', 'plat':'platform', 'pub':'publish_time', 'rem':'remark'};
            for (let [k, dbKey] of Object.entries(map)) {
                fd.append(dbKey, document.getElementById(`ed-${k}`).value.replace('T', ' '));
            }
            await fetch('/api/video/save', {method:'POST', body:fd});
            editingId = null; loadData(); updateStats();
        }

        // --- æ‚é¡¹ ---
        function toggleFilters() { document.getElementById('filter-panel').classList.toggle('open'); }
        function showBigImg(src) { document.getElementById('big-img').src = src; document.getElementById('preview-modal').classList.add('active'); }
        function openAddModal() { document.getElementById('add-modal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function resetFilters() { document.querySelectorAll('#filter-panel input, #filter-panel select').forEach(e => e.value=''); loadData(1); }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        function sortBy(col) { currentSort.col = col; currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc'; loadData(1); }
        
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            if(fd.get('publish_time')) fd.set('publish_time', fd.get('publish_time').replace('T',' '));
            await fetch('/api/video/save', {method:'POST', body:fd});
            closeModal('add-modal'); loadData(1); updateStats();
        };
        async function delVideo(id) { if(confirm('åˆ ?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); }}
        async function updateStats() { try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;if(d.host!=='æš‚æ— ') document.getElementById('st-host').innerText=d.host;}catch{} }
    </script>
</body>
</html>