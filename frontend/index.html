<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V22.0 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           å…¨å±€åŸºç¡€æ ·å¼ (Base Styles)
           ========================================= */
        body { 
            font-family: 'Inter', 'Noto Sans SC', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢å‡ºç°åŒæ»šåŠ¨æ¡ */
        }
        
        /* å¸ƒå±€æ¡†æ¶ */
        .app-container { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
        }
        
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            background: #f1f5f9; 
            position: relative; 
        }

        /* =========================================
           ä¾§è¾¹æ æ ·å¼ (Sidebar)
           ========================================= */
        .sidebar { 
            width: 240px; 
            background-color: #0f172a; 
            color: #94a3b8; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            transition: width 0.3s ease; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 50;
        }
        
        .sidebar-header { 
            height: 64px; 
            display: flex; 
            align-items: center; 
            padding: 0 24px; 
            color: white; 
            font-weight: 700; 
            font-size: 18px; 
            border-bottom: 1px solid #1e293b; 
        }
        
        .logo-icon {
            width: 32px; 
            height: 32px; 
            background-color: #2563eb; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold;
            margin-right: 12px;
        }

        .nav-item { 
            padding: 16px 24px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 14px; 
            font-weight: 500; 
            transition: all 0.2s; 
            border-left: 3px solid transparent; 
        }
        
        .nav-item:hover { 
            background-color: #1e293b; 
            color: white; 
        }
        
        .nav-item.active { 
            background-color: #1e293b; 
            color: white; 
            border-left-color: #3b82f6; 
        }
        
        .nav-text { 
            white-space: nowrap; 
            opacity: 1;
            transition: opacity 0.2s;
        }

        /* ç§»åŠ¨ç«¯é€‚é…ï¼šä¾§è¾¹æ è‡ªåŠ¨æ”¶èµ· */
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar-header { padding: 0 10px; justify-content: center; }
            .sidebar-header h1 { display: none; }
            .nav-item { padding: 14px 0; justify-content: center; }
            .nav-text { display: none; }
            .logo-icon { margin-right: 0; }
            
            /* ç§»åŠ¨ç«¯Gridè°ƒæ•´ */
            .kpi-grid { grid-template-columns: 1fr !important; }
            .chart-grid { grid-template-columns: 1fr !important; }
            .trend-box { height: 300px; }
            .filter-panel .grid { grid-template-columns: 1fr 1fr; }
        }

        /* =========================================
           ä»ªè¡¨ç›˜è§†å›¾æ ·å¼ (Dashboard View)
           ========================================= */
        .dash-container { 
            padding: 24px; 
            overflow-y: auto; 
            height: 100%; 
            scrollbar-width: thin; /* Firefox */
        }
        
        /* KPI å¡ç‰‡åŒºåŸŸ */
        .kpi-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        
        .stat-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            min-height: 120px;
        }
        
        .stat-label { 
            font-size: 12px; 
            font-weight: 700; 
            color: #64748b; 
            text-transform: uppercase; 
            margin-bottom: 8px; 
            letter-spacing: 0.5px;
        }
        
        .stat-num { 
            font-size: 28px; 
            font-weight: 800; 
            color: #0f172a; 
        }
        
        .stat-sub {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* ä¸­éƒ¨å›¾è¡¨åŒºåŸŸ */
        .chart-grid { 
            display: grid; 
            grid-template-columns: 2fr 1.5fr 1.5fr; 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        
        .chart-box { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; 
            height: 360px; 
            position: relative;
        }
        
        .chart-title { 
            font-size: 14px; 
            font-weight: 700; 
            color: #334155; 
            margin-bottom: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        /* åº•éƒ¨è¶‹åŠ¿å›¾ */
        .trend-box { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; 
            height: 420px; 
            margin-bottom: 24px; 
        }
        
        /* åº•éƒ¨è´¦å·çŸ©é˜µè¡¨ */
        .matrix-box { 
            background: white; 
            border-radius: 12px; 
            border: 1px solid #e2e8f0; 
            overflow: hidden; 
            margin-bottom: 40px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .matrix-header { 
            padding: 16px 24px; 
            border-bottom: 1px solid #e2e8f0; 
            font-weight: 700; 
            color: #334155; 
            background: #f8fafc; 
        }
        
        .matrix-table { 
            width: 100%; 
            text-align: left; 
            border-collapse: collapse; 
        }
        
        .matrix-table th { 
            padding: 14px 24px; 
            font-size: 12px; 
            color: #64748b; 
            font-weight: 700; 
            background: #f8fafc; 
            border-bottom: 1px solid #e2e8f0; 
            text-transform: uppercase;
        }
        
        .matrix-table td { 
            padding: 14px 24px; 
            font-size: 13px; 
            border-bottom: 1px solid #f1f5f9; 
            color: #334155;
        }
        
        .matrix-table tr:hover td { background-color: #f8fafc; }
        .val-today { color: #ef4444; font-weight: 800; } /* ä»Šæ—¥æ•°æ®é«˜äº® */

        /* =========================================
           åº“å­˜ç®¡ç†è§†å›¾æ ·å¼ (Inventory View)
           ========================================= */
        .inventory-view { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
        }
        
        .toolbar { 
            padding: 16px 24px; 
            background: white; 
            border-bottom: 1px solid #e2e8f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            shrink-0; 
            z-index: 20;
        }
        
        /* ç­›é€‰é¢æ¿ */
        .filter-panel { 
            background: white; 
            border-bottom: 1px solid #e2e8f0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out; 
            max-height: 0; 
            padding: 0 24px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 15;
        }
        
        .filter-panel.open { 
            max-height: 600px; 
            padding-top: 24px; 
            padding-bottom: 24px; 
        }
        
        .filter-label { 
            font-size: 12px; 
            font-weight: 700; 
            color: #64748b; 
            margin-bottom: 6px; 
            display: block; 
        }
        
        /* è¡¨æ ¼åŒºåŸŸ */
        .table-wrap { 
            flex: 1; 
            overflow: auto; 
            background: white; 
            margin: 16px 24px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            position: relative;
        }
        
        .main-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1800px; /* å¼ºåˆ¶å®½åº¦ï¼Œè§¦å‘æ¨ªå‘æ»šåŠ¨ */
        }
        
        .main-table th { 
            position: sticky; 
            top: 0; 
            background: #f8fafc; 
            color: #475569; 
            font-weight: 700; 
            font-size: 13px; 
            padding: 14px; 
            border-bottom: 2px solid #e2e8f0; 
            z-index: 10; 
            text-align: left; 
            white-space: nowrap;
        }
        
        .main-table td { 
            padding: 12px 14px; 
            border-bottom: 1px solid #f1f5f9; 
            font-size: 14px; 
            vertical-align: middle; 
            color: #334155; 
        }
        
        .main-table tr:hover td { background-color: #f8fafc; }

        /* =========================================
           UI ç»„ä»¶æ ·å¼ (Components)
           ========================================= */
        /* è¡¨æ ¼è¾“å…¥æ¡† */
        .t-input { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            font-size: 13px; 
            outline: none; 
            background: white; 
            height: 36px; 
            transition: all 0.2s;
        }
        
        .t-input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }
        
        .editing { 
            background-color: #eff6ff !important; 
        }
        
        /* æ ‡ç­¾ */
        .pill { 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
            display: inline-block; 
            margin-right: 4px; 
            border: 1px solid transparent; 
            white-space: nowrap;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ æ ¼ */
        .img-cell { 
            width: 48px; 
            height: 48px; 
            border-radius: 6px; 
            border: 1px solid #e2e8f0; 
            background: white; 
            overflow: hidden; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: border-color 0.2s;
        }
        
        .img-cell:hover { border-color: #3b82f6; }
        
        .img-cell:hover::after { 
            content: '+'; 
            position: absolute; 
            inset: 0; 
            background: rgba(0,0,0,0.4); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 20px;
        }

        /* å¼¹çª—é€šç”¨ */
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 60; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(2px);
        }
        
        .modal.active { display: flex; }
        
        /* å¤šé€‰ä¸‹æ‹‰æ¡† */
        .multi-pop { 
            position: absolute; 
            background: white; 
            border: 1px solid #cbd5e1; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); 
            border-radius: 8px; 
            width: 240px; 
            max-height: 280px; 
            overflow-y: auto; 
            z-index: 40; 
            display: none; 
        }
        
        .multi-pop.show { display: block; }
        
        .multi-opt { 
            padding: 10px 16px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 13px; 
            transition: background 0.1s;
        }
        
        .multi-opt:hover { 
            background-color: #f1f5f9; 
            color: #2563eb; 
        }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon">V</div>
            <h1 class="text-xl font-bold text-white tracking-tight">VideoHub</h1>
        </div>
        
        <nav class="flex-1 py-4 space-y-1">
            <div class="nav-item active" onclick="switchView('dashboard', this)">
                <span class="text-lg">ğŸ“Š</span> 
                <span class="nav-text">æ•°æ®é©¾é©¶èˆ±</span>
            </div>
            <div class="nav-item" onclick="switchView('inventory', this)">
                <span class="text-lg">ğŸ“¦</span> 
                <span class="nav-text">è§†é¢‘åº“å­˜è¡¨</span>
            </div>
            <div class="nav-item" onclick="switchView('product', this)">
                <span class="text-lg">ğŸ·ï¸</span> 
                <span class="nav-text">äº§å“åº“å­˜ (SPU)</span>
            </div>
        </nav>
        
        <div class="p-4 border-t border-slate-700 text-xs text-slate-500 text-center">
            V22.0 Ultimate
        </div>
    </aside>

    <main class="main-content">
        
        <div id="view-dashboard" class="dash-container">
            
            <div class="kpi-grid">
                <div class="stat-card border-l-4 border-blue-500">
                    <div class="stat-label">æ€»åº“å­˜ (è§†é¢‘)</div>
                    <div class="stat-num" id="d-total">-</div>
                    <div class="stat-sub">Total Assets</div>
                </div>
                <div class="stat-card border-l-4 border-purple-500">
                    <div class="stat-label text-purple-600">ç´¯è®¡åˆ†å‘ (äººæ¬¡)</div>
                    <div class="stat-num text-purple-700" id="d-dist">-</div>
                    <div class="stat-sub">Total Distributions</div>
                </div>
                <div class="stat-card border-l-4 border-orange-500">
                    <div class="stat-label text-orange-600">å¾…å‘å¸ƒåº“å­˜</div>
                    <div class="stat-num text-orange-700" id="d-pending">-</div>
                    <div class="stat-sub">Pending Publish</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div>
                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-3xl font-black text-slate-800" id="d-today-in">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-3xl font-black text-green-600" id="d-today-out">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div>
                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-3xl font-black text-slate-800" id="d-month-in">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-3xl font-black text-green-600" id="d-month-out">0</span>
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-box">
                    <div class="chart-title">ğŸ† ä¸»æ’­äº§å‡º Top 5</div>
                    <div id="chart-host" class="w-full h-full pb-6"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ“Š å†…å®¹ç±»å‹å æ¯”</div>
                    <div id="chart-type" class="w-full h-full pb-6"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ•¸ï¸ å¹³å°åˆ†å‘çŸ©é˜µ</div>
                    <div id="chart-plat" class="w-full h-full pb-6"></div>
                </div>
            </div>

            <div class="trend-box">
                <div class="chart-title">
                    <span>ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿ (å…¥åº“ vs å‘å¸ƒ)</span>
                    <div class="flex gap-2">
                        <button onclick="loadDashboard('day')" class="text-xs font-bold px-3 py-1 rounded bg-slate-100 hover:bg-blue-100 transition-colors">æ—¥</button>
                        <button onclick="loadDashboard('week')" class="text-xs font-bold px-3 py-1 rounded bg-slate-100 hover:bg-blue-100 transition-colors">å‘¨</button>
                        <button onclick="loadDashboard('month')" class="text-xs font-bold px-3 py-1 rounded bg-slate-100 hover:bg-blue-100 transition-colors">æœˆ</button>
                    </div>
                </div>
                <div id="chart-trend" class="w-full h-[340px]"></div>
            </div>

            <div class="matrix-box">
                <div class="matrix-header">ğŸ“± è´¦å·åˆ†å‘çŸ©é˜µ (Account Distribution)</div>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th style="width: 30%">å¹³å°è´¦å·åç§°</th>
                            <th style="width: 15%">ä»Šæ—¥å‘å¸ƒ ğŸ”¥</th>
                            <th style="width: 15%">æœ¬å‘¨å‘å¸ƒ</th>
                            <th style="width: 15%">æœ¬æœˆå‘å¸ƒ</th>
                            <th style="width: 25%">å¹´åº¦ç´¯è®¡ (Rank)</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-inventory" class="inventory-view hidden">
            <div class="toolbar">
                <h2 class="text-lg font-bold text-slate-800 hidden md:block">åº“å­˜æ˜ç»†</h2>
                <div class="flex gap-3 items-center flex-1 justify-end">
                    <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢: æ ‡é¢˜/ç¼–å·/å¤‡æ³¨" class="t-input w-48 md:w-72 bg-slate-50 border-transparent focus:bg-white transition-all">
                    
                    <button onclick="toggleFilter()" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        ç­›é€‰
                    </button>
                    
                    <button onclick="openSettings()" class="px-3 py-2 text-slate-500 hover:text-slate-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                    
                    <div class="h-6 w-px bg-slate-300 mx-1"></div>
                    
                    <button onclick="openImport()" class="px-4 py-2 text-sm font-bold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                        å¯¼å…¥ Excel
                    </button>
                    
                    <button onclick="addNewRow()" class="px-5 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700 transition-transform active:scale-95 flex items-center gap-1">
                        <span>+</span> æ–°å¢ä¸€è¡Œ
                    </button>
                </div>
            </div>

            <div id="filter-panel" class="filter-panel">
                <div class="grid grid-cols-2 md:grid-cols-6 gap-x-4 gap-y-4">
                    <div><label class="filter-label">äº§å“ç¼–å·</label><input id="s-pid" list="dl-pids" class="t-input" placeholder="è¾“å…¥ç¼–å·..."></div>
                    <div><label class="filter-label">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="t-input" placeholder="åŒ…å«æ ‡é¢˜..."></div>
                    
                    <div><label class="filter-label">äº§å“ç±»å‹</label><select id="s-cat" class="t-input"></select></div>
                    <div><label class="filter-label">è§†é¢‘ç±»å‹</label><select id="s-type" class="t-input"></select></div>
                    
                    <div><label class="filter-label">ä¸»æ’­ (åŒ…å«)</label><select id="s-host" class="t-input"></select></div>
                    <div><label class="filter-label">å½“å‰çŠ¶æ€</label><select id="s-status" class="t-input"></select></div>
                    
                    <div><label class="filter-label">å‘å¸ƒå¹³å°</label><select id="s-plat" class="t-input"></select></div>
                    
                    <div class="col-span-2">
                        <label class="filter-label">å®Œæˆæ—¶é—´èŒƒå›´</label>
                        <div class="flex gap-2"><input type="date" id="s-fin-start" class="t-input"><input type="date" id="s-fin-end" class="t-input"></div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="filter-label">å‘å¸ƒæ—¶é—´èŒƒå›´</label>
                        <div class="flex gap-2"><input type="date" id="s-pub-start" class="t-input"><input type="date" id="s-pub-end" class="t-input"></div>
                    </div>
                    
                    <div><label class="filter-label">å¤‡æ³¨ä¿¡æ¯</label><input id="s-remark" class="t-input" placeholder="åŒ…å«å¤‡æ³¨..."></div>

                    <div class="col-span-2 md:col-span-6 flex justify-end gap-2 border-t pt-4 mt-2">
                        <button onclick="loadData(1)" class="px-6 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-black transition-colors">æ‰§è¡ŒæŸ¥è¯¢</button>
                        <button onclick="resetFilters()" class="px-6 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-bold hover:bg-slate-50 transition-colors">é‡ç½®æ¡ä»¶</button>
                    </div>
                </div>
            </div>

            <div class="table-wrap">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">é¢„è§ˆ</th>
                            <th class="w-32">äº§å“/ç¼–å·</th>
                            <th style="min-width: 260px;">è§†é¢‘æ ‡é¢˜</th>
                            <th class="w-24">ç±»å‹</th>
                            <th class="w-28">å®Œæˆæ—¶é—´</th>
                            <th class="w-24">è§†ç±»</th>
                            <th class="w-32">ä¸»æ’­(å¤šé€‰)</th>
                            <th class="w-24 text-center">çŠ¶æ€</th>
                            <th class="w-32">å¹³å°(å¤šé€‰)</th>
                            <th class="w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-40">å¤‡æ³¨</th>
                            <th class="w-20 text-center sticky right-0 bg-slate-50 border-l shadow-sm">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>

            <div class="h-14 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-500 font-medium" id="page-info">æ­£åœ¨åŠ è½½...</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="px-4 py-1.5 bg-slate-100 rounded-md text-xs font-bold hover:bg-slate-200 disabled:opacity-50 transition-colors">â—€ ä¸Šä¸€é¡µ</button>
                    <button onclick="changePage(1)" class="px-4 py-1.5 bg-slate-100 rounded-md text-xs font-bold hover:bg-slate-200 disabled:opacity-50 transition-colors">ä¸‹ä¸€é¡µ â–¶</button>
                </div>
            </div>
        </div>

        <div id="view-product" class="dash-container hidden">
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <span>ğŸ·ï¸</span> äº§å“è§†é¢‘åº“å­˜ç›‘æ§
            </h2>
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="p-4 bg-slate-50 border-b border-slate-200 font-bold text-sm text-slate-600 w-1/4">äº§å“/ç¼–å·</th>
                            <th class="p-4 bg-slate-50 border-b border-slate-200 font-bold text-sm text-slate-600 w-1/4">åº“å­˜æ¦‚è§ˆ (æ€»æ•°)</th>
                            <th class="p-4 bg-slate-50 border-b border-slate-200 font-bold text-sm text-slate-600 w-1/4">å¾…å‘å¸ƒ</th>
                            <th class="p-4 bg-slate-50 border-b border-slate-200 font-bold text-sm text-slate-600 w-1/4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="product-body">
                        </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')">
    <img id="big-img" src="" class="max-h-[90vh] max-w-[95vw] object-contain rounded shadow-2xl">
</div>

<div id="multi-pop" class="multi-pop"></div>

<div id="import-modal" class="modal">
    <div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl">
        <div class="text-5xl mb-4">ğŸ“‚</div>
        <h3 class="font-bold text-xl mb-4 text-slate-800">æ‰¹é‡å¯¼å…¥æ•°æ®</h3>
        <p class="text-sm text-slate-500 mb-6">è¯·ç¡®è®¤ Excel æ–‡ä»¶å·²ä¸Šä¼ è‡³ NAS <code class="bg-slate-100 px-1 rounded">temp_uploads</code> ç›®å½•</p>
        <button onclick="startImport()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-black transition-transform active:scale-95">å¼€å§‹æ‰«æå¹¶å¯¼å…¥</button>
        <button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å…³é—­çª—å£</button>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="bg-white rounded-xl w-[450px] p-6 shadow-2xl">
        <h3 class="font-bold mb-6 text-lg text-slate-800 border-b pb-2">å…¨å±€é€‰é¡¹é…ç½®</h3>
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">ä¸»æ’­åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                <textarea id="set-hosts" class="t-input h-20 resize-none"></textarea>
            </div>
            <div><label class="text-xs font-bold text-slate-400 mb-1 block">äº§å“ç±»å‹</label><input id="set-cats" class="t-input"></div>
            <div><label class="text-xs font-bold text-slate-400 mb-1 block">è§†é¢‘ç±»å‹</label><input id="set-types" class="t-input"></div>
            <div><label class="text-xs font-bold text-slate-400 mb-1 block">å‘å¸ƒå¹³å°</label><input id="set-plats" class="t-input"></div>
        </div>
        <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-6 hover:bg-blue-700 shadow-lg transition-all">ä¿å­˜ç”Ÿæ•ˆ</button>
        <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-slate-400 text-xs hover:text-slate-600">å–æ¶ˆå…³é—­</button>
    </div>
</div>

<datalist id="dl-pids"></datalist>

<script>
    // ==========================================
    // å…¨å±€çŠ¶æ€ç®¡ç†
    // ==========================================
    let currPage = 1;
    let totalPages = 1;
    let globalOptions = {};
    let editingId = null;
    let globalData = [];
    let chartTrend = null; // å›¾è¡¨å®ä¾‹ç¼“å­˜

    // ==========================================
    // åˆå§‹åŒ–é€»è¾‘
    // ==========================================
    (function init() {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œäº’ä¸é˜»å¡
        loadDashboard('day'); 
        loadOptions(); 
        loadData(1);
        loadProductStats();
        
        // å…¨å±€ç‚¹å‡»ç›‘å¬ï¼šå…³é—­å¤šé€‰å¼¹çª—
        document.addEventListener('click', e => {
            if(!e.target.closest('.multi-pop') && !e.target.closest('.multi-trig')) 
                document.getElementById('multi-pop').classList.remove('show');
        });
    })();

    // ==========================================
    // è§†å›¾åˆ‡æ¢é€»è¾‘
    // ==========================================
    function switchView(view, btn) {
        // 1. å¯¼èˆªæ æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        
        // 2. éšè—æ‰€æœ‰è§†å›¾
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-inventory').classList.add('hidden');
        document.getElementById('view-product').classList.add('hidden');
        
        // 3. æ˜¾ç¤ºç›®æ ‡è§†å›¾å¹¶åˆ·æ–°æ•°æ®
        document.getElementById('view-' + view).classList.remove('hidden');
        
        if(view === 'dashboard') loadDashboard('day');
        if(view === 'product') loadProductStats();
    }

    // ==========================================
    // æ¨¡å— 1ï¼šä»ªè¡¨ç›˜é€»è¾‘ (ECharts + DOMæ“ä½œ)
    // ==========================================
    async function loadDashboard(dim) {
        try {
            const res = await fetch(`/api/dashboard?dim=${dim}`);
            const data = await res.json();
            
            // 1. å¡«å…… KPI æ•°å­—
            document.getElementById('d-total').innerText = data.kpi.total;
            document.getElementById('d-dist').innerText = data.kpi.dist_total;
            document.getElementById('d-pending').innerText = data.kpi.pending;
            document.getElementById('d-today-in').innerText = data.kpi.today_in;
            document.getElementById('d-today-out').innerText = data.kpi.today_out;
            document.getElementById('d-month-in').innerText = data.kpi.month_in;
            document.getElementById('d-month-out').innerText = data.kpi.month_out;
            
            // 2. æ¸²æŸ“çŸ©é˜µè¡¨æ ¼
            const tbody = document.getElementById('matrix-body');
            tbody.innerHTML = data.matrix.map((row, idx) => `
                <tr>
                    <td class="font-bold flex items-center gap-2">
                        <span class="w-5 h-5 rounded bg-slate-100 text-slate-500 text-xs flex items-center justify-center">${idx+1}</span>
                        ${row.name}
                    </td>
                    <td class="${row.day > 0 ? 'val-today' : ''}">${row.day}</td>
                    <td>${row.week}</td>
                    <td>${row.month}</td>
                    <td class="font-mono text-slate-700 font-bold">${row.year}</td>
                </tr>
            `).join('');

            // 3. æ¸²æŸ“ ECharts å›¾è¡¨
            // (1) è¶‹åŠ¿å›¾
            if(!chartTrend) chartTrend = echarts.init(document.getElementById('chart-trend'));
            chartTrend.setOption({
                tooltip: {trigger:'axis'},
                legend: {data:['å…¥åº“','å‘å¸ƒ'], bottom:0},
                grid: {top:20, left:40, right:20, bottom:30},
                xAxis: {type:'category', data:data.trend.dates},
                yAxis: {type:'value'},
                series: [
                    {name:'å…¥åº“', type:'line', data:data.trend.in, smooth:true, itemStyle:{color:'#3b82f6'}, areaStyle:{opacity:0.1}},
                    {name:'å‘å¸ƒ', type:'bar', data:data.trend.out, itemStyle:{color:'#10b981'}}
                ]
            });

            // (2) ä¸»æ’­æ’è¡Œ
            const ch = echarts.init(document.getElementById('chart-host'));
            ch.setOption({
                tooltip: {trigger:'axis'},
                grid: {top:10, left:60, right:20, bottom:20},
                xAxis: {type:'value'},
                yAxis: {type:'category', data:data.hosts.map(i=>i.name).reverse()},
                series: [{type:'bar', data:data.hosts.map(i=>i.value).reverse(), itemStyle:{color:'#f59e0b', borderRadius:[0,4,4,0]}}]
            });

            // (3) ç±»å‹å æ¯”
            const ct = echarts.init(document.getElementById('chart-type'));
            ct.setOption({
                tooltip: {trigger:'item'},
                series: [{type:'pie', radius:['40%','70%'], data:data.types, itemStyle:{borderRadius:5}}]
            });

            // (4) å¹³å°é›·è¾¾
            const cp = echarts.init(document.getElementById('chart-plat'));
            const maxV = Math.max(...data.plats.map(p=>p.value), 10);
            cp.setOption({
                tooltip: {},
                radar: {indicator: data.plats.map(p=>({name:p.name, max:maxV}))},
                series: [{type:'radar', data:[{value:data.plats.map(p=>p.value), name:'åˆ†å‘é‡', areaStyle:{color:'rgba(16,185,129,0.2)'}}]}]
            });

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–é‡ç»˜å›¾è¡¨
            window.onresize = () => { chartTrend.resize(); ch.resize(); ct.resize(); cp.resize(); };

        } catch(e) { console.error("Dashboard error:", e); }
    }

    // ==========================================
    // æ¨¡å— 2ï¼šäº§å“åº“å­˜é€»è¾‘ (SPU View)
    // ==========================================
    async function loadProductStats() {
        const res = await fetch('/api/product_stats');
        const data = await res.json();
        const tbody = document.getElementById('product-body');
        
        tbody.innerHTML = data.map(item => {
            const pct = Math.round(((item.total - item.pending) / item.total) * 100) || 0;
            return `
            <tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors">
                <td class="p-4 font-bold text-slate-800 text-lg">${item.name}</td>
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold text-slate-500 w-8">${item.total}</span>
                        <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500" style="width: ${pct}%"></div>
                        </div>
                        <span class="text-xs text-slate-400 font-mono">${pct}%</span>
                    </div>
                </td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${item.pending > 0 ? 'bg-orange-100 text-orange-600' : 'bg-emerald-100 text-emerald-600'}">
                        ${item.pending > 0 ? item.pending + ' å¾…å‘' : 'âœ… å®Œæˆ'}
                    </span>
                </td>
                <td class="p-4">
                    <button onclick="jumpToProduct('${item.name}')" class="text-blue-600 hover:text-blue-800 hover:underline font-bold text-sm transition-colors">
                        æŸ¥çœ‹åº“å­˜è¯¦æƒ… &rarr;
                    </button>
                </td>
            </tr>`;
        }).join('');
    }

    function jumpToProduct(pid) {
        // è·³è½¬å¹¶ç­›é€‰é€»è¾‘
        document.querySelectorAll('.nav-item')[1].click(); // Click 'Inventory' tab
        document.getElementById('s-pid').value = pid;
        // å¦‚æœç­›é€‰æ æ²¡å±•å¼€ï¼Œè‡ªåŠ¨å±•å¼€
        if(!document.getElementById('filter-panel').classList.contains('open')) toggleFilter();
        loadData(1);
    }

    // ==========================================
    // æ¨¡å— 3ï¼šåº“å­˜ç®¡ç†æ ¸å¿ƒé€»è¾‘ (Inventory View)
    // ==========================================
    
    // 3.1 åŠ è½½é€‰é¡¹å­—å…¸
    async function loadOptions() {
        const res = await fetch('/api/options');
        globalOptions = await res.json();
        
        // è¾…åŠ©å¡«å……å‡½æ•°
        const fill = (id, list, label) => {
            document.getElementById(id).innerHTML = `<option value="">å…¨éƒ¨${label}</option>` + 
                list.map(i => `<option value="${i}">${i}</option>`).join('');
        };
        
        fill('s-cat', globalOptions.categories, 'ç±»å‹');
        fill('s-type', globalOptions.video_types, 'è§†ç±»');
        fill('s-host', globalOptions.hosts, 'ä¸»æ’­');
        fill('s-status', globalOptions.statuses, 'çŠ¶æ€');
        fill('s-plat', globalOptions.platforms, 'å¹³å°');
        
        // å¡«å……ç¼–å·è”æƒ³åˆ—è¡¨
        document.getElementById('dl-pids').innerHTML = globalOptions.product_ids.map(i => `<option value="${i}">`).join('');
    }

    // 3.2 åŠ è½½æ•°æ®åˆ—è¡¨
    async function loadData(p) {
        currPage = p || currPage;
        
        // æ„å»ºå¤æ‚çš„æŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams({
            page: currPage, 
            size: 100, 
            keyword: document.getElementById('g-search').value,
            product_id: document.getElementById('s-pid').value,
            title: document.getElementById('s-title').value,
            remark: document.getElementById('s-remark').value,
            host: document.getElementById('s-host').value,
            status: document.getElementById('s-status').value,
            category: document.getElementById('s-cat').value,
            video_type: document.getElementById('s-type').value,
            platform: document.getElementById('s-plat').value,
            finish_start: document.getElementById('s-fin-start').value,
            finish_end: document.getElementById('s-fin-end').value,
            publish_start: document.getElementById('s-pub-start').value,
            publish_end: document.getElementById('s-pub-end').value
        });

        try {
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`;
            renderTable(data.items);
        } catch(e) {
            console.error("Load data error:", e);
        }
    }

    // 3.3 æ–°å¢è¡Œé€»è¾‘
    function addNewRow() {
        // åœ¨æ•°ç»„å¤´éƒ¨æ’å…¥ä¸€ä¸ªä¸´æ—¶å¯¹è±¡
        globalData.unshift({id: 'new', product_id: '', title: '', isNew: true});
        editingId = 'new';
        renderTable(globalData);
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        document.querySelector('.table-wrap').scrollTop = 0;
    }

    // 3.4 æ¸²æŸ“è¡¨æ ¼ (åŒ…å«æå…¶å¤æ‚çš„è¡Œå†…ç¼–è¾‘é€»è¾‘)
    function renderTable(items) {
        const tbody = document.getElementById('table-body');
        
        tbody.innerHTML = items.map(v => {
            const isEdit = (v.id === editingId);
            const cln = s => (s && s !== 'nan' && s !== 'None') ? s : '';
            const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';

            // --- ç¼–è¾‘çŠ¶æ€æ¸²æŸ“ ---
            if (isEdit) {
                const sel = (k, list) => `<select id="ed-${k}" class="t-input">${list.map(o => `<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                const mul = (k, type) => `<input id="ed-${k}" class="t-input multi-trig cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this, '${type}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                
                return `
                <tr class="editing ${v.isNew ? 'new-row' : ''}">
                    <td class="p-2 text-center">
                        <div class="img-cell mx-auto relative group" 
                             onclick="document.getElementById('up-${v.id}').click()"
                             ondrop="handleDrop(event, '${v.id}')"
                             ondragover="event.preventDefault()"
                             onpaste="handlePaste(event, '${v.id}')">
                            <img src="${img}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 text-xs font-bold transition-opacity">ä¸Šä¼ </div>
                        </div>
                        <input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this, '${v.id}')">
                        <input type="hidden" id="ed-img" value="${cln(v.image_url)}">
                    </td>
                    <td><input id="ed-pid" class="t-input font-mono" value="${cln(v.product_id)}" placeholder="ç¼–å·"></td>
                    <td><input id="ed-title" class="t-input font-bold" value="${cln(v.title)}" placeholder="æ ‡é¢˜"></td>
                    <td>${sel('cat', globalOptions.categories)}</td>
                    <td><input id="ed-fin" type="date" class="t-input" value="${cln(v.finish_time)}"></td>
                    <td>${sel('type', globalOptions.video_types)}</td>
                    <td>${mul('host', 'hosts')}</td>
                    <td>${sel('status', globalOptions.statuses)}</td>
                    <td>${mul('plat', 'platforms')}</td>
                    <td><input id="ed-pub" type="datetime-local" class="t-input" value="${cln(v.publish_time).replace(' ', 'T')}"></td>
                    <td><input id="ed-rem" class="t-input" value="${cln(v.remark)}"></td>
                    <td class="text-center sticky right-0 bg-blue-50 border-l shadow-sm">
                        <button onclick="saveRow('${v.id}')" class="text-white bg-blue-600 px-3 py-1 rounded text-xs font-bold shadow hover:bg-blue-700 transition-colors">ä¿å­˜</button>
                        <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1 hover:text-slate-600">å–æ¶ˆ</button>
                    </td>
                </tr>`;
            }
            
            // --- æµè§ˆçŠ¶æ€æ¸²æŸ“ ---
            const getColor = (s, t) => { 
                if(t==='st') return s.includes('å·²') ? {b:'#dcfce7', c:'#166534'} : {b:'#fff7ed', c:'#c2410c'}; 
                return {b:'#f1f5f9', c:'#475569'}; 
            };
            
            const pill = (s, t) => s.split(/[,ï¼Œ]/).map(x => 
                `<span class="pill" style="background:${getColor(x, t).b};color:${getColor(x, t).c}">${x}</span>`
            ).join('');

            return `
            <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                <td class="p-2 text-center">
                    <div class="img-cell mx-auto bg-slate-100" 
                         onclick="showBig('${img}')"
                         ondrop="handleDrop(event, '${v.id}')"
                         ondragover="event.preventDefault()"
                         onpaste="handlePaste(event, '${v.id}')">
                        <img src="${img}" class="w-full h-full object-cover">
                    </div>
                </td>
                <td class="font-mono text-slate-500 font-bold">${cln(v.product_id)}</td>
                <td class="font-bold text-slate-700 truncate" style="max-width:260px" title="${cln(v.title)}">${cln(v.title)}</td>
                <td><span class="pill bg-slate-100 text-slate-600">${cln(v.category)}</span></td>
                <td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td>
                <td><span class="pill bg-slate-100 text-slate-600">${cln(v.video_type)}</span></td>
                <td>${pill(cln(v.host), '')}</td>
                <td class="text-center">${pill(cln(v.status), 'st')}</td>
                <td>${pill(cln(v.platform), '')}</td>
                <td class="text-slate-400 text-xs font-mono">${cln(v.publish_time).replace('T', ' ')}</td>
                <td class="text-slate-400 truncate max-w-[120px] text-xs" title="${cln(v.remark)}">${cln(v.remark)}</td>
                <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l shadow-sm">
                    <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button>
                    <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                </td>
            </tr>`;
        }).join('');
    }

    // ==========================================
    // äº¤äº’é€»è¾‘é›† (CRUD + Drag&Drop)
    // ==========================================
    function startEdit(id) { editingId = id; renderTable(globalData); }
    function cancelEdit() { editingId = null; loadData(); } // Reload to clear temp rows
    
    async function saveRow(id) {
        const fd = new FormData();
        if (id !== 'new') fd.append('id', id);
        
        // æ”¶é›†æ‰€æœ‰å­—æ®µ
        const map = {
            'pid': 'product_id', 'title': 'title', 'cat': 'category', 
            'fin': 'finish_time', 'type': 'video_type', 'host': 'host', 
            'status': 'status', 'plat': 'platform', 'pub': 'publish_time', 'rem': 'remark'
        };
        
        for (let [eid, key] of Object.entries(map)) {
            fd.append(key, document.getElementById('ed-' + eid).value.replace('T', ' '));
        }
        fd.append('image_url', document.getElementById('ed-img').value);
        
        await fetch('/api/video/save', {method: 'POST', body: fd});
        editingId = null; 
        loadData(); 
        // æç¤ºï¼šå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ª toast æç¤ºä¿å­˜æˆåŠŸ
    }

    // --- å›¾ç‰‡å¤„ç†æ ¸å¿ƒé€»è¾‘ ---
    async function handleDrop(e, id) { 
        e.preventDefault(); 
        if(e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0], id); 
    }
    
    async function handlePaste(e, id) { 
        if(e.clipboardData.files[0]) uploadFile(e.clipboardData.files[0], id); 
    }
    
    async function upImg(input, id) { 
        if(input.files[0]) uploadFile(input.files[0], id); 
    }
    
    async function uploadFile(file, id) {
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch('/api/upload', {method:'POST', body:fd});
        const d = await res.json();
        
        if (editingId == id) { 
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œåªæ›´æ–°éšè—åŸŸ
            document.getElementById('ed-img').value = d.url; 
        } else { 
            // å¦‚æœæ˜¯æŸ¥çœ‹æ¨¡å¼ï¼Œç›´æ¥ä¿å­˜å›¾ç‰‡é“¾æ¥åˆ°åç«¯
            const fd2 = new FormData(); fd2.append('id', id); fd2.append('image_url', d.url);
            await fetch('/api/video/save', {method:'POST', body:fd2}); 
        }
        
        // æ›´æ–°æœ¬åœ°æ•°æ®å¹¶é‡ç»˜ï¼Œå®ç°â€œå³æ—¶é¢„è§ˆâ€
        const row = globalData.find(v => v.id == id || (id==='new' && v.id==='new'));
        if(row) row.image_url = d.url;
        renderTable(globalData);
    }

    // --- å¤šé€‰èœå•é€»è¾‘ ---
    function openMulti(input, type) {
        const pop = document.getElementById('multi-pop');
        const rect = input.getBoundingClientRect();
        const curr = input.value.split(/[,ï¼Œ]/).map(s => s.trim());
        
        pop.innerHTML = globalOptions[type].map(o => `
            <div class="multi-opt" onclick="togOpt('${input.id}', '${o}', '${type}')">
                <span class="${curr.includes(o) ? 'text-blue-600 font-bold w-4' : 'w-4'}">${curr.includes(o) ? 'âœ“' : ''}</span> 
                ${o}
            </div>
        `).join('');
        
        pop.style.top = (rect.bottom + window.scrollY) + 'px';
        pop.style.left = (rect.left + window.scrollX) + 'px';
        pop.classList.add('show');
    }
    
    function togOpt(eid, val, type) {
        const inp = document.getElementById(eid);
        let vals = inp.value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
        
        if (vals.includes(val)) vals = vals.filter(i => i !== val);
        else vals.push(val);
        
        inp.value = vals.join(', ');
        openMulti(inp, type); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
    }

    // --- æ‚é¡¹äº¤äº’ ---
    function toggleFilter() { document.getElementById('filter-panel').classList.toggle('open'); }
    function showBig(s) { document.getElementById('big-img').src = s; document.getElementById('preview-modal').classList.add('active'); }
    function resetFilters() { document.querySelectorAll('#filter-panel input, #filter-panel select').forEach(e => e.value = ''); loadData(1); }
    function changePage(d) { if(currPage + d > 0 && currPage + d <= totalPages) loadData(currPage + d); }
    async function delVideo(id) { if(confirm('ç¡®è®¤åˆ é™¤æ­¤æ¡ç›®å—ï¼Ÿ')) { await fetch(`/api/video/${id}`, {method: 'DELETE'}); loadData(); } }
    
    // --- å¯¼å…¥ä¸è®¾ç½® ---
    function openImport() { document.getElementById('import-modal').classList.add('active'); }
    async function startImport() { await fetch('/api/import/local', {method: 'POST'}); alert('åå°å¯¼å…¥ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨ååˆ·æ–°ã€‚'); document.getElementById('import-modal').classList.remove('active'); }
    
    function openSettings() { 
        document.getElementById('settings-modal').classList.add('active'); 
        document.getElementById('set-hosts').value = globalOptions.hosts.join(',');
        document.getElementById('set-cats').value = globalOptions.categories.join(',');
        document.getElementById('set-types').value = globalOptions.video_types.join(',');
        document.getElementById('set-plats').value = globalOptions.platforms.join(',');
    }
    
    async function saveSettings() {
        const fd = new FormData();
        const save = (k, v) => fetch('/api/settings', {method: 'POST', body: new URLSearchParams({key: k, value: v})});
        await save('hosts', document.getElementById('set-hosts').value);
        await save('categories', document.getElementById('set-cats').value);
        await save('video_types', document.getElementById('set-types').value);
        await save('platforms', document.getElementById('set-plats').value);
        document.getElementById('settings-modal').classList.remove('active');
        loadOptions(); // åˆ·æ–°é€‰é¡¹
    }
</script>
</body>
</html>