<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V9.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #1e293b; }
        
        /* è¡¨æ ¼ä¼˜åŒ– - å­—å·åŠ å¤§ */
        .table-container { width: 100%; overflow-x: auto; padding-bottom: 60px; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { font-size: 14px; font-weight: 700; color: #475569; padding: 14px 12px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; text-align: left; cursor: pointer; }
        th:hover { background: #e2e8f0; color: #0f172a; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* è¾“å…¥æ¡† - é«˜åº¦èˆ’é€‚ */
        .table-input { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; background: white; outline: none; transition: all 0.2s; height: 36px; }
        .table-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .editing { background: #eff6ff !important; }

        /* å¤šé€‰èœå• */
        .multi-menu { position: absolute; z-index: 50; background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 8px; padding: 6px; width: 200px; max-height: 240px; overflow-y: auto; display: none; }
        .multi-menu.show { display: block; }
        .multi-option { display: flex; items-center; gap: 8px; padding: 8px; cursor: pointer; font-size: 13px; border-radius: 6px; color: #334155; }
        .multi-option:hover { background: #f1f5f9; color: #2563eb; }

        /* ç­›é€‰é¢æ¿åŠ¨ç”» */
        #filter-panel { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; background: white; border-bottom: 1px solid #e2e8f0; }
        #filter-panel.open { max-height: 600px; }

        /* è§†è§‰å…ƒç´  */
        .pill { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; border: 1px solid transparent; white-space: nowrap; line-height: 1.2; }
        .img-zone { width: 48px; height: 48px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; overflow: hidden; cursor: pointer; position: relative; }
        .img-zone:hover { border-color: #3b82f6; transform: scale(1.05); transition: transform 0.2s; }
        
        /* æ¨¡æ€æ¡† */
        .modal { opacity: 0; pointer-events: none; transition: opacity 0.2s; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 60; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        /* è¿›åº¦æ¡ */
        .progress-bar { height: 8px; background: #f1f5f9; border-radius: 99px; overflow: hidden; margin-top: 12px; display: none; }
        .progress-val { height: 100%; background: #3b82f6; width: 0%; transition: width 0.2s; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-50">

    <div class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-40">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-md shadow-blue-100">V</div>
            <h1 class="text-xl font-bold text-slate-800 hidden md:block">VideoHub <span class="text-slate-400 font-normal text-sm">V9.0</span></h1>
        </div>
        
        <div class="flex gap-3 items-center">
            <div class="relative group">
                <svg class="absolute left-3 top-3 w-4 h-4 text-slate-400 group-focus-within:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input id="global-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢..." class="pl-10 pr-4 py-2 w-40 md:w-80 bg-slate-100 border-transparent rounded-lg text-sm focus:bg-white focus:border-blue-500 focus:ring-2 outline-none transition-all">
            </div>
            <button onclick="toggleFilters()" class="text-slate-600 hover:text-blue-600 p-2 rounded-lg hover:bg-slate-100 transition-colors" title="é«˜çº§ç­›é€‰">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
            </button>
            <button onclick="openAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95 flex items-center gap-1">
                <span>+</span> <span class="hidden md:inline">æ–°å¢èµ„äº§</span>
            </button>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-4 shrink-0 z-30">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex items-center justify-between">
                <div><div class="text-xs font-bold text-slate-400 uppercase tracking-wider">æ€»èµ„äº§</div><div class="text-2xl font-black text-slate-800" id="st-total">-</div></div>
                <div class="text-3xl opacity-50 grayscale">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex items-center justify-between">
                <div><div class="text-xs font-bold text-orange-400 uppercase tracking-wider">å¾…å‘å¸ƒ</div><div class="text-2xl font-black text-orange-500" id="st-pending">-</div></div>
                <div class="text-3xl opacity-50 grayscale">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex items-center justify-between hidden md:flex">
                <div><div class="text-xs font-bold text-emerald-400 uppercase tracking-wider">æœ¬æœˆåŠ³æ¨¡</div><div class="text-2xl font-black text-emerald-600" id="st-host">-</div></div>
                <div class="text-3xl opacity-50 grayscale">ğŸ†</div>
            </div>
        </div>
    </div>

    <div id="filter-panel" class="shrink-0 px-6">
        <div class="py-5 grid grid-cols-2 md:grid-cols-6 gap-4">
            <div><label class="text-xs font-bold text-slate-500 block mb-1.5">äº§å“ç¼–å·</label><input id="s-pid" list="dl-pids" class="table-input" placeholder="è¾“å…¥..."></div>
            <div><label class="text-xs font-bold text-slate-500 block mb-1.5">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="table-input" placeholder="è¾“å…¥..."></div>
            
            <div><label class="text-xs font-bold text-slate-500 block mb-1.5">äº§å“ç±»å‹</label><select id="s-cat" class="table-input"></select></div>
            <div><label class="text-xs font-bold text-slate-500 block mb-1.5">è§†é¢‘ç±»å‹</label><select id="s-type" class="table-input"></select></div>
            <div><label class="text-xs font-bold text-slate-500 block mb-1.5">å‘å¸ƒçŠ¶æ€</label><select id="s-status" class="table-input"></select></div>
            <div><label class="text-xs font-bold text-slate-500 block mb-1.5">ä¸»æ’­</label><select id="s-host" class="table-input"></select></div>
            
            <div class="col-span-2"><label class="text-xs font-bold text-slate-500 block mb-1.5">å®Œæˆæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-fin-start" class="table-input"><input type="date" id="s-fin-end" class="table-input"></div></div>
            <div class="col-span-2"><label class="text-xs font-bold text-slate-500 block mb-1.5">å‘å¸ƒæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="table-input"><input type="date" id="s-pub-end" class="table-input"></div></div>
            
            <div class="col-span-2 flex items-end gap-2">
                <button onclick="loadData(1)" class="flex-1 bg-slate-800 text-white text-sm font-bold py-2 rounded hover:bg-black transition-colors">åº”ç”¨ç­›é€‰</button>
                <button onclick="resetFilters()" class="flex-1 bg-white border border-slate-300 text-slate-600 text-sm font-bold py-2 rounded hover:bg-slate-50">é‡ç½®</button>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-hidden relative w-full border-t border-slate-200">
        <div class="absolute inset-0 table-container">
            <table class="w-full text-left">
                <thead class="sticky top-0 z-20 shadow-sm">
                    <tr>
                        <th class="w-16 text-center">é¢„è§ˆ</th>
                        <th onclick="sortBy('product_id')" class="w-28">ç¼–å· â†•</th>
                        <th onclick="sortBy('title')" style="width: 280px; min-width: 280px;">è§†é¢‘æ ‡é¢˜ â†•</th> <th onclick="sortBy('category')" class="w-28">äº§å“ç±»å‹ â†•</th>
                        <th onclick="sortBy('finish_time')" class="w-32">å®Œæˆæ—¶é—´ â†•</th>
                        <th onclick="sortBy('video_type')" class="w-28">è§†é¢‘ç±»å‹ â†•</th>
                        <th onclick="sortBy('host')" class="w-32">ä¸»æ’­(å¤šé€‰) â†•</th>
                        <th onclick="sortBy('status')" class="w-28 text-center">çŠ¶æ€ â†•</th>
                        <th onclick="sortBy('platform')" class="w-32">å¹³å°(å¤šé€‰) â†•</th>
                        <th onclick="sortBy('publish_time')" class="w-36">å‘å¸ƒæ—¶é—´ â†•</th>
                        <th onclick="sortBy('remark')" class="w-40">å¤‡æ³¨ â†•</th>
                        <th class="w-24 text-center sticky right-0 bg-slate-100 border-l">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-200 bg-white"></tbody>
            </table>
        </div>
    </div>

    <div class="h-12 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0 text-sm text-slate-500 font-medium z-30">
        <div class="flex gap-4">
            <span id="page-info">å…± 0 æ¡</span>
            <button onclick="openImport()" class="text-blue-600 hover:underline flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg> å¯¼å…¥æ•°æ®</button>
        </div>
        <div class="flex gap-2">
            <button onclick="changePage(-1)" id="btn-prev" class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200 disabled:opacity-50 transition-colors">â—€ ä¸Šä¸€é¡µ</button>
            <button onclick="changePage(1)" id="btn-next" class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200 disabled:opacity-50 transition-colors">ä¸‹ä¸€é¡µ â–¶</button>
        </div>
    </div>

    <div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')">
        <img id="big-img" src="" class="max-h-[90vh] max-w-[95vw] object-contain">
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content p-8">
            <h3 class="font-bold mb-6 text-xl">æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-1 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center bg-slate-50 h-48 md:h-full cursor-pointer relative group transition-colors hover:border-blue-400 hover:bg-blue-50"
                     onclick="document.getElementById('add-file').click()"
                     ondragover="event.preventDefault()" ondrop="handleAddDrop(event)">
                    <img id="add-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-xl">
                    <div class="text-center text-slate-400 group-hover:text-blue-500 pointer-events-none">
                        <div class="text-4xl mb-2">ğŸ“·</div>
                        <div class="text-sm font-medium">ç‚¹å‡» / æ‹–æ‹½ / ç²˜è´´</div>
                    </div>
                    <input type="file" id="add-file" class="hidden" onchange="uploadAddFile(this.files[0])">
                    <input type="hidden" name="image_url" id="add-img-val">
                </div>

                <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-500 mb-1 block">è§†é¢‘æ ‡é¢˜ *</label><input name="title" required class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">äº§å“ç¼–å· *</label><input name="product_id" required class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">äº§å“ç±»å‹</label><select name="category" id="add-cat" class="table-input"></select></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">è§†é¢‘ç±»å‹</label><select name="video_type" id="add-type" class="table-input"></select></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">ä¸»æ’­ (é€—å·åˆ†éš”)</label><input name="host" list="dl-host" class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">å¹³å° (é€—å·åˆ†éš”)</label><input name="platform" list="dl-plat" class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">å‘å¸ƒçŠ¶æ€</label><select name="status" id="add-status" class="table-input"></select></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">å®Œæˆæ—¶é—´</label><input name="finish_time" type="date" class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">å‘å¸ƒæ—¶é—´</label><input name="publish_time" type="datetime-local" class="table-input"></div>
                    <div><label class="text-xs font-bold text-slate-500 mb-1 block">å¤‡æ³¨</label><input name="remark" class="table-input"></div>
                </div>
                
                <div class="col-span-1 md:col-span-3 flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('add-modal')" class="text-slate-500 font-bold px-4 py-2 hover:bg-slate-100 rounded">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl">
            <div class="text-5xl mb-4">ğŸ“‚</div>
            <h3 class="font-bold mb-2 text-xl">å¯¼å…¥æ•°æ®</h3>
            <p class="text-sm text-slate-500 mb-6">ç¡®ä¿ Excel æ–‡ä»¶å·²æ”¾å…¥ NAS çš„ <code class="bg-slate-100 px-1 rounded font-mono">temp_uploads</code> ç›®å½•</p>
            
            <div class="progress-bar" id="prog-bar"><div class="progress-val" id="prog-val"></div></div>
            
            <button onclick="startImport()" class="w-full bg-slate-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-black mt-4">å¼€å§‹æ‰«æå¹¶å¯¼å…¥</button>
            <button onclick="closeModal('import-modal')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å…³é—­</button>
        </div>
    </div>

    <div id="multi-menu" class="multi-menu"></div>

    <datalist id="dl-pids"></datalist><datalist id="dl-host"></datalist><datalist id="dl-plat"></datalist>

    <script>
        let currPage = 1, totalPages = 1, currentSort = { col: 'id', order: 'desc' };
        let globalOptions = {}, editingId = null, globalData = [];

        // åˆå§‹åŒ–
        (async () => {
            await loadOptions();
            await loadData(1);
            updateStats();
            document.addEventListener('paste', e => {
                if(document.getElementById('add-modal').classList.contains('active') && e.clipboardData.files.length) {
                    uploadAddFile(e.clipboardData.files[0]);
                }
            });
            document.addEventListener('click', e => {
                if(!e.target.closest('.multi-menu') && !e.target.closest('.multi-trigger')) {
                    document.getElementById('multi-menu').classList.remove('show');
                }
            });
        })();

        // --- æ ¸å¿ƒé€»è¾‘ ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            
            // ç­›é€‰ä¸‹æ‹‰ (åŒ…å« s-type)
            const fill = (id, list) => document.getElementById(id).innerHTML = `<option value="">å…¨éƒ¨</option>` + list.map(i=>`<option value="${i}">${i}</option>`).join('');
            fill('s-cat', globalOptions.categories);
            fill('s-type', globalOptions.video_types); // ä¿®å¤ï¼šè§†é¢‘ç±»å‹
            fill('s-host', globalOptions.hosts);
            fill('s-status', globalOptions.statuses);
            
            // æ–°å¢ä¸‹æ‹‰ (åŒ…å« add-type)
            const fillReq = (id, list) => document.getElementById(id).innerHTML = list.map(i=>`<option value="${i}">${i}</option>`).join('');
            fillReq('add-cat', globalOptions.categories);
            fillReq('add-type', globalOptions.video_types); // ä¿®å¤ï¼šè§†é¢‘ç±»å‹
            fillReq('add-status', globalOptions.statuses);
            
            // Datalists
            const fillDL = (id, list) => document.getElementById(id).innerHTML = list.map(i=>`<option value="${i}">`).join('');
            fillDL('dl-pids', globalOptions.product_ids);
            fillDL('dl-host', globalOptions.hosts);
            fillDL('dl-plat', globalOptions.platforms);
        }

        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                sort_by: currentSort.col, order: currentSort.order,
                keyword: document.getElementById('global-search').value,
                product_id: document.getElementById('s-pid').value,
                title: document.getElementById('s-title').value,
                category: document.getElementById('s-cat').value,
                video_type: document.getElementById('s-type').value,
                host: document.getElementById('s-host').value,
                status: document.getElementById('s-status').value,
                pub_start: document.getElementById('s-pub-start').value,
                pub_end: document.getElementById('s-pub-end').value,
                fin_start: document.getElementById('s-fin-start').value,
                fin_end: document.getElementById('s-fin-end').value
            });
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);
            
            renderTable(data.items);
        }

        // --- æ¸²æŸ“ ---
        const getColor = (str, type) => {
            if(!str || str==='nan') return {bg:'#f1f5f9', t:'#94a3b8'};
            if(type==='status') {
                if(str.includes('å·²')) return {bg:'#dcfce7',t:'#166534'};
                if(str.includes('å¾…')) return {bg:'#fff7ed',t:'#c2410c'};
                return {bg:'#f1f5f9',t:'#475569'};
            }
            const c=[{bg:'#fee2e2',t:'#991b1b'},{bg:'#dbeafe',t:'#1e40af'},{bg:'#fef3c7',t:'#92400e'},{bg:'#f3e8ff',t:'#6b21a8'}];
            let h=0; for(let i=0;i<str.length;i++) h=str.charCodeAt(i)+((h<<5)-h);
            return c[Math.abs(h)%c.length];
        };
        const pill = (s,t) => !s||s==='nan'?'-':s.split(/[,ï¼Œ]/).map(x=>`<span class="pill" style="background:${getColor(x.trim(),t).bg};color:${getColor(x.trim(),t).t}">${x.trim()}</span>`).join('');
        const cln = s => (s && s!=='nan' && s!=='NaT' && s!=='None') ? s : '';

        function renderTable(items) {
            document.getElementById('table-body').innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                
                if (v.id === editingId) {
                    // ç¼–è¾‘è¡Œ
                    const sel = (k, list) => `<select id="ed-${k}" class="table-input bg-blue-50 border-blue-300">${list.map(o => `<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                    const multi = (k, type) => `<input id="ed-${k}" class="table-input bg-blue-50 multi-trigger cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this, '${type}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                    
                    return `
                    <tr class="editing border-b border-blue-200">
                        <td class="p-2 text-center"><div class="w-10 h-10 bg-slate-200 rounded mx-auto"></div></td>
                        <td><input id="ed-pid" class="table-input" value="${cln(v.product_id)}"></td>
                        <td><input id="ed-title" class="table-input font-bold" value="${cln(v.title)}"></td>
                        <td>${sel('cat', globalOptions.categories)}</td>
                        <td><input id="ed-fin" type="date" class="table-input" value="${cln(v.finish_time)}"></td>
                        <td>${sel('type', globalOptions.video_types)}</td>
                        <td>${multi('host', 'hosts')}</td>
                        <td>${sel('status', globalOptions.statuses)}</td>
                        <td>${multi('plat', 'platforms')}</td>
                        <td><input id="ed-pub" type="datetime-local" class="table-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="table-input" value="${cln(v.remark)}"></td>
                        <td class="text-center">
                            <button onclick="saveRow(${v.id})" class="text-white bg-blue-600 px-3 py-1 rounded text-xs font-bold shadow">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1 hover:text-slate-600">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                return `
                <tr class="hover:bg-slate-50 group border-b border-slate-100 last:border-0 transition-colors">
                    <td class="p-2 text-center">
                        <div class="img-zone mx-auto" onclick="showBigImg('${img}')" onpaste="handleRowPaste(event,${v.id})" ondrop="handleRowDrop(event,${v.id})" ondragover="event.preventDefault()">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td class="font-mono text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 truncate" style="max-width: 280px;" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td>${pill(cln(v.category))}</td>
                    <td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td>
                    <td>${pill(cln(v.video_type))}</td>
                    <td>${pill(cln(v.host))}</td>
                    <td class="text-center">${pill(cln(v.status), 'status')}</td>
                    <td>${pill(cln(v.platform))}</td>
                    <td class="text-slate-400 font-mono text-xs whitespace-nowrap">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-slate-400 truncate max-w-[120px] text-xs">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l">
                        <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- å¤šé€‰äº¤äº’ ---
        function openMulti(input, type) {
            const menu = document.getElementById('multi-menu');
            const rect = input.getBoundingClientRect();
            const opts = globalOptions[type] || [];
            const current = input.value.split(/[,ï¼Œ]/).map(s => s.trim());
            
            menu.innerHTML = opts.map(o => {
                const isChk = current.includes(o);
                return `<div class="multi-option" onclick="toggleOption('${input.id}', '${o}')">
                    <span class="${isChk?'text-blue-600':'text-slate-300'} text-lg">${isChk?'â˜‘':'â˜'}</span> ${o}
                </div>`;
            }).join('');
            
            menu.style.top = (rect.bottom + window.scrollY) + 'px';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.classList.add('show');
        }

        function toggleOption(inputId, val) {
            const input = document.getElementById(inputId);
            let vals = input.value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            if(vals.includes(val)) vals = vals.filter(v => v !== val);
            else vals.push(val);
            input.value = vals.join(', ');
            openMulti(input, inputId.includes('host') ? 'hosts' : 'platforms');
        }

        // --- ç¼–è¾‘é€»è¾‘ ---
        function startEdit(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        async function saveRow(id) {
            const fd = new FormData(); fd.append('id', id);
            const map = {'pid':'product_id', 'title':'title', 'cat':'category', 'fin':'finish_time', 
                         'type':'video_type', 'host':'host', 'status':'status', 'plat':'platform', 'pub':'publish_time', 'rem':'remark'};
            for (let [k, dbKey] of Object.entries(map)) {
                fd.append(dbKey, document.getElementById(`ed-${k}`).value.replace('T', ' '));
            }
            await fetch('/api/video/save', {method:'POST', body:fd});
            editingId = null; loadData(); updateStats();
        }

        // --- å›¾ç‰‡äº¤äº’ ---
        async function uploadAddFile(file) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            document.getElementById('add-preview').src = d.url;
            document.getElementById('add-preview').classList.remove('hidden');
            document.getElementById('add-img-val').value = d.url;
        }
        function handleAddDrop(e) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadAddFile(e.dataTransfer.files[0]); }
        
        async function uploadRowImg(file, id) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            const row = globalData.find(v => v.id === id);
            const sfd = new FormData(); sfd.append('id', id); sfd.append('image_url', d.url); sfd.append('product_id', row.product_id);
            await fetch('/api/video/save', {method:'POST', body:sfd});
            loadData();
        }
        function handleRowDrop(e, id) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadRowImg(e.dataTransfer.files[0], id); }
        function handleRowPaste(e, id) { e.stopPropagation(); if(e.clipboardData.files[0]) uploadRowImg(e.clipboardData.files[0], id); }

        // --- æ‚é¡¹ ---
        function toggleFilters() { document.getElementById('filter-panel').classList.toggle('open'); }
        function showBigImg(src) { document.getElementById('big-img').src = src; document.getElementById('preview-modal').classList.add('active'); }
        function openAddModal() { document.getElementById('add-modal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function resetFilters() { document.querySelectorAll('#filter-panel input, #filter-panel select').forEach(e => e.value=''); loadData(1); }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        function sortBy(col) { currentSort.col = col; currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc'; loadData(1); }
        
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            if(fd.get('publish_time')) fd.set('publish_time', fd.get('publish_time').replace('T',' '));
            await fetch('/api/video/save', {method:'POST', body:fd});
            closeModal('add-modal'); loadData(1); updateStats();
        };
        
        // å¯¼å…¥å¸¦è¿›åº¦æ¡
        function openImport() { document.getElementById('import-modal').classList.add('active'); }
        async function startImport() {
            const bar = document.getElementById('prog-bar'); const val = document.getElementById('prog-val');
            bar.style.display = 'block'; val.style.width = '20%';
            setTimeout(() => val.style.width = '80%', 500); // æ¨¡æ‹Ÿè¿›åº¦
            await fetch('/api/import/local', {method:'POST'});
            val.style.width = '100%';
            setTimeout(() => { alert('ä»»åŠ¡å·²å¯åŠ¨'); closeModal('import-modal'); bar.style.display='none'; width='0%'; }, 500);
        }
        
        async function delVideo(id) { if(confirm('åˆ ?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); } }
        async function updateStats() { try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;if(d.host!=='æš‚æ— ') document.getElementById('st-host').innerText=d.host;}catch{} }
    </script>
</body>
</html>