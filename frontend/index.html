<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V48.0 Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === æ ¸å¿ƒå¸ƒå±€ === */
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #334155; margin: 0; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }
        .hidden { display: none !important; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; box-shadow: 4px 0 24px rgba(0,0,0,0.1); }
        .sidebar-header { height: 64px; display: flex; align-items: center; padding: 0 24px; color: white; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; }
        .nav-item { padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: white; border-left-color: #3b82f6; }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content { flex: 1; position: relative; height: 100%; background: #f1f5f9; overflow: hidden; }
        .view-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden; }
        .scroll-content { flex: 1; overflow-y: auto; padding: 24px; min-height: 0; scrollbar-width: thin; }

        /* ä»ªè¡¨ç›˜ç»„ä»¶ */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:space-between; }
        .stat-num { font-size: 28px; font-weight: 800; color: #0f172a; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 16px; margin-bottom: 24px; }
        .chart-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 380px; display: flex; flex-direction: column; }
        .trend-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 380px; margin-bottom: 24px; }
        .matrix-box { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; height: 380px; display: flex; flex-direction: column; }
        .matrix-header { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-weight: 700; color: #334155; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .matrix-content { flex: 1; overflow-y: auto; }
        .matrix-table { width: 100%; border-collapse: collapse; text-align: left; }
        .matrix-table th { position: sticky; top: 0; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 12px; padding: 12px 16px; border-bottom: 1px solid #e2e8f0; z-index: 10; }
        .matrix-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #334155; font-weight: 500; }
        .matrix-table tr:hover td { background: #f8fafc; }
        .rank-badge { display: inline-flex; width: 20px; height: 20px; align-items: center; justify-content: center; border-radius: 4px; font-size: 12px; font-weight: 700; margin-right: 8px; color: #64748b; background: #f1f5f9; }
        .rank-1 { background: #fef9c3; color: #b45309; } .rank-2 { background: #f3f4f6; color: #4b5563; } .rank-3 { background: #ffedd5; color: #c2410c; }
        .val-today { color: #ef4444; font-weight: 800; }

        /* === åº“å­˜è¡¨ (Excel æ¨¡å¼) === */
        .inventory-layout { display: flex; flex-direction: column; height: 100%; }
        .inv-header { flex-shrink: 0; z-index: 20; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .toolbar { padding: 12px 24px; background: white; display: flex; justify-content: space-between; align-items: center; }
        .inv-body { flex: 1; overflow: auto; position: relative; margin: 0; background: white; border-top: 1px solid #e2e8f0; }
        
        .main-table { width: 100%; table-layout: fixed; border-collapse: collapse; min-width: 1500px; }
        .main-table th { 
            position: sticky; top: 0; background: #f1f5f9; color: #475569; font-weight: 600; font-size: 12px; 
            padding: 10px 12px; border-bottom: 1px solid #cbd5e1; border-right: 1px solid #e2e8f0; 
            text-align: left; z-index: 10; white-space: nowrap; user-select: none;
        }
        .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; height: 100%; z-index: 20; }
        .resizer:hover { background: #3b82f6; }

        .main-table td { 
            padding: 0; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; 
            font-size: 13px; vertical-align: top; color: #334155; 
            /* å…³é”®ï¼šå…è®¸æ¢è¡Œ */
            white-space: normal; word-wrap: break-word; overflow-wrap: break-word;
        }
        .main-table tr:hover td { background: #f8fafc; }

        /* å•å…ƒæ ¼å†…è¾“å…¥æ¡† - é€‚é…å¤šè¡Œ */
        .cell-input { 
            width: 100%; min-height: 44px; height: 100%; border: none; outline: none; background: transparent; 
            padding: 12px; font-family: inherit; font-size: inherit; color: inherit;
            resize: none; display: block; overflow: hidden; /* è‡ªåŠ¨æ’‘å¼€ */
        }
        .cell-input:focus { background: #fff; box-shadow: inset 0 0 0 2px #3b82f6; z-index: 2; position: relative; }
        
        .cell-select { width: 100%; height: 100%; min-height: 44px; border: none; outline: none; background: transparent; padding: 0 8px; cursor: pointer; -webkit-appearance: none; }
        .cell-trigger { width: 100%; min-height: 44px; padding: 8px 12px; cursor: pointer; display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        .cell-trigger:hover { background: #f8fafc; }

        /* èƒ¶å›Šæ ‡ç­¾ */
        .pill { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 3px; border: 1px solid transparent; white-space: nowrap; line-height: 1.2; }
        
        /* æç¤º */
        #save-toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 600; opacity: 0; transition: opacity 0.3s; z-index: 100; pointer-events: none; }
        #save-toast.show { opacity: 1; }

        /* æ§ä»¶ */
        .t-input { width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; background: white; height: 34px; }
        .btn { padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; border: 1px solid transparent; }
        .btn-primary { background: #0f172a; color: white; }
        .btn-secondary { background: white; border-color: #cbd5e1; color: #475569; }
        .img-cell { width: 44px; height: 44px; border-radius: 4px; border: 1px solid #e2e8f0; background: #f8fafc; overflow: hidden; cursor: pointer; margin: 4px auto; display: flex; align-items: center; justify-content: center; }

        /* å¤šé€‰å¼¹çª— */
        .multi-pop { position: absolute; background: white; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; width: 220px; max-height: 260px; overflow-y: auto; z-index: 60; display: none; }
        .multi-pop.show { display: block; }
        .multi-opt { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .multi-opt:hover { background: #f1f5f9; color: #2563eb; }
        
        /* ç­›é€‰é¢æ¿ */
        .filter-panel { background: white; border-bottom: 1px solid #e2e8f0; overflow: hidden; transition: max-height 0.3s; max-height: 0; padding: 0 24px; }
        .filter-panel.open { max-height: 600px; padding-top: 20px; padding-bottom: 20px; }

        /* æ¨¡æ€æ¡† */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding-bottom: 40px; }
        .prod-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .prod-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
    </style>
</head>
<body>

<div id="save-toast">âˆš å·²è‡ªåŠ¨ä¿å­˜</div>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header"><div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-xl mr-3 shadow">V</div>VideoHub</div>
        <div class="sidebar-content mt-4">
            <div class="nav-item active" onclick="switchView('dashboard', this)"><span>ğŸ“Š</span> <span>æ•°æ®é©¾é©¶èˆ±</span></div>
            <div class="nav-item" onclick="switchView('inventory', this)"><span>ğŸ“¦</span> <span>è§†é¢‘åº“å­˜è¡¨</span></div>
            <div class="nav-item" onclick="switchView('product', this)"><span>ğŸ·ï¸</span> <span>äº§å“åº“å­˜ (SPU)</span></div>
        </div>
    </aside>

    <main class="main-content">
        <div id="view-dashboard" class="view-container">
            <div class="scroll-content">
                <div class="kpi-grid">
                    <div class="stat-card border-l-4 border-blue-500"><div class="text-xs font-bold text-slate-500 uppercase mb-2">æ€»åº“å­˜</div><div class="stat-num" id="d-total">-</div></div>
                    <div class="stat-card border-l-4 border-purple-500"><div class="text-xs font-bold text-slate-500 uppercase mb-2">ç´¯è®¡åˆ†å‘</div><div class="stat-num" id="d-dist">-</div></div>
                    <div class="stat-card border-l-4 border-orange-500"><div class="text-xs font-bold text-slate-500 uppercase mb-2">å¾…å‘å¸ƒ</div><div class="stat-num" id="d-pending">-</div></div>
                    <div class="stat-card"><div class="text-xs font-bold text-slate-500 uppercase mb-2">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-today-in">-</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-today-out">-</span></div></div>
                    <div class="stat-card"><div class="text-xs font-bold text-slate-500 uppercase mb-2">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-month-in">-</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-month-out">-</span></div></div>
                </div>
                <div class="trend-box">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700">ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿</h3><div class="flex gap-2"><button onclick="loadDashboard('day')" class="btn btn-secondary py-1 text-xs">æ—¥</button><button onclick="loadDashboard('week')" class="btn btn-secondary py-1 text-xs">å‘¨</button><button onclick="loadDashboard('month')" class="btn btn-secondary py-1 text-xs">æœˆ</button></div></div>
                    <div id="chart-trend" class="w-full h-[320px]"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ† ä¸»æ’­äº§å‡º Top 5</div><div id="chart-host" class="w-full h-full pb-4"></div></div>
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ“Š ç±»å‹å æ¯”</div><div id="chart-type" class="w-full h-full pb-4"></div></div>
                    
                    <div class="matrix-box">
                        <div class="matrix-header">
                            <span>ğŸ“± è´¦å·åˆ†å‘æ•°æ®</span>
                            <span class="text-xs text-slate-400 font-normal">å®æ—¶ç»Ÿè®¡</span>
                        </div>
                        <div class="matrix-content">
                            <table class="matrix-table">
                                <thead>
                                    <tr>
                                        <th style="width: 35%">å¹³å°è´¦å·</th>
                                        <th style="width: 15%">ä»Šæ—¥</th>
                                        <th style="width: 15%">æœ¬å‘¨</th>
                                        <th style="width: 15%">æœ¬æœˆ</th>
                                        <th style="width: 20%">å¹´åº¦</th>
                                    </tr>
                                </thead>
                                <tbody id="matrix-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="inventory-layout hidden">
            <div class="inv-header">
                <div class="toolbar">
                    <div class="flex gap-2 items-center flex-1">
                        <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å¿«é€Ÿæœç´¢..." class="t-input w-64 pl-2">
                        <button onclick="toggleFilter()" class="btn btn-secondary">ç­›é€‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openSettings()" class="btn btn-secondary">é…ç½®</button>
                        <button onclick="openImport()" class="btn btn-secondary text-blue-600">å¯¼å…¥</button>
                        <button onclick="addNewRow()" class="btn btn-primary">æ–°å¢è¡Œ</button>
                    </div>
                </div>
                <div id="filter-panel" class="filter-panel">
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 py-4">
                        <input id="s-pid" class="t-input" placeholder="äº§å“ç¼–å·">
                        <input id="s-title" class="t-input" placeholder="æ ‡é¢˜">
                        <select id="s-cat" class="t-input"></select>
                        <select id="s-host" class="t-input"></select>
                        <select id="s-status" class="t-input"></select>
                        <select id="s-plat" class="t-input"></select>
                        <input type="date" id="s-fin-start" class="t-input">
                        <input type="date" id="s-fin-end" class="t-input">
                        <div class="flex justify-end gap-2 col-span-full md:col-span-1"><button onclick="loadData(1)" class="btn btn-primary w-full">æŸ¥è¯¢</button></div>
                    </div>
                </div>
            </div>
            
            <div class="inv-body">
                <table class="main-table" id="inv-table">
                    <colgroup>
                        <col style="width: 60px;">  <col style="width: 120px;"> <col style="width: 280px;"> <col style="width: 100px;"> <col style="width: 120px;"> <col style="width: 100px;"> <col style="width: 140px;"> <col style="width: 100px;"> <col style="width: 160px;"> <col style="width: 140px;"> <col style="width: 160px;"> <col style="width: 50px;">  </colgroup>
                    <thead>
                        <tr>
                            <th class="text-center">å›¾<div class="resizer"></div></th>
                            <th>ç¼–å·<div class="resizer"></div></th>
                            <th>è§†é¢‘æ ‡é¢˜<div class="resizer"></div></th>
                            <th>è§†ç±»<div class="resizer"></div></th>
                            <th>å®Œæˆæ—¶é—´<div class="resizer"></div></th>
                            <th>åˆ†ç±»<div class="resizer"></div></th>
                            <th>ä¸»æ’­ (å¤šé€‰)<div class="resizer"></div></th>
                            <th class="text-center">çŠ¶æ€<div class="resizer"></div></th>
                            <th>å¹³å° (å¤šé€‰)<div class="resizer"></div></th>
                            <th>å‘å¸ƒæ—¶é—´<div class="resizer"></div></th>
                            <th>å¤‡æ³¨<div class="resizer"></div></th>
                            <th class="text-center">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            
            <div class="inv-header bg-white border-t border-slate-200 px-4 py-2 flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-500" id="page-info">0 æ¡</span>
                <div class="flex gap-2"><button onclick="changePage(-1)" class="btn btn-secondary py-1 text-xs"> < </button><button onclick="changePage(1)" class="btn btn-secondary py-1 text-xs"> > </button></div>
            </div>
        </div>

        <div id="view-product" class="view-container hidden">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f8fafc] pt-4 px-6 z-10 shrink-0 border-b border-slate-200/50 backdrop-blur-sm">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span>ğŸ·ï¸</span> äº§å“åº“å­˜ç›‘æ§</h2>
                <input id="prod-search" class="t-input w-64 pl-2 rounded-full border-slate-300 shadow-sm" placeholder="æœç´¢å‹å·...">
            </div>
            <div class="scroll-content pt-0">
                <div id="product-grid" class="card-grid"></div>
            </div>
        </div>
    </main>
</div>

<div id="multi-pop" class="multi-pop"></div>
<div id="import-modal" class="modal"><div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl"><h3 class="font-bold text-xl mb-4 text-slate-800">å¯¼å…¥ Excel</h3><button onclick="startImport()" class="btn btn-primary w-full justify-center py-2">å¼€å§‹æ‰«æ</button><button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å…³é—­</button></div></div>
<div id="settings-modal" class="modal"><div class="bg-white rounded-xl w-[500px] p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-slate-800">é…ç½®</h3><div class="grid gap-3"><textarea id="set-hosts" class="t-input h-16" placeholder="ä¸»æ’­..."></textarea><input id="set-cats" class="t-input" placeholder="åˆ†ç±»..."><input id="set-types" class="t-input" placeholder="è§†ç±»..."><input id="set-plats" class="t-input" placeholder="å¹³å°..."></div><div class="flex gap-3 mt-4"><button onclick="saveSettings()" class="btn btn-primary flex-1 justify-center">ä¿å­˜</button><button onclick="document.getElementById('settings-modal').classList.remove('active')" class="btn btn-secondary flex-1 justify-center">å–æ¶ˆ</button></div></div></div>
<div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh]"></div>

<script>
    let currPage=1, totalPages=1, globalOptions={}, currentEditId=null;

    window.addEventListener('load', async () => {
        // === ç‹¬ç«‹å¯åŠ¨é€»è¾‘ (é˜²æ­¢ä¸€ä¸ªæŒ‚äº†å…¨æŒ‚) ===
        loadOptions().catch(e => console.error("Opts Error", e));
        loadDashboard('day').catch(e => console.error("Dash Error", e));
        loadData(1).catch(e => console.error("Data Error", e));
        Product.init();
        
        document.getElementById('prod-search').addEventListener('input', (e) => Product.search(e.target.value));
        document.addEventListener('click', e => { 
            if(!e.target.closest('.multi-pop') && !e.target.closest('.cell-trigger')) document.getElementById('multi-pop').classList.remove('show'); 
        });
        initResizers();
    });

    function switchView(view, btn) {
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active')); 
        if(btn) btn.classList.add('active');
        ['dashboard', 'inventory', 'product'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
        document.getElementById('view-'+view).classList.remove('hidden');
        if(view === 'product') Product.init();
    }

    // === Helpers ===
    function getPillStyle(text) {
        if(!text || text==='-') return 'background:#f1f5f9; color:#64748b; border-color:#e2e8f0';
        if(text.includes('å¾…')) return 'background:#fff7ed; color:#c2410c; border-color:#ffedd5'; 
        if(text.includes('å·²')) return 'background:#f0fdf4; color:#15803d; border-color:#dcfce7'; 
        const colors = [{bg:'#fef2f2',c:'#b91c1c',b:'#fecaca'}, {bg:'#fffbeb',c:'#b45309',b:'#fde68a'}, {bg:'#f0f9ff',c:'#0369a1',b:'#bae6fd'}, {bg:'#f5f3ff',c:'#4338ca',b:'#ddd6fe'}, {bg:'#ecfccb',c:'#3f6212',b:'#d9f99d'}, {bg:'#fdf2f8',c:'#be185d',b:'#fbcfe8'}];
        let h=0; for(let i=0;i<text.length;i++) h=text.charCodeAt(i)+((h<<5)-h);
        const c = colors[Math.abs(h)%colors.length];
        return `background:${c.bg}; color:${c.c}; border-color:${c.b}`;
    }
    function renderPills(str) {
        if(!str) return '-';
        return str.split(/[,ï¼Œ]/).filter(s=>s.trim()).map(s => `<span class="pill" style="${getPillStyle(s.trim())}">${s.trim()}</span>`).join('');
    }
    
    // === ä¿®å¤æ—¥æœŸæ˜¾ç¤º (å…¼å®¹ ISO æ ¼å¼ T) ===
    const formatDate = (s) => s ? s.split(/[ T]/)[0] : ''; // åªè¦å‰é¢çš„æ—¥æœŸéƒ¨åˆ†
    const formatDateTime = (s) => s ? s.replace(' ', 'T').slice(0, 16) : ''; // é€‚é… datetime-local

    // === Excel Logic (Auto Save) ===
    function showToast() { const t = document.getElementById('save-toast'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    async function saveCell(id, field, value) {
        const fd = new FormData(); fd.append('id', id); fd.append(field, value);
        const map = {'pid':'product_id', 'fin':'finish_time', 'pub':'publish_time', 'cat':'category', 'type':'video_type', 'rem':'remark'};
        if(map[field]) { fd.delete(field); fd.append(map[field], value); }
        await fetch('/api/video/save', { method: 'POST', body: fd });
        showToast();
    }

    // === Renderer ===
    function renderRow(v) {
        const cln = s => (s && s!=='nan' && s!=='None') ? s : '';
        const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';
        const opts = globalOptions || {}; // é˜²å´©å…œåº•
        
        return `
        <tr>
            <td class="text-center">
                <div class="img-cell" onclick="showBig('${img}')"><img src="${img}" class="w-full h-full object-cover"></div>
            </td>
            <td><textarea class="cell-input font-mono" onchange="saveCell('${v.id}','product_id',this.value)">${cln(v.product_id)}</textarea></td>
            <td><textarea class="cell-input font-bold text-slate-700" onchange="saveCell('${v.id}','title',this.value)">${cln(v.title)}</textarea></td>
            <td><select class="cell-select text-xs" onchange="saveCell('${v.id}','video_type',this.value)">
                <option value="${cln(v.video_type)}">${cln(v.video_type)||'-'}</option>
                ${(opts.video_types||[]).map(o=>`<option>${o}</option>`).join('')}
            </select></td>
            <td><input type="date" class="cell-input text-xs" value="${formatDate(cln(v.finish_time))}" onchange="saveCell('${v.id}','finish_time',this.value)"></td>
            <td><select class="cell-select text-xs" onchange="saveCell('${v.id}','category',this.value)">
                <option value="${cln(v.category)}">${cln(v.category)||'-'}</option>
                ${(opts.categories||[]).map(o=>`<option>${o}</option>`).join('')}
            </select></td>
            <td><div class="cell-trigger" onclick="openMulti('${v.id}','host',this, event)">${renderPills(cln(v.host))}</div></td>
            <td><select class="cell-select text-xs text-center" onchange="saveCell('${v.id}','status',this.value)">
                <option value="${cln(v.status)}">${cln(v.status)||'-'}</option>
                ${(opts.statuses||[]).map(o=>`<option>${o}</option>`).join('')}
            </select></td>
            <td><div class="cell-trigger" onclick="openMulti('${v.id}','platform',this, event)">${renderPills(cln(v.platform))}</div></td>
            <td><input type="datetime-local" class="cell-input text-xs" value="${formatDateTime(cln(v.publish_time))}" onchange="saveCell('${v.id}','publish_time',this.value)"></td>
            <td><textarea class="cell-input text-xs text-slate-400" onchange="saveCell('${v.id}','remark',this.value)">${cln(v.remark)}</textarea></td>
            <td class="text-center"><button onclick="delVideo('${v.id}')" class="text-slate-300 hover:text-red-500 font-bold">Ã—</button></td>
        </tr>`;
    }

    // === Multi Select ===
    let multiTargetId=null, multiTargetField=null, multiTargetEl=null;
    function openMulti(id, field, el, event) {
        event.stopPropagation();
        multiTargetId = id; multiTargetField = field; multiTargetEl = el;
        const pop = document.getElementById('multi-pop');
        const rect = el.getBoundingClientRect();
        const currentVals = Array.from(el.querySelectorAll('.pill')).map(p => p.innerText);
        const options = field === 'host' ? (globalOptions.hosts||[]) : (globalOptions.platforms||[]);
        
        pop.innerHTML = options.map(o => {
            const active = currentVals.includes(o) ? 'text-blue-600 font-bold bg-blue-50' : '';
            return `<div class="multi-opt ${active}" onclick="toggleMulti('${o}')">
                <span class="w-4">${currentVals.includes(o) ? 'âœ“' : ''}</span>${o}
            </div>`;
        }).join('');
        pop.style.top = (rect.bottom + window.scrollY) + 'px';
        pop.style.left = (rect.left + window.scrollX) + 'px';
        pop.classList.add('show');
    }

    function toggleMulti(val) {
        const currentPills = Array.from(multiTargetEl.querySelectorAll('.pill')).map(p => p.innerText);
        let newVals = [...currentPills];
        if (newVals.includes(val)) newVals = newVals.filter(v => v !== val);
        else newVals.push(val);
        multiTargetEl.innerHTML = renderPills(newVals.join(','));
        saveCell(multiTargetId, multiTargetField, newVals.join(','));
        openMulti(multiTargetId, multiTargetField, multiTargetEl, event); // Refresh
    }

    function initResizers() {
        const table = document.getElementById('inv-table');
        table.querySelectorAll('th').forEach(col => {
            const resizer = col.querySelector('.resizer');
            if(!resizer) return;
            let x=0, w=0;
            const md = (e) => { x=e.clientX; w=parseInt(window.getComputedStyle(col).width); document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu); };
            const mm = (e) => { col.style.width = `${w + e.clientX - x}px`; };
            const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
            resizer.addEventListener('mousedown', md);
        });
    }

    // === Dashboard (æ‰‹åŠ¨ ID æ˜ å°„ä¿®å¤) ===
    async function loadDashboard(dim) {
        try {
            const res = await fetch(`/api/dashboard?dim=${dim}`);
            const data = await res.json();
            
            document.getElementById('d-total').innerText = data.kpi.total;
            document.getElementById('d-dist').innerText = data.kpi.dist;
            document.getElementById('d-pending').innerText = data.kpi.pending;
            document.getElementById('d-today-in').innerText = data.kpi.t_in; 
            document.getElementById('d-today-out').innerText = data.kpi.t_out;
            document.getElementById('d-month-in').innerText = data.kpi.m_in;   
            document.getElementById('d-month-out').innerText = data.kpi.m_out; 
            
            document.getElementById('matrix-body').innerHTML = data.matrix.map((r, i) => {
                let rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : ''));
                return `<tr>
                    <td><div class="flex items-center"><span class="rank-badge ${rankClass}">${i+1}</span><span class="font-bold text-slate-700">${r.name}</span></div></td>
                    <td class="val-today">${r.day > 0 ? '+'+r.day : '-'}</td>
                    <td>${r.week}</td>
                    <td>${r.month}</td>
                    <td class="val-year">${r.year}</td>
                </tr>`;
            }).join('');
            
            if(typeof echarts !== 'undefined') {
                echarts.init(document.getElementById('chart-trend')).setOption({tooltip:{trigger:'axis'}, xAxis:{type:'category',data:data.trend.dates}, yAxis:{type:'value'}, series:[{name:'å…¥åº“',type:'line',smooth:true,itemStyle:{color:'#3b82f6'},areaStyle:{opacity:0.1},data:data.trend.in},{name:'å‘å¸ƒ',type:'bar',itemStyle:{color:'#10b981'},data:data.trend.out}]});
                echarts.init(document.getElementById('chart-host')).setOption({tooltip:{trigger:'axis'}, xAxis:{type:'value'}, yAxis:{type:'category',data:data.hosts.map(i=>i.name).reverse()}, series:[{type:'bar',data:data.hosts.map(i=>i.value).reverse(), itemStyle:{color:'#f59e0b', borderRadius:[0,4,4,0]}}]});
                echarts.init(document.getElementById('chart-type')).setOption({tooltip:{trigger:'item'}, series:[{type:'pie',radius:['40%','70%'],data:data.types}]});
                echarts.init(document.getElementById('chart-plat')).setOption({tooltip:{}, radar:{indicator:data.plats.map(p=>({name:p.name, max:Math.max(...data.plats.map(v=>v.value),10)}))}, series:[{type:'radar',data:[{value:data.plats.map(p=>p.value)}]}]});
            }
        } catch(e) { console.error(e); }
    }

    async function loadData(page) { 
        currPage = page || currPage; 
        const params = new URLSearchParams({
            page:currPage, size:50, 
            keyword:document.getElementById('g-search').value, 
            product_id:document.getElementById('s-pid').value, 
            title:document.getElementById('s-title').value, 
            remark:document.getElementById('s-remark').value, 
            host:document.getElementById('s-host').value, 
            status:document.getElementById('s-status').value, 
            category:document.getElementById('s-cat').value, 
            video_type:document.getElementById('s-type').value, 
            platform:document.getElementById('s-plat').value, 
            finish_start:document.getElementById('s-fin-start').value, 
            finish_end:document.getElementById('s-fin-end').value, 
            publish_start:document.getElementById('s-pub-start').value, 
            publish_end:document.getElementById('s-pub-end').value
        });
        try {
            const res = await fetch(`/api/videos?${params}`); 
            const data = await res.json(); 
            totalPages = data.total_pages;
            document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`; 
            document.getElementById('table-body').innerHTML = data.items.map(v => renderRow(v)).join(''); 
        } catch(e) { console.error("Data Error", e); }
    }

    async function loadOptions() { 
        try {
            const res=await fetch('/api/options'); 
            globalOptions=await res.json(); 
            const fill=(id,l)=>document.getElementById(id).innerHTML=`<option value="">å…¨éƒ¨</option>`+l.map(i=>`<option>${i}</option>`).join(''); 
            fill('s-cat',globalOptions.categories); fill('s-type',globalOptions.video_types); 
            fill('s-host',globalOptions.hosts); fill('s-status',globalOptions.statuses); fill('s-plat',globalOptions.platforms);
        } catch(e) { console.error("Opts Error", e); globalOptions={}; }
    }

    const Product = {
        allData: [],
        init: async function() { try { const res = await fetch('/api/product_stats'); this.allData = await res.json(); this.render(this.allData); } catch(e){} },
        search: function(kw) { this.render(kw ? this.allData.filter(i=>String(i.name).toLowerCase().includes(kw.toLowerCase())) : this.allData); },
        render: function(data) {
            const grid = document.getElementById('product-grid');
            if(!data.length) { grid.innerHTML = '<div class="text-center text-slate-400 col-span-full py-8">æš‚æ— æ•°æ®</div>'; return; }
            grid.innerHTML = data.map(i => {
                const pct = i.total>0?Math.round(((i.total-i.pending)/i.total)*100):0;
                let c = i.pending>5?'#ef4444':(i.pending===0?'#10b981':'#3b82f6');
                return `<div class="prod-card" style="border-left:4px solid ${c}" onclick="jumpTo('${i.name}')"><div class="pc-head"><div class="pc-title" title="${i.name}">${i.name}</div></div><div class="pc-body"><div><div class="pc-num" style="color:${c}">${i.pending}</div><div class="text-xs text-slate-400">å¾…å‘å¸ƒ</div></div><div class="text-right"><div class="text-2xl font-bold text-slate-300">${pct}%</div><div class="text-xs text-slate-400">å®Œæˆç‡</div></div></div><div class="pc-bar-bg mt-2"><div class="pc-bar-fill" style="width:${pct}%;background:${c}"></div></div></div>`;
            }).join('');
        }
    };

    function addNewRow() { const tr = document.createElement('tbody'); tr.innerHTML = renderRow({id:'new', product_id:'', title:''}); document.getElementById('table-body').prepend(tr.firstElementChild); }
    async function delVideo(id){ if(confirm('åˆ ?')){ await fetch(`/api/video/${id}`,{method:'DELETE'}); loadData(currPage); } }
    
    // Utils
    function toggleFilter(){ document.getElementById('filter-panel').classList.toggle('open'); }
    function resetFilters(){ document.querySelectorAll('#filter-panel input,select').forEach(e=>e.value=''); loadData(1); }
    function openImport(){ document.getElementById('import-modal').classList.add('active'); }
    async function startImport(){ await fetch('/api/import/local',{method:'POST'}); alert('åå°ä»»åŠ¡å·²å¯åŠ¨'); location.reload(); }
    function openSettings(){ document.getElementById('settings-modal').classList.add('active'); document.getElementById('set-hosts').value=globalOptions.hosts.join(','); document.getElementById('set-cats').value=globalOptions.categories.join(','); document.getElementById('set-types').value=globalOptions.video_types.join(','); document.getElementById('set-plats').value=globalOptions.platforms.join(','); }
    async function saveSettings(){ const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})}); await s('hosts',document.getElementById('set-hosts').value); await s('categories',document.getElementById('set-cats').value); await s('video_types',document.getElementById('set-types').value); await s('platforms',document.getElementById('set-plats').value); document.getElementById('settings-modal').classList.remove('active'); loadOptions(); }
    function showBig(s){ document.getElementById('big-img').src=s; document.getElementById('preview-modal').classList.add('active'); }
    function jumpTo(pid) { window.switchView('inventory'); document.getElementById('s-pid').value = pid; document.getElementById('filter-panel').classList.add('open'); loadData(1); }
    window.changePage = (d) => { if(currPage+d > 0) loadData(currPage+d); };
</script>
</body>
</html>