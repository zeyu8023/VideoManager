<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V18.0 Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #1e293b; overflow: hidden; }
        
        .app-container { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 240px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { height: 64px; display: flex; align-items: center; padding: 0 24px; color: white; font-weight: 700; font-size: 18px; gap: 10px; border-bottom: 1px solid #1e293b; }
        .nav-item { padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: #1e293b; color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f1f5f9; position: relative; }

        /* ä»ªè¡¨ç›˜ */
        .dash-container { padding: 24px; overflow-y: auto; height: 100%; }
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .stat-label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        .stat-num { font-size: 28px; font-weight: 800; color: #0f172a; }
        .stat-sub { font-size: 12px; color: #94a3b8; margin-top: 4px; }

        .chart-grid { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 16px; margin-bottom: 24px; }
        .chart-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; height: 340px; }
        .chart-title { font-size: 14px; font-weight: 700; color: #334155; margin-bottom: 12px; }

        .trend-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; height: 400px; margin-bottom: 24px; }

        /* æ–°å¢ï¼šçŸ©é˜µè¡¨æ ¼æ ·å¼ */
        .matrix-box { background: white; border-radius: 12px; padding: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 40px; }
        .matrix-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #334155; background: #f8fafc; }
        .matrix-table { width: 100%; text-align: left; border-collapse: collapse; }
        .matrix-table th { padding: 12px 20px; font-size: 12px; color: #64748b; font-weight: 700; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .matrix-table td { padding: 12px 20px; font-size: 13px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .matrix-table tr:last-child td { border-bottom: none; }
        .matrix-table tr:hover { background: #f8fafc; }
        .val-today { color: #ef4444; font-weight: 700; } /* ä»Šæ—¥æ•°æ®é«˜äº® */

        /* åº“å­˜è¡¨ */
        .toolbar { padding: 16px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; shrink-0; }
        .filter-panel { background: white; border-bottom: 1px solid #e2e8f0; overflow: hidden; transition: max-height 0.3s; max-height: 0; padding: 0 24px; }
        .filter-panel.open { max-height: 600px; padding-top: 20px; padding-bottom: 20px; }
        .filter-label { font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; display: block; }
        .table-wrap { flex: 1; overflow: auto; background: white; margin: 16px 24px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .main-table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        .main-table th { position: sticky; top: 0; background: #f8fafc; color: #475569; font-weight: 700; font-size: 13px; padding: 12px; border-bottom: 2px solid #e2e8f0; z-index: 10; text-align: left; }
        .main-table td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; color: #334155; }

        /* ç»„ä»¶ */
        .t-input { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; outline: none; background: white; height: 34px; }
        .t-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .editing { background: #eff6ff !important; }
        .pill { padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; border: 1px solid transparent; }
        .img-cell { width: 44px; height: 44px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-cell:hover::after { content:'+'; position:absolute; inset:0; background:rgba(0,0,0,0.4); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .multi-pop { position: absolute; background: white; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; width: 220px; max-height: 260px; overflow-y: auto; z-index: 40; display: none; }
        .multi-pop.show { display: block; }
        .multi-opt { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .multi-opt:hover { background: #f1f5f9; color: #2563eb; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-xl">V</div>
            <h1 class="text-xl font-bold text-white tracking-tight">VideoHub</h1>
        </div>
        <div class="nav-item active" onclick="switchView('dashboard', this)"><span>ğŸ“Š</span> æ•°æ®é©¾é©¶èˆ±</div>
        <div class="nav-item" onclick="switchView('inventory', this)"><span>ğŸ“¦</span> è§†é¢‘åº“å­˜è¡¨</div>
    </aside>

    <main class="main-content">
        
        <div id="view-dashboard" class="dash-container">
            
            <div class="kpi-grid">
                <div class="stat-card border-l-4 border-blue-500">
                    <div class="stat-label">æ€»åº“å­˜ (è§†é¢‘æ•°)</div>
                    <div class="stat-num" id="d-total">-</div>
                </div>
                <div class="stat-card border-l-4 border-purple-500">
                    <div class="stat-label text-purple-600">ç´¯è®¡åˆ†å‘ (äººæ¬¡)</div>
                    <div class="stat-num text-purple-700" id="d-dist">-</div>
                    <div class="stat-sub">å…¨å¹³å°æ€»å‘å¸ƒé‡</div>
                </div>
                <div class="stat-card border-l-4 border-orange-500">
                    <div class="stat-label text-orange-600">å¾…å‘å¸ƒåº“å­˜</div>
                    <div class="stat-num text-orange-700" id="d-pending">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div>
                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-3xl font-black text-slate-800" id="d-today-in">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-3xl font-black text-green-600" id="d-today-out">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div>
                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-3xl font-black text-slate-800" id="d-month-in">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-3xl font-black text-green-600" id="d-month-out">0</span>
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-box">
                    <div class="chart-title">ğŸ† ä¸»æ’­äº§å‡ºæ’è¡Œ (Top 5)</div>
                    <div id="chart-host" class="w-full h-full pb-6"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ“Š å†…å®¹ç±»å‹å æ¯”</div>
                    <div id="chart-type" class="w-full h-full pb-6"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ•¸ï¸ å¹³å°åˆ†å‘é›·è¾¾</div>
                    <div id="chart-plat" class="w-full h-full pb-6"></div>
                </div>
            </div>

            <div class="trend-box">
                <div class="chart-title flex justify-between">
                    <span>ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿ (å…¥åº“ vs å‘å¸ƒ)</span>
                    <div class="flex gap-2">
                        <button onclick="loadDashboard('day')" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-blue-100">æ—¥</button>
                        <button onclick="loadDashboard('week')" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-blue-100">å‘¨</button>
                        <button onclick="loadDashboard('month')" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-blue-100">æœˆ</button>
                    </div>
                </div>
                <div id="chart-trend" class="w-full h-[320px]"></div>
            </div>

            <div class="matrix-box">
                <div class="matrix-header">ğŸ“± å„è´¦å·åˆ†å‘çŸ©é˜µ (Account Distribution Matrix)</div>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th style="width: 30%">å¹³å°è´¦å·åç§°</th>
                            <th style="width: 15%">ä»Šæ—¥å‘å¸ƒ ğŸ”¥</th>
                            <th style="width: 15%">æœ¬å‘¨å‘å¸ƒ</th>
                            <th style="width: 15%">æœ¬æœˆå‘å¸ƒ</th>
                            <th style="width: 25%">å¹´åº¦æ€»è®¡ (Rank)</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-inventory" class="inventory-view hidden">
            <div class="toolbar">
                <h2 class="text-lg font-bold text-slate-800">åº“å­˜æ˜ç»†</h2>
                <div class="flex gap-2 items-center">
                    <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢..." class="t-input w-64 bg-slate-50 border-transparent focus:bg-white">
                    <button onclick="toggleFilter()" class="px-3 py-1.5 text-sm font-bold text-slate-600 bg-slate-100 rounded hover:bg-slate-200">ç­›é€‰</button>
                    <button onclick="openSettings()" class="px-3 py-1.5 text-sm font-bold text-slate-600 bg-slate-100 rounded hover:bg-slate-200">é…ç½®</button>
                    <button onclick="openImport()" class="px-3 py-1.5 text-sm font-bold text-blue-600 bg-blue-50 rounded hover:bg-blue-100">å¯¼å…¥</button>
                    <button onclick="addNewRow()" class="px-4 py-1.5 text-sm font-bold text-white bg-blue-600 rounded hover:bg-blue-700 shadow flex items-center gap-1"><span>+</span> æ–°å¢</button>
                </div>
            </div>

            <div id="filter-panel" class="filter-panel">
                <div class="grid grid-cols-6 gap-x-4 gap-y-4">
                    <div><label class="filter-label">äº§å“ç¼–å·</label><input id="s-pid" list="dl-pids" class="t-input" placeholder="è¾“å…¥ç¼–å·..."></div>
                    <div><label class="filter-label">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="t-input" placeholder="åŒ…å«æ ‡é¢˜..."></div>
                    <div><label class="filter-label">äº§å“ç±»å‹</label><select id="s-cat" class="t-input"></select></div>
                    <div><label class="filter-label">è§†é¢‘ç±»å‹</label><select id="s-type" class="t-input"></select></div>
                    <div><label class="filter-label">ä¸»æ’­</label><select id="s-host" class="t-input"></select></div>
                    <div><label class="filter-label">çŠ¶æ€</label><select id="s-status" class="t-input"></select></div>
                    <div><label class="filter-label">å‘å¸ƒå¹³å°</label><select id="s-plat" class="t-input"></select></div>
                    <div class="col-span-2"><label class="filter-label">å®Œæˆæ—¶é—´èŒƒå›´</label><div class="flex gap-2"><input type="date" id="s-fin-start" class="t-input"><input type="date" id="s-fin-end" class="t-input"></div></div>
                    <div class="col-span-2"><label class="filter-label">å‘å¸ƒæ—¶é—´èŒƒå›´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="t-input"><input type="date" id="s-pub-end" class="t-input"></div></div>
                    <div><label class="filter-label">å¤‡æ³¨</label><input id="s-remark" class="t-input" placeholder="åŒ…å«å¤‡æ³¨..."></div>
                    <div class="col-span-6 flex justify-end gap-2 border-t pt-3 mt-2">
                        <button onclick="loadData(1)" class="px-5 py-1.5 bg-slate-800 text-white rounded text-sm font-bold">æ‰§è¡ŒæŸ¥è¯¢</button>
                        <button onclick="resetFilters()" class="px-5 py-1.5 bg-white border rounded text-sm font-bold">é‡ç½®æ¡ä»¶</button>
                    </div>
                </div>
            </div>

            <div class="table-wrap">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">å›¾</th>
                            <th class="w-24">ç¼–å·</th>
                            <th style="min-width: 260px;">è§†é¢‘æ ‡é¢˜</th>
                            <th class="w-24">ç±»å‹</th>
                            <th class="w-28">å®Œæˆæ—¶é—´</th>
                            <th class="w-24">è§†ç±»</th>
                            <th class="w-32">ä¸»æ’­(å¤š)</th>
                            <th class="w-24 text-center">çŠ¶æ€</th>
                            <th class="w-32">å¹³å°(å¤š)</th>
                            <th class="w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-40">å¤‡æ³¨</th>
                            <th class="w-20 text-center sticky right-0 bg-slate-50 border-l">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>

            <div class="h-12 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-500 font-medium" id="page-info">0 æ¡</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="px-3 py-1 bg-slate-100 rounded text-xs font-bold disabled:opacity-50">â—€</button>
                    <button onclick="changePage(1)" class="px-3 py-1 bg-slate-100 rounded text-xs font-bold disabled:opacity-50">â–¶</button>
                </div>
            </div>
        </div>

    </main>
</div>

<div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh]"></div>
<div id="multi-pop" class="multi-pop"></div>
<datalist id="dl-pids"></datalist>

<div id="import-modal" class="modal">
    <div class="bg-white rounded-xl w-[400px] p-8 text-center">
        <h3 class="font-bold text-xl mb-4">å¯¼å…¥</h3>
        <p class="text-sm text-slate-500 mb-6">è¯·ç¡®è®¤æ–‡ä»¶åœ¨ NAS temp_uploads ç›®å½•</p>
        <button onclick="startImport()" class="w-full bg-slate-800 text-white py-2 rounded font-bold">æ‰«æå¯¼å…¥</button>
        <button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs">å…³é—­</button>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="bg-white rounded-xl w-[400px] p-6">
        <h3 class="font-bold mb-4">å…¨å±€é…ç½®</h3>
        <textarea id="set-hosts" class="t-input h-20 mb-2" placeholder="ä¸»æ’­..."></textarea>
        <input id="set-cats" class="t-input mb-2" placeholder="ç±»å‹...">
        <input id="set-types" class="t-input mb-2" placeholder="è§†ç±»...">
        <input id="set-plats" class="t-input mb-2" placeholder="å¹³å°..."></textarea>
        <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">ä¿å­˜</button>
        <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-slate-400 text-xs">å…³é—­</button>
    </div>
</div>

<script>
    let currPage=1, totalPages=1;
    let globalOptions={}, editingId=null, globalData=[];
    let chartTrend=null;

    // --- åˆå§‹åŒ– ---
    (function init() {
        loadDashboard('day'); 
        loadOptions(); 
        loadData(1);
        document.addEventListener('click', e => {
            if(!e.target.closest('.multi-pop') && !e.target.closest('.multi-trig')) 
                document.getElementById('multi-pop').classList.remove('show');
        });
    })();

    function switchView(view, btn) {
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-inventory').classList.add('hidden');
        document.getElementById('view-'+view).classList.remove('hidden');
        if(view === 'dashboard') loadDashboard('day');
    }

    // --- ä»ªè¡¨ç›˜é€»è¾‘ (å¢å¼ºç‰ˆ) ---
    async function loadDashboard(dim) {
        try {
            const res = await fetch(`/api/dashboard?dim=${dim}`);
            const data = await res.json();
            
            // å¡«å…… KPI
            document.getElementById('d-total').innerText = data.kpi.total;
            document.getElementById('d-dist').innerText = data.kpi.dist_total; // æ–°å¢ç´¯è®¡åˆ†å‘
            document.getElementById('d-pending').innerText = data.kpi.pending;
            document.getElementById('d-today-in').innerText = data.kpi.today_in;
            document.getElementById('d-today-out').innerText = data.kpi.today_out;
            document.getElementById('d-month-in').innerText = data.kpi.month_in;
            document.getElementById('d-month-out').innerText = data.kpi.month_out;
            
            // æ¸²æŸ“çŸ©é˜µè¡¨ (æ–°å¢)
            const tbody = document.getElementById('matrix-body');
            tbody.innerHTML = data.matrix.map((row, idx) => `
                <tr>
                    <td class="font-bold flex items-center gap-2">
                        <span class="w-5 h-5 rounded bg-slate-100 text-slate-500 text-xs flex items-center justify-center">${idx+1}</span>
                        ${row.name}
                    </td>
                    <td class="${row.day>0?'val-today':''}">${row.day}</td>
                    <td>${row.week}</td>
                    <td>${row.month}</td>
                    <td class="font-mono text-slate-700 font-bold">${row.year}</td>
                </tr>
            `).join('');

            // ECharts 1: Trend
            if(!chartTrend) chartTrend = echarts.init(document.getElementById('chart-trend'));
            chartTrend.setOption({
                tooltip: {trigger:'axis'},
                legend: {data:['å…¥åº“','å‘å¸ƒ'], bottom:0},
                grid: {top:20, left:40, right:20, bottom:30},
                xAxis: {type:'category', data:data.trend.dates},
                yAxis: {type:'value'},
                series: [
                    {name:'å…¥åº“', type:'line', data:data.trend.in, smooth:true, itemStyle:{color:'#3b82f6'}, areaStyle:{opacity:0.1}},
                    {name:'å‘å¸ƒ', type:'bar', data:data.trend.out, itemStyle:{color:'#10b981'}}
                ]
            });

            // ECharts 2: Host
            const ch = echarts.init(document.getElementById('chart-host'));
            ch.setOption({
                tooltip: {trigger:'axis'}, grid: {top:10, left:60, right:20, bottom:20},
                xAxis: {type:'value'}, yAxis: {type:'category', data:data.hosts.map(i=>i.name).reverse()},
                series: [{type:'bar', data:data.hosts.map(i=>i.value).reverse(), itemStyle:{color:'#f59e0b', borderRadius:[0,4,4,0]}}]
            });

            // ECharts 3: Type
            const ct = echarts.init(document.getElementById('chart-type'));
            ct.setOption({ tooltip: {trigger:'item'}, series: [{type:'pie', radius:['40%','70%'], data:data.types}] });

            // ECharts 4: Radar
            const cp = echarts.init(document.getElementById('chart-plat'));
            const maxV = Math.max(...data.plats.map(p=>p.value), 10);
            cp.setOption({
                tooltip: {}, radar: {indicator: data.plats.map(p=>({name:p.name, max:maxV}))},
                series: [{type:'radar', data:[{value:data.plats.map(p=>p.value), name:'åˆ†å‘é‡'}]}]
            });

            window.onresize = () => { chartTrend.resize(); ch.resize(); ct.resize(); cp.resize(); };

        } catch(e) { console.error(e); }
    }

    // --- é€‰é¡¹ & åˆ—è¡¨ (ä¿æŒä¸å˜) ---
    async function loadOptions() {
        const res=await fetch('/api/options'); globalOptions=await res.json();
        const fill=(id,l,label)=>document.getElementById(id).innerHTML=`<option value="">å…¨éƒ¨${label}</option>`+l.map(i=>`<option>${i}</option>`).join('');
        fill('s-cat',globalOptions.categories, 'ç±»å‹'); fill('s-type',globalOptions.video_types, 'è§†ç±»');
        fill('s-host',globalOptions.hosts, 'ä¸»æ’­'); fill('s-status',globalOptions.statuses, 'çŠ¶æ€');
        fill('s-plat',globalOptions.platforms, 'å¹³å°');
        document.getElementById('dl-pids').innerHTML=globalOptions.product_ids.map(i=>`<option>${i}</option>`).join('');
    }

    async function loadData(p) {
        currPage=p||currPage;
        const params=new URLSearchParams({page:currPage, size:100, 
            keyword:document.getElementById('g-search').value,
            product_id:document.getElementById('s-pid').value, title:document.getElementById('s-title').value,
            remark:document.getElementById('s-remark').value,
            host:document.getElementById('s-host').value, status:document.getElementById('s-status').value,
            category:document.getElementById('s-cat').value, video_type:document.getElementById('s-type').value,
            platform:document.getElementById('s-plat').value,
            finish_start:document.getElementById('s-fin-start').value, finish_end:document.getElementById('s-fin-end').value,
            publish_start:document.getElementById('s-pub-start').value, publish_end:document.getElementById('s-pub-end').value
        });
        const res=await fetch(`/api/videos?${params}`); const data=await res.json();
        globalData=data.items; totalPages=data.total_pages;
        document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`;
        renderTable(data.items);
    }

    // --- æ¸²æŸ“ ---
    function addNewRow() {
        globalData.unshift({id:'new', product_id:'', title:'', isNew:true});
        editingId='new';
        renderTable(globalData);
        document.querySelector('.table-wrap').scrollTop = 0;
    }

    function renderTable(items) {
        document.getElementById('table-body').innerHTML = items.map(v => {
            const isEdit = (v.id === editingId);
            const cln = s => (s && s!=='nan' && s!=='None') ? s : '';
            const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';

            if (isEdit) {
                const sel=(k,l)=>`<select id="ed-${k}" class="t-input">${l.map(o=>`<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                const mul=(k,t)=>`<input id="ed-${k}" class="t-input multi-trig cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this,'${t}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                
                return `<tr class="editing ${v.isNew?'new-row':''}">
                    <td class="p-2"><div class="img-cell mx-auto" onclick="document.getElementById('up-${v.id}').click()"><img src="${img}" class="w-full h-full object-cover"></div><input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this,'${v.id}')"><input type="hidden" id="ed-img" value="${cln(v.image_url)}"></td>
                    <td><input id="ed-pid" class="t-input" value="${cln(v.product_id)}" placeholder="ç¼–å·"></td>
                    <td><input id="ed-title" class="t-input font-bold" value="${cln(v.title)}" placeholder="æ ‡é¢˜"></td>
                    <td>${sel('cat',globalOptions.categories)}</td>
                    <td><input id="ed-fin" type="date" class="t-input" value="${cln(v.finish_time)}"></td>
                    <td>${sel('type',globalOptions.video_types)}</td>
                    <td>${mul('host','hosts')}</td>
                    <td>${sel('status',globalOptions.statuses)}</td>
                    <td>${mul('plat','platforms')}</td>
                    <td><input id="ed-pub" type="datetime-local" class="t-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                    <td><input id="ed-rem" class="t-input" value="${cln(v.remark)}"></td>
                    <td class="text-center sticky right-0 bg-blue-50 border-l">
                        <button onclick="saveRow('${v.id}')" class="text-blue-600 font-bold text-xs">ä¿å­˜</button>
                        <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1">å–æ¶ˆ</button>
                    </td>
                </tr>`;
            }
            
            const getColor = (s,t) => { if(t==='st') return s.includes('å·²')?{b:'#dcfce7',c:'#166534'}:{b:'#fff7ed',c:'#c2410c'}; return {b:'#f1f5f9',c:'#475569'}; };
            const pill = (s,t) => s.split(/[,ï¼Œ]/).map(x=>`<span class="pill" style="background:${getColor(x,t).b};color:${getColor(x,t).c}">${x}</span>`).join('');

            return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                <td class="p-2 text-center"><div class="img-cell mx-auto bg-slate-100" onclick="showBig('${img}')"><img src="${img}" class="w-full h-full object-cover"></div></td>
                <td class="font-mono text-slate-500">${cln(v.product_id)}</td>
                <td class="font-bold text-slate-700 truncate" style="max-width:260px" title="${cln(v.title)}">${cln(v.title)}</td>
                <td><span class="pill bg-slate-100">${cln(v.category)}</span></td>
                <td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td>
                <td><span class="pill bg-slate-100">${cln(v.video_type)}</span></td>
                <td>${pill(cln(v.host),'')}</td>
                <td class="text-center">${pill(cln(v.status),'st')}</td>
                <td>${pill(cln(v.platform),'')}</td>
                <td class="text-slate-400 text-xs font-mono">${cln(v.publish_time).replace('T',' ')}</td>
                <td class="text-slate-400 truncate max-w-[120px] text-xs" title="${cln(v.remark)}">${cln(v.remark)}</td>
                <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l shadow-sm">
                    <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button>
                    <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                </td>
            </tr>`;
        }).join('');
    }

    // --- äº¤äº’ ---
    function startEdit(id){ editingId=id; renderTable(globalData); }
    function cancelEdit(){ editingId=null; loadData(); }
    
    async function saveRow(id){
        const fd=new FormData(); if(id!=='new') fd.append('id',id);
        const map={'pid':'product_id','title':'title','cat':'category','fin':'finish_time','type':'video_type','host':'host','status':'status','plat':'platform','pub':'publish_time','rem':'remark'};
        for(let [eid,k] of Object.entries(map)) fd.append(k, document.getElementById('ed-'+eid).value.replace('T',' '));
        fd.append('image_url',document.getElementById('ed-img').value);
        await fetch('/api/video/save',{method:'POST',body:fd});
        editingId=null; loadData(); 
    }

    async function upImg(input, id) {
        const fd = new FormData(); fd.append('file', input.files[0]);
        const res = await fetch('/api/upload', {method:'POST', body:fd});
        const d = await res.json();
        document.getElementById('ed-img').value = d.url;
        globalData.find(v => v.id == id || v.id === 'new').image_url = d.url;
        renderTable(globalData);
    }

    function openMulti(input, type) {
        const pop = document.getElementById('multi-pop'); const r = input.getBoundingClientRect();
        const curr = input.value.split(/[,ï¼Œ]/).map(s=>s.trim());
        pop.innerHTML = globalOptions[type].map(o => `<div class="multi-opt" onclick="togOpt('${input.id}','${o}','${type}')"><span class="${curr.includes(o)?'text-blue-600 font-bold w-4':'w-4'}">${curr.includes(o)?'âœ“':''}</span> ${o}</div>`).join('');
        pop.style.top = (r.bottom + window.scrollY) + 'px';
        pop.style.left = (r.left + window.scrollX) + 'px';
        pop.classList.add('show');
    }
    function togOpt(eid,v,type){
        const inp=document.getElementById(eid); let vals=inp.value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s);
        if(vals.includes(v)) vals=vals.filter(i=>i!==v); else vals.push(v);
        inp.value=vals.join(','); openMulti(inp,type);
    }

    function toggleFilter(){ document.getElementById('filter-panel').classList.toggle('open'); }
    function showBig(s){ document.getElementById('big-img').src=s; document.getElementById('preview-modal').classList.add('active'); }
    function resetFilters(){ document.querySelectorAll('#filter-panel input, #filter-panel select').forEach(e=>e.value=''); loadData(1); }
    function changePage(d){ if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
    async function delVideo(id){ if(confirm('åˆ ?')){ await fetch(`/api/video/${id}`,{method:'DELETE'}); loadData(); } }
    
    function openImport(){ document.getElementById('import-modal').classList.add('active'); }
    async function startImport(){ await fetch('/api/import/local',{method:'POST'}); alert('åå°ä»»åŠ¡å·²å¯åŠ¨'); document.getElementById('import-modal').classList.remove('active'); }
    function openSettings(){ document.getElementById('settings-modal').classList.add('active'); 
        document.getElementById('set-hosts').value=globalOptions.hosts.join(',');
        document.getElementById('set-cats').value=globalOptions.categories.join(',');
        document.getElementById('set-types').value=globalOptions.video_types.join(',');
        document.getElementById('set-plats').value=globalOptions.platforms.join(',');
    }
    async function saveSettings(){
        const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})});
        await s('hosts',document.getElementById('set-hosts').value);
        await s('categories',document.getElementById('set-cats').value);
        await s('video_types',document.getElementById('set-types').value);
        await s('platforms',document.getElementById('set-plats').value);
        document.getElementById('settings-modal').classList.remove('active'); loadOptions();
    }
</script>
</body>
</html>