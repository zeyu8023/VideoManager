<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V31.0 Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === å¸ƒå±€æ ¸å¿ƒä¿®å¤ === */
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #1e293b; margin: 0; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }
        
        .sidebar { width: 240px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; box-shadow: 4px 0 24px rgba(0,0,0,0.1); }
        .sidebar-content { flex: 1; overflow-y: auto; }
        
        .main-content { 
            flex: 1; 
            position: relative; /* å…³é”®ï¼šä½œä¸ºç»å¯¹å®šä½çš„çˆ¶å®¹å™¨ */
            height: 100%; 
            background: #f1f5f9; 
            overflow: hidden; 
        }

        /* è§†å›¾å®¹å™¨ï¼šç»å¯¹å®šä½å æ»¡çˆ¶å®¹å™¨ï¼Œç¡®ä¿å†…éƒ¨æ»šåŠ¨ */
        .view-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ä»ªè¡¨ç›˜å’Œäº§å“åº“çš„æ»šåŠ¨åŒºåŸŸ */
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            min-height: 0;
        }

        /* åº“å­˜è¡¨ç‰¹æ®Šå¸ƒå±€ï¼šå¤´éƒ¨å›ºå®šï¼Œè¡¨æ ¼åŒºåŸŸæ»šåŠ¨ */
        .inventory-layout { display: flex; flex-direction: column; height: 100%; }
        .inv-header { flex-shrink: 0; z-index: 20; background: #f1f5f9; }
        .inv-body { 
            flex: 1; 
            overflow: auto; 
            position: relative; 
            margin: 16px 24px; 
            background: white; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* === å…¶ä»–æ ·å¼ === */
        .sidebar-header { height: 64px; display: flex; align-items: center; padding: 0 24px; color: white; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .nav-item { padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: white; border-left-color: #3b82f6; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; flex-shrink: 0; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:space-between; }
        .stat-label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        .stat-num { font-size: 28px; font-weight: 800; color: #0f172a; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 16px; margin-bottom: 24px; flex-shrink: 0; }
        .chart-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 340px; }
        .trend-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 400px; margin-bottom: 24px; flex-shrink: 0; }
        .matrix-box { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 40px; flex-shrink: 0; }
        .matrix-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #334155; background: #f8fafc; }
        .matrix-table { width: 100%; text-align: left; border-collapse: collapse; }
        .matrix-table th { padding: 12px 20px; font-size: 12px; color: #64748b; font-weight: 700; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .matrix-table td { padding: 12px 20px; font-size: 13px; border-bottom: 1px solid #f1f5f9; }
        .val-today { color: #ef4444; font-weight: 700; }

        .toolbar { padding: 16px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; shrink-0; }
        .filter-panel { background: white; border-bottom: 1px solid #e2e8f0; overflow: hidden; transition: max-height 0.3s; max-height: 0; padding: 0 24px; shrink-0; }
        .filter-panel.open { max-height: 600px; padding-top: 20px; padding-bottom: 20px; }
        .main-table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        .main-table th { position: sticky; top: 0; background: #f8fafc; color: #475569; font-weight: 700; font-size: 13px; padding: 12px; border-bottom: 2px solid #e2e8f0; z-index: 10; text-align: left; }
        .main-table td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; color: #334155; }

        /* Pure Text Card Grid */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; padding-bottom: 40px; }
        .prod-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .prod-card:hover { transform: translateY(-2px); box-shadow: 0 8px 12px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
        .prod-card.danger { border-left: 4px solid #ef4444; } .prod-card.safe { border-left: 4px solid #10b981; } .prod-card.warn { border: 2px solid #f59e0b; }
        .pc-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .pc-title { font-weight: 700; font-size: 15px; color: #1e293b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 75%; }
        .pc-badge { font-size: 10px; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: #64748b; }
        .pc-body { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; }
        .pc-num { font-size: 28px; font-weight: 800; line-height: 1; }
        .pc-label { font-size: 11px; color: #64748b; font-weight: 600; margin-top: 4px; }
        .pc-bar-bg { height: 4px; background: #f1f5f9; border-radius: 2px; overflow: hidden; display: flex; }
        .pc-bar-fill { height: 100%; border-radius: 2px; }
        .pc-foot { display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; color: #94a3b8; }

        .t-input { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; outline: none; background: white; height: 34px; }
        .editing { background: #eff6ff !important; }
        .pill { padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; border: 1px solid transparent; }
        .img-cell { width: 44px; height: 44px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-cell:hover::after { content:'+'; position:absolute; inset:0; background:rgba(0,0,0,0.4); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .multi-pop { position: absolute; background: white; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; width: 240px; max-height: 260px; overflow-y: auto; z-index: 40; display: none; }
        .multi-pop.show { display: block; }
        .multi-opt { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .multi-opt:hover { background: #f1f5f9; color: #2563eb; }
        
        @media (max-width: 768px) { .sidebar { width: 60px; } .sidebar-header h1, .nav-text { display: none; } .sidebar-header { padding: 0; justify-content: center; } .nav-item { justify-content: center; padding: 16px 0; } .kpi-grid, .chart-grid, .card-grid { grid-template-columns: 1fr !important; } }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header"><div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-xl">V</div><h1 class="text-xl font-bold text-white tracking-tight ml-3">VideoHub</h1></div>
        <div class="sidebar-content">
            <div class="nav-item active" onclick="switchView('dashboard', this)"><span>ğŸ“Š</span> <span class="nav-text">æ•°æ®é©¾é©¶èˆ±</span></div>
            <div class="nav-item" onclick="switchView('inventory', this)"><span>ğŸ“¦</span> <span class="nav-text">è§†é¢‘åº“å­˜è¡¨</span></div>
            <div class="nav-item" onclick="switchView('product', this)"><span>ğŸ·ï¸</span> <span class="nav-text">äº§å“åº“å­˜ (SPU)</span></div>
        </div>
    </aside>

    <main class="main-content">
        <div id="view-dashboard" class="view-container">
            <div class="scroll-content">
                <div class="kpi-grid">
                    <div class="stat-card border-l-4 border-blue-500"><div class="stat-label text-blue-600">æ€»åº“å­˜</div><div class="stat-num" id="d-total">-</div></div>
                    <div class="stat-card border-l-4 border-purple-500"><div class="stat-label text-purple-600">ç´¯è®¡åˆ†å‘</div><div class="stat-num text-purple-700" id="d-dist">-</div></div>
                    <div class="stat-card border-l-4 border-orange-500"><div class="stat-label text-orange-600">å¾…å‘å¸ƒ</div><div class="stat-num text-orange-700" id="d-pending">-</div></div>
                    <div class="stat-card"><div class="stat-label">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-today-in">0</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-today-out">0</span></div></div>
                    <div class="stat-card"><div class="stat-label">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-month-in">0</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-month-out">0</span></div></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-box"><div class="chart-title">ğŸ† ä¸»æ’­äº§å‡º Top 5</div><div id="chart-host" class="w-full h-full pb-6"></div></div>
                    <div class="chart-box"><div class="chart-title">ğŸ“Š ç±»å‹å æ¯”</div><div id="chart-type" class="w-full h-full pb-6"></div></div>
                    <div class="chart-box"><div class="chart-title">ğŸ•¸ï¸ å¹³å°åˆ†å‘</div><div id="chart-plat" class="w-full h-full pb-6"></div></div>
                </div>
                <div class="trend-box">
                    <div class="chart-title flex justify-between"><span>ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿</span><div class="flex gap-2"><button onclick="loadDashboard('day')" class="text-xs px-2 py-1 rounded bg-slate-100">æ—¥</button><button onclick="loadDashboard('week')" class="text-xs px-2 py-1 rounded bg-slate-100">å‘¨</button><button onclick="loadDashboard('month')" class="text-xs px-2 py-1 rounded bg-slate-100">æœˆ</button></div></div>
                    <div id="chart-trend" class="w-full h-[320px]"></div>
                </div>
                <div class="matrix-box">
                    <div class="matrix-header">ğŸ“± è´¦å·åˆ†å‘çŸ©é˜µ</div>
                    <table class="matrix-table"><thead><tr><th style="width:30%">å¹³å°è´¦å·</th><th style="width:15%">ä»Šæ—¥ğŸ”¥</th><th style="width:15%">æœ¬å‘¨</th><th style="width:15%">æœ¬æœˆ</th><th style="width:25%">å¹´åº¦</th></tr></thead><tbody id="matrix-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="inventory-layout hidden">
            <div class="inv-header">
                <div class="toolbar flex justify-between items-center p-4 bg-white border-b border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 hidden md:block">åº“å­˜æ˜ç»†</h2>
                    <div class="flex gap-2 items-center flex-1 justify-end">
                        <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢..." class="t-input w-48 md:w-64 bg-slate-50 border-transparent focus:bg-white">
                        <button onclick="toggleFilter()" class="px-3 py-1.5 text-sm font-bold text-slate-600 bg-slate-100 rounded hover:bg-slate-200">ç­›é€‰</button>
                        <button onclick="openSettings()" class="px-3 py-1.5 text-sm font-bold text-slate-600 bg-slate-100 rounded hover:bg-slate-200">é…ç½®</button>
                        <button onclick="openImport()" class="px-3 py-1.5 text-sm font-bold text-blue-600 bg-blue-50 rounded hover:bg-blue-100">å¯¼å…¥</button>
                        <button onclick="addNewRow()" class="px-4 py-1.5 text-sm font-bold text-white bg-blue-600 rounded hover:bg-blue-700 shadow flex items-center gap-1"><span>+</span> æ–°å¢</button>
                    </div>
                </div>
                <div id="filter-panel" class="filter-panel">
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-x-4 gap-y-4 py-4 px-6">
                        <div><label class="filter-label">äº§å“</label><input id="s-pid" list="dl-pids" class="t-input" placeholder="è¾“å…¥ç¼–å·..."></div>
                        <div><label class="filter-label">æ ‡é¢˜</label><input id="s-title" class="t-input" placeholder="åŒ…å«æ ‡é¢˜..."></div>
                        <div><label class="filter-label">ç±»å‹</label><select id="s-cat" class="t-input"></select></div>
                        <div><label class="filter-label">è§†ç±»</label><select id="s-type" class="t-input"></select></div>
                        <div><label class="filter-label">ä¸»æ’­</label><select id="s-host" class="t-input"></select></div>
                        <div><label class="filter-label">çŠ¶æ€</label><select id="s-status" class="t-input"></select></div>
                        <div><label class="filter-label">å¹³å°</label><select id="s-plat" class="t-input"></select></div>
                        <div class="col-span-2"><label class="filter-label">å®Œæˆæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-fin-start" class="t-input"><input type="date" id="s-fin-end" class="t-input"></div></div>
                        <div class="col-span-2"><label class="filter-label">å‘å¸ƒæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="t-input"><input type="date" id="s-pub-end" class="t-input"></div></div>
                        <div><label class="filter-label">å¤‡æ³¨</label><input id="s-remark" class="t-input" placeholder="åŒ…å«å¤‡æ³¨..."></div>
                        <div class="col-span-2 md:col-span-6 flex justify-end gap-2 border-t pt-3 mt-2">
                            <button onclick="loadData(1)" class="px-5 py-1.5 bg-slate-800 text-white rounded text-sm font-bold">æŸ¥è¯¢</button>
                            <button onclick="resetFilters()" class="px-5 py-1.5 bg-white border rounded text-sm font-bold">é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="inv-body">
                <table class="main-table"><thead><tr><th class="w-16 text-center">å›¾</th><th class="w-32">äº§å“/ç¼–å·</th><th style="min-width: 260px;">è§†é¢‘æ ‡é¢˜</th><th class="w-24">ç±»å‹</th><th class="w-28">å®Œæˆæ—¶é—´</th><th class="w-24">è§†ç±»</th><th class="w-32">ä¸»æ’­(å¤š)</th><th class="w-24 text-center">çŠ¶æ€</th><th class="w-32">å¹³å°(å¤š)</th><th class="w-32">å‘å¸ƒæ—¶é—´</th><th class="w-40">å¤‡æ³¨</th><th class="w-20 text-center sticky right-0 bg-slate-50 border-l">æ“ä½œ</th></tr></thead><tbody id="table-body"></tbody></table>
            </div>
            
            <div class="inv-header h-12 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-500 font-medium" id="page-info">0 æ¡</span>
                <div class="flex gap-2"><button onclick="changePage(-1)" class="px-3 py-1 bg-slate-100 rounded text-xs font-bold disabled:opacity-50">â—€</button><button onclick="changePage(1)" class="px-3 py-1 bg-slate-100 rounded text-xs font-bold disabled:opacity-50">â–¶</button></div>
            </div>
        </div>

        <div id="view-product" class="view-container hidden">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f8fafc] pt-4 px-6 z-10 shrink-0">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span>ğŸ·ï¸</span> äº§å“åº“å­˜ç›‘æ§ (SPU)</h2>
                <div class="relative">
                    <input id="prod-search" class="t-input w-64 pl-8 rounded-full border-slate-300 focus:border-blue-500" placeholder="æœç´¢äº§å“å‹å·...">
                    <svg class="w-4 h-4 absolute left-2.5 top-2.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            <div class="scroll-content pt-0">
                <div id="product-grid" class="card-grid"></div>
            </div>
        </div>
    </main>
</div>

<div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh]"></div>
<div id="multi-pop" class="multi-pop"></div>
<datalist id="dl-pids"></datalist>
<div id="import-modal" class="modal"><div class="bg-white rounded-xl w-[400px] p-8 text-center"><h3 class="font-bold text-xl mb-4">å¯¼å…¥</h3><p class="text-sm text-slate-500 mb-6">æ–‡ä»¶å­˜å…¥ temp_uploads ç›®å½•</p><button onclick="startImport()" class="w-full bg-slate-800 text-white py-2 rounded font-bold">æ‰«æ</button><button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs">å…³é—­</button></div></div>
<div id="settings-modal" class="modal"><div class="bg-white rounded-xl w-[400px] p-6"><h3 class="font-bold mb-4">é…ç½®</h3><textarea id="set-hosts" class="t-input h-20 mb-2"></textarea><input id="set-cats" class="t-input mb-2"><input id="set-types" class="t-input mb-2"><input id="set-plats" class="t-input mb-2"><button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">ä¿å­˜</button><button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-slate-400 text-xs">å…³é—­</button></div></div>

<script>
    let currPage=1, totalPages=1, globalOptions={}, editingId=null, globalData=[], chartTrend=null;

    (function init() {
        loadDashboard('day'); loadOptions(); loadData(1); loadProductStats();
        document.addEventListener('click', e => { if(!e.target.closest('.multi-pop') && !e.target.closest('.multi-trig')) document.getElementById('multi-pop').classList.remove('show'); });
        document.getElementById('prod-search').addEventListener('input', (e) => Product.search(e.target.value));
    })();

    function switchView(view, btn) {
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active')); btn.classList.add('active');
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-inventory').classList.add('hidden');
        document.getElementById('view-product').classList.add('hidden');
        document.getElementById('view-'+view).classList.remove('hidden');
        if(view === 'dashboard') loadDashboard('day');
        if(view === 'product') loadProductStats();
    }

    // Dashboard Logic
    async function loadDashboard(dim) {
        const res = await fetch(`/api/dashboard?dim=${dim}`); const data = await res.json();
        document.getElementById('d-total').innerText = data.kpi.total;
        document.getElementById('d-dist').innerText = data.kpi.dist;
        document.getElementById('d-pending').innerText = data.kpi.pending;
        document.getElementById('d-today-in').innerText = data.kpi.t_in; 
        document.getElementById('d-today-out').innerText = data.kpi.t_out;
        document.getElementById('d-month-in').innerText = data.kpi.m_in;   
        document.getElementById('d-month-out').innerText = data.kpi.m_out; 
        document.getElementById('matrix-body').innerHTML = data.matrix.map((r, i) => `<tr><td class="font-bold flex items-center gap-2"><span class="w-5 h-5 rounded bg-slate-100 text-slate-500 text-xs flex items-center justify-center">${i+1}</span>${r.name}</td><td class="${r.day>0?'val-today':''}">${r.day}</td><td>${r.week}</td><td>${r.month}</td><td class="font-mono font-bold">${r.year}</td></tr>`).join('');
        if(!chartTrend) chartTrend = echarts.init(document.getElementById('chart-trend'));
        chartTrend.setOption({tooltip:{trigger:'axis'}, legend:{data:['å…¥åº“','å‘å¸ƒ'],bottom:0}, grid:{top:20,left:40,right:20,bottom:30}, xAxis:{type:'category',data:data.trend.dates}, yAxis:{type:'value'}, series:[{name:'å…¥åº“',type:'line',data:data.trend.in,smooth:true,itemStyle:{color:'#3b82f6'},areaStyle:{opacity:0.1}}, {name:'å‘å¸ƒ',type:'bar',data:data.trend.out,itemStyle:{color:'#10b981'}}]});
        echarts.init(document.getElementById('chart-host')).setOption({tooltip:{trigger:'axis'}, grid:{top:10,left:60,right:20,bottom:20}, xAxis:{type:'value'}, yAxis:{type:'category',data:data.hosts.map(i=>i.name).reverse()}, series:[{type:'bar',data:data.hosts.map(i=>i.value).reverse(),itemStyle:{color:'#f59e0b',borderRadius:[0,4,4,0]}}]});
        echarts.init(document.getElementById('chart-type')).setOption({tooltip:{trigger:'item'}, series:[{type:'pie',radius:['40%','70%'],data:data.types}]});
        echarts.init(document.getElementById('chart-plat')).setOption({tooltip:{}, radar:{indicator:data.plats.map(p=>({name:p.name, max:Math.max(...data.plats.map(v=>v.value),10)}))}, series:[{type:'radar',data:[{value:data.plats.map(p=>p.value),name:'åˆ†å‘é‡'}]}]});
    }

    // Product Logic
    const Product = {
        allData: [],
        init: async function() {
            const res = await fetch('/api/product_stats');
            this.allData = await res.json();
            this.render(this.allData);
        },
        search: function(keyword) {
            if(!keyword) { this.render(this.allData); return; }
            const filtered = this.allData.filter(item => item.name && item.name.toLowerCase().includes(keyword.toLowerCase()));
            this.render(filtered);
        },
        render: function(data) {
            const grid = document.getElementById('product-grid');
            if(!grid) return;
            grid.innerHTML = data.map(item => {
                const pct = Math.round(((item.total - item.pending)/item.total)*100)||0;
                let color = '#3b82f6';
                if(item.pending > 5) color='#ef4444'; else if(item.pending === 0) color='#10b981';
                
                return `
                <div class="prod-card" style="border-left: 4px solid ${color}" onclick="jumpTo('${item.name}')">
                    <div class="pc-head">
                        <div class="pc-title" title="${item.name}">${item.name}</div>
                        <span class="pc-badge">SPU</span>
                    </div>
                    <div class="pc-body">
                        <div>
                            <div class="pc-num" style="color: ${color}">${item.pending}</div>
                            <div class="pc-label">å¾…å‘å¸ƒ</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-slate-300">${pct}%</div>
                            <div class="text-xs text-slate-400">å®Œæˆç‡</div>
                        </div>
                    </div>
                    <div class="pc-bar-bg"><div class="pc-bar-fill" style="width: ${pct}%; background-color: ${color}"></div></div>
                    <div class="pc-foot"><span>æ€»åº“å­˜ ${item.total}</span><span>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… &rarr;</span></div>
                </div>`;
            }).join('');
        }
    };
    window.loadProductStats = () => Product.init();

    // Inventory Logic
    function jumpTo(pid) { document.querySelectorAll('.nav-item')[1].click(); document.getElementById('s-pid').value = pid; if(!document.getElementById('filter-panel').classList.contains('open')) toggleFilter(); loadData(1); }
    async function loadOptions() { const res=await fetch('/api/options'); globalOptions=await res.json(); const fill=(id,l)=>document.getElementById(id).innerHTML=`<option value="">å…¨éƒ¨</option>`+l.map(i=>`<option>${i}</option>`).join(''); fill('s-cat',globalOptions.categories); fill('s-type',globalOptions.video_types); fill('s-host',globalOptions.hosts); fill('s-status',globalOptions.statuses); fill('s-plat',globalOptions.platforms); document.getElementById('dl-pids').innerHTML=globalOptions.product_ids.map(i=>`<option>${i}</option>`).join(''); }
    async function loadData(p) { currPage=p||currPage; const params=new URLSearchParams({page:currPage, size:100, keyword:document.getElementById('g-search').value, product_id:document.getElementById('s-pid').value, title:document.getElementById('s-title').value, remark:document.getElementById('s-remark').value, host:document.getElementById('s-host').value, status:document.getElementById('s-status').value, category:document.getElementById('s-cat').value, video_type:document.getElementById('s-type').value, platform:document.getElementById('s-plat').value, finish_start:document.getElementById('s-fin-start').value, finish_end:document.getElementById('s-fin-end').value, publish_start:document.getElementById('s-pub-start').value, publish_end:document.getElementById('s-pub-end').value}); const res=await fetch(`/api/videos?${params}`); const data=await res.json(); globalData=data.items; totalPages=data.total_pages; document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`; renderTable(data.items); }
    function addNewRow() { globalData.unshift({id:'new', product_id:'', title:'', isNew:true}); editingId='new'; renderTable(globalData); document.querySelector('.table-wrap').scrollTop = 0; }
    function renderTable(items) { document.getElementById('table-body').innerHTML = items.map(v => { const isEdit = (v.id === editingId); const cln = s => (s && s!=='nan' && s!=='None') ? s : ''; const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png'; if (isEdit) { const sel=(k,l)=>`<select id="ed-${k}" class="t-input">${l.map(o=>`<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`; const mul=(k,t)=>`<input id="ed-${k}" class="t-input multi-trig cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this,'${t}')" placeholder="ç‚¹å‡»é€‰æ‹©">`; return `<tr class="editing ${v.isNew?'new-row':''}"> <td class="p-2"><div class="img-cell mx-auto" onclick="document.getElementById('up-${v.id}').click()" ondrop="handleDrop(event,'${v.id}')" ondragover="event.preventDefault()" onpaste="handlePaste(event,'${v.id}')"><img src="${img}" class="w-full h-full object-cover"></div><input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this,'${v.id}')"><input type="hidden" id="ed-img" value="${cln(v.image_url)}"></td> <td><input id="ed-pid" class="t-input" value="${cln(v.product_id)}" placeholder="ç¼–å·"></td><td><input id="ed-title" class="t-input font-bold" value="${cln(v.title)}" placeholder="æ ‡é¢˜"></td><td>${sel('cat',globalOptions.categories)}</td><td><input id="ed-fin" type="date" class="t-input" value="${cln(v.finish_time)}"></td><td>${sel('type',globalOptions.video_types)}</td><td>${mul('host','hosts')}</td><td>${sel('status',globalOptions.statuses)}</td><td>${mul('plat','platforms')}</td><td><input id="ed-pub" type="datetime-local" class="t-input" value="${cln(v.publish_time).replace(' ','T')}"></td><td><input id="ed-rem" class="t-input" value="${cln(v.remark)}"></td> <td class="text-center sticky right-0 bg-blue-50 border-l"><button onclick="saveRow('${v.id}')" class="text-blue-600 font-bold text-xs">ä¿å­˜</button> <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1">å–æ¶ˆ</button></td></tr>`; } const pill = (s,t) => s.split(/[,ï¼Œ]/).map(x=>`<span class="pill" style="background:${t==='st'?(x.includes('å·²')?'#dcfce7':'#fff7ed'):'#f1f5f9'};color:${t==='st'?(x.includes('å·²')?'#166534':'#c2410c'):'#475569'}">${x}</span>`).join(''); return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-2 text-center"><div class="img-cell mx-auto bg-slate-100" onclick="showBig('${img}')" ondrop="handleDrop(event,'${v.id}')" ondragover="event.preventDefault()" onpaste="handlePaste(event,'${v.id}')"><img src="${img}" class="w-full h-full object-cover"></div></td><td class="font-mono text-slate-500">${cln(v.product_id)}</td><td class="font-bold text-slate-700 truncate" style="max-width:260px" title="${cln(v.title)}">${cln(v.title)}</td><td><span class="pill bg-slate-100">${cln(v.category)}</span></td><td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td><td><span class="pill bg-slate-100">${cln(v.video_type)}</span></td><td>${pill(cln(v.host),'')}</td><td class="text-center">${pill(cln(v.status),'st')}</td><td>${pill(cln(v.platform),'')}</td><td class="text-slate-400 text-xs font-mono">${cln(v.publish_time).replace('T',' ')}</td><td class="text-slate-400 truncate max-w-[100px] text-xs" title="${cln(v.remark)}">${cln(v.remark)}</td><td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l"><button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button><button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button></td></tr>`; }).join(''); }
    function startEdit(id){ editingId=id; renderTable(globalData); }
    function cancelEdit(){ editingId=null; loadData(); }
    async function saveRow(id){ const fd=new FormData(); if(id!=='new') fd.append('id',id); const map={'pid':'product_id','title':'title','cat':'category','fin':'finish_time','type':'video_type','host':'host','status':'status','plat':'platform','pub':'publish_time','rem':'remark'}; for(let [eid,k] of Object.entries(map)) fd.append(k, document.getElementById('ed-'+eid).value.replace('T',' ')); fd.append('image_url',document.getElementById('ed-img').value); await fetch('/api/video/save',{method:'POST',body:fd}); editingId=null; loadData(); }
    async function handleDrop(e,id){ e.preventDefault(); if(e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0], id); }
    async function handlePaste(e,id){ if(e.clipboardData.files[0]) uploadFile(e.clipboardData.files[0], id); }
    async function upImg(input,id){ if(input.files[0]) uploadFile(input.files[0], id); }
    async function uploadFile(file, id){ const fd = new FormData(); fd.append('file', file); const res = await fetch('/api/upload', {method:'POST', body:fd}); const d = await res.json(); if(editingId == id) { document.getElementById('ed-img').value = d.url; } else { const fd2=new FormData(); fd2.append('id',id); fd2.append('image_url',d.url); await fetch('/api/video/save',{method:'POST',body:fd2}); } const row = globalData.find(v => v.id == id || (id==='new' && v.id==='new')); if(row) row.image_url = d.url; renderTable(globalData); }
    function openMulti(input,type){ const pop=document.getElementById('multi-pop'); const r=input.getBoundingClientRect(); const curr=input.value.split(/[,ï¼Œ]/).map(s=>s.trim()); pop.innerHTML=globalOptions[type].map(o=>`<div class="multi-opt" onclick="togOpt('${input.id}','${o}','${type}')"><span class="${curr.includes(o)?'text-blue-600 font-bold w-4':'w-4'}">${curr.includes(o)?'âœ“':''}</span> ${o}</div>`).join(''); pop.style.top=(r.bottom+window.scrollY)+'px'; pop.style.left=(r.left+window.scrollX)+'px'; pop.classList.add('show'); }
    function togOpt(eid,v,type){ const inp=document.getElementById(eid); let vals=inp.value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); if(vals.includes(v)) vals=vals.filter(i=>i!==v); else vals.push(v); inp.value=vals.join(','); openMulti(inp,type); }
    function toggleFilter(){ document.getElementById('filter-panel').classList.toggle('open'); }
    function showBig(s){ document.getElementById('big-img').src=s; document.getElementById('preview-modal').classList.add('active'); }
    function resetFilters(){ document.querySelectorAll('#filter-panel input,select').forEach(e=>e.value=''); loadData(1); }
    function changePage(d){ if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
    async function delVideo(id){ if(confirm('åˆ ?')){ await fetch(`/api/video/${id}`,{method:'DELETE'}); loadData(); } }
    function openImport(){ document.getElementById('import-modal').classList.add('active'); }
    async function startImport(){ await fetch('/api/import/local',{method:'POST'}); alert('åå°ä»»åŠ¡å·²å¯åŠ¨'); document.getElementById('import-modal').classList.remove('active'); }
    function openSettings(){ document.getElementById('settings-modal').classList.add('active'); document.getElementById('set-hosts').value=globalOptions.hosts.join(','); document.getElementById('set-cats').value=globalOptions.categories.join(','); document.getElementById('set-types').value=globalOptions.video_types.join(','); document.getElementById('set-plats').value=globalOptions.platforms.join(','); }
    async function saveSettings(){ const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})}); await s('hosts',document.getElementById('set-hosts').value); await s('categories',document.getElementById('set-cats').value); await s('video_types',document.getElementById('set-types').value); await s('platforms',document.getElementById('set-plats').value); document.getElementById('settings-modal').classList.remove('active'); loadOptions(); }
</script>
</body>
</html>