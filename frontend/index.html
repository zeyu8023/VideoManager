<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub Pro Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 1. å­—ä½“ç»Ÿä¸€ */
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* 2. è¡¨æ ¼åˆ—å®½æ‹–åŠ¨ç›¸å…³ */
        table { border-collapse: collapse; table-layout: fixed; width: 100%; }
        th { position: relative; font-size: 13px; font-weight: 700; color: #475569; padding: 12px 8px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr:hover td { background: #f8fafc; }
        
        /* æ‹–æ‹½æ‰‹æŸ„ */
        .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; z-index: 10; }
        .resizer:hover, .resizing { background-color: #3b82f6; }

        /* ç¼–è¾‘æ¡† */
        .table-input { width: 100%; border: 1px solid transparent; background: transparent; padding: 4px; border-radius: 4px; font-size: 14px; color: inherit; transition: all 0.2s; }
        .table-input:focus, .editing .table-input { background: white; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); outline: none; }
        
        /* å›¾ç‰‡åŒºåŸŸ */
        .img-zone { position: relative; overflow: hidden; cursor: pointer; border-radius: 6px; border: 1px solid #e2e8f0; background: #f8fafc; }
        .img-zone:hover::after { content: 'æ›¿æ¢'; position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .badge { padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; }
        .badge-wait { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .badge-done { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }

        /* æ¨¡æ€æ¡† */
        .modal { transition: opacity 0.2s; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow">V</div>
            <h1 class="text-lg font-bold text-slate-800">VideoHub <span class="text-xs font-normal text-slate-400">Ult</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="openSettings()" class="text-xs font-bold text-slate-500 hover:text-blue-600 flex items-center gap-1 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                <span>âš™ï¸ å…¨å±€é…ç½®</span>
            </button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-500">ZY</div>
            </div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-4 z-20 shrink-0">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-[2000px] mx-auto">
            <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-slate-400 uppercase">æ€»è§†é¢‘èµ„äº§</div><div class="text-3xl font-black text-slate-800" id="st-total">-</div></div>
                <div class="text-3xl">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-orange-400 uppercase">å¾…å‘å¸ƒåº“å­˜</div><div class="text-3xl font-black text-orange-500" id="st-pending">-</div></div>
                <div class="text-3xl">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-emerald-400 uppercase">æœ¬æœˆåŠ³æ¨¡</div><div class="text-3xl font-black text-emerald-600" id="st-host">-</div></div>
                <div class="text-3xl">ğŸ†</div>
            </div>
        </div>
    </div>

    <div class="flex-1 p-4 overflow-hidden flex flex-col max-w-[2000px] mx-auto w-full">
        <div class="flex flex-wrap items-center gap-2 mb-3 bg-white p-2 rounded-lg border border-slate-200 shadow-sm shrink-0">
            <input id="q-key" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="ğŸ” æœç´¢..." class="px-3 py-1.5 w-48 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <select id="q-host" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none"></select>
            <select id="q-status" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none"></select>
            <select id="q-cat" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none"></select>
            <button onclick="loadData(1)" class="px-4 py-1.5 bg-blue-600 text-white font-bold text-sm rounded hover:bg-blue-700 ml-auto">æŸ¥è¯¢</button>
            <button onclick="scanLocal()" class="px-3 py-1.5 bg-slate-700 text-white font-bold text-sm rounded hover:bg-slate-800">å¯¼å…¥</button>
            <button onclick="openAddModal()" class="px-3 py-1.5 bg-emerald-600 text-white font-bold text-sm rounded hover:bg-emerald-700">æ–°å¢</button>
        </div>

        <div class="bg-white border border-slate-200 rounded-lg shadow-sm flex flex-col flex-1 overflow-hidden relative">
            <div class="overflow-auto flex-1 w-full h-full" id="table-container">
                <table id="main-table">
                    <thead class="sticky top-0 z-10">
                        <tr id="table-header">
                            <th data-key="img" style="width: 60px">å›¾<div class="resizer"></div></th>
                            <th data-key="pid" contenteditable="true" onblur="saveHeader(this)" style="width: 100px">ç¼–å·<div class="resizer"></div></th>
                            <th data-key="title" contenteditable="true" onblur="saveHeader(this)" style="width: 250px">æ ‡é¢˜<div class="resizer"></div></th>
                            <th data-key="type" contenteditable="true" onblur="saveHeader(this)" style="width: 80px">ç±»å‹<div class="resizer"></div></th>
                            <th data-key="host" contenteditable="true" onblur="saveHeader(this)" style="width: 80px">ä¸»æ’­<div class="resizer"></div></th>
                            <th data-key="status" contenteditable="true" onblur="saveHeader(this)" style="width: 80px">çŠ¶æ€<div class="resizer"></div></th>
                            <th data-key="plat" contenteditable="true" onblur="saveHeader(this)" style="width: 100px">å¹³å°<div class="resizer"></div></th>
                            <th data-key="pub_time" contenteditable="true" onblur="saveHeader(this)" style="width: 120px">å‘å¸ƒæ—¶é—´<div class="resizer"></div></th>
                            <th data-key="remark" contenteditable="true" onblur="saveHeader(this)" style="width: 150px">å¤‡æ³¨<div class="resizer"></div></th>
                            <th data-key="op" style="width: 100px; text-align: center;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="border-t border-slate-200 px-4 py-2 flex justify-between items-center bg-slate-50 shrink-0 text-sm">
                <span class="text-slate-500">å…± <b id="total-count">0</b> æ¡</span>
                <div class="space-x-1">
                    <button onclick="changePage(-1)" class="px-2 py-1 border rounded bg-white hover:bg-slate-100">ä¸Šä¸€é¡µ</button>
                    <button onclick="changePage(1)" class="px-2 py-1 border rounded bg-white hover:bg-slate-100">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[400px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">å…¨å±€é…ç½®</h3>
            <textarea id="set-hosts" class="w-full p-2 border rounded mb-2 text-sm h-20" placeholder="ä¸»æ’­åˆ—è¡¨..."></textarea>
            <input id="set-cats" class="w-full p-2 border rounded mb-2 text-sm" placeholder="åˆ†ç±»...">
            <input id="set-plats" class="w-full p-2 border rounded mb-4 text-sm" placeholder="å¹³å°...">
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">ä¿å­˜</button>
            <button onclick="closeSettings()" class="w-full mt-2 text-slate-400 text-sm">å…³é—­</button>
        </div>
    </div>
    
    <div id="add-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[500px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-2 gap-3">
                <input name="product_id" placeholder="ç¼–å·*" required class="p-2 border rounded text-sm">
                <input name="title" placeholder="æ ‡é¢˜*" required class="p-2 border rounded text-sm">
                <select name="host" id="add-host" class="p-2 border rounded text-sm"></select>
                <select name="status" id="add-status" class="p-2 border rounded text-sm"></select>
                <button type="button" onclick="closeAddModal()" class="text-slate-500 text-sm">å–æ¶ˆ</button>
                <button type="submit" class="bg-blue-600 text-white py-2 rounded font-bold text-sm">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script>
        let currPage = 1, totalPages = 1, globalData = [], globalOptions = {}, editingId = null;

        // åˆå§‹åŒ–
        (async () => {
            initResizers(); // 1. åˆå§‹åŒ–åˆ—å®½æ‹–åŠ¨
            loadHeaderLabels(); // 2. åŠ è½½è¡¨å¤´åç§°
            await loadSettings();
            await loadData(1);
            updateStats();
        })();

        // --- æ ¸å¿ƒé€»è¾‘ ---
        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                keyword: document.getElementById('q-key').value,
                host: document.getElementById('q-host').value,
                status: document.getElementById('q-status').value,
                category: document.getElementById('q-cat').value
            });
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            document.getElementById('total-count').innerText = data.total;
            renderTable(data.items);
        }

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                const isEdit = (v.id === editingId);
                
                // çŠ¶æ€é¢œè‰²
                let stClass = "bg-slate-100 text-slate-500";
                if(v.status === 'å¾…å‘å¸ƒ') stClass = "badge-wait";
                if(v.status === 'å·²å‘å¸ƒ') stClass = "badge-done";

                if(isEdit) return `
                    <tr class="bg-blue-50/50 editing">
                        <td class="text-center text-xs">å›¾</td>
                        <td><input id="ed-pid" class="table-input" value="${v.product_id}"></td>
                        <td><input id="ed-title" class="table-input" value="${v.title}"></td>
                        <td><input id="ed-type" class="table-input" value="${v.video_type||''}"></td>
                        <td><input id="ed-host" class="table-input" value="${v.host||''}"></td>
                        <td><input id="ed-status" class="table-input" value="${v.status||''}"></td>
                        <td><input id="ed-plat" class="table-input" value="${v.platform||''}"></td>
                        <td><input id="ed-pub" type="datetime-local" class="table-input" value="${(v.publish_time||'').replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="table-input" value="${v.remark||''}"></td>
                        <td class="text-center">
                            <button onclick="saveRow(${v.id})" class="text-blue-600 font-bold text-xs mr-2">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs">å–æ¶ˆ</button>
                        </td>
                    </tr>`;

                return `
                <tr class="hover:bg-slate-50 group">
                    <td class="p-1">
                        <div class="w-10 h-10 rounded mx-auto img-zone" 
                             onpaste="handlePaste(event, ${v.id})" 
                             ondrop="handleDrop(event, ${v.id})" 
                             ondragover="event.preventDefault()">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td title="${v.product_id}">${v.product_id}</td>
                    <td title="${v.title}" class="font-bold text-slate-700">${v.title}</td>
                    <td>${v.video_type||'-'}</td>
                    <td class="font-bold">${v.host||'-'}</td>
                    <td class="text-center"><span class="badge ${stClass}">${v.status||'-'}</span></td>
                    <td>${v.platform||'-'}</td>
                    <td class="text-xs text-slate-400 font-mono">${(v.publish_time||'').split(' ')[0]}</td>
                    <td class="text-xs text-slate-400">${v.remark||''}</td>
                    <td class="text-center">
                        <button onclick="editRow(${v.id})" class="text-blue-600 text-xs font-bold mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- å›¾ç‰‡ä¿®å¤é€»è¾‘ ---
        async function uploadImg(file, id) {
            // 1. ä¸Šä¼ æ–‡ä»¶
            const fd = new FormData();
            fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const data = await res.json(); // {url: "..."}

            // 2. è·å–æ—§æ•°æ®ï¼Œé˜²æ­¢è¦†ç›–æ¸…ç©º
            const row = globalData.find(v => v.id === id);
            
            // 3. æ„é€ ä¿å­˜è¯·æ±‚ (å¿…é¡»å¸¦ä¸Š ID å’Œå…¶ä»–å¿…å¡«é¡¹)
            const saveFd = new FormData();
            saveFd.append('id', id);
            saveFd.append('image_url', data.url); 
            // è¡¥å…¨å¿…å¡«é¡¹ (è™½ç„¶æˆ‘ä»¬åç«¯æ”¹æˆäº† Optionalï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§å¸¦ä¸Šä¸»è¦ä¿¡æ¯)
            saveFd.append('product_id', row.product_id);
            saveFd.append('title', row.title);

            await fetch('/api/video/save', {method:'POST', body:saveFd});
            loadData(); // åˆ·æ–°
        }
        function handleDrop(e, id) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadImg(e.dataTransfer.files[0], id); }
        function handlePaste(e, id) { if(e.clipboardData.files[0]) uploadImg(e.clipboardData.files[0], id); }

        // --- åˆ—å®½æ‹–æ‹½ (Resizing) ---
        function initResizers() {
            const table = document.getElementById('main-table');
            const ths = table.getElementsByTagName('th');
            
            // æ¢å¤ä¿å­˜çš„åˆ—å®½
            const saved = JSON.parse(localStorage.getItem('colWidths') || '{}');
            for(let th of ths) {
                const key = th.getAttribute('data-key');
                if(saved[key]) th.style.width = saved[key];
            }

            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            document.querySelectorAll('.resizer').forEach(resizer => {
                let x = 0, w = 0, col = null;
                resizer.addEventListener('mousedown', e => {
                    col = e.target.parentElement;
                    x = e.pageX;
                    w = col.offsetWidth;
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    col.classList.add('resizing');
                });
                
                function mouseMoveHandler(e) {
                    const dx = e.pageX - x;
                    col.style.width = `${w + dx}px`;
                }
                
                function mouseUpHandler() {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    col.classList.remove('resizing');
                    // ä¿å­˜å®½åº¦
                    const current = JSON.parse(localStorage.getItem('colWidths') || '{}');
                    current[col.getAttribute('data-key')] = col.style.width;
                    localStorage.setItem('colWidths', JSON.stringify(current));
                }
            });
        }

        // --- è¡¨å¤´ç¼–è¾‘ ---
        function saveHeader(el) {
            const key = el.parentElement.getAttribute('data-key');
            const labels = JSON.parse(localStorage.getItem('colLabels') || '{}');
            labels[key] = el.innerText.trim(); // ä¿å­˜æ–°åå­—
            localStorage.setItem('colLabels', JSON.stringify(labels));
        }
        function loadHeaderLabels() {
            const labels = JSON.parse(localStorage.getItem('colLabels') || '{}');
            document.querySelectorAll('th[data-key]').forEach(th => {
                const key = th.getAttribute('data-key');
                // åªæ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¿ç•™ resizer div
                if(labels[key]) th.firstChild.textContent = labels[key]; 
            });
        }

        // --- å¸¸è§„é€»è¾‘ ---
        function editRow(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        async function saveRow(id) {
            const fd = new FormData();
            fd.append('id', id);
            fd.append('product_id', document.getElementById('ed-pid').value);
            fd.append('title', document.getElementById('ed-title').value);
            fd.append('host', document.getElementById('ed-host').value);
            fd.append('status', document.getElementById('ed-status').value);
            fd.append('video_type', document.getElementById('ed-type').value);
            fd.append('platform', document.getElementById('ed-plat').value);
            fd.append('publish_time', document.getElementById('ed-pub').value.replace('T', ' '));
            fd.append('remark', document.getElementById('ed-rem').value);
            await fetch('/api/video/save', {method:'POST', body:fd});
            cancelEdit(); loadData(); updateStats();
        }

        async function loadSettings() {
            const res = await fetch('/api/settings');
            globalOptions = await res.json();
            fillSel('q-host', globalOptions.hosts, 'å…¨éƒ¨ä¸»æ’­');
            fillSel('q-status', globalOptions.statuses, 'å…¨éƒ¨çŠ¶æ€');
            fillSel('q-cat', globalOptions.categories, 'å…¨éƒ¨åˆ†ç±»');
            
            fillSel('add-host', globalOptions.hosts, 'é€‰æ‹©ä¸»æ’­');
            fillSel('add-status', globalOptions.statuses, 'é€‰æ‹©çŠ¶æ€');
        }
        function fillSel(id, items, def) {
            const el = document.getElementById(id);
            if(el) el.innerHTML = `<option value="">${def}</option>` + (items||[]).map(i=>`<option value="${i}">${i}</option>`).join('');
        }

        function openSettings() { 
            document.getElementById('settings-modal').classList.add('active'); 
            document.getElementById('set-hosts').value = globalOptions.hosts.join(',');
            document.getElementById('set-cats').value = globalOptions.categories.join(',');
            document.getElementById('set-plats').value = globalOptions.platforms.join(',');
        }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
        async function saveSettings() {
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'hosts', value:document.getElementById('set-hosts').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'categories', value:document.getElementById('set-cats').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'platforms', value:document.getElementById('set-plats').value})});
            closeSettings(); loadSettings();
        }

        function openAddModal() { document.getElementById('add-modal').classList.add('active'); }
        function closeAddModal() { document.getElementById('add-modal').classList.remove('active'); }
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/api/video/save', {method:'POST', body:new FormData(e.target)});
            closeAddModal(); loadData(1);
        };
        
        async function updateStats() { try { const r=await fetch('/api/stats'); const d=await r.json(); document.getElementById('st-total').innerText=d.total; document.getElementById('st-pending').innerText=d.pending; document.getElementById('st-host').innerText=d.host; }catch(e){} }
        function changePage(d) { if(currPage+d>0) loadData(currPage+d); }
        async function delVideo(id) { if(confirm('åˆ ?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); } }
        async function scanLocal() { if(confirm('å¯¼å…¥?')) { fetch('/api/import/local', {method:'POST'}); alert('å¯¼å…¥ä¸­'); } }
    </script>
</body>
</html>