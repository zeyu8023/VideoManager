<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V43.0 UI Perfect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === æ ¸å¿ƒå¸ƒå±€ === */
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #334155; margin: 0; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }
        .hidden { display: none !important; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; box-shadow: 4px 0 24px rgba(0,0,0,0.1); }
        .sidebar-header { height: 64px; display: flex; align-items: center; padding: 0 24px; color: white; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; }
        .nav-item { padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: white; border-left-color: #3b82f6; }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content { flex: 1; position: relative; height: 100%; background: #f1f5f9; overflow: hidden; }
        .view-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden; }
        .scroll-content { flex: 1; overflow-y: auto; padding: 24px; min-height: 0; scrollbar-width: thin; }

        /* ä»ªè¡¨ç›˜ç»„ä»¶ */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:space-between; }
        .stat-num { font-size: 28px; font-weight: 800; color: #0f172a; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 16px; margin-bottom: 24px; }
        .chart-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 360px; display: flex; flex-direction: column; }
        .trend-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 380px; margin-bottom: 24px; }
        
        /* === çŸ©é˜µåˆ†å‘ (Matrix) ç¾åŒ– === */
        .matrix-box { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; height: 360px; display: flex; flex-direction: column; }
        .matrix-header { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-weight: 700; color: #334155; display: flex; justify-content: space-between; align-items: center; }
        .matrix-list { flex: 1; overflow-y: auto; padding: 0 12px; }
        .matrix-item { display: flex; align-items: center; padding: 12px 8px; border-bottom: 1px dashed #f1f5f9; transition: all 0.2s; }
        .matrix-item:last-child { border-bottom: none; }
        .matrix-item:hover { background: #f8fafc; transform: translateX(4px); }
        .rank-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 12px; font-weight: 800; color: #94a3b8; }
        .rank-top-1 { font-size: 20px; } .rank-top-2 { font-size: 18px; } .rank-top-3 { font-size: 18px; }
        .acc-info { flex: 1; }
        .acc-name { font-weight: 600; font-size: 13px; color: #334155; margin-bottom: 4px; }
        .acc-bar-bg { height: 6px; background: #f1f5f9; border-radius: 3px; width: 100%; overflow: hidden; }
        .acc-bar-fill { height: 100%; border-radius: 3px; background: #3b82f6; }
        .acc-stat { width: 80px; text-align: right; }
        .acc-val { font-weight: 800; color: #0f172a; font-size: 14px; }
        .acc-sub { font-size: 10px; color: #94a3b8; }

        /* === åº“å­˜è¡¨ - æ·±åº¦å¸ƒå±€ä¼˜åŒ– === */
        .inventory-layout { display: flex; flex-direction: column; height: 100%; }
        .inv-header { flex-shrink: 0; z-index: 20; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .toolbar { padding: 16px 24px; background: white; display: flex; justify-content: space-between; align-items: center; }
        .filter-panel { background: white; border-bottom: 1px solid #e2e8f0; overflow: hidden; transition: max-height 0.3s; max-height: 0; padding: 0 24px; }
        .filter-panel.open { max-height: 600px; padding-top: 20px; padding-bottom: 20px; }
        .inv-body { flex: 1; overflow: auto; position: relative; margin: 16px 24px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* è¡¨æ ¼åˆ—å®½æ§åˆ¶ */
        .main-table { width: 100%; table-layout: fixed; border-collapse: collapse; min-width: 1400px; }
        .main-table th { position: sticky; top: 0; background: #f8fafc; color: #475569; font-weight: 600; font-size: 13px; padding: 14px 12px; border-bottom: 1px solid #e2e8f0; text-align: left; z-index: 10; white-space: nowrap; }
        .main-table td { padding: 12px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; color: #334155; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .main-table tr:hover td { background: #f8fafc; }
        
        /* æ ‡é¢˜åˆ—ï¼šè‡ªåŠ¨æ¢è¡Œï¼Œéœ¸å å‰©ä½™ç©ºé—´ */
        .col-title { white-space: normal !important; line-height: 1.5; font-weight: 600; color: #1e293b; }
        /* å¤‡æ³¨åˆ—ï¼šä¿æŒå•è¡Œæˆªæ–­ï¼Œé¼ æ ‡æ‚¬æµ®çœ‹è¯¦æƒ… */
        .col-remark { max-width: 120px; color: #94a3b8; cursor: help; }

        /* èƒ¶å›Šæ ‡ç­¾ */
        .pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-right: 4px; border: 1px solid transparent; }
        
        /* æ§ä»¶ */
        .t-input { width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; background: white; height: 34px; }
        .btn { padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; border: 1px solid transparent; }
        .btn-primary { background: #0f172a; color: white; } .btn-primary:hover { background: #334155; }
        .btn-secondary { background: white; border-color: #cbd5e1; color: #475569; } .btn-secondary:hover { background: #f1f5f9; }
        .btn-blue { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .img-cell { width: 40px; height: 40px; border-radius: 4px; border: 1px solid #e2e8f0; background: #f8fafc; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* äº§å“å¡ç‰‡ */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding-bottom: 40px; }
        .prod-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .prod-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .multi-pop { position: absolute; background: white; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; width: 200px; max-height: 260px; overflow-y: auto; z-index: 60; display: none; }
        .multi-pop.show { display: block; }
        .multi-opt { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .multi-opt:hover { background: #f1f5f9; color: #2563eb; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header"><div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-xl mr-3 shadow">V</div>VideoHub</div>
        <div class="sidebar-content mt-4">
            <div class="nav-item active" onclick="switchView('dashboard', this)"><span>ğŸ“Š</span> <span>æ•°æ®é©¾é©¶èˆ±</span></div>
            <div class="nav-item" onclick="switchView('inventory', this)"><span>ğŸ“¦</span> <span>è§†é¢‘åº“å­˜è¡¨</span></div>
            <div class="nav-item" onclick="switchView('product', this)"><span>ğŸ·ï¸</span> <span>äº§å“åº“å­˜ (SPU)</span></div>
        </div>
    </aside>

    <main class="main-content">
        <div id="view-dashboard" class="view-container">
            <div class="scroll-content">
                <div class="kpi-grid">
                    <div class="stat-card border-l-4 border-blue-500"><div class="text-xs font-bold text-slate-500 uppercase mb-2">æ€»åº“å­˜</div><div class="stat-num" id="d-total">-</div></div>
                    <div class="stat-card border-l-4 border-purple-500"><div class="text-xs font-bold text-slate-500 uppercase mb-2">ç´¯è®¡åˆ†å‘</div><div class="stat-num text-purple-700" id="d-dist">-</div></div>
                    <div class="stat-card border-l-4 border-orange-500"><div class="text-xs font-bold text-slate-500 uppercase mb-2">å¾…å‘å¸ƒ</div><div class="stat-num text-orange-700" id="d-pending">-</div></div>
                    <div class="stat-card"><div class="text-xs font-bold text-slate-500 uppercase mb-2">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-today-in">-</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-today-out">-</span></div></div>
                    <div class="stat-card"><div class="text-xs font-bold text-slate-500 uppercase mb-2">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-month-in">-</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-month-out">-</span></div></div>
                </div>
                <div class="trend-box">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700">ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿</h3><div class="flex gap-2"><button onclick="loadDashboard('day')" class="btn btn-secondary py-1 text-xs">æ—¥</button><button onclick="loadDashboard('week')" class="btn btn-secondary py-1 text-xs">å‘¨</button><button onclick="loadDashboard('month')" class="btn btn-secondary py-1 text-xs">æœˆ</button></div></div>
                    <div id="chart-trend" class="w-full h-[320px]"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ† ä¸»æ’­äº§å‡º Top 5</div><div id="chart-host" class="w-full h-full pb-4"></div></div>
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ“Š ç±»å‹å æ¯”</div><div id="chart-type" class="w-full h-full pb-4"></div></div>
                    <div class="matrix-box">
                        <div class="matrix-header">
                            <span>ğŸ“± è´¦å·çŸ©é˜µçƒ­åº¦</span>
                            <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">Annual</span>
                        </div>
                        <div class="matrix-list" id="matrix-list">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="inventory-layout hidden">
            <div class="inv-header">
                <div class="toolbar">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span>ğŸ“¦</span> åº“å­˜æ˜ç»†</h2>
                    <div class="flex gap-2 items-center flex-1 justify-end">
                        <div class="relative">
                            <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢..." class="t-input w-56 pl-8">
                            <span class="absolute left-2.5 top-2.5 text-slate-400">ğŸ”</span>
                        </div>
                        <button onclick="toggleFilter()" class="btn btn-secondary">ç­›é€‰</button>
                        <button onclick="openSettings()" class="btn btn-secondary">é…ç½®</button>
                        <button onclick="openImport()" class="btn btn-blue">å¯¼å…¥</button>
                        <button onclick="addNewRow()" class="btn btn-primary">æ–°å¢</button>
                    </div>
                </div>
                <div id="filter-panel" class="filter-panel">
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-x-4 gap-y-4 py-4 px-6">
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">ç¼–å·</label><input id="s-pid" list="dl-pids" class="t-input"></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">æ ‡é¢˜</label><input id="s-title" class="t-input"></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">ç±»å‹</label><select id="s-cat" class="t-input"></select></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">è§†ç±»</label><select id="s-type" class="t-input"></select></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">ä¸»æ’­</label><select id="s-host" class="t-input"></select></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">çŠ¶æ€</label><select id="s-status" class="t-input"></select></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">å¹³å°</label><select id="s-plat" class="t-input"></select></div>
                        <div class="col-span-2"><label class="text-xs font-bold text-slate-500 mb-1 block">å®Œæˆæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-fin-start" class="t-input"><input type="date" id="s-fin-end" class="t-input"></div></div>
                        <div class="col-span-2"><label class="text-xs font-bold text-slate-500 mb-1 block">å‘å¸ƒæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="t-input"><input type="date" id="s-pub-end" class="t-input"></div></div>
                        <div><label class="text-xs font-bold text-slate-500 mb-1 block">å¤‡æ³¨</label><input id="s-remark" class="t-input"></div>
                        <div class="col-span-2 md:col-span-6 flex justify-end gap-2 border-t pt-3 mt-2">
                            <button onclick="loadData(1)" class="btn btn-primary">æŸ¥è¯¢</button>
                            <button onclick="resetFilters()" class="btn btn-secondary">é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="inv-body">
                <table class="main-table">
                    <colgroup>
                        <col style="width: 60px;">  <col style="width: 110px;"> <col style="width: auto;">  <col style="width: 80px;">  <col style="width: 110px;"> <col style="width: 80px;">  <col style="width: 100px;"> <col style="width: 100px;"> <col style="width: 140px;"> <col style="width: 140px;"> <col style="width: 100px;"> <col style="width: 70px;">  </colgroup>
                    <thead>
                        <tr>
                            <th class="text-center">å›¾</th>
                            <th>äº§å“/ç¼–å·</th>
                            <th>è§†é¢‘æ ‡é¢˜</th>
                            <th>è§†ç±»</th>
                            <th>å®Œæˆæ—¶é—´</th>
                            <th>åˆ†ç±»</th>
                            <th>ä¸»æ’­</th>
                            <th class="text-center">çŠ¶æ€</th>
                            <th>å‘å¸ƒå¹³å°</th>
                            <th>å‘å¸ƒæ—¶é—´</th>
                            <th>å¤‡æ³¨</th>
                            <th class="text-center sticky right-0 bg-slate-50 border-l shadow-sm">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            
            <div class="inv-header h-12 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-500 font-medium" id="page-info">0 æ¡</span>
                <div class="flex gap-2"><button onclick="changePage(-1)" class="btn btn-secondary py-1 text-xs">ä¸Šä¸€é¡µ</button><button onclick="changePage(1)" class="btn btn-secondary py-1 text-xs">ä¸‹ä¸€é¡µ</button></div>
            </div>
        </div>

        <div id="view-product" class="view-container hidden">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f8fafc] pt-4 px-6 z-10 shrink-0 border-b border-slate-200/50 backdrop-blur-sm">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span>ğŸ·ï¸</span> äº§å“åº“å­˜ç›‘æ§ (SPU)</h2>
                <div class="relative">
                    <input id="prod-search" class="t-input w-64 pl-9 rounded-full border-slate-300 focus:border-blue-500 shadow-sm" placeholder="æœç´¢äº§å“å‹å·...">
                    <span class="absolute left-3 top-2.5 text-slate-400">ğŸ”</span>
                </div>
            </div>
            <div class="scroll-content pt-0">
                <div id="product-grid" class="card-grid"></div>
            </div>
        </div>
    </main>
</div>

<div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh]"></div>
<div id="multi-pop" class="multi-pop"></div>
<datalist id="dl-pids"></datalist>

<div id="import-modal" class="modal"><div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl"><h3 class="font-bold text-xl mb-4 text-slate-800">å¯¼å…¥ Excel</h3><p class="text-sm text-slate-500 mb-6">è¯·å°†æ–‡ä»¶ä¸Šä¼ è‡³ temp_uploads ç›®å½•åç‚¹å‡»æ‰«æ</p><button onclick="startImport()" class="btn btn-primary w-full justify-center py-2">å¼€å§‹æ‰«æ</button><button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å…³é—­</button></div></div>

<div id="settings-modal" class="modal"><div class="bg-white rounded-xl w-[500px] p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-slate-800">é…ç½® (é€—å·åˆ†éš”)</h3><div class="mb-3"><label class="text-xs font-bold text-slate-500">ä¸»æ’­</label><textarea id="set-hosts" class="t-input h-16 w-full mt-1"></textarea></div><div class="mb-3"><label class="text-xs font-bold text-slate-500">åˆ†ç±»</label><input id="set-cats" class="t-input w-full mt-1"></div><div class="mb-3"><label class="text-xs font-bold text-slate-500">è§†ç±»</label><input id="set-types" class="t-input w-full mt-1"></div><div class="mb-6"><label class="text-xs font-bold text-slate-500">å¹³å°</label><input id="set-plats" class="t-input w-full mt-1"></div><div class="flex gap-3"><button onclick="saveSettings()" class="btn btn-primary flex-1 justify-center">ä¿å­˜</button><button onclick="document.getElementById('settings-modal').classList.remove('active')" class="btn btn-secondary flex-1 justify-center">å–æ¶ˆ</button></div></div></div>

<script>
    let currPage=1, totalPages=1, globalOptions={}, editingId=null;

    // === å¯åŠ¨ ===
    window.addEventListener('load', async () => {
        await loadOptions();
        loadDashboard('day');
        loadData(1);
        Product.init();
        document.getElementById('prod-search').addEventListener('input', (e) => Product.search(e.target.value));
        document.addEventListener('click', e => { if(!e.target.closest('.multi-pop') && !e.target.closest('.multi-trig')) document.getElementById('multi-pop').classList.remove('show'); });
    });

    function switchView(view, btn) {
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active')); 
        if(btn) btn.classList.add('active');
        ['dashboard', 'inventory', 'product'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
        document.getElementById('view-'+view).classList.remove('hidden');
        if(view === 'product') Product.init();
    }

    // === è‰²å½©ç”Ÿæˆå™¨ (å…¨å½©èƒ¶å›Š) ===
    function getPillStyle(text) {
        if(!text || text==='-') return 'background:#f1f5f9; color:#64748b; border-color:#e2e8f0';
        if(text.includes('å¾…')) return 'background:#fff7ed; color:#c2410c; border-color:#ffedd5'; 
        if(text.includes('å·²')) return 'background:#f0fdf4; color:#15803d; border-color:#dcfce7'; 
        
        const colors = [
            {bg:'#fef2f2', c:'#b91c1c', b:'#fecaca'}, {bg:'#fffbeb', c:'#b45309', b:'#fde68a'},
            {bg:'#f0f9ff', c:'#0369a1', b:'#bae6fd'}, {bg:'#f5f3ff', c:'#4338ca', b:'#ddd6fe'},
            {bg:'#ecfccb', c:'#3f6212', b:'#d9f99d'}, {bg:'#fdf2f8', c:'#be185d', b:'#fbcfe8'}
        ];
        let h = 0; for(let i=0;i<text.length;i++) h = text.charCodeAt(i) + ((h<<5)-h);
        const c = colors[Math.abs(h) % colors.length];
        return `background:${c.bg}; color:${c.c}; border-color:${c.b}`;
    }

    function renderPills(str) {
        if(!str) return '-';
        return str.split(/[,ï¼Œ]/).filter(s=>s.trim()).map(s => 
            `<span class="pill" style="${getPillStyle(s.trim())}">${s.trim()}</span>`
        ).join('');
    }

    // === Dashboard (Matrix ç¾åŒ–) ===
    async function loadDashboard(dim='day') {
        try {
            const res = await fetch(`/api/dashboard?dim=${dim}`);
            const data = await res.json();
            
            // æ•°å­—æ›´æ–°
            ['total','dist','pending','t_in','t_out','m_in','m_out'].forEach(k => {
                document.getElementById('d-'+k.replace(/_/g,'-')).innerText = data.kpi[k] || 0;
            });
            
            // Matrix ç¾åŒ–æ¸²æŸ“
            const maxVal = Math.max(...data.matrix.map(m => m.year), 1);
            document.getElementById('matrix-list').innerHTML = data.matrix.map((r, i) => {
                let rankIcon = `<span class="text-slate-300 font-mono text-sm">#${i+1}</span>`;
                if(i===0) rankIcon = 'ğŸ¥‡'; if(i===1) rankIcon = 'ğŸ¥ˆ'; if(i===2) rankIcon = 'ğŸ¥‰';
                const pct = (r.year / maxVal) * 100;
                
                return `
                <div class="matrix-item">
                    <div class="rank-icon">${rankIcon}</div>
                    <div class="acc-info">
                        <div class="acc-name">${r.name}</div>
                        <div class="acc-bar-bg"><div class="acc-bar-fill" style="width: ${pct}%"></div></div>
                    </div>
                    <div class="acc-stat">
                        <div class="acc-val">${r.year}</div>
                        <div class="acc-sub">Total</div>
                    </div>
                </div>`;
            }).join('');
            
            // Charts
            if(typeof echarts !== 'undefined') {
                echarts.init(document.getElementById('chart-trend')).setOption({tooltip:{trigger:'axis'}, xAxis:{type:'category',data:data.trend.dates}, yAxis:{type:'value'}, series:[{name:'å…¥åº“',type:'line',smooth:true,itemStyle:{color:'#3b82f6'},areaStyle:{opacity:0.1},data:data.trend.in},{name:'å‘å¸ƒ',type:'bar',itemStyle:{color:'#10b981'},data:data.trend.out}]});
                echarts.init(document.getElementById('chart-host')).setOption({tooltip:{trigger:'axis'}, xAxis:{type:'value'}, yAxis:{type:'category',data:data.hosts.map(i=>i.name).reverse()}, series:[{type:'bar',data:data.hosts.map(i=>i.value).reverse(), itemStyle:{color:'#f59e0b', borderRadius:[0,4,4,0]}}]});
                echarts.init(document.getElementById('chart-type')).setOption({tooltip:{trigger:'item'}, series:[{type:'pie',radius:['40%','70%'],data:data.types}]});
            }
        } catch(e) { console.error("Dash Error", e); }
    }

    // === Product ===
    const Product = {
        allData: [],
        init: async function() {
            try {
                const res = await fetch('/api/product_stats');
                this.allData = await res.json();
                this.render(this.allData);
            } catch(e) {}
        },
        search: function(kw) {
            if(!kw) return this.render(this.allData);
            this.render(this.allData.filter(i => i.name && String(i.name).toLowerCase().includes(kw.toLowerCase())));
        },
        render: function(data) {
            const grid = document.getElementById('product-grid');
            if(!data.length) { grid.innerHTML = `<div class="text-slate-400 text-center col-span-full py-12">æš‚æ— æ•°æ®</div>`; return; }
            grid.innerHTML = data.map(item => {
                const pct = item.total > 0 ? Math.round(((item.total - item.pending)/item.total)*100) : 0;
                let color = item.pending > 5 ? '#ef4444' : (item.pending === 0 ? '#10b981' : '#3b82f6');
                return `
                <div class="prod-card" style="border-left: 4px solid ${color}" onclick="jumpTo('${item.name}')">
                    <div class="pc-head"><div class="pc-title" title="${item.name}">${item.name}</div><span class="pc-badge" style="color:${color};background:${color}10">SPU</span></div>
                    <div class="pc-body"><div><div class="pc-num" style="color:${color}">${item.pending}</div><div class="text-xs text-slate-400 font-bold">å¾…å‘å¸ƒ</div></div><div class="text-right"><div class="text-2xl font-bold text-slate-300">${pct}%</div><div class="text-xs text-slate-400">å®Œæˆç‡</div></div></div>
                    <div class="pc-bar-bg mt-3"><div class="pc-bar-fill" style="width:${pct}%; background:${color}"></div></div>
                    <div class="pc-foot">æ€»åº“å­˜ ${item.total}</div>
                </div>`;
            }).join('');
        }
    };

    // === Inventory ===
    async function loadData(page) { 
        currPage = page || currPage; 
        const params = new URLSearchParams({
            page:currPage, size:100, 
            keyword:document.getElementById('g-search').value, 
            product_id:document.getElementById('s-pid').value, 
            title:document.getElementById('s-title').value, 
            remark:document.getElementById('s-remark').value, 
            host:document.getElementById('s-host').value, 
            status:document.getElementById('s-status').value, 
            category:document.getElementById('s-cat').value, 
            video_type:document.getElementById('s-type').value, 
            platform:document.getElementById('s-plat').value, 
            finish_start:document.getElementById('s-fin-start').value, 
            finish_end:document.getElementById('s-fin-end').value, 
            publish_start:document.getElementById('s-pub-start').value, 
            publish_end:document.getElementById('s-pub-end').value
        });
        const res = await fetch(`/api/videos?${params}`); 
        const data = await res.json(); 
        totalPages = data.total_pages;
        document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`; 
        renderTable(data.items); 
    }

    function renderTable(items) { 
        document.getElementById('table-body').innerHTML = items.map(v => v.id === editingId ? getEditHtml(v) : getViewHtml(v)).join(''); 
    }

    function getViewHtml(v) {
        const cln = s => (s && s!=='nan' && s!=='None') ? s : '';
        const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';
        
        return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
            <td class="p-2 text-center"><div class="img-cell mx-auto" onclick="showBig('${img}')"><img src="${img}" class="w-full h-full object-cover"></div></td>
            <td class="font-mono text-slate-600 font-bold">${cln(v.product_id)}</td>
            <td class="col-title" title="${cln(v.title)}">${cln(v.title)}</td>
            <td>${renderPills(cln(v.video_type))}</td>
            <td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td>
            <td>${renderPills(cln(v.category))}</td>
            <td>${renderPills(cln(v.host))}</td>
            <td class="text-center">${renderPills(cln(v.status))}</td>
            <td>${renderPills(cln(v.platform))}</td>
            <td class="text-slate-400 text-xs font-mono">${cln(v.publish_time).replace('T',' ').slice(0,16)}</td>
            <td class="text-slate-400 text-xs col-remark truncate" title="${cln(v.remark)}">${cln(v.remark)}</td>
            <td class="text-center sticky right-0 bg-white border-l">
                <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button>
                <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
            </td>
        </tr>`;
    }

    function getEditHtml(v) {
        const cln = s => (s && s!=='nan' && s!=='None') ? s : '';
        const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';
        const sel=(k,l)=>`<select id="ed-${k}" class="t-input h-8 text-xs p-1">${l.map(o=>`<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
        const mul=(k,t)=>`<input id="ed-${k}" class="t-input h-8 text-xs multi-trig cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this,'${t}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
        
        return `
            <td class="p-2"><div class="img-cell mx-auto border-blue-500" onclick="document.getElementById('up-${v.id}').click()"><img src="${img}" class="w-full h-full object-cover"></div><input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this,'${v.id}')"><input type="hidden" id="ed-img" value="${cln(v.image_url)}"></td>
            <td><input id="ed-pid" class="t-input h-8" value="${cln(v.product_id)}"></td>
            <td><input id="ed-title" class="t-input h-8 font-bold" value="${cln(v.title)}"></td>
            <td>${sel('type',globalOptions.video_types)}</td>
            <td><input id="ed-fin" type="date" class="t-input h-8" value="${cln(v.finish_time)}"></td>
            <td>${sel('cat',globalOptions.categories)}</td>
            <td>${mul('host','hosts')}</td>
            <td>${sel('status',globalOptions.statuses)}</td>
            <td>${mul('plat','platforms')}</td>
            <td><input id="ed-pub" type="datetime-local" class="t-input h-8" value="${cln(v.publish_time).replace(' ','T')}"></td>
            <td><input id="ed-rem" class="t-input h-8" value="${cln(v.remark)}"></td>
            <td class="text-center sticky right-0 bg-blue-50 border-l">
                <button onclick="saveRow('${v.id}')" class="text-blue-600 font-bold text-xs">ä¿å­˜</button>
                <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1">å–æ¶ˆ</button>
            </td>`;
    }

    // === Helpers ===
    function startEdit(id){ editingId=id; loadData(); }
    function cancelEdit(){ editingId=null; loadData(); }
    async function saveRow(id){ const fd=new FormData(); if(id!=='new') fd.append('id',id); const map={'pid':'product_id','title':'title','cat':'category','fin':'finish_time','type':'video_type','host':'host','status':'status','plat':'platform','pub':'publish_time','rem':'remark'}; for(let [eid,k] of Object.entries(map)) fd.append(k, document.getElementById('ed-'+eid).value.replace('T',' ')); fd.append('image_url',document.getElementById('ed-img').value); await fetch('/api/video/save',{method:'POST',body:fd}); editingId=null; loadData(); }
    async function upImg(input,id){ if(input.files[0]) uploadFile(input.files[0], id); }
    async function uploadFile(file, id){ const fd = new FormData(); fd.append('file', file); const res = await fetch('/api/upload', {method:'POST', body:fd}); const d = await res.json(); if(document.getElementById('ed-img')) document.getElementById('ed-img').value = d.url; if(editingId != id) loadData(); else { const img = document.querySelector(`#up-${id}`).previousElementSibling.querySelector('img'); if(img) img.src = d.url; } }
    function openMulti(input,type){ const pop=document.getElementById('multi-pop'); const r=input.getBoundingClientRect(); const curr=input.value.split(/[,ï¼Œ]/).map(s=>s.trim()); pop.innerHTML=(globalOptions[type]||[]).map(o=>`<div class="multi-opt" onclick="togOpt('${input.id}','${o}','${type}')"><span class="${curr.includes(o)?'text-blue-600 font-bold w-4':'w-4'}">${curr.includes(o)?'âœ“':''}</span> ${o}</div>`).join(''); pop.style.top=(r.bottom+window.scrollY)+'px'; pop.style.left=(r.left+window.scrollX)+'px'; pop.classList.add('show'); }
    function togOpt(eid,v,type){ const inp=document.getElementById(eid); let vals=inp.value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); if(vals.includes(v)) vals=vals.filter(i=>i!==v); else vals.push(v); inp.value=vals.join(','); openMulti(inp,type); }
    function toggleFilter(){ document.getElementById('filter-panel').classList.toggle('open'); }
    function showBig(s){ document.getElementById('big-img').src=s; document.getElementById('preview-modal').classList.add('active'); }
    function resetFilters(){ document.querySelectorAll('#filter-panel input,select').forEach(e=>e.value=''); loadData(1); }
    async function delVideo(id){ if(confirm('åˆ ?')){ await fetch(`/api/video/${id}`,{method:'DELETE'}); loadData(); } }
    async function loadOptions() { const res=await fetch('/api/options'); globalOptions=await res.json(); const fill=(id,l)=>document.getElementById(id).innerHTML=`<option value="">å…¨éƒ¨</option>`+l.map(i=>`<option>${i}</option>`).join(''); fill('s-cat',globalOptions.categories); fill('s-type',globalOptions.video_types); fill('s-host',globalOptions.hosts); fill('s-status',globalOptions.statuses); fill('s-plat',globalOptions.platforms); document.getElementById('dl-pids').innerHTML=globalOptions.product_ids.map(i=>`<option>${i}</option>`).join(''); }
    function openImport(){ document.getElementById('import-modal').classList.add('active'); }
    async function startImport(){ const btn = document.querySelector('#import-modal button'); btn.innerText = 'æ‰«æä¸­...'; btn.disabled = true; await fetch('/api/import/local',{method:'POST'}); alert('åå°ä»»åŠ¡å·²å¯åŠ¨'); document.getElementById('import-modal').classList.remove('active'); btn.innerText = 'å¼€å§‹æ‰«æ'; btn.disabled = false; loadData(1); }
    function openSettings(){ document.getElementById('settings-modal').classList.add('active'); document.getElementById('set-hosts').value=globalOptions.hosts.join(','); document.getElementById('set-cats').value=globalOptions.categories.join(','); document.getElementById('set-types').value=globalOptions.video_types.join(','); document.getElementById('set-plats').value=globalOptions.platforms.join(','); }
    async function saveSettings(){ const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})}); await s('hosts',document.getElementById('set-hosts').value); await s('categories',document.getElementById('set-cats').value); await s('video_types',document.getElementById('set-types').value); await s('platforms',document.getElementById('set-plats').value); document.getElementById('settings-modal').classList.remove('active'); loadOptions(); }
    function addNewRow() { const tr = document.createElement('tr'); tr.className = 'editing bg-blue-50'; tr.innerHTML = getEditHtml({id:'new', product_id:'', title:'', image_url:''}); document.getElementById('table-body').prepend(tr); editingId = 'new'; }
    function jumpTo(pid) { window.switchView('inventory'); document.getElementById('s-pid').value = pid; document.getElementById('filter-panel').classList.add('open'); loadData(1); }
    window.changePage = (d) => { if(currPage+d > 0) loadData(currPage+d); };
</script>
</body>
</html>