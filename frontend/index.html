<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        /* è¡¨æ ¼æ ·å¼ */
        th { white-space: nowrap; }
        td { vertical-align: middle; }
        .table-cell { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <div class="bg-white border-b border-slate-200 px-6 py-4 shadow-sm z-10 sticky top-0">
        <div class="max-w-[1920px] mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">V</div>
                    <h1 class="text-2xl font-bold text-slate-900">VideoHub <span class="text-sm font-normal text-slate-400">Pro</span></h1>
                </div>
                <div class="flex gap-3">
                     <button onclick="scanLocal()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition-all flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        æ‰«æå¯¼å…¥ (NAS)
                    </button>
                    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-blue-200 shadow transition-all flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        æ–°å¢èµ„äº§
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-slate-400 text-xs font-bold uppercase">Total Assets</div>
                        <div class="text-3xl font-black text-slate-800" id="st-total">--</div>
                    </div>
                    <div class="h-10 w-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-400">ğŸ“¦</div>
                </div>
                <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-orange-600/70 text-xs font-bold uppercase">Pending Publish</div>
                        <div class="text-3xl font-black text-orange-500" id="st-pending">--</div>
                    </div>
                    <div class="h-10 w-10 bg-orange-200 rounded-full flex items-center justify-center text-orange-500">ğŸ”¥</div>
                </div>
                <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-emerald-600/70 text-xs font-bold uppercase">Top Host</div>
                        <div class="text-3xl font-black text-emerald-600" id="st-host">--</div>
                    </div>
                    <div class="h-10 w-10 bg-emerald-200 rounded-full flex items-center justify-center text-emerald-500">ğŸ†</div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 p-6 max-w-[1920px] mx-auto w-full overflow-hidden flex flex-col">
        
        <div class="flex flex-wrap items-center gap-3 mb-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm shrink-0">
            <div class="relative">
                <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input id="q-key" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="æœç´¢ç¼–å·/æ ‡é¢˜" class="pl-9 pr-4 py-2 w-64 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <select id="q-host" onchange="loadData(1)" class="py-2 pl-3 pr-8 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer min-w-[120px]">
                <option value="">å…¨éƒ¨ä¸»æ’­</option>
                </select>
            
            <select id="q-status" onchange="loadData(1)" class="py-2 pl-3 pr-8 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer min-w-[120px]">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                </select>

            <select id="q-cat" onchange="loadData(1)" class="py-2 pl-3 pr-8 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer min-w-[120px]">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                </select>

            <button onclick="loadData(1)" class="px-5 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 shadow ml-auto">æŸ¥è¯¢</button>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col flex-1 overflow-hidden">
            <div class="overflow-auto flex-1">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 w-16">é¢„è§ˆ</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 w-32">äº§å“ç¼–å·</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 min-w-[200px]">è§†é¢‘æ ‡é¢˜</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500">ç±»å‹</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 w-32">å®Œæˆæ—¶é—´</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 w-20">ä¸»æ’­</th>
                            <th class="px-4 py-3 text-center font-bold text-slate-500 w-24">çŠ¶æ€</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500">å¹³å°</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="px-4 py-3 text-left font-bold text-slate-500 w-48">å¤‡æ³¨</th>
                            <th class="px-4 py-3 text-center font-bold text-slate-500 sticky right-0 bg-slate-50 w-32 shadow-l">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            <div class="border-t border-slate-200 px-4 py-2 flex justify-between items-center bg-slate-50 shrink-0">
                <span class="text-xs text-slate-500">å…± <span id="total-count">0</span> æ¡ï¼Œç¬¬ <span id="curr-page">1</span> é¡µ</span>
                <div class="space-x-2">
                    <button onclick="changePage(-1)" class="px-3 py-1 bg-white border border-slate-300 rounded text-xs hover:bg-slate-100">ä¸Šä¸€é¡µ</button>
                    <button onclick="changePage(1)" class="px-3 py-1 bg-white border border-slate-300 rounded text-xs hover:bg-slate-100">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-[600px] shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4" id="modal-title">ç¼–è¾‘èµ„äº§</h3>
            <form id="editForm" class="grid grid-cols-2 gap-4">
                <input type="hidden" name="id">
                <div class="col-span-2">
                    <label class="text-xs font-bold text-slate-400">è§†é¢‘æ ‡é¢˜</label>
                    <input name="title" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">äº§å“ç¼–å·</label>
                    <input name="product_id" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">ä¸»æ’­</label>
                    <input name="host" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50" list="host-list" required>
                    <datalist id="host-list"></datalist> </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">äº§å“ç±»å‹</label>
                    <input name="category" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">å½“å‰çŠ¶æ€</label>
                    <select name="status" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                        <option>å¾…å‘å¸ƒ</option><option>å·²å‘å¸ƒ</option>
                    </select>
                </div>
                 <div>
                    <label class="text-xs font-bold text-slate-400">å‘å¸ƒå¹³å°</label>
                    <input name="platform" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                </div>
                 <div>
                    <label class="text-xs font-bold text-slate-400">è§†é¢‘ç±»å‹</label>
                    <input name="video_type" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                </div>
                 <div>
                    <label class="text-xs font-bold text-slate-400">å®Œæˆæ—¶é—´</label>
                    <input name="finish_time" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                </div>
                 <div>
                    <label class="text-xs font-bold text-slate-400">å‘å¸ƒæ—¶é—´</label>
                    <input name="publish_time" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                </div>
                <div class="col-span-2">
                     <label class="text-xs font-bold text-slate-400">å¤‡æ³¨</label>
                    <input name="remark" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50">
                </div>
                 <div class="col-span-2">
                     <label class="text-xs font-bold text-slate-400">ä¸Šä¼ æ–°å°é¢ (è¦†ç›–åŸå›¾)</label>
                    <input type="file" name="image" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div class="col-span-2 flex justify-end gap-3 pt-4 border-t mt-2">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm font-bold text-slate-500">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currPage = 1, totalPages = 1;

        // åˆå§‹åŒ–
        (async function init() {
            await loadOptions(); // å…ˆåŠ è½½åŠ¨æ€é€‰é¡¹
            await loadData(1);   // å†åŠ è½½æ•°æ®
            updateStats();
        })();

        // 1. åŠ¨æ€åŠ è½½ç­›é€‰é€‰é¡¹
        async function loadOptions() {
            try {
                const res = await fetch('/api/options');
                const data = await res.json();
                
                fillSelect('q-host', data.hosts, 'å…¨éƒ¨ä¸»æ’­');
                fillSelect('q-status', data.statuses, 'å…¨éƒ¨çŠ¶æ€');
                fillSelect('q-cat', data.categories, 'å…¨éƒ¨åˆ†ç±»');
                
                // ç»™ç¼–è¾‘å¼¹çª—çš„ä¸»æ’­åˆ—è¡¨åŠ è‡ªåŠ¨è¡¥å…¨
                const dl = document.getElementById('host-list');
                dl.innerHTML = data.hosts.map(h => `<option value="${h}">`).join('');

            } catch(e) { console.error("Options failed", e); }
        }

        function fillSelect(id, items, defaultText) {
            const sel = document.getElementById(id);
            // ä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
            sel.innerHTML = `<option value="">${defaultText}</option>` + 
                            items.map(i => `<option value="${i}">${i}</option>`).join('');
        }

        // 2. åŠ è½½æ•°æ®
        async function loadData(p) {
            currPage = p || currPage;
            // ä¿®æ­£ç­›é€‰ä¼ å‚ï¼šå¦‚æœé€‰äº†ç©ºå€¼ï¼Œåˆ™ä¸ä¼ æˆ–ä¼ ç©º
            const params = new URLSearchParams({
                page: currPage, size: 20,
                keyword: document.getElementById('q-key').value,
                host: document.getElementById('q-host').value || "",
                status: document.getElementById('q-status').value || "",
                category: document.getElementById('q-cat').value || ""
            });
            
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            totalPages = data.total_pages;
            
            document.getElementById('total-count').innerText = data.total;
            document.getElementById('curr-page').innerText = data.page;
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = data.items.map(v => {
                // æ¸…æ´—æ˜¾ç¤ºæ•°æ®ï¼Œå»æ‰ 'nan'
                const clean = (val) => (val && val !== 'nan' && val !== 'NaT') ? val : '';
                // å›¾ç‰‡é˜²æŠ–å¤„ç†ï¼šå¦‚æœURLæ˜¯ç©ºçš„æˆ–nanï¼Œç›´æ¥ç”¨é»˜è®¤å›¾ï¼Œé¿å…onerroræ­»å¾ªç¯
                const imgUrl = (v.image_url && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                
                // çŠ¶æ€æ ·å¼
                let stClass = "bg-slate-100 text-slate-600";
                if(clean(v.status) === 'å¾…å‘å¸ƒ') stClass = "bg-orange-50 text-orange-600 border border-orange-100";
                if(clean(v.status) === 'å·²å‘å¸ƒ') stClass = "bg-emerald-50 text-emerald-600 border border-emerald-100";

                return `
                <tr class="hover:bg-blue-50/50 transition-colors group">
                    <td class="px-4 py-2">
                        <div class="w-10 h-10 bg-slate-100 rounded border border-slate-200 overflow-hidden">
                            <img src="${imgUrl}" 
                                 class="w-full h-full object-cover cursor-zoom-in hover:scale-150 transition-transform origin-left"
                                 onerror="this.onerror=null;this.src='/assets/default.png'">
                        </div>
                    </td>
                    <td class="px-4 py-2 font-mono font-bold text-blue-600 text-xs">${clean(v.product_id)}</td>
                    <td class="px-4 py-2 font-medium text-slate-700 table-cell" title="${clean(v.title)}">${clean(v.title)}</td>
                    <td class="px-4 py-2 text-slate-500 text-xs">${clean(v.category)}</td>
                    <td class="px-4 py-2 text-slate-400 text-xs">${clean(v.finish_time)}</td>
                    <td class="px-4 py-2 font-bold text-slate-600 text-xs">${clean(v.host)}</td>
                    <td class="px-4 py-2 text-center">
                        <span class="status-badge ${stClass}">${clean(v.status)}</span>
                    </td>
                    <td class="px-4 py-2 text-slate-500 text-xs">${clean(v.platform)}</td>
                    <td class="px-4 py-2 text-slate-400 text-xs">${clean(v.publish_time)}</td>
                    <td class="px-4 py-2 text-slate-400 text-xs table-cell">${clean(v.remark)}</td>
                    <td class="px-4 py-2 text-center sticky right-0 bg-white group-hover:bg-blue-50/50 shadow-l">
                        <button onclick='openModal(${JSON.stringify(v).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800 font-bold text-xs mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 hover:text-red-600 font-bold text-xs">åˆ é™¤</button>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="11" class="text-center py-10 text-slate-400">æš‚æ— æ•°æ®</td></tr>';
        }

        function changePage(d) {
            if(currPage + d > 0 && currPage + d <= totalPages) loadData(currPage + d);
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const s = await res.json();
                document.getElementById('st-total').innerText = s.total;
                document.getElementById('st-pending').innerText = s.pending;
                document.getElementById('st-host').innerText = s.host;
            } catch(e){}
        }

        // --- æ¨¡æ€æ¡†é€»è¾‘ ---
        function openModal(data) {
            const form = document.getElementById('editForm');
            form.reset();
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            
            if(data) {
                document.getElementById('modal-title').innerText = "ç¼–è¾‘èµ„äº§";
                // è‡ªåŠ¨å¡«å……è¡¨å•
                for(let k in data) {
                    if(form[k]) form[k].value = (data[k] === 'nan' || data[k] === null) ? '' : data[k];
                }
            } else {
                document.getElementById('modal-title').innerText = "æ–°å¢èµ„äº§";
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            try {
                const res = await fetch('/api/video/save', {method:'POST', body:fd});
                if(res.ok) { 
                    closeModal(); 
                    loadData(); 
                    updateStats();
                    loadOptions(); // æ–°å¢åå¯èƒ½æœ‰æ–°ä¸»æ’­/åˆ†ç±»ï¼Œåˆ·æ–°ä¸‹æ‹‰æ¡†
                    alert("ä¿å­˜æˆåŠŸ");
                } else { alert("ä¿å­˜å¤±è´¥"); }
            } catch(err) { alert("ç½‘ç»œé”™è¯¯"); }
        };

        async function delVideo(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¯¥è®°å½•å—ï¼Ÿ")) return;
            await fetch(`/api/video/${id}`, {method:'DELETE'});
            loadData();
            updateStats();
        }

        async function scanLocal() {
            if(!confirm("ç¡®è®¤æ‰«æ temp_uploads ç›®å½•ï¼Ÿ")) return;
            fetch('/api/import/local', {method:'POST'});
            alert("åå°å¼€å§‹å¯¼å…¥ï¼Œè¯·ç¨ååˆ·æ–°");
        }
    </script>
</body>
</html>