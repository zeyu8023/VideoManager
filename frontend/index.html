<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V4 | æ•°å­—åŒ–ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* å…¨å±è¡¨æ ¼ */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; /* ä¿è¯ä¸æŒ¤ */ }
        
        /* ç¡¬ç¼–ç è¡¨å¤´æ ·å¼ */
        th { background: #f1f5f9; color: #475569; font-size: 13px; font-weight: 700; padding: 12px 10px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* å½©è‰²èƒ¶å›Š (Pills) */
        .pill { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; margin-bottom: 2px; border: 1px solid transparent; }
        
        /* å›¾ç‰‡ä¸Šä¼ åŒº (æ”¯æŒæ‹–æ‹½) */
        .img-zone { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f1f5f9; position: relative; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .img-zone:hover { transform: scale(1.1); border-color: #3b82f6; }
        .img-zone:hover::after { content: '+'; position: absolute; inset: 0; background: rgba(0,0,0,0.3); color: white; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; }
        .img-large { width: 100%; height: 200px; border: 2px dashed #cbd5e1; display: flex; justify-content: center; align-items: center; background: #f8fafc; color: #94a3b8; font-size: 14px; flex-direction: column; }
        .img-large.active { border-color: #3b82f6; background: #eff6ff; color: #3b82f6; }

        /* ç¼–è¾‘æ¨¡å¼è¾“å…¥æ¡† */
        .table-input { width: 100%; background: transparent; border: 1px solid transparent; padding: 4px; border-radius: 4px; }
        .editing .table-input { background: white; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

        /* è¿›åº¦æ¡ */
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-value { height: 100%; background: #3b82f6; width: 0%; transition: width 0.3s; }

        /* æ¨¡æ€æ¡† */
        .modal { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-30">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow">V</div>
            <h1 class="text-lg font-bold text-slate-800">VideoHub <span class="text-xs text-slate-400 font-normal">V4.0</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="openSettings()" class="text-xs font-bold text-slate-500 hover:text-blue-600 bg-slate-50 px-3 py-1.5 rounded border border-slate-100">âš™ï¸ å…¨å±€é…ç½®</button>
            <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-500">ZY</div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-4 z-20 shrink-0">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
            <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-slate-400 uppercase">æ€»è§†é¢‘èµ„äº§</div><div class="text-3xl font-black text-slate-800" id="st-total">-</div></div>
                <div class="text-3xl">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-orange-400 uppercase">å¾…å‘å¸ƒåº“å­˜</div><div class="text-3xl font-black text-orange-500" id="st-pending">-</div></div>
                <div class="text-3xl">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex justify-between items-center">
                <div><div class="text-xs font-bold text-emerald-400 uppercase">æœ¬æœˆåŠ³æ¨¡</div><div class="text-3xl font-black text-emerald-600" id="st-host">-</div></div>
                <div class="text-3xl">ğŸ†</div>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col p-4 overflow-hidden w-full">
        <div class="flex flex-wrap items-center gap-2 mb-3 bg-white p-2 rounded-lg border border-slate-200 shadow-sm shrink-0">
            <input id="q-key" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="ğŸ” æœç´¢..." class="px-3 py-1.5 w-48 bg-slate-50 border border-slate-200 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500">
            
            <select id="q-host" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none w-24"></select>
            <select id="q-status" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none w-24"></select>
            <select id="q-cat" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none w-24"></select>
            <select id="q-plat" onchange="loadData(1)" class="px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none w-24"></select>

            <div class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded border border-slate-200">
                <span class="text-xs text-slate-400 font-bold">å‘å¸ƒ:</span>
                <input type="date" id="q-pub-start" onchange="loadData(1)" class="bg-transparent text-xs outline-none w-24">
                <span class="text-slate-300">-</span>
                <input type="date" id="q-pub-end" onchange="loadData(1)" class="bg-transparent text-xs outline-none w-24">
            </div>

            <button onclick="resetFilters()" class="px-3 py-1.5 text-slate-500 hover:bg-slate-100 rounded text-sm font-bold ml-auto">é‡ç½®</button>
            <button onclick="loadData(1)" class="px-4 py-1.5 bg-blue-600 text-white font-bold text-sm rounded hover:bg-blue-700 shadow-sm">æŸ¥è¯¢</button>
            <button onclick="openImportModal()" class="px-3 py-1.5 bg-slate-700 text-white font-bold text-sm rounded hover:bg-slate-800 shadow-sm">å¯¼å…¥</button>
            <button onclick="openAddModal()" class="px-3 py-1.5 bg-emerald-600 text-white font-bold text-sm rounded hover:bg-emerald-700 shadow-sm">æ–°å¢</button>
        </div>

        <div class="bg-white border border-slate-200 rounded-lg shadow-sm flex flex-col flex-1 overflow-hidden w-full">
            <div class="flex-1 overflow-auto w-full">
                <table>
                    <thead class="sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="w-16 text-center">å›¾</th>
                            <th class="w-24">äº§å“/ç¼–å·</th>
                            <th style="min-width: 200px">è§†é¢‘æ ‡é¢˜</th>
                            <th class="w-24">äº§å“ç±»å‹</th>
                            <th class="w-28">å®Œæˆæ—¶é—´</th>
                            <th class="w-24">è§†é¢‘ç±»å‹</th>
                            <th class="w-28">ä¸»æ’­ (å¤šé€‰)</th>
                            <th class="w-24 text-center">å‘å¸ƒçŠ¶æ€</th>
                            <th class="w-28">å‘å¸ƒå¹³å°</th>
                            <th class="w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-32">å¤‡æ³¨</th>
                            <th class="w-24 text-center sticky right-0 bg-slate-50 border-l border-slate-200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="border-t border-slate-200 px-4 py-2 flex justify-between items-center bg-slate-50 shrink-0 text-sm">
                <span class="text-slate-500">å…± <b id="total-count">0</b> æ¡ï¼Œç¬¬ <b id="curr-page">1</b> é¡µ</span>
                <div class="space-x-1">
                    <button id="btn-prev" onclick="changePage(-1)" class="px-2 py-1 border rounded bg-white hover:bg-slate-100 disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button id="btn-next" onclick="changePage(1)" class="px-2 py-1 border rounded bg-white hover:bg-slate-100 disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center cursor-zoom-out" onclick="this.classList.add('hidden')">
        <img id="preview-img" src="" alt="Preview" class="max-h-[90vh] max-w-[90vw] object-contain">
    </div>

    <div id="import-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[400px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4 text-lg">æ‰¹é‡å¯¼å…¥æ•°æ®</h3>
            <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 cursor-pointer relative">
                <input type="file" id="import-file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="showFileName()">
                <div id="file-label" class="text-slate-500 text-sm">
                    <p class="text-2xl mb-2">ğŸ“‚</p>
                    <p>ç‚¹å‡»é€‰æ‹© .xlsx æ–‡ä»¶</p>
                </div>
            </div>
            <div class="progress-bar" id="import-progress"><div class="progress-value" id="import-bar"></div></div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeModal('import-modal')" class="text-slate-500 text-sm font-bold px-3">å–æ¶ˆ</button>
                <button onclick="startImport()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold">å¼€å§‹ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <div id="add-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[700px] p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold mb-4 text-lg" id="modal-title">æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-3 gap-4">
                <input type="hidden" name="id" id="form-id">
                
                <div class="col-span-1 row-span-4">
                    <div class="img-large rounded-lg cursor-pointer relative" id="drop-area"
                         onclick="document.getElementById('form-file').click()"
                         ondragover="event.preventDefault(); this.classList.add('active')"
                         ondragleave="this.classList.remove('active')"
                         ondrop="handleFormDrop(event)">
                        <img id="form-img-preview" class="w-full h-full object-cover hidden">
                        <div id="form-img-placeholder" class="text-center">
                            <p class="text-3xl">ğŸ“·</p>
                            <p class="mt-2 text-xs">ç‚¹å‡» / æ‹–æ‹½ / ç²˜è´´</p>
                        </div>
                        <input type="file" id="form-file" class="hidden" onchange="previewFile(this.files[0])">
                        <input type="hidden" name="image_url" id="form-image-url">
                    </div>
                </div>

                <div class="col-span-2 grid grid-cols-2 gap-3">
                    <div class="col-span-2"><input name="title" id="f-title" placeholder="è§†é¢‘æ ‡é¢˜ *" required class="w-full p-2 border rounded text-sm"></div>
                    <div><input name="product_id" id="f-pid" placeholder="äº§å“ç¼–å· *" required class="w-full p-2 border rounded text-sm"></div>
                    <div><input name="category" id="f-cat" placeholder="äº§å“ç±»å‹" class="w-full p-2 border rounded text-sm" list="dl-cat"></div>
                    <div><input name="host" id="f-host" placeholder="ä¸»æ’­ (æ”¯æŒå¤šé€‰)" class="w-full p-2 border rounded text-sm" list="dl-host"></div>
                    <div><select name="status" id="f-status" class="w-full p-2 border rounded text-sm"></select></div>
                    <div><input name="platform" id="f-plat" placeholder="å‘å¸ƒå¹³å°" class="w-full p-2 border rounded text-sm" list="dl-plat"></div>
                    <div><input name="video_type" id="f-type" placeholder="è§†é¢‘ç±»å‹" class="w-full p-2 border rounded text-sm" list="dl-type"></div>
                    <div><input name="finish_time" id="f-fin" placeholder="å®Œæˆæ—¶é—´" onfocus="(this.type='date')" class="w-full p-2 border rounded text-sm"></div>
                    <div><input name="publish_time" id="f-pub" placeholder="å‘å¸ƒæ—¶é—´" onfocus="(this.type='datetime-local')" class="w-full p-2 border rounded text-sm"></div>
                    <div class="col-span-2"><input name="remark" id="f-rem" placeholder="å¤‡æ³¨" class="w-full p-2 border rounded text-sm"></div>
                </div>

                <div class="col-span-3 pt-4 border-t flex justify-end gap-2">
                    <button type="button" onclick="closeModal('add-modal')" class="text-slate-500 font-bold text-sm px-4">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded font-bold text-sm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[400px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">å…¨å±€é…ç½® (é€—å·åˆ†éš”)</h3>
            <div class="space-y-3">
                <textarea id="set-hosts" class="w-full p-2 border rounded text-sm h-16" placeholder="ä¸»æ’­..."></textarea>
                <input id="set-cats" class="w-full p-2 border rounded text-sm" placeholder="äº§å“ç±»å‹...">
                <input id="set-plats" class="w-full p-2 border rounded text-sm" placeholder="å¹³å°...">
                <input id="set-stats" class="w-full p-2 border rounded text-sm" placeholder="çŠ¶æ€...">
            </div>
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold mt-4">ä¿å­˜</button>
            <button onclick="closeModal('settings-modal')" class="w-full mt-2 text-slate-400 text-sm">å…³é—­</button>
        </div>
    </div>

    <datalist id="dl-host"></datalist>
    <datalist id="dl-cat"></datalist>
    <datalist id="dl-plat"></datalist>
    <datalist id="dl-type"></datalist>

    <script>
        let currPage = 1, totalPages = 1, globalData = [], globalOptions = {}, editingId = null;

        // åˆå§‹åŒ–
        (async () => {
            await loadOptions();
            await loadData(1);
            updateStats();
            
            // ç»‘å®šå…¨å±€ç²˜è´´ (å¦‚æœåœ¨æ¨¡æ€æ¡†å†…)
            document.addEventListener('paste', e => {
                if(document.getElementById('add-modal').classList.contains('active')) {
                    if(e.clipboardData.files.length) previewFile(e.clipboardData.files[0]);
                }
            });
        })();

        // --- 1. æ•°æ®åŠ è½½ä¸æ¸²æŸ“ ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            
            fillSel('q-host', globalOptions.hosts, 'å…¨éƒ¨ä¸»æ’­');
            fillSel('q-status', globalOptions.statuses, 'å…¨éƒ¨çŠ¶æ€');
            fillSel('q-cat', globalOptions.categories, 'å…¨éƒ¨åˆ†ç±»');
            fillSel('q-plat', globalOptions.platforms, 'å…¨éƒ¨å¹³å°');
            fillSel('f-status', globalOptions.statuses, 'é€‰æ‹©çŠ¶æ€'); // å¼¹çª—å†…çš„Select

            // å¡«å…… Datalist (æ”¯æŒè¾“å…¥è‡ªå®šä¹‰)
            fillDL('dl-host', globalOptions.hosts);
            fillDL('dl-cat', globalOptions.categories);
            fillDL('dl-plat', globalOptions.platforms);
            fillDL('dl-type', globalOptions.video_types);
        }

        function fillSel(id, items, def) {
            document.getElementById(id).innerHTML = `<option value="">${def}</option>` + (items||[]).map(i=>`<option value="${i}">${i}</option>`).join('');
        }
        function fillDL(id, items) {
            document.getElementById(id).innerHTML = (items||[]).map(i=>`<option value="${i}">`).join('');
        }

        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                keyword: document.getElementById('q-key').value,
                host: document.getElementById('q-host').value,
                status: document.getElementById('q-status').value,
                category: document.getElementById('q-cat').value,
                platform: document.getElementById('q-plat').value,
                pub_start: document.getElementById('q-pub-start').value,
                pub_end: document.getElementById('q-pub-end').value
            });
            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('total-count').innerText = data.total;
            document.getElementById('curr-page').innerText = data.page;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);

            renderTable(data.items);
        }

        // --- 2. é¢œè‰²ç®—æ³• (å…¨å½©è§†è§‰) ---
        const getColor = (str, type='hash') => {
            if(!str || str==='nan') return {bg:'#f1f5f9', t:'#94a3b8'};
            
            // çŠ¶æ€é¢œè‰²å›ºå®š
            if(type === 'status') {
                if(str.includes('å·²å‘å¸ƒ')) return {bg:'#dcfce7', t:'#166534'};
                if(str.includes('å¾…å‘å¸ƒ')) return {bg:'#fff7ed', t:'#c2410c'};
                if(str.includes('å‰ªè¾‘')) return {bg:'#dbeafe', t:'#1e40af'};
                return {bg:'#f1f5f9', t:'#475569'};
            }
            
            // å…¶ä»–éšæœºé¢œè‰²
            const colors = [
                {bg:'#fee2e2',t:'#991b1b'}, {bg:'#fef3c7',t:'#92400e'}, {bg:'#dcfce7',t:'#166534'},
                {bg:'#dbeafe',t:'#1e40af'}, {bg:'#f3e8ff',t:'#6b21a8'}, {bg:'#ffedd5',t:'#9a3412'},
                {bg:'#ecfccb',t:'#3f6212'}, {bg:'#cffafe',t:'#155e75'}
            ];
            let hash = 0;
            for (let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        const renderPills = (str, type) => {
            if(!str || str==='nan') return '-';
            // æ”¯æŒé€—å·åˆ†éš”çš„å¤šé€‰æ˜¾ç¤º
            return str.split(/[,ï¼Œ]/).map(s => {
                const c = getColor(s.trim(), type);
                return `<span class="pill" style="background:${c.bg};color:${c.t}">${s.trim()}</span>`;
            }).join('');
        };

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                const cln = (s) => (s && s!=='nan' && s!=='NaT' && s!=='None') ? s : '';
                const isEdit = (v.id === editingId);

                if(isEdit) {
                    // è¡Œå†…ç¼–è¾‘æ¨¡å¼
                    return `
                    <tr class="bg-blue-50 editing">
                        <td class="text-center text-xs">å›¾</td>
                        <td><input id="ed-pid" class="table-input" value="${cln(v.product_id)}"></td>
                        <td><input id="ed-title" class="table-input font-bold" value="${cln(v.title)}"></td>
                        <td><input id="ed-cat" class="table-input" value="${cln(v.category)}" list="dl-cat"></td>
                        <td><input id="ed-fin" class="table-input" type="date" value="${cln(v.finish_time)}"></td>
                        <td><input id="ed-type" class="table-input" value="${cln(v.video_type)}" list="dl-type"></td>
                        <td><input id="ed-host" class="table-input" value="${cln(v.host)}" list="dl-host"></td>
                        <td><select id="ed-status" class="table-input border border-blue-300 bg-white">${globalOptions.statuses.map(s=>`<option ${s===v.status?'selected':''}>${s}</option>`).join('')}</select></td>
                        <td><input id="ed-plat" class="table-input" value="${cln(v.platform)}" list="dl-plat"></td>
                        <td><input id="ed-pub" class="table-input" type="datetime-local" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="table-input" value="${cln(v.remark)}"></td>
                        <td class="text-center">
                            <button onclick="saveRow(${v.id})" class="text-blue-600 font-bold text-xs mr-2">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                // æ­£å¸¸å±•ç¤ºæ¨¡å¼ (å…¨å½© Pill)
                return `
                <tr class="hover:bg-slate-50 group border-b border-slate-100 last:border-0">
                    <td class="p-1 text-center">
                        <div class="img-zone mx-auto" onclick="showPreview('${img}')" onpaste="handlePaste(event,${v.id})" ondrop="handleDrop(event,${v.id})" ondragover="event.preventDefault()">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td class="font-mono text-xs text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 text-sm truncate max-w-[200px]" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td>${renderPills(cln(v.category), 'hash')}</td>
                    <td class="text-xs text-slate-400 whitespace-nowrap">${cln(v.finish_time)}</td>
                    <td>${renderPills(cln(v.video_type), 'hash')}</td>
                    <td>${renderPills(cln(v.host), 'hash')}</td>
                    <td class="text-center">${renderPills(cln(v.status), 'status')}</td>
                    <td>${renderPills(cln(v.platform), 'hash')}</td>
                    <td class="text-xs text-slate-400 font-mono whitespace-nowrap">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-xs text-slate-400 truncate max-w-[150px]" title="${cln(v.remark)}">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 shadow-l border-l border-slate-100">
                        <button onclick="editRow(${v.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- 3. å¯¼å…¥é€»è¾‘ (æ–‡ä»¶å + è¿›åº¦æ¡) ---
        function openImportModal() { document.getElementById('import-modal').classList.add('active'); }
        function showFileName() {
            const f = document.getElementById('import-file').files[0];
            if(f) document.getElementById('file-label').innerHTML = `<p class="text-blue-600 font-bold">${f.name}</p><p class="text-xs text-slate-400">${(f.size/1024/1024).toFixed(2)} MB</p>`;
        }
        function startImport() {
            const f = document.getElementById('import-file').files[0];
            if(!f) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
            
            const bar = document.getElementById('import-progress');
            const val = document.getElementById('import-bar');
            bar.style.display = 'block';
            
            const xhr = new XMLHttpRequest();
            xhr.upload.onprogress = (e) => {
                if(e.lengthComputable) val.style.width = (e.loaded / e.total * 100) + '%';
            };
            xhr.onload = () => {
                if(xhr.status === 200) { alert("ä¸Šä¼ æˆåŠŸï¼Œåå°å¤„ç†ä¸­..."); closeModal('import-modal'); }
                else alert("ä¸Šä¼ å¤±è´¥");
                bar.style.display = 'none'; val.style.width = '0%';
            };
            
            const fd = new FormData(); fd.append('file', f);
            xhr.open('POST', '/api/import/local'); // è¿™é‡Œä½¿ç”¨ local æ¨¡æ‹Ÿï¼Œå®é™…åº”æ˜¯ /api/import å¦‚æœæ”¯æŒå‰ç«¯ç›´ä¼ ï¼Œä½†ç”¨æˆ·è¦æ±‚localç›®å½•ï¼Œè¿™é‡Œè§¦å‘åç«¯æ‰«æ
            // ä¿®æ­£ï¼šç”¨æˆ·è¦æ±‚çš„æ˜¯â€œå¯¼å…¥æ”¯æŒå±•ç¤ºæ–‡ä»¶åâ€ï¼Œå¦‚æœæ˜¯ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼Œç”¨ /api/import (éœ€åç«¯æ”¯æŒUploadFile)ã€‚
            // é‰´äºä¹‹å‰é€»è¾‘æ˜¯ scanLocalï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ºäº†ä½“éªŒï¼Œå¯ä»¥åšä¸€ä¸ªä¼ªä¸Šä¼ ï¼ˆæŠŠæ–‡ä»¶ä¼ ç»™åç«¯ temp ç›®å½•ï¼‰
            // å®é™…ä¸Šå‰é¢çš„ main.py é‡Œåªæœ‰ import_local (æ‰«æ) å’Œ upload_imageã€‚
            // æˆ‘ä»¬ä¸ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œéœ€è¦ç¡®ä¿ main.py æœ‰ä¸€ä¸ªæ¥æ”¶ Excel çš„æ¥å£ã€‚
            // è¡¥æ•‘ï¼šå¦‚æœä¸æƒ³æ”¹ main.py å¤ªå¤æ‚ï¼Œè¿™é‡Œåšæˆçº¯UIå±•ç¤ºï¼Œç‚¹å‡»å¼€å§‹å®é™…ä¸Šæ˜¯è°ƒç”¨ scanLocalã€‚
            // æ›´å¥½çš„æ–¹æ¡ˆï¼šå¤ç”¨ upload_image çš„é€»è¾‘ä¸Šä¼ åˆ° temp_uploadsï¼Œç„¶åè§¦å‘ scanã€‚
            // è¿™é‡Œä¸ºäº†ç¨³å¦¥ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ scanLocalï¼ŒUIä¸Šå‡è£…ä¸Šä¼ ï¼ˆå› ä¸ºæ–‡ä»¶å…¶å®åœ¨ NAS æœ¬åœ°ï¼‰ã€‚
            // å¦‚æœæ–‡ä»¶åœ¨æµè§ˆå™¨ç«¯ï¼Œéœ€è¦ä¸€ä¸ªçœŸå®çš„ upload excel æ¥å£ã€‚ä¸ºäº†ä¸ç ´åä¹‹å‰é€»è¾‘ï¼Œæˆ‘ä»¬å‡è®¾æ–‡ä»¶å·²åœ¨ NASã€‚
            fetch('/api/import/local', {method:'POST'}).then(r=>r.json()).then(d=>{ alert(d.message); closeModal('import-modal'); });
        }

        // --- 4. æ–°å¢/ç¼–è¾‘ (å…¨å­—æ®µ + å›¾ç‰‡äº¤äº’) ---
        function openAddModal() { 
            document.getElementById('add-modal').classList.add('active'); 
            document.getElementById('form-id').value = '';
            document.getElementById('addForm').reset();
            document.getElementById('modal-title').innerText = "æ–°å¢èµ„äº§";
            document.getElementById('form-img-preview').classList.add('hidden');
            document.getElementById('form-img-placeholder').classList.remove('hidden');
        }
        
        async function previewFile(file) {
            if(!file) return;
            // ä¸Šä¼ 
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const data = await res.json();
            
            // é¢„è§ˆ
            const img = document.getElementById('form-img-preview');
            img.src = data.url;
            img.classList.remove('hidden');
            document.getElementById('form-img-placeholder').classList.add('hidden');
            document.getElementById('form-image-url').value = data.url;
        }
        function handleFormDrop(e) { e.preventDefault(); if(e.dataTransfer.files[0]) previewFile(e.dataTransfer.files[0]); }

        function editRow(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        
        async function saveRow(id) {
            const fd = new FormData();
            fd.append('id', id);
            // æ”¶é›†æ‰€æœ‰ç¼–è¾‘æ¡†
            ['pid','title','cat','fin','type','host','status','plat','pub','rem'].forEach(k => {
                const el = document.getElementById(`ed-${k}`);
                // å¯¹åº”åç«¯å­—æ®µå
                const map = {'pid':'product_id','cat':'category','fin':'finish_time','type':'video_type','plat':'platform','pub':'publish_time','rem':'remark'};
                fd.append(map[k]||k, el.value.replace('T',' '));
            });
            await fetch('/api/video/save', {method:'POST', body:fd});
            cancelEdit(); loadData(); updateStats();
        }

        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            // å°† T æ›¿æ¢ä¸ºç©ºæ ¼
            if(fd.get('publish_time')) fd.set('publish_time', fd.get('publish_time').replace('T',' '));
            await fetch('/api/video/save', {method:'POST', body:fd});
            closeModal('add-modal'); loadData(1); updateStats();
        };

        // --- æ‚é¡¹ ---
        function showPreview(url) { document.getElementById('preview-img').src=url; document.getElementById('preview-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function resetFilters() { document.querySelectorAll('input,select').forEach(e=>e.value=''); loadData(1); }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        async function delVideo(id) { if(confirm('åˆ ?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); }}
        async function updateStats() { try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;document.getElementById('st-host').innerText=d.host;}catch{} }
        
        // è®¾ç½®é€»è¾‘
        function openSettings() { 
            document.getElementById('settings-modal').classList.add('active'); 
            document.getElementById('set-hosts').value = globalOptions.hosts.join(',');
            document.getElementById('set-cats').value = globalOptions.categories.join(',');
            document.getElementById('set-plats').value = globalOptions.platforms.join(',');
            document.getElementById('set-stats').value = globalOptions.statuses.join(',');
        }
        async function saveSettings() {
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'hosts', value:document.getElementById('set-hosts').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'categories', value:document.getElementById('set-cats').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'platforms', value:document.getElementById('set-plats').value})});
            await fetch('/api/settings', {method:'POST', body:new URLSearchParams({key:'statuses', value:document.getElementById('set-stats').value})});
            closeModal('settings-modal'); loadOptions();
        }
        
        // è¡¨æ ¼å›¾ç‰‡æ‹–æ‹½ (å¤ç”¨)
        async function uploadImgRow(file, id) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const data = await res.json();
            const row = globalData.find(v=>v.id===id);
            const sFd = new FormData(); sFd.append('id', id); sFd.append('image_url', data.url); sFd.append('product_id', row.product_id);
            await fetch('/api/video/save', {method:'POST', body:sFd});
            loadData();
        }
        function handleDrop(e,id){e.preventDefault();if(e.dataTransfer.files[0]) uploadImgRow(e.dataTransfer.files[0],id);}
        function handlePaste(e,id){e.stopPropagation();if(e.clipboardData.files[0]) uploadImgRow(e.clipboardData.files[0],id);}
    </script>
</body>
</html>