<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #1e293b; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 240px; background: #1e293b; color: #94a3b8; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: #334155; color: white; }
        .sidebar-item.active { background: #0f172a; color: white; border-left-color: #3b82f6; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f1f5f9; }
        
        /* Table */
        .table-container { flex: 1; overflow: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin: 0 16px 16px 16px; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { position: sticky; top: 0; background: #f8fafc; font-size: 13px; font-weight: 700; color: #475569; padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: left; z-index: 10; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* Inline Edit */
        .t-input { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; outline: none; background: white; }
        .t-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .editing { background: #eff6ff !important; }
        .new-row { background: #f0fdf4 !important; animation: fadeIn 0.3s; }

        /* Filter Panel */
        #filter-panel { transition: max-height 0.3s ease; overflow: hidden; max-height: 0; background: white; margin: 0 16px 16px; border-radius: 8px; padding: 0 16px; }
        #filter-panel.open { max-height: 500px; padding: 16px; }

        /* Pills & Images */
        .pill { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; border: 1px solid transparent; }
        .img-cell { width: 44px; height: 44px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .img-cell:hover { border-color: #3b82f6; }

        /* Modals & Popups */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .multi-pop { position: absolute; background: white; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; width: 200px; max-height: 200px; overflow-y: auto; z-index: 40; display: none; }
        .multi-pop.show { display: block; }
        .multi-opt { padding: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .multi-opt:hover { background: #f1f5f9; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen">

    <aside class="sidebar">
        <div class="h-16 flex items-center px-6 gap-3 mb-4">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">V</div>
            <h1 class="text-lg font-bold text-white">VideoHub</h1>
        </div>
        <div class="sidebar-item active" onclick="switchView('assets', this)">
            <span>ğŸ“¦</span> èµ„äº§ç®¡ç†
        </div>
        <div class="sidebar-item" onclick="switchView('report', this)">
            <span>ğŸ“Š</span> æ•°æ®ç»Ÿè®¡
        </div>
    </aside>

    <main class="main-content">
        
        <header class="h-16 flex justify-between items-center px-6 shrink-0 bg-white border-b border-slate-200 mb-4">
            <h2 class="text-lg font-bold text-slate-800" id="page-title">èµ„äº§ç®¡ç†</h2>
            <div class="flex items-center gap-3">
                <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢..." class="pl-3 pr-3 py-1.5 w-64 bg-slate-100 border-none rounded text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="toggleFilters()" class="text-slate-500 hover:text-blue-600 p-2 border rounded hover:bg-slate-50 text-sm">ç­›é€‰</button>
                <button onclick="openSettings()" class="text-slate-500 hover:text-blue-600 p-2 border rounded hover:bg-slate-50 text-sm">é…ç½®</button>
                <button onclick="addNewRow()" class="bg-emerald-600 text-white text-sm font-bold px-4 py-2 rounded hover:bg-emerald-700 shadow">+ æ–°å¢ä¸€è¡Œ</button>
            </div>
        </header>

        <div id="view-assets" class="flex flex-col flex-1 overflow-hidden">
            
            <div class="px-6 mb-4 grid grid-cols-3 gap-4 shrink-0">
                <div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                    <div><div class="text-xs text-slate-400 font-bold">æ€»èµ„äº§</div><div class="text-xl font-black" id="st-total">-</div></div>
                </div>
                <div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                    <div><div class="text-xs text-orange-400 font-bold">å¾…å‘å¸ƒ</div><div class="text-xl font-black text-orange-500" id="st-pending">-</div></div>
                </div>
                <div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                    <div><div class="text-xs text-emerald-400 font-bold">æ‰¹é‡æ“ä½œ</div>
                    <button onclick="openImport()" class="text-blue-600 text-xs font-bold hover:underline">å¯¼å…¥æ•°æ®</button></div>
                </div>
            </div>

            <div id="filter-panel">
                <div class="grid grid-cols-6 gap-4 py-2">
                    <input id="s-pid" list="dl-pids" class="t-input" placeholder="ç¼–å·...">
                    <input id="s-title" class="t-input" placeholder="æ ‡é¢˜...">
                    <select id="s-cat" class="t-input"></select>
                    <select id="s-type" class="t-input"></select>
                    <select id="s-status" class="t-input"></select>
                    <select id="s-host" class="t-input"></select>
                    <div class="col-span-6 flex justify-end gap-2 border-t pt-2">
                        <button onclick="loadData(1)" class="bg-slate-800 text-white text-xs px-4 py-2 rounded">æŸ¥è¯¢</button>
                        <button onclick="resetFilters()" class="bg-white border text-xs px-4 py-2 rounded">é‡ç½®</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="w-16">å›¾</th>
                            <th class="w-24" onclick="sortBy('product_id')">ç¼–å· â†•</th>
                            <th style="min-width: 240px" onclick="sortBy('title')">æ ‡é¢˜ â†•</th>
                            <th class="w-24">ç±»å‹</th>
                            <th class="w-24">è§†ç±»</th>
                            <th class="w-28">ä¸»æ’­(å¤š)</th>
                            <th class="w-24">çŠ¶æ€</th>
                            <th class="w-28">å¹³å°(å¤š)</th>
                            <th class="w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-40">å¤‡æ³¨</th>
                            <th class="w-20 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            
            <div class="h-12 bg-white border-t px-6 flex justify-between items-center shrink-0">
                <span id="page-info" class="text-xs text-slate-500">0 æ¡</span>
                <div class="flex gap-2">
                    <button id="btn-prev" onclick="changePage(-1)" class="px-2 py-1 bg-slate-100 rounded text-xs">â—€</button>
                    <button id="btn-next" onclick="changePage(1)" class="px-2 py-1 bg-slate-100 rounded text-xs">â–¶</button>
                </div>
            </div>
        </div>

        <div id="view-report" class="hidden flex-1 overflow-y-auto p-6">
            <div class="flex justify-end gap-2 mb-4">
                <button onclick="loadReport('day')" class="px-3 py-1 bg-white border rounded text-xs">æ—¥</button>
                <button onclick="loadReport('week')" class="px-3 py-1 bg-white border rounded text-xs">å‘¨</button>
                <button onclick="loadReport('month')" class="px-3 py-1 bg-white border rounded text-xs">æœˆ</button>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-xl border shadow-sm col-span-2 lg:col-span-1" style="height: 400px;" id="chart-trend"></div>
                <div class="bg-white p-4 rounded-xl border shadow-sm col-span-2 lg:col-span-1" style="height: 400px;" id="chart-plat"></div>
            </div>
        </div>

    </main>

    <div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh]"></div>
    <div id="multi-pop" class="multi-pop"></div>
    <datalist id="dl-pids"></datalist>

    <div id="import-modal" class="modal">
        <div class="bg-white rounded-xl w-[400px] p-8 text-center">
            <h3 class="font-bold text-xl mb-4">å¯¼å…¥</h3>
            <p class="text-sm text-slate-500 mb-6">ç¡®ä¿ Excel åœ¨ temp_uploads ç›®å½•</p>
            <button onclick="startImport()" class="w-full bg-slate-800 text-white py-2 rounded font-bold">æ‰«æ</button>
            <button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs">å…³é—­</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="bg-white rounded-xl w-[400px] p-6">
            <h3 class="font-bold mb-4">é…ç½®</h3>
            <textarea id="set-hosts" class="t-input h-20 mb-2" placeholder="ä¸»æ’­..."></textarea>
            <input id="set-cats" class="t-input mb-2" placeholder="ç±»å‹...">
            <input id="set-types" class="t-input mb-2" placeholder="è§†ç±»...">
            <input id="set-plats" class="t-input mb-4" placeholder="å¹³å°...">
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded">ä¿å­˜</button>
            <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-slate-400 text-xs">å…³é—­</button>
        </div>
    </div>

    <script>
        let currPage=1, totalPages=1, currentSort={col:'id',order:'desc'};
        let globalOptions={}, editingId=null, globalData=[];
        let charts={};

        (async()=>{ await loadOptions(); await loadData(1); updateStats(); 
            document.addEventListener('click',e=>{if(!e.target.closest('.multi-pop')&&!e.target.closest('.multi-trig')) document.getElementById('multi-pop').classList.remove('show')});
        })();

        function switchView(v, btn) {
            document.querySelectorAll('.sidebar-item').forEach(e=>e.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('view-assets').classList.add('hidden');
            document.getElementById('view-report').classList.add('hidden');
            document.getElementById('view-'+v).classList.remove('hidden');
            document.getElementById('page-title').innerText = v==='assets'?'èµ„äº§ç®¡ç†':'æ•°æ®ç»Ÿè®¡';
            if(v==='report') loadReport('day');
        }

        async function loadOptions() {
            const res=await fetch('/api/options'); globalOptions=await res.json();
            const fill=(id,l)=>document.getElementById(id).innerHTML=`<option value="">å…¨éƒ¨</option>`+l.map(i=>`<option>${i}</option>`).join('');
            fill('s-cat',globalOptions.categories); fill('s-type',globalOptions.video_types);
            fill('s-host',globalOptions.hosts); fill('s-status',globalOptions.statuses);
            document.getElementById('dl-pids').innerHTML=globalOptions.product_ids.map(i=>`<option>${i}</option>`).join('');
        }

        async function loadData(p) {
            currPage=p||currPage;
            const params=new URLSearchParams({page:currPage,size:100,sort_by:currentSort.col,order:currentSort.order,
                keyword:document.getElementById('g-search').value,
                product_id:document.getElementById('s-pid').value, title:document.getElementById('s-title').value,
                category:document.getElementById('s-cat').value, video_type:document.getElementById('s-type').value,
                host:document.getElementById('s-host').value, status:document.getElementById('s-status').value
            });
            const res=await fetch(`/api/videos?${params}`); const data=await res.json();
            globalData=data.items; totalPages=data.total_pages;
            document.getElementById('total-count').innerText=data.total;
            document.getElementById('page-info').innerText=`${data.page}/${data.total_pages}`;
            renderTable(data.items);
        }

        function addNewRow() {
            globalData.unshift({id:'new',product_id:'',title:'',isNew:true});
            editingId='new'; renderTable(globalData);
        }

        function renderTable(items) {
            document.getElementById('table-body').innerHTML = items.map(v => {
                const isEdit = (v.id===editingId);
                const cln = s => (s&&s!=='nan'?s:'');
                const img = (v.image_url&&!v.image_url.includes('default'))?v.image_url:'';

                if(isEdit) {
                    const sel=(k,l)=>`<select id="ed-${k}" class="t-input">${l.map(o=>`<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                    const mul=(k,t)=>`<input id="ed-${k}" class="t-input multi-trig" value="${cln(v[k])}" readonly onclick="openMulti(this,'${t}')" placeholder="é€‰æ‹©">`;
                    return `<tr class="editing ${v.isNew?'new-row':''}">
                        <td class="p-2"><div class="img-cell mx-auto" onclick="document.getElementById('up-${v.id}').click()">${img?`<img src="${img}" class="w-full h-full object-cover">`:'+'}</div><input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this,'${v.id}')"><input type="hidden" id="ed-img" value="${cln(v.image_url)}"></td>
                        <td><input id="ed-pid" class="t-input" value="${cln(v.product_id)}"></td>
                        <td><input id="ed-title" class="t-input font-bold" value="${cln(v.title)}"></td>
                        <td>${sel('cat',globalOptions.categories)}</td>
                        <td><input id="ed-fin" type="date" class="t-input" value="${cln(v.finish_time)}"></td>
                        <td>${sel('type',globalOptions.video_types)}</td>
                        <td>${mul('host','hosts')}</td>
                        <td>${sel('status',globalOptions.statuses)}</td>
                        <td>${mul('plat','platforms')}</td>
                        <td><input id="ed-pub" type="datetime-local" class="t-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="t-input" value="${cln(v.remark)}"></td>
                        <td class="text-center"><button onclick="saveRow('${v.id}')" class="text-blue-600 font-bold text-xs">ä¿å­˜</button> <button onclick="cancelEdit()" class="text-slate-400 text-xs">å–æ¶ˆ</button></td>
                    </tr>`;
                }
                return `<tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="p-2 text-center"><div class="img-cell mx-auto" onclick="showBig('${img}')"><img src="${img||'/assets/default.png'}" class="w-full h-full object-cover"></div></td>
                    <td class="text-slate-500 font-mono">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 truncate" style="max-width:240px" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td><span class="pill bg-slate-100">${cln(v.category)}</span></td>
                    <td class="text-slate-400 text-xs">${cln(v.finish_time)}</td>
                    <td><span class="pill bg-slate-100">${cln(v.video_type)}</span></td>
                    <td>${cln(v.host)}</td>
                    <td class="text-center"><span class="pill ${v.status==='å·²å‘å¸ƒ'?'bg-emerald-100 text-emerald-700':'bg-orange-100 text-orange-600'}">${cln(v.status)}</span></td>
                    <td>${cln(v.platform)}</td>
                    <td class="text-slate-400 text-xs">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-slate-400 truncate max-w-[100px] text-xs">${cln(v.remark)}</td>
                    <td class="text-center"><button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs">ç¼–è¾‘</button> <button onclick="delVideo(${v.id})" class="text-red-400 text-xs">åˆ </button></td>
                </tr>`;
            }).join('');
        }

        function startEdit(id){editingId=id;renderTable(globalData);}
        function cancelEdit(){editingId=null;loadData();}
        async function saveRow(id){
            const fd=new FormData(); if(id!=='new') fd.append('id',id);
            ['pid','title','cat','fin','type','host','status','plat','pub','rem'].forEach(k=>{
                fd.append({'pid':'product_id','cat':'category','fin':'finish_time','type':'video_type','plat':'platform','pub':'publish_time','rem':'remark'}[k]||k, document.getElementById('ed-'+k).value.replace('T',' '));
            });
            fd.append('image_url',document.getElementById('ed-img').value);
            await fetch('/api/video/save',{method:'POST',body:fd});
            editingId=null; loadData(); updateStats();
        }

        async function upImg(input, id) {
            const fd = new FormData(); fd.append('file', input.files[0]);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            document.getElementById('ed-img').value = d.url;
            globalData.find(v => v.id == id || v.id === 'new').image_url = d.url;
            renderTable(globalData);
        }

        async function loadReport(dim) {
            const res = await fetch(`/api/report?dim=${dim}`); const d = await res.json();
            if(!charts.t) charts.t = echarts.init(document.getElementById('chart-trend'));
            charts.t.setOption({tooltip:{trigger:'axis'},legend:{data:['å…¥åº“','å‘å¸ƒ']},xAxis:{type:'category',data:d.dates},yAxis:{type:'value'},series:[{name:'å…¥åº“',type:'line',data:d.series_in,smooth:true},{name:'å‘å¸ƒ',type:'bar',data:d.series_out}]});
            if(!charts.p) charts.p = echarts.init(document.getElementById('chart-plat'));
            charts.p.setOption({tooltip:{trigger:'item'},series:[{type:'pie',radius:['40%','70%'],data:d.platforms}]});
        }

        function openMulti(input,type){
            const pop=document.getElementById('multi-pop'); const r=input.getBoundingClientRect();
            const curr=input.value.split(/[,ï¼Œ]/).map(s=>s.trim());
            pop.innerHTML=globalOptions[type].map(o=>`<div class="multi-opt" onclick="togOpt('${input.id}','${o}','${type}')"><span class="${curr.includes(o)?'text-blue-600 font-bold':''}">${curr.includes(o)?'âœ“':''}</span> ${o}</div>`).join('');
            pop.style.top=(r.bottom+window.scrollY)+'px'; pop.style.left=(r.left+window.scrollX)+'px'; pop.classList.add('show');
        }
        function togOpt(eid,v,type){
            const inp=document.getElementById(eid); let vals=inp.value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s);
            if(vals.includes(v)) vals=vals.filter(i=>i!==v); else vals.push(v);
            inp.value=vals.join(','); openMulti(inp,type);
        }

        function toggleFilters(){document.getElementById('filter-panel').classList.toggle('open');}
        function showBig(s){if(s){document.getElementById('big-img').src=s;document.getElementById('preview-modal').classList.add('active');}}
        function resetFilters(){document.querySelectorAll('#filter-panel input,select').forEach(e=>e.value='');loadData(1);}
        function changePage(d){if(currPage+d>0&&currPage+d<=totalPages)loadData(currPage+d);}
        function sortBy(c){currentSort.col=c;currentSort.order=currentSort.order==='asc'?'desc':'asc';loadData(1);}
        async function delVideo(id){if(confirm('åˆ ?')){await fetch(`/api/video/${id}`,{method:'DELETE'});loadData();updateStats();}}
        function openSettings(){document.getElementById('settings-modal').classList.add('active');
            document.getElementById('set-hosts').value=globalOptions.hosts.join(',');
            document.getElementById('set-cats').value=globalOptions.categories.join(',');
            document.getElementById('set-types').value=globalOptions.video_types.join(',');
            document.getElementById('set-plats').value=globalOptions.platforms.join(',');
        }
        async function saveSettings(){
            const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})});
            await s('hosts',document.getElementById('set-hosts').value);
            await s('categories',document.getElementById('set-cats').value);
            await s('video_types',document.getElementById('set-types').value);
            await s('platforms',document.getElementById('set-plats').value);
            document.getElementById('settings-modal').classList.remove('active'); loadOptions();
        }
        function openImport(){document.getElementById('import-modal').classList.add('active');}
        async function startImport(){await fetch('/api/import/local',{method:'POST'});alert('å·²å¯åŠ¨');document.getElementById('import-modal').classList.remove('active');}
        async function updateStats(){try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;}catch{}}
    </script>
</body>
</html>