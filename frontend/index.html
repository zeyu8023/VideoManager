<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V6.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* 1. è¡¨æ ¼æ ·å¼ (å…¨å®½å¸ƒå±€) */
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; table-layout: fixed; }
        th { font-size: 13px; font-weight: 700; color: #475569; padding: 12px 8px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; text-align: left; cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; color: #0f172a; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr:hover td { background: #f8fafc; }

        /* 2. è¡Œå†…ç¼–è¾‘è¾“å…¥æ¡† */
        .table-input { width: 100%; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; background: white; outline: none; height: 30px; }
        .table-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        tr.editing { background: #eff6ff !important; } /* ç¼–è¾‘æ—¶é«˜äº®æ•´è¡Œ */

        /* 3. ç­›é€‰é¢æ¿åŠ¨ç”» */
        #filter-panel { transition: all 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        #filter-panel.open { max-height: 400px; opacity: 1; padding: 16px 24px; border-bottom: 1px solid #cbd5e1; }

        /* 4. å½©è‰²èƒ¶å›Š (è§†è§‰ä¼˜åŒ–) */
        .pill { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; border: 1px solid transparent; }
        
        /* 5. å›¾ç‰‡ä¸Šä¼ åŒº */
        .img-zone { width: 44px; height: 44px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; overflow: hidden; cursor: pointer; position: relative; transition: all 0.2s; }
        .img-zone:hover { transform: scale(1.1); border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .img-zone:hover::after { content: 'æ›¿æ¢'; position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; }

        /* 6. æ¨¡æ€æ¡† */
        .modal { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        /* æ’åºå›¾æ ‡ */
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; color: #94a3b8; }
        th:hover .sort-icon { color: #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">V</div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">VideoHub</h1>
            </div>
            
            <div class="relative group">
                <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input id="global-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="è¾“å…¥ç¼–å· / æ ‡é¢˜ / å¤‡æ³¨ å›è½¦æœç´¢..." class="pl-10 pr-4 py-2 w-96 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="toggleFilter()" class="flex items-center gap-2 text-sm font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-lg border border-transparent hover:border-slate-200 transition-all active:scale-95">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                é«˜çº§ç­›é€‰
            </button>
            <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold px-5 py-2 rounded-lg shadow-md shadow-blue-100 transition-all flex items-center gap-2 active:scale-95">
                <span class="text-lg leading-none">+</span> æ–°å¢èµ„äº§
            </button>
            <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">âš™ï¸</button>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-4 shrink-0">
        <div class="flex gap-6">
            <div class="flex-1 bg-slate-50 border border-slate-100 p-4 rounded-2xl flex items-center justify-between">
                <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">æ€»èµ„äº§åº“å­˜</div><div class="text-3xl font-black text-slate-800 mt-1" id="st-total">-</div></div>
                <div class="text-3xl opacity-80">ğŸ“¦</div>
            </div>
            <div class="flex-1 bg-orange-50 border border-orange-100 p-4 rounded-2xl flex items-center justify-between">
                <div><div class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">å¾…å‘å¸ƒ</div><div class="text-3xl font-black text-orange-500 mt-1" id="st-pending">-</div></div>
                <div class="text-3xl opacity-80">ğŸ”¥</div>
            </div>
            <div class="flex-1 bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex items-center justify-between">
                <div><div class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider">æœ¬æœˆåŠ³æ¨¡</div><div class="text-3xl font-black text-emerald-600 mt-1" id="st-host">-</div></div>
                <div class="text-3xl opacity-80">ğŸ†</div>
            </div>
        </div>
    </div>

    <div id="filter-panel" class="shrink-0">
        <div class="grid grid-cols-6 gap-x-4 gap-y-4">
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">äº§å“ç¼–å· (è‡ªåŠ¨è”æƒ³)</label><input id="s-pid" list="dl-pids" class="table-input" placeholder="è¾“å…¥æˆ–é€‰æ‹©..."></div>
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="table-input" placeholder="åŒ…å«æ–‡å­—..."></div>
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">äº§å“ç±»å‹</label><select id="s-cat" class="table-input"></select></div>
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">ä¸»æ’­</label><select id="s-host" class="table-input"></select></div>
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">å‘å¸ƒçŠ¶æ€</label><select id="s-status" class="table-input"></select></div>
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">å‘å¸ƒå¹³å°</label><select id="s-plat" class="table-input"></select></div>
            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">è§†é¢‘ç±»å‹</label><select id="s-type" class="table-input"></select></div>
            <div class="col-span-2"><label class="block text-[10px] font-bold text-slate-400 mb-1">å®Œæˆæ—¶é—´èŒƒå›´</label><div class="flex gap-2"><input type="date" id="s-fin-start" class="table-input"><input type="date" id="s-fin-end" class="table-input"></div></div>
            <div class="col-span-2"><label class="block text-[10px] font-bold text-slate-400 mb-1">å‘å¸ƒæ—¶é—´èŒƒå›´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="table-input"><input type="date" id="s-pub-end" class="table-input"></div></div>
            <div class="col-span-1 flex items-end">
                <div class="flex gap-2 w-full">
                    <button onclick="resetFilter()" class="flex-1 bg-white border border-slate-300 text-slate-600 font-bold text-xs py-1.5 rounded hover:bg-slate-50">é‡ç½®</button>
                    <button onclick="loadData(1)" class="flex-1 bg-slate-800 text-white font-bold text-xs py-1.5 rounded hover:bg-black">ç­›é€‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 bg-slate-50 overflow-hidden w-full relative border-t border-slate-200">
        <div class="absolute inset-0 overflow-auto">
            <table class="w-full text-left">
                <thead class="sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="w-16 text-center">å›¾</th>
                        <th onclick="sortBy('product_id')" class="w-24">ç¼–å· <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('title')" style="min-width:220px">è§†é¢‘æ ‡é¢˜ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('category')" class="w-24">äº§å“ç±»å‹ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('finish_time')" class="w-28">å®Œæˆæ—¶é—´ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('video_type')" class="w-24">è§†é¢‘ç±»å‹ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('host')" class="w-24">ä¸»æ’­ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('status')" class="w-24 text-center">çŠ¶æ€ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('platform')" class="w-28">å‘å¸ƒå¹³å° <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('publish_time')" class="w-32">å‘å¸ƒæ—¶é—´ <span class="sort-icon">â†•</span></th>
                        <th onclick="sortBy('remark')" class="w-32">å¤‡æ³¨ <span class="sort-icon">â†•</span></th>
                        <th class="w-24 text-center sticky right-0 bg-slate-100 border-l border-slate-200">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-200 bg-white"></tbody>
            </table>
        </div>
    </div>
    
    <div class="h-10 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0 text-xs text-slate-500 font-medium z-30">
        <div class="flex gap-4">
            <span class="bg-slate-100 px-2 py-1 rounded text-slate-600">å…± <b id="total-count" class="text-slate-900">0</b> æ¡æ•°æ®</span>
            <button onclick="openImport()" class="text-blue-600 hover:underline">æ‰¹é‡å¯¼å…¥æ•°æ®</button>
        </div>
        <div class="flex gap-2 items-center">
            <button id="btn-prev" onclick="changePage(-1)" class="px-2 py-1 hover:bg-slate-100 rounded disabled:opacity-50">â—€ ä¸Šä¸€é¡µ</button>
            <span id="page-info" class="font-mono">1 / 1</span>
            <button id="btn-next" onclick="changePage(1)" class="px-2 py-1 hover:bg-slate-100 rounded disabled:opacity-50">ä¸‹ä¸€é¡µ â–¶</button>
        </div>
    </div>

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center cursor-zoom-out" onclick="this.classList.add('hidden')">
        <img id="big-img" src="" class="max-h-[90vh] max-w-[90vw] object-contain">
    </div>

    <div id="add-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[600px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4 text-lg text-slate-800">æ–°å¢èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-2 gap-4">
                <input name="product_id" placeholder="äº§å“ç¼–å· *" required class="table-input border-slate-300 h-9">
                <input name="title" placeholder="è§†é¢‘æ ‡é¢˜ *" required class="table-input border-slate-300 h-9">
                <select name="category" id="add-cat" class="table-input border-slate-300 h-9"></select>
                <select name="host" id="add-host" class="table-input border-slate-300 h-9"></select>
                <select name="status" id="add-status" class="table-input border-slate-300 h-9"></select>
                <select name="platform" id="add-plat" class="table-input border-slate-300 h-9"></select>
                <input name="finish_time" placeholder="å®Œæˆæ—¶é—´" type="date" class="table-input border-slate-300 h-9">
                <select name="video_type" id="add-type" class="table-input border-slate-300 h-9"></select>
                <div class="col-span-2 flex justify-end gap-2 pt-2 border-t mt-2">
                    <button type="button" onclick="closeModal('add-modal')" class="px-4 py-2 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700">ä¿å­˜å½•å…¥</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl">
            <div class="text-4xl mb-4">ğŸ“‚</div>
            <h3 class="font-bold mb-2 text-lg">æ‰¹é‡å¯¼å…¥æ•°æ®</h3>
            <p class="text-xs text-slate-500 mb-6">è¯·ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ è‡³ NAS çš„ <code class="bg-slate-100 px-1 rounded">temp_uploads</code> ç›®å½•</p>
            <button onclick="startImport()" class="w-full bg-slate-800 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-black transition-all">å¼€å§‹æ‰«æå¹¶å¯¼å…¥</button>
            <button onclick="closeModal('import-modal')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å–æ¶ˆæ“ä½œ</button>
        </div>
    </div>

    <div id="settings-modal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl w-[450px] p-6 shadow-2xl">
            <h3 class="font-bold mb-4">å…¨å±€é€‰é¡¹é…ç½® (é€—å·åˆ†éš”)</h3>
            <div class="space-y-3">
                <div><label class="text-[10px] font-bold text-slate-400">ä¸»æ’­</label><textarea id="set-hosts" class="table-input h-16"></textarea></div>
                <div><label class="text-[10px] font-bold text-slate-400">äº§å“ç±»å‹</label><input id="set-cats" class="table-input"></div>
                <div><label class="text-[10px] font-bold text-slate-400">å‘å¸ƒå¹³å°</label><input id="set-plats" class="table-input"></div>
                <div><label class="text-[10px] font-bold text-slate-400">è§†é¢‘ç±»å‹</label><input id="set-types" class="table-input"></div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold mt-4">ä¿å­˜é…ç½®</button>
            <button onclick="closeModal('settings-modal')" class="w-full mt-2 text-slate-400 text-sm">å…³é—­</button>
        </div>
    </div>

    <datalist id="dl-pids"></datalist>

    <script>
        let currPage = 1, totalPages = 1, currentSort = { col: 'id', order: 'desc' };
        let globalOptions = {};
        let editingId = null; // å½“å‰ç¼–è¾‘è¡Œçš„ ID
        let globalData = [];  // å½“å‰é¡µæ•°æ®ç¼“å­˜

        // åˆå§‹åŒ–
        (async () => {
            await loadOptions();
            await loadData(1);
            updateStats();
        })();

        // --- 1. æ ¸å¿ƒæ•°æ®é€»è¾‘ ---
        async function loadOptions() {
            const res = await fetch('/api/options');
            globalOptions = await res.json();
            
            // å¡«å……ç­›é€‰ä¸‹æ‹‰æ¡† (å…¨éƒ¨)
            const fill = (id, items) => {
                document.getElementById(id).innerHTML = `<option value="">å…¨éƒ¨</option>` + items.map(i=>`<option value="${i}">${i}</option>`).join('');
            };
            fill('s-cat', globalOptions.categories);
            fill('s-host', globalOptions.hosts);
            fill('s-status', globalOptions.statuses);
            fill('s-plat', globalOptions.platforms);
            fill('s-type', globalOptions.video_types);

            // å¡«å……æ–°å¢/ç¼–è¾‘ä¸‹æ‹‰æ¡† (å¿…é€‰)
            const fillReq = (id, items) => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = items.map(i=>`<option value="${i}">${i}</option>`).join('');
            };
            fillReq('add-cat', globalOptions.categories);
            fillReq('add-host', globalOptions.hosts);
            fillReq('add-status', globalOptions.statuses);
            fillReq('add-plat', globalOptions.platforms);
            fillReq('add-type', globalOptions.video_types);

            // å¡«å……äº§å“ç¼–å·è”æƒ³
            document.getElementById('dl-pids').innerHTML = globalOptions.product_ids.map(p=>`<option value="${p}">`).join('');
        }

        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                sort_by: currentSort.col, order: currentSort.order,
                keyword: document.getElementById('global-search').value,
                
                product_id: document.getElementById('s-pid').value,
                title: document.getElementById('s-title').value,
                host: document.getElementById('s-host').value,
                status: document.getElementById('s-status').value,
                category: document.getElementById('s-cat').value,
                platform: document.getElementById('s-plat').value,
                video_type: document.getElementById('s-type').value,
                
                pub_start: document.getElementById('s-pub-start').value,
                pub_end: document.getElementById('s-pub-end').value,
                fin_start: document.getElementById('s-fin-start').value,
                fin_end: document.getElementById('s-fin-end').value
            });

            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;
            
            document.getElementById('total-count').innerText = data.total;
            document.getElementById('page-info').innerText = `${data.page} / ${data.total_pages}`;
            document.getElementById('btn-prev').disabled = (data.page <= 1);
            document.getElementById('btn-next').disabled = (data.page >= data.total_pages);

            renderTable(data.items);
        }

        // --- 2. æ¸²æŸ“è¡¨æ ¼ (çœŸÂ·è¡Œå†…ç¼–è¾‘) ---
        const getColor = (str, type) => {
            if(!str || str==='nan') return {bg:'#f1f5f9', t:'#94a3b8'};
            if(type==='status') {
                if(str.includes('å·²å‘å¸ƒ')) return {bg:'#dcfce7', t:'#166534'};
                if(str.includes('å¾…å‘å¸ƒ')) return {bg:'#fff7ed', t:'#c2410c'};
                return {bg:'#f1f5f9', t:'#475569'};
            }
            const c=[{bg:'#fee2e2',t:'#991b1b'},{bg:'#dbeafe',t:'#1e40af'},{bg:'#fef3c7',t:'#92400e'},{bg:'#f3e8ff',t:'#6b21a8'}];
            let h=0; for(let i=0;i<str.length;i++) h=str.charCodeAt(i)+((h<<5)-h);
            return c[Math.abs(h)%c.length];
        };
        const pill = (s,t) => !s||s==='nan'?'-':s.split(/[,ï¼Œ]/).map(x=>`<span class="pill" style="background:${getColor(x.trim(),t).bg};color:${getColor(x.trim(),t).t}">${x.trim()}</span>`).join('');
        const cln = s => (s && s!=='nan' && s!=='NaT' && s!=='None') ? s : '';

        function renderTable(items) {
            document.getElementById('table-body').innerHTML = items.map(v => {
                const img = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                
                // === ç¼–è¾‘æ¨¡å¼ ===
                if (v.id === editingId) {
                    const sel = (k, list) => `<select id="ed-${k}" class="table-input bg-blue-50 border-blue-300">${list.map(o => `<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                    return `
                    <tr class="editing border-b border-blue-200">
                        <td class="p-1"><div class="w-10 h-10 bg-slate-200 rounded mx-auto"></div></td>
                        <td><input id="ed-pid" class="table-input" value="${cln(v.product_id)}"></td>
                        <td><input id="ed-title" class="table-input font-bold" value="${cln(v.title)}"></td>
                        <td>${sel('category', globalOptions.categories)}</td>
                        <td><input id="ed-fin" type="date" class="table-input" value="${cln(v.finish_time)}"></td>
                        <td>${sel('video_type', globalOptions.video_types)}</td>
                        <td>${sel('host', globalOptions.hosts)}</td>
                        <td>${sel('status', globalOptions.statuses)}</td>
                        <td>${sel('platform', globalOptions.platforms)}</td>
                        <td><input id="ed-pub" type="datetime-local" class="table-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="table-input" value="${cln(v.remark)}"></td>
                        <td class="text-center">
                            <button onclick="saveRow(${v.id})" class="text-white bg-blue-600 px-2 py-1 rounded text-xs">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1 hover:text-slate-600">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                // === æ­£å¸¸æ¨¡å¼ ===
                return `
                <tr class="hover:bg-slate-50 group border-b border-slate-100 last:border-0 transition-colors">
                    <td class="p-1 text-center">
                        <div class="img-zone mx-auto" onclick="showBigImg('${img}')" 
                             onpaste="handleRowPaste(event,${v.id})" ondrop="handleRowDrop(event,${v.id})" ondragover="event.preventDefault()">
                            <img src="${img}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                    </td>
                    <td class="font-mono text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 text-sm truncate max-w-[240px]" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td>${pill(cln(v.category))}</td>
                    <td class="text-slate-400 font-mono text-xs">${cln(v.finish_time)}</td>
                    <td>${pill(cln(v.video_type))}</td>
                    <td>${pill(cln(v.host))}</td>
                    <td class="text-center">${pill(cln(v.status), 'status')}</td>
                    <td>${pill(cln(v.platform))}</td>
                    <td class="text-slate-400 font-mono text-xs whitespace-nowrap">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-slate-400 truncate max-w-[100px]" title="${cln(v.remark)}">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l">
                        <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- 3. ç¼–è¾‘ä¸ä¿å­˜ ---
        function startEdit(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        
        async function saveRow(id) {
            const fd = new FormData();
            fd.append('id', id);
            // æ˜ å°„å­—æ®µ
            const map = {'pid':'product_id', 'title':'title', 'cat':'category', 'fin':'finish_time', 
                         'type':'video_type', 'host':'host', 'status':'status', 'plat':'platform', 'pub':'publish_time', 'rem':'remark'};
            for (let [k, dbKey] of Object.entries(map)) {
                const el = document.getElementById(`ed-${k}`);
                if(el) fd.append(dbKey, el.value.replace('T', ' '));
            }
            
            await fetch('/api/video/save', {method:'POST', body:fd});
            editingId = null; loadData(); updateStats();
        }

        // --- 4. äº¤äº’é€»è¾‘ ---
        function toggleFilter() { document.getElementById('filter-panel').classList.toggle('open'); }
        function showBigImg(src) { document.getElementById('big-img').src=src; document.getElementById('preview-modal').classList.remove('hidden'); }
        function sortBy(col) { 
            currentSort.col = col; 
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc'; 
            loadData(1); 
        }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
        function resetFilter() { document.querySelectorAll('.table-input').forEach(e => e.value=''); loadData(1); }

        // --- æ‹–æ‹½å›¾ç‰‡ ---
        async function uploadRowImg(file, id) {
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            // è·å–æ—§æ•°æ®
            const row = globalData.find(v => v.id === id);
            const sfd = new FormData(); sfd.append('id', id); sfd.append('image_url', d.url); sfd.append('product_id', row.product_id);
            await fetch('/api/video/save', {method:'POST', body:sfd});
            loadData();
        }
        function handleRowDrop(e, id) { e.preventDefault(); if(e.dataTransfer.files[0]) uploadRowImg(e.dataTransfer.files[0], id); }
        function handleRowPaste(e, id) { e.stopPropagation(); if(e.clipboardData.files[0]) uploadRowImg(e.clipboardData.files[0], id); }

        // --- å¼¹çª—ä¸é…ç½® ---
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openImport() { document.getElementById('import-modal').classList.add('active'); }
        async function startImport() { await fetch('/api/import/local', {method:'POST'}); alert('ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨ååˆ·æ–°'); closeModal('import-modal'); }
        
        function openAddModal() { document.getElementById('add-modal').classList.add('active'); }
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/api/video/save', {method:'POST', body:new FormData(e.target)});
            closeModal('add-modal'); loadData(1); updateStats();
        };

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            document.getElementById('set-hosts').value = globalOptions.hosts.join(',');
            document.getElementById('set-cats').value = globalOptions.categories.join(',');
            document.getElementById('set-plats').value = globalOptions.platforms.join(',');
            document.getElementById('set-types').value = globalOptions.video_types.join(',');
        }
        async function saveSettings() {
            const fd = new FormData();
            fd.append('key','hosts'); fd.append('value', document.getElementById('set-hosts').value); await fetch('/api/settings', {method:'POST', body:fd});
            // ... (å…¶ä»–åŒç†ï¼Œä¸ºèŠ‚çœé•¿åº¦ç•¥å†™ï¼Œå®é™…ä»£ç è¯·å®Œæ•´å¤åˆ¶ä¸Šæ–¹é€»è¾‘)
            // ä¿®æ­£ï¼šè¿™é‡Œéœ€è¦å®Œæ•´å†™å‡ºæ‰€æœ‰ fetch
            const post = (k,v) => { const f=new FormData(); f.append('key',k); f.append('value',v); fetch('/api/settings',{method:'POST',body:f}); };
            post('categories', document.getElementById('set-cats').value);
            post('platforms', document.getElementById('set-plats').value);
            post('video_types', document.getElementById('set-types').value);
            closeModal('settings-modal'); loadOptions();
        }

        async function delVideo(id) { if(confirm('ç¡®å®šåˆ é™¤?')) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); } }
        async function updateStats() { try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;document.getElementById('st-host').innerText=d.host;}catch{} }
    </script>
</body>
</html>