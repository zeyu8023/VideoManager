<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V38.0 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* === æ ¸å¿ƒå¸ƒå±€ (å‹¿åŠ¨) === */
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #334155; margin: 0; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }
        .hidden { display: none !important; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; box-shadow: 4px 0 24px rgba(0,0,0,0.1); }
        .sidebar-header { height: 64px; display: flex; align-items: center; padding: 0 24px; color: white; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; font-size: 18px; letter-spacing: -0.5px; }
        .nav-item { padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: white; border-left-color: #3b82f6; }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content { flex: 1; position: relative; height: 100%; background: #f1f5f9; overflow: hidden; }
        .view-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden; }
        .scroll-content { flex: 1; overflow-y: auto; padding: 24px; min-height: 0; scrollbar-width: thin; }

        /* ä»ªè¡¨ç›˜ç»„ä»¶ */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:space-between; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-label { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .stat-num { font-size: 28px; font-weight: 800; color: #0f172a; line-height: 1.1; }
        
        /* å›¾è¡¨åŒº */
        .chart-grid { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 16px; margin-bottom: 24px; }
        .chart-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 340px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .trend-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 380px; margin-bottom: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        .inventory-layout { display: flex; flex-direction: column; height: 100%; }
        .inv-header { flex-shrink: 0; z-index: 20; background: #f8fafc; }
        .inv-body { 
            flex: 1; 
            overflow: auto; 
            position: relative; 
            margin: 16px 24px; 
            background: white; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .main-table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        .main-table th { position: sticky; top: 0; background: #f8fafc; color: #475569; font-weight: 600; font-size: 13px; padding: 14px 16px; border-bottom: 1px solid #e2e8f0; text-align: left; z-index: 10; }
        .main-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; color: #334155; }
        .main-table tr:hover td { background: #f8fafc; }
        .main-table tr:last-child td { border-bottom: none; }

        /* çŠ¶æ€èƒ¶å›Š */
        .status-pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 500; }
        .st-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .st-published { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .st-editing { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }

        /* äº§å“å¡ç‰‡ä¼˜åŒ– */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-bottom: 40px; }
        .prod-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; height: 160px; }
        .prod-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
        .pc-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .pc-title { font-weight: 700; font-size: 16px; color: #1e293b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
        .pc-badge { font-size: 10px; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .pc-stat-row { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
        
        /* æ§ä»¶ */
        .t-input { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; background: white; transition: border 0.2s; }
        .t-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: #3b82f6; color: white; } .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #475569; } .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }
        .btn-success { background: #10b981; color: white; } .btn-success:hover { background: #059669; }

        @media (max-width: 768px) { 
            .sidebar { width: 64px; } 
            .sidebar-header span { display: none; } 
            .nav-item span:last-child { display: none; } 
            .nav-item { justify-content: center; padding: 16px 0; }
            .kpi-grid, .chart-grid, .card-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg mr-3">V</div>
            <span>VideoHub</span>
        </div>
        <div class="sidebar-content mt-4">
            <div class="nav-item active" onclick="switchView('dashboard', this)"><span>ğŸ“Š</span> <span>æ•°æ®é©¾é©¶èˆ±</span></div>
            <div class="nav-item" onclick="switchView('inventory', this)"><span>ğŸ“¦</span> <span>è§†é¢‘åº“å­˜è¡¨</span></div>
            <div class="nav-item" onclick="switchView('product', this)"><span>ğŸ·ï¸</span> <span>äº§å“åº“å­˜ (SPU)</span></div>
        </div>
    </aside>

    <main class="main-content">
        <div id="view-dashboard" class="view-container">
            <div class="scroll-content">
                <div class="kpi-grid">
                    <div class="stat-card border-l-4 border-blue-500"><div class="stat-label text-blue-600">æ€»åº“å­˜</div><div class="stat-num" id="d-total">-</div></div>
                    <div class="stat-card border-l-4 border-purple-500"><div class="stat-label text-purple-600">ç´¯è®¡åˆ†å‘</div><div class="stat-num text-purple-700" id="d-dist">-</div></div>
                    <div class="stat-card border-l-4 border-orange-500"><div class="stat-label text-orange-600">å¾…å‘å¸ƒ</div><div class="stat-num text-orange-700" id="d-pending">-</div></div>
                    <div class="stat-card"><div class="stat-label">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-today-in">0</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-today-out">0</span></div></div>
                    <div class="stat-card"><div class="stat-label">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div><div class="flex items-baseline gap-2 mt-auto"><span class="text-3xl font-black text-slate-800" id="d-month-in">0</span><span class="text-slate-400">/</span><span class="text-3xl font-black text-green-600" id="d-month-out">0</span></div></div>
                </div>
                <div class="trend-box">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700">ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿</h3><div class="flex gap-2"><button onclick="loadDashboard('day')" class="px-3 py-1 text-xs font-bold rounded bg-slate-100 hover:bg-slate-200">æ—¥</button><button onclick="loadDashboard('week')" class="px-3 py-1 text-xs font-bold rounded bg-slate-100 hover:bg-slate-200">å‘¨</button><button onclick="loadDashboard('month')" class="px-3 py-1 text-xs font-bold rounded bg-slate-100 hover:bg-slate-200">æœˆ</button></div></div>
                    <div id="chart-trend" class="w-full h-[320px]"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ† ä¸»æ’­äº§å‡º Top 5</div><div id="chart-host" class="w-full h-[280px]"></div></div>
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ“Š ç±»å‹å æ¯”</div><div id="chart-type" class="w-full h-[280px]"></div></div>
                    <div class="chart-box"><div class="font-bold text-slate-700 mb-4">ğŸ•¸ï¸ å¹³å°åˆ†å‘</div><div id="chart-plat" class="w-full h-[280px]"></div></div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="inventory-layout hidden">
            <div class="inv-header">
                <div class="toolbar flex justify-between items-center px-6 py-4 bg-white border-b border-slate-200 shadow-sm z-20 relative">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span>ğŸ“¦</span> åº“å­˜æ˜ç»†</h2>
                    <div class="flex gap-3 items-center flex-1 justify-end">
                        <div class="relative">
                            <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="æœç´¢ç¼–å·ã€æ ‡é¢˜..." class="t-input w-64 pl-9">
                            <span class="absolute left-3 top-2.5 text-slate-400">ğŸ”</span>
                        </div>
                        <button onclick="toggleFilter()" class="btn btn-secondary">ç­›é€‰</button>
                        <button onclick="openSettings()" class="btn btn-secondary">é…ç½®</button>
                        <button onclick="openImport()" class="btn btn-secondary text-blue-600 bg-blue-50 border-blue-200">å¯¼å…¥</button>
                        <button onclick="addNewRow()" class="btn btn-primary"><span>+</span> æ–°å¢</button>
                    </div>
                </div>
                <div id="filter-panel" class="filter-panel bg-white border-b border-slate-200 px-6 overflow-hidden transition-all duration-300 max-h-0">
                    <div class="grid grid-cols-6 gap-4 py-6">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">äº§å“ç¼–å·</label><input id="s-pid" class="t-input"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">æ ‡é¢˜</label><input id="s-title" class="t-input"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">çŠ¶æ€</label><select id="s-status" class="t-input"><option value="">å…¨éƒ¨</option></select></div>
                        <div class="col-span-3 flex items-end justify-end gap-2">
                            <button onclick="loadData(1)" class="btn btn-primary">æŸ¥è¯¢</button>
                            <button onclick="resetFilters()" class="btn btn-secondary">é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="inv-body">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">ID</th>
                            <th class="w-32">äº§å“ç¼–å·</th>
                            <th style="min-width: 200px">è§†é¢‘æ ‡é¢˜</th>
                            <th class="w-24">çŠ¶æ€</th>
                            <th class="w-32">å¹³å°</th>
                            <th class="w-32">ä¸»æ’­</th>
                            <th class="w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-20 text-center sticky right-0 bg-slate-50 border-l shadow-sm">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            
            <div class="inv-header h-14 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0">
                <span class="text-sm text-slate-500 font-medium" id="page-info">åŠ è½½ä¸­...</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="btn btn-secondary px-3 py-1 text-xs">ä¸Šä¸€é¡µ</button>
                    <button onclick="changePage(1)" class="btn btn-secondary px-3 py-1 text-xs">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>

        <div id="view-product" class="view-container hidden">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f8fafc] py-4 px-8 z-10 shrink-0 border-b border-slate-200/50 backdrop-blur-sm">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span>ğŸ·ï¸</span> äº§å“åº“å­˜ç›‘æ§ (SPU)</h2>
                <div class="relative">
                    <input id="prod-search" class="t-input w-72 pl-10 rounded-full shadow-sm border-transparent focus:bg-white bg-white" placeholder="æœç´¢äº§å“å‹å·...">
                    <span class="absolute left-3.5 top-2.5 text-slate-400">ğŸ”</span>
                </div>
            </div>
            <div class="scroll-content pt-0 px-8">
                <div id="product-grid" class="card-grid"></div>
            </div>
        </div>
    </main>
</div>

<div id="import-modal" class="modal hidden"></div>
<div id="settings-modal" class="modal hidden"></div>

<script>
    // === å…¨å±€çŠ¶æ€ ===
    let currPage=1, totalPages=1, globalOptions={}, editingId=null;

    // === å¯åŠ¨ ===
    window.addEventListener('load', () => {
        initApp();
        document.getElementById('prod-search')?.addEventListener('input', (e) => Product.search(e.target.value));
    });

    async function initApp() {
        console.log("App Initializing...");
        await loadDashboard('day');
        await loadData(1);
        Product.init(); // ç‹¬ç«‹åŠ è½½
        loadOptions();
    }

    // === è§†å›¾åˆ‡æ¢ ===
    window.switchView = function(view, btn) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        ['dashboard', 'inventory', 'product'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
        document.getElementById('view-'+view).classList.remove('hidden');
        
        if(view === 'product') Product.init();
    }

    // === Dashboard ===
    async function loadDashboard(dim='day') {
        try {
            const res = await fetch(`/api/dashboard?dim=${dim}`);
            const data = await res.json();
            
            // æ›´æ–°æ•°å­—
            document.getElementById('d-total').innerText = data.kpi.total;
            document.getElementById('d-dist').innerText = data.kpi.dist;
            document.getElementById('d-pending').innerText = data.kpi.pending;
            document.getElementById('d-today-in').innerText = data.kpi.t_in;
            document.getElementById('d-today-out').innerText = data.kpi.t_out;
            document.getElementById('d-month-in').innerText = data.kpi.m_in;
            document.getElementById('d-month-out').innerText = data.kpi.m_out;

            // æ¸²æŸ“å›¾è¡¨ (å¸¦å®¹é”™)
            if(typeof echarts !== 'undefined') {
                const trendChart = echarts.init(document.getElementById('chart-trend'));
                trendChart.setOption({
                    tooltip: { trigger: 'axis' },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', boundaryGap: false, data: data.trend.dates },
                    yAxis: { type: 'value' },
                    series: [
                        { name: 'å…¥åº“', type: 'line', smooth: true, itemStyle: {color:'#3b82f6'}, areaStyle: {opacity:0.1}, data: data.trend.in },
                        { name: 'å‘å¸ƒ', type: 'bar', itemStyle: {color:'#10b981', borderRadius:[4,4,0,0]}, data: data.trend.out }
                    ]
                });
                // å…¶ä»–å›¾è¡¨ç•¥... (ä¿æŒä»£ç ç²¾ç®€ï¼Œé˜²å´©)
            }
        } catch(e) { console.error("Dashboard Error", e); }
    }

    // === Product Logic (çº¯æ–‡å­— Proç‰ˆ) ===
    const Product = {
        allData: [],
        init: async function() {
            try {
                const res = await fetch('/api/product_stats');
                this.allData = await res.json();
                this.render(this.allData);
            } catch(e) { document.getElementById('product-grid').innerHTML = `<div class="text-red-500 text-center col-span-full py-8">æ•°æ®åŠ è½½å¤±è´¥</div>`; }
        },
        search: function(kw) {
            if(!kw) return this.render(this.allData);
            this.render(this.allData.filter(i => i.name && String(i.name).toLowerCase().includes(kw.toLowerCase())));
        },
        render: function(data) {
            const grid = document.getElementById('product-grid');
            if(!data.length) { grid.innerHTML = `<div class="text-slate-400 text-center col-span-full py-12">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨åº“å­˜è¡¨ä¸­æ·»åŠ </div>`; return; }
            
            grid.innerHTML = data.map(item => {
                const pct = item.total > 0 ? Math.round(((item.total - item.pending)/item.total)*100) : 0;
                let color = '#3b82f6'; // Blue
                let statusText = 'è¿›è¡Œä¸­';
                if(item.pending > 5) { color = '#ef4444'; statusText = 'ç§¯å‹'; } // Red
                else if(item.pending === 0) { color = '#10b981'; statusText = 'å®Œæˆ'; } // Green
                
                return `
                <div class="prod-card" style="border-left: 4px solid ${color}" onclick="jumpTo('${item.name}')">
                    <div class="pc-head">
                        <div class="pc-title" title="${item.name}">${item.name}</div>
                        <span class="pc-badge" style="color:${color}; background:${color}10">SPU</span>
                    </div>
                    <div class="pc-body">
                        <div>
                            <div class="pc-num" style="color: ${color}">${item.pending}</div>
                            <div class="pc-label">å¾…å‘å¸ƒ</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-slate-200">${pct}%</div>
                        </div>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5 mt-auto mb-2 overflow-hidden">
                        <div class="h-full rounded-full" style="width: ${pct}%; background-color: ${color}"></div>
                    </div>
                    <div class="pc-foot flex justify-between text-xs text-slate-400 font-medium">
                        <span>æ€»åº“å­˜ ${item.total}</span>
                        <span>${statusText}</span>
                    </div>
                </div>`;
            }).join('');
        }
    };

    // === Inventory Logic ===
    async function loadData(page) {
        currPage = page;
        const kw = document.getElementById('g-search').value;
        const pid = document.getElementById('s-pid')?.value || '';
        
        try {
            const res = await fetch(`/api/videos?page=${page}&size=50&keyword=${kw}&product_id=${pid}`);
            const data = await res.json();
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = data.items.map(v => {
                const statusClass = v.status && v.status.includes('å·²') ? 'st-published' : (v.status && v.status.includes('å¾…') ? 'st-pending' : 'bg-slate-100 text-slate-500');
                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="text-center text-slate-300 font-mono text-xs">${v.id}</td>
                    <td class="font-mono text-slate-600 font-bold">${v.product_id || '-'}</td>
                    <td class="font-bold text-slate-800 truncate max-w-xs" title="${v.title}">${v.title || '-'}</td>
                    <td><span class="status-pill ${statusClass}">${v.status || 'æœªçŸ¥'}</span></td>
                    <td class="text-xs text-slate-500">${v.platform || '-'}</td>
                    <td class="text-xs text-slate-500">${v.host || '-'}</td>
                    <td class="text-xs font-mono text-slate-400">${v.publish_time ? v.publish_time.replace('T',' ').slice(0,16) : '-'}</td>
                    <td class="text-center sticky right-0 bg-white border-l">
                        <button onclick="alert('ç¼–è¾‘åŠŸèƒ½')" class="text-blue-600 font-bold text-xs hover:underline">ç¼–è¾‘</button>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('page-info').innerText = `ç¬¬ ${data.page} é¡µ / å…± ${data.total_pages} é¡µ (æ€»è®¡ ${data.total} æ¡)`;
        } catch(e) { console.error("Load Data Error", e); }
    }

    function jumpTo(pid) {
        window.switchView('inventory');
        const sPid = document.getElementById('s-pid');
        if(sPid) sPid.value = pid; // è®¾ç½®ç­›é€‰å™¨
        document.getElementById('filter-panel').classList.add('max-h-[500px]'); // å±•å¼€ç­›é€‰
        loadData(1);
    }

    function toggleFilter() {
        const p = document.getElementById('filter-panel');
        if(p.classList.contains('max-h-0')) { p.classList.remove('max-h-0'); p.classList.add('max-h-[500px]'); }
        else { p.classList.add('max-h-0'); p.classList.remove('max-h-[500px]'); }
    }
    
    function resetFilters() {
        document.querySelectorAll('#filter-panel input, #filter-panel select').forEach(el => el.value = '');
        loadData(1);
    }

    // å ä½å‡½æ•°
    async function loadOptions() { /* åŠ è½½ä¸‹æ‹‰é€‰é¡¹é€»è¾‘ */ }
    window.changePage = (d) => { if(currPage+d > 0) loadData(currPage+d); };
    window.addNewRow = () => alert('æ–°å¢åŠŸèƒ½å¾…å¼€å‘');
    window.openSettings = () => alert('é…ç½®é¢æ¿å¾…å¼€å‘');
    window.openImport = () => alert('å¯¼å…¥é¢æ¿å¾…å¼€å‘');

</script>
</body>
</html>