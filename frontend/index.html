<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub V24.0 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* =================================================================
           1. å…¨å±€ä¸åŸºç¡€æ ·å¼ (Global & Base)
           ================================================================= */
        :root {
            --sidebar-width: 240px;
            --sidebar-width-mobile: 60px;
            --primary-color: #2563eb;
            --header-height: 64px;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overflow: hidden; /* App-like feel */
            margin: 0;
            padding: 0;
        }

        /* å¸ƒå±€æ¡†æ¶ */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f1f5f9;
            position: relative;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* =================================================================
           2. ä¾§è¾¹æ æ ·å¼ (Sidebar)
           ================================================================= */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #0f172a;
            color: #94a3b8;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: white;
            font-weight: 700;
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
        }

        .logo-box {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .nav-menu {
            flex: 1;
            padding-top: 16px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 14px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            color: #94a3b8;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left-color: #3b82f6;
        }

        .nav-icon { font-size: 18px; width: 24px; text-align: center; }
        .nav-text { white-space: nowrap; transition: opacity 0.2s; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { width: var(--sidebar-width-mobile); }
            .sidebar-header { padding: 0; justify-content: center; }
            .sidebar-header h1 { display: none; }
            .logo-box { margin-right: 0; }
            .nav-item { padding: 16px 0; justify-content: center; }
            .nav-text { display: none; }
            /* ä¿®æ­£ç§»åŠ¨ç«¯Grid */
            .kpi-grid, .chart-grid { grid-template-columns: 1fr !important; }
            .filter-panel .grid { grid-template-columns: 1fr 1fr !important; }
            .trend-box { height: 300px; }
        }

        /* =================================================================
           3. ä»ªè¡¨ç›˜æ ·å¼ (Dashboard)
           ================================================================= */
        .dash-container {
            padding: 24px;
            overflow-y: auto;
            height: 100%;
        }

        /* KPI å¡ç‰‡ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 140px;
            transition: transform 0.2s;
        }
        
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .stat-label {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-num {
            font-size: 32px;
            font-weight: 800;
            color: #0f172a;
            line-height: 1;
        }

        .stat-sub {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 8px;
            font-weight: 500;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr; /* å·¦ä¾§å®½ä¸€äº› */
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            height: 380px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-content { flex: 1; width: 100%; min-height: 0; }

        /* è¶‹åŠ¿å›¾é€šæ  */
        .trend-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            height: 420px;
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
        }

        /* çŸ©é˜µè¡¨æ ¼ */
        .matrix-box {
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .matrix-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            color: #334155;
            background: #f8fafc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .matrix-table {
            width: 100%;
            text-align: left;
            border-collapse: collapse;
        }

        .matrix-table th {
            padding: 14px 24px;
            font-size: 12px;
            color: #64748b;
            font-weight: 700;
            background: #fcfcfc;
            border-bottom: 1px solid #e2e8f0;
            text-transform: uppercase;
        }

        .matrix-table td {
            padding: 14px 24px;
            font-size: 13px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }

        .matrix-table tr:hover td { background-color: #f8fafc; }
        .val-today { color: #ef4444; font-weight: 800; }

        /* =================================================================
           4. åº“å­˜ç®¡ç†è§†å›¾æ ·å¼ (Inventory)
           ================================================================= */
        .inventory-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .toolbar {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            shrink-0;
            z-index: 20;
        }

        /* ç­›é€‰é¢æ¿åŠ¨ç”» */
        .filter-panel {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            padding: 0 24px;
            box-shadow: 0 4px 10px -5px rgba(0,0,0,0.05);
            z-index: 15;
        }

        .filter-panel.open {
            max-height: 600px;
            padding-top: 24px;
            padding-bottom: 24px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 6px;
            display: block;
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .table-wrap {
            flex: 1;
            overflow: auto;
            background: white;
            margin: 16px 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            position: relative;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1800px; /* ä¿è¯ä¸æŒ¤å‹ */
        }

        .main-table th {
            position: sticky;
            top: 0;
            background: #f8fafc;
            color: #475569;
            font-weight: 700;
            font-size: 13px;
            padding: 14px;
            border-bottom: 2px solid #e2e8f0;
            z-index: 10;
            text-align: left;
            white-space: nowrap;
        }

        .main-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            vertical-align: middle;
            color: #334155;
        }

        .main-table tr:hover td { background-color: #f8fafc; }

        /* =================================================================
           5. äº§å“ SPU å¡ç‰‡è§†å›¾ (Card Grid)
           ================================================================= */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            padding-bottom: 40px;
        }

        .prod-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .prod-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }

        /* çŠ¶æ€æ ‡è®°æ¡ */
        .prod-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .prod-card.safe::before { background-color: #10b981; }   /* ç»¿ï¼šå®Œæˆ */
        .prod-card.danger::before { background-color: #ef4444; } /* çº¢ï¼šç§¯å‹ */
        .prod-card.warn::before { background-color: #f59e0b; }   /* é»„ï¼šç¼ºè´§ */
        .prod-card.normal::before { background-color: #3b82f6; } /* è“ï¼šæ­£å¸¸ */

        .pc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .pc-title { font-weight: 700; font-size: 18px; color: #1e293b; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80%; }
        .pc-badge { font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 6px; background: #f1f5f9; color: #64748b; }

        .pc-body { flex: 1; display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 20px; }
        .pc-stat { text-align: left; }
        .pc-num { font-size: 40px; font-weight: 800; line-height: 1; letter-spacing: -1px; }
        .pc-label { font-size: 12px; color: #64748b; font-weight: 600; margin-top: 6px; }

        .pc-footer { border-top: 1px solid #f1f5f9; pt-4; display: flex; align-items: center; justify-content: space-between; }
        .pc-progress-bg { flex: 1; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-right: 12px; }
        .pc-progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .pc-total { font-size: 13px; color: #64748b; font-weight: 600; }

        /* =================================================================
           6. é€šç”¨ç»„ä»¶æ ·å¼ (Components)
           ================================================================= */
        /* è¾“å…¥æ¡† */
        .t-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            background: white;
            height: 38px;
            transition: all 0.2s;
        }
        .t-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        
        /* è¡Œå†…ç¼–è¾‘é«˜äº® */
        .editing { background-color: #eff6ff !important; }
        .new-row { background-color: #f0fdf4 !important; }

        /* æ ‡ç­¾ Pill */
        .pill {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-right: 4px;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        /* å›¾ç‰‡ä¸Šä¼ æ ¼ */
        .img-cell {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
        }
        .img-cell:hover { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .img-cell:hover::after {
            content: '+'; position: absolute; inset: 0;
            background: rgba(0,0,0,0.4); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 20px;
        }

        /* Toast æ¶ˆæ¯æç¤º */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
            display: flex; align-items: center; gap: 10px;
            font-size: 14px; font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* æ¨¡æ€å¼¹çª— */
        .modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; }

        /* å¤šé€‰èœå• */
        .multi-pop {
            position: absolute;
            background: white;
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            border-radius: 8px;
            width: 240px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 40;
            display: none;
        }
        .multi-pop.show { display: block; }
        .multi-opt {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            transition: background 0.1s;
        }
        .multi-opt:hover { background-color: #f1f5f9; color: #2563eb; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-box">V</div>
            <h1 class="text-xl font-bold text-white tracking-tight">VideoHub</h1>
        </div>
        
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchView('dashboard', this)">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">æ•°æ®é©¾é©¶èˆ±</span>
            </div>
            <div class="nav-item" onclick="switchView('inventory', this)">
                <span class="nav-icon">ğŸ“¦</span>
                <span class="nav-text">è§†é¢‘åº“å­˜è¡¨</span>
            </div>
            <div class="nav-item" onclick="switchView('product', this)">
                <span class="nav-icon">ğŸ·ï¸</span>
                <span class="nav-text">äº§å“åº“å­˜ (SPU)</span>
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-700 text-xs text-slate-500 text-center">
            V24.0 Enterprise
        </div>
    </aside>

    <main class="main-content">
        <div id="toast-container"></div>

        <div id="view-dashboard" class="dash-container">
            <div class="kpi-grid">
                <div class="stat-card border-l-4 border-blue-500">
                    <div class="stat-label">æ€»åº“å­˜ (è§†é¢‘)</div>
                    <div class="stat-num" id="d-total">-</div>
                    <div class="stat-sub">Total Assets</div>
                </div>
                <div class="stat-card border-l-4 border-purple-500">
                    <div class="stat-label text-purple-600">ç´¯è®¡åˆ†å‘ (äººæ¬¡)</div>
                    <div class="stat-num text-purple-700" id="d-dist">-</div>
                    <div class="stat-sub">Total Distributions</div>
                </div>
                <div class="stat-card border-l-4 border-orange-500">
                    <div class="stat-label text-orange-600">å¾…å‘å¸ƒåº“å­˜</div>
                    <div class="stat-num text-orange-700" id="d-pending">-</div>
                    <div class="stat-sub">Pending Publish</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥ å…¥åº“ / å‘å¸ƒ</div>
                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-3xl font-black text-slate-800" id="d-today-in">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-3xl font-black text-green-600" id="d-today-out">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ¬æœˆ å…¥åº“ / å‘å¸ƒ</div>
                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-3xl font-black text-slate-800" id="d-month-in">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-3xl font-black text-green-600" id="d-month-out">0</span>
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-box">
                    <div class="chart-title">ğŸ† ä¸»æ’­äº§å‡º Top 5</div>
                    <div id="chart-host" class="chart-content"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ“Š å†…å®¹ç±»å‹å æ¯”</div>
                    <div id="chart-type" class="chart-content"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ•¸ï¸ å¹³å°åˆ†å‘çŸ©é˜µ</div>
                    <div id="chart-plat" class="chart-content"></div>
                </div>
            </div>

            <div class="trend-box">
                <div class="chart-title">
                    <span>ğŸ“ˆ ä¸šåŠ¡è¶‹åŠ¿ (å…¥åº“ vs å‘å¸ƒ)</span>
                    <div class="flex gap-2">
                        <button onclick="loadDashboard('day')" class="text-xs font-bold px-3 py-1 rounded bg-slate-100 hover:bg-blue-100 transition-colors">æ—¥</button>
                        <button onclick="loadDashboard('week')" class="text-xs font-bold px-3 py-1 rounded bg-slate-100 hover:bg-blue-100 transition-colors">å‘¨</button>
                        <button onclick="loadDashboard('month')" class="text-xs font-bold px-3 py-1 rounded bg-slate-100 hover:bg-blue-100 transition-colors">æœˆ</button>
                    </div>
                </div>
                <div id="chart-trend" class="chart-content"></div>
            </div>

            <div class="matrix-box">
                <div class="matrix-header">ğŸ“± è´¦å·åˆ†å‘çŸ©é˜µ (Account Distribution)</div>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th style="width: 30%">å¹³å°è´¦å·åç§°</th>
                            <th style="width: 15%">ä»Šæ—¥å‘å¸ƒ ğŸ”¥</th>
                            <th style="width: 15%">æœ¬å‘¨å‘å¸ƒ</th>
                            <th style="width: 15%">æœ¬æœˆå‘å¸ƒ</th>
                            <th style="width: 25%">å¹´åº¦ç´¯è®¡ (Rank)</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-inventory" class="inventory-view hidden">
            <div class="toolbar">
                <h2 class="text-lg font-bold text-slate-800 hidden md:block">åº“å­˜æ˜ç»†</h2>
                <div class="flex gap-3 items-center flex-1 justify-end">
                    <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢: æ ‡é¢˜/ç¼–å·/å¤‡æ³¨" class="t-input w-48 md:w-72 bg-slate-50 border-transparent focus:bg-white transition-all">
                    <button onclick="toggleFilter()" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">ç­›é€‰</button>
                    <button onclick="openSettings()" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">é…ç½®</button>
                    <button onclick="openImport()" class="px-4 py-2 text-sm font-bold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100">å¯¼å…¥</button>
                    <button onclick="addNewRow()" class="px-5 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700 active:scale-95 flex items-center gap-1"><span>+</span> æ–°å¢</button>
                </div>
            </div>

            <div id="filter-panel" class="filter-panel">
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div><label class="filter-label">äº§å“ç¼–å·</label><input id="s-pid" list="dl-pids" class="t-input" placeholder="è¾“å…¥ç¼–å·..."></div>
                    <div><label class="filter-label">è§†é¢‘æ ‡é¢˜</label><input id="s-title" class="t-input" placeholder="åŒ…å«æ ‡é¢˜..."></div>
                    <div><label class="filter-label">äº§å“ç±»å‹</label><select id="s-cat" class="t-input"></select></div>
                    <div><label class="filter-label">è§†é¢‘ç±»å‹</label><select id="s-type" class="t-input"></select></div>
                    <div><label class="filter-label">ä¸»æ’­</label><select id="s-host" class="t-input"></select></div>
                    <div><label class="filter-label">çŠ¶æ€</label><select id="s-status" class="t-input"></select></div>
                    <div><label class="filter-label">å¹³å°</label><select id="s-plat" class="t-input"></select></div>
                    <div class="col-span-2"><label class="filter-label">å®Œæˆæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-fin-start" class="t-input"><input type="date" id="s-fin-end" class="t-input"></div></div>
                    <div class="col-span-2"><label class="filter-label">å‘å¸ƒæ—¶é—´</label><div class="flex gap-2"><input type="date" id="s-pub-start" class="t-input"><input type="date" id="s-pub-end" class="t-input"></div></div>
                    <div><label class="filter-label">å¤‡æ³¨</label><input id="s-remark" class="t-input" placeholder="å¤‡æ³¨..."></div>
                    <div class="col-span-2 md:col-span-6 flex justify-end gap-2 border-t pt-4 mt-2">
                        <button onclick="loadData(1)" class="px-6 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold">æ‰§è¡ŒæŸ¥è¯¢</button>
                        <button onclick="resetFilters()" class="px-6 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-bold">é‡ç½®</button>
                    </div>
                </div>
            </div>

            <div class="table-wrap">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">å›¾</th><th class="w-32">äº§å“/ç¼–å·</th><th style="min-width: 260px;">è§†é¢‘æ ‡é¢˜</th><th class="w-24">ç±»å‹</th><th class="w-28">å®Œæˆæ—¶é—´</th><th class="w-24">è§†ç±»</th><th class="w-32">ä¸»æ’­(å¤š)</th><th class="w-24 text-center">çŠ¶æ€</th><th class="w-32">å¹³å°(å¤š)</th><th class="w-32">å‘å¸ƒæ—¶é—´</th><th class="w-40">å¤‡æ³¨</th><th class="w-20 text-center sticky right-0 bg-slate-50 border-l">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>

            <div class="h-14 bg-white border-t border-slate-200 px-6 flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-500 font-medium" id="page-info">æ­£åœ¨åŠ è½½...</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="px-4 py-1.5 bg-slate-100 rounded-md text-xs font-bold disabled:opacity-50">â—€</button>
                    <button onclick="changePage(1)" class="px-4 py-1.5 bg-slate-100 rounded-md text-xs font-bold disabled:opacity-50">â–¶</button>
                </div>
            </div>
        </div>

        <div id="view-product" class="dash-container hidden">
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><span>ğŸ·ï¸</span> äº§å“åº“å­˜ç›‘æ§ (SPU)</h2>
            <div id="product-grid" class="card-grid"></div>
        </div>
    </main>
</div>

<div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh] rounded shadow-2xl"></div>
<div id="multi-pop" class="multi-pop"></div>
<datalist id="dl-pids"></datalist>

<div id="import-modal" class="modal">
    <div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl">
        <h3 class="font-bold text-xl mb-4 text-slate-800">æ‰¹é‡å¯¼å…¥</h3>
        <p class="text-sm text-slate-500 mb-6">è¯·ç¡®è®¤æ–‡ä»¶åœ¨ <code class="bg-slate-100 px-1 rounded">temp_uploads</code> ç›®å½•</p>
        <button onclick="startImport()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold">å¼€å§‹æ‰«æ</button>
        <button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å…³é—­</button>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="bg-white rounded-xl w-[450px] p-6 shadow-2xl">
        <h3 class="font-bold mb-6 text-lg border-b pb-2">å…¨å±€é…ç½®</h3>
        <textarea id="set-hosts" class="t-input h-20 mb-3" placeholder="ä¸»æ’­..."></textarea>
        <input id="set-cats" class="t-input mb-3" placeholder="ç±»å‹...">
        <input id="set-types" class="t-input mb-3" placeholder="è§†ç±»...">
        <input id="set-plats" class="t-input mb-3" placeholder="å¹³å°...">
        <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">ä¿å­˜é…ç½®</button>
        <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-slate-400 text-xs">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // å…¨å±€çŠ¶æ€
    let currPage = 1, totalPages = 1;
    let globalOptions = {}, editingId = null, globalData = [];
    let chartTrend = null;

    // åˆå§‹åŒ–
    (function init() {
        loadDashboard('day');
        loadOptions();
        loadData(1);
        loadProductStats();
        
        // å…¨å±€å…³é—­äº‹ä»¶
        document.addEventListener('click', e => {
            if(!e.target.closest('.multi-pop') && !e.target.closest('.multi-trig')) 
                document.getElementById('multi-pop').classList.remove('show');
        });
    })();

    // æç¤ºæ¶ˆæ¯å‡½æ•°
    function showToast(msg, type='info') {
        const box = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = 'toast';
        el.innerHTML = `<span>${type==='success'?'âœ…':'â„¹ï¸'}</span> ${msg}`;
        box.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    // è§†å›¾åˆ‡æ¢
    function switchView(view, btn) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        ['dashboard', 'inventory', 'product'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
        document.getElementById('view-'+view).classList.remove('hidden');
        if(view === 'dashboard') loadDashboard('day');
        if(view === 'product') loadProductStats();
    }

    // Dashboard
    async function loadDashboard(dim) {
        const res = await fetch(`/api/dashboard?dim=${dim}`);
        const data = await res.json();
        
        // KPI
        document.getElementById('d-total').innerText = data.kpi.total;
        document.getElementById('d-dist').innerText = data.kpi.dist_total;
        document.getElementById('d-pending').innerText = data.kpi.pending;
        document.getElementById('d-today-in').innerText = data.kpi.today_in;
        document.getElementById('d-today-out').innerText = data.kpi.today_out;
        document.getElementById('d-month-in').innerText = data.kpi.month_in;
        document.getElementById('d-month-out').innerText = data.kpi.month_out;
        
        // Matrix
        document.getElementById('matrix-body').innerHTML = data.matrix.map((r, i) => `
            <tr>
                <td class="font-bold flex items-center gap-2">
                    <span class="w-5 h-5 rounded bg-slate-100 text-slate-500 text-xs flex items-center justify-center">${i+1}</span>
                    ${r.name}
                </td>
                <td class="${r.day>0?'val-today':''}">${r.day}</td>
                <td>${r.week}</td><td>${r.month}</td><td class="font-mono font-bold">${r.year}</td>
            </tr>`).join('');

        // Charts
        if(!chartTrend) chartTrend = echarts.init(document.getElementById('chart-trend'));
        chartTrend.setOption({
            tooltip:{trigger:'axis'}, legend:{data:['å…¥åº“','å‘å¸ƒ'],bottom:0}, 
            grid:{top:20,left:40,right:20,bottom:30}, xAxis:{type:'category',data:data.trend.dates}, yAxis:{type:'value'}, 
            series:[{name:'å…¥åº“',type:'line',data:data.trend.in,smooth:true,itemStyle:{color:'#3b82f6'},areaStyle:{opacity:0.1}}, {name:'å‘å¸ƒ',type:'bar',data:data.trend.out,itemStyle:{color:'#10b981'}}]
        });
        
        echarts.init(document.getElementById('chart-host')).setOption({
            tooltip:{trigger:'axis'}, grid:{top:10,left:60,right:20,bottom:20}, 
            xAxis:{type:'value'}, yAxis:{type:'category',data:data.hosts.map(i=>i.name).reverse()}, 
            series:[{type:'bar',data:data.hosts.map(i=>i.value).reverse(),itemStyle:{color:'#f59e0b',borderRadius:[0,4,4,0]}}]
        });
        
        echarts.init(document.getElementById('chart-type')).setOption({tooltip:{trigger:'item'}, series:[{type:'pie',radius:['40%','70%'],data:data.types}]});
        
        echarts.init(document.getElementById('chart-plat')).setOption({
            tooltip:{}, radar:{indicator:data.plats.map(p=>({name:p.name, max:Math.max(...data.plats.map(v=>v.value),10)}))}, 
            series:[{type:'radar',data:[{value:data.plats.map(p=>p.value),name:'åˆ†å‘é‡'}]}]
        });
    }

    // Product SPU
    async function loadProductStats() {
        const res = await fetch('/api/product_stats');
        const data = await res.json();
        const grid = document.getElementById('product-grid');
        
        grid.innerHTML = data.map(item => {
            const pct = Math.round(((item.total - item.pending) / item.total) * 100) || 0;
            let status = 'normal', color = '#3b82f6';
            if(item.pending > 5) { status='danger'; color='#ef4444'; }
            else if(item.pending === 0) { status='safe'; color='#10b981'; }
            else if(item.total < 3) { status='warn'; }

            return `
            <div class="prod-card ${status}" onclick="jumpTo('${item.name}')">
                <div class="pc-header"><div class="pc-title" title="${item.name}">${item.name}</div><div class="pc-badge">SPU</div></div>
                <div class="pc-body">
                    <div class="pc-stat"><div class="pc-num" style="color:${color}">${item.pending}</div><div class="pc-label">å¾…å‘å¸ƒ</div></div>
                    <div class="text-right"><div class="text-2xl font-bold text-slate-300">${pct}%</div><div class="text-xs text-slate-400">å®Œæˆ</div></div>
                </div>
                <div class="pc-footer">
                    <div class="pc-progress-bg"><div class="pc-progress-fill" style="width:${pct}%; background:${color}"></div></div>
                    <div class="pc-total">æ€»åº“ ${item.total}</div>
                </div>
            </div>`;
        }).join('');
    }

    function jumpTo(pid) {
        document.querySelectorAll('.nav-item')[1].click();
        document.getElementById('s-pid').value = pid;
        if(!document.getElementById('filter-panel').classList.contains('open')) toggleFilter();
        loadData(1);
    }

    // Inventory Core
    async function loadOptions() {
        const res = await fetch('/api/options'); globalOptions = await res.json();
        const fill = (id, list, label) => document.getElementById(id).innerHTML = `<option value="">å…¨éƒ¨${label}</option>` + list.map(i=>`<option>${i}</option>`).join('');
        fill('s-cat', globalOptions.categories, 'ç±»å‹'); fill('s-type', globalOptions.video_types, 'è§†ç±»');
        fill('s-host', globalOptions.hosts, 'ä¸»æ’­'); fill('s-status', globalOptions.statuses, 'çŠ¶æ€'); fill('s-plat', globalOptions.platforms, 'å¹³å°');
        document.getElementById('dl-pids').innerHTML = globalOptions.product_ids.map(i=>`<option>${i}</option>`).join('');
    }

    async function loadData(p) {
        currPage = p || currPage;
        const params = new URLSearchParams({
            page:currPage, size:100, keyword:document.getElementById('g-search').value,
            product_id:document.getElementById('s-pid').value, title:document.getElementById('s-title').value, remark:document.getElementById('s-remark').value,
            host:document.getElementById('s-host').value, status:document.getElementById('s-status').value, category:document.getElementById('s-cat').value,
            video_type:document.getElementById('s-type').value, platform:document.getElementById('s-plat').value,
            finish_start:document.getElementById('s-fin-start').value, finish_end:document.getElementById('s-fin-end').value,
            publish_start:document.getElementById('s-pub-start').value, publish_end:document.getElementById('s-pub-end').value
        });
        const res = await fetch(`/api/videos?${params}`);
        const data = await res.json();
        globalData = data.items;
        totalPages = data.total_pages;
        document.getElementById('page-info').innerText = `å…± ${data.total} æ¡ Â· ${data.page}/${data.total_pages} é¡µ`;
        renderTable(data.items);
    }

    function addNewRow() {
        globalData.unshift({id:'new', product_id:'', title:'', isNew:true});
        editingId = 'new';
        renderTable(globalData);
        document.querySelector('.table-wrap').scrollTop = 0;
    }

    function renderTable(items) {
        document.getElementById('table-body').innerHTML = items.map(v => {
            const isEdit = (v.id === editingId);
            const cln = s => (s && s!=='nan' && s!=='None') ? s : '';
            const img = (v.image_url && !v.image_url.includes('default')) ? v.image_url : '/assets/default.png';

            if (isEdit) {
                const sel = (k,l) => `<select id="ed-${k}" class="t-input">${l.map(o=>`<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                const mul = (k,t) => `<input id="ed-${k}" class="t-input multi-trig cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this,'${t}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                
                return `<tr class="editing ${v.isNew?'new-row':''}">
                    <td class="p-2"><div class="img-cell mx-auto" onclick="document.getElementById('up-${v.id}').click()" ondrop="handleDrop(event,'${v.id}')" ondragover="event.preventDefault()" onpaste="handlePaste(event,'${v.id}')"><img src="${img}" class="w-full h-full object-cover"></div><input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this,'${v.id}')"><input type="hidden" id="ed-img" value="${cln(v.image_url)}"></td>
                    <td><input id="ed-pid" class="t-input" value="${cln(v.product_id)}" placeholder="ç¼–å·"></td>
                    <td><input id="ed-title" class="t-input font-bold" value="${cln(v.title)}" placeholder="æ ‡é¢˜"></td>
                    <td>${sel('cat',globalOptions.categories)}</td><td><input id="ed-fin" type="date" class="t-input" value="${cln(v.finish_time)}"></td>
                    <td>${sel('type',globalOptions.video_types)}</td><td>${mul('host','hosts')}</td><td>${sel('status',globalOptions.statuses)}</td><td>${mul('plat','platforms')}</td>
                    <td><input id="ed-pub" type="datetime-local" class="t-input" value="${cln(v.publish_time).replace(' ','T')}"></td><td><input id="ed-rem" class="t-input" value="${cln(v.remark)}"></td>
                    <td class="text-center sticky right-0 bg-blue-50 border-l"><button onclick="saveRow('${v.id}')" class="text-blue-600 font-bold text-xs">ä¿å­˜</button> <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1">å–æ¶ˆ</button></td></tr>`;
            }
            
            const pill = (s,t) => s.split(/[,ï¼Œ]/).map(x=>`<span class="pill" style="background:${t==='st'?(x.includes('å·²')?'#dcfce7':'#fff7ed'):'#f1f5f9'};color:${t==='st'?(x.includes('å·²')?'#166534':'#c2410c'):'#475569'}">${x}</span>`).join('');
            
            return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                <td class="p-2 text-center"><div class="img-cell mx-auto bg-slate-100" onclick="showBig('${img}')" ondrop="handleDrop(event,'${v.id}')" ondragover="event.preventDefault()" onpaste="handlePaste(event,'${v.id}')"><img src="${img}" class="w-full h-full object-cover"></div></td>
                <td class="font-mono text-slate-500">${cln(v.product_id)}</td><td class="font-bold text-slate-700 truncate" style="max-width:260px" title="${cln(v.title)}">${cln(v.title)}</td>
                <td><span class="pill bg-slate-100">${cln(v.category)}</span></td><td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td><td><span class="pill bg-slate-100">${cln(v.video_type)}</span></td>
                <td>${pill(cln(v.host),'')}</td><td class="text-center">${pill(cln(v.status),'st')}</td><td>${pill(cln(v.platform),'')}</td>
                <td class="text-slate-400 text-xs font-mono">${cln(v.publish_time).replace('T',' ')}</td><td class="text-slate-400 truncate max-w-[120px] text-xs" title="${cln(v.remark)}">${cln(v.remark)}</td>
                <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l"><button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button><button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button></td></tr>`;
        }).join('');
    }

    function startEdit(id){ editingId=id; renderTable(globalData); }
    function cancelEdit(){ editingId=null; loadData(); }
    
    async function saveRow(id){
        const fd = new FormData();
        if (id !== 'new') fd.append('id', id);
        ['pid','title','cat','fin','type','host','status','plat','pub','rem'].forEach(k => {
            const key = {'pid':'product_id','title':'title','cat':'category','fin':'finish_time','type':'video_type','host':'host','status':'status','plat':'platform','pub':'publish_time','rem':'remark'}[k];
            fd.append(key, document.getElementById('ed-'+k).value.replace('T', ' '));
        });
        fd.append('image_url', document.getElementById('ed-img').value);
        await fetch('/api/video/save', {method:'POST', body:fd});
        editingId = null; loadData(); showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    // å›¾ç‰‡ä¸Šä¼  (å«æ‹–æ‹½/ç²˜è´´)
    async function handleDrop(e,id){ e.preventDefault(); if(e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0], id); }
    async function handlePaste(e,id){ if(e.clipboardData.files[0]) uploadFile(e.clipboardData.files[0], id); }
    async function upImg(input,id){ if(input.files[0]) uploadFile(input.files[0], id); }
    async function uploadFile(file, id){
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch('/api/upload', {method:'POST', body:fd}); const d = await res.json();
        if(editingId == id) document.getElementById('ed-img').value = d.url;
        else { const fd2=new FormData(); fd2.append('id',id); fd2.append('image_url',d.url); await fetch('/api/video/save',{method:'POST',body:fd2}); }
        globalData.find(v=>v.id==id||(id==='new'&&v.id==='new')).image_url = d.url;
        renderTable(globalData); showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
    }

    // è¾…åŠ©åŠŸèƒ½
    function openMulti(input,type){
        const pop=document.getElementById('multi-pop'); const r=input.getBoundingClientRect(); const curr=input.value.split(/[,ï¼Œ]/).map(s=>s.trim());
        pop.innerHTML=globalOptions[type].map(o=>`<div class="multi-opt" onclick="togOpt('${input.id}','${o}','${type}')"><span class="${curr.includes(o)?'text-blue-600 font-bold w-4':'w-4'}">${curr.includes(o)?'âœ“':''}</span> ${o}</div>`).join('');
        pop.style.top=(r.bottom+window.scrollY)+'px'; pop.style.left=(r.left+window.scrollX)+'px'; pop.classList.add('show');
    }
    function togOpt(eid,v,type){ const inp=document.getElementById(eid); let vals=inp.value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); if(vals.includes(v)) vals=vals.filter(i=>i!==v); else vals.push(v); inp.value=vals.join(','); openMulti(inp,type); }
    
    function toggleFilter(){ document.getElementById('filter-panel').classList.toggle('open'); }
    function showBig(s){ document.getElementById('big-img').src=s; document.getElementById('preview-modal').classList.add('active'); }
    function resetFilters(){ document.querySelectorAll('#filter-panel input,select').forEach(e=>e.value=''); loadData(1); }
    function changePage(d){ if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
    
    async function delVideo(id){ if(confirm('ç¡®å®šåˆ é™¤è¯¥è§†é¢‘ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')){ await fetch(`/api/video/${id}`,{method:'DELETE'}); loadData(); showToast('å·²åˆ é™¤'); } }
    function openImport(){ document.getElementById('import-modal').classList.add('active'); }
    async function startImport(){ await fetch('/api/import/local',{method:'POST'}); showToast('åå°ä»»åŠ¡å·²å¯åŠ¨', 'info'); document.getElementById('import-modal').classList.remove('active'); }
    
    function openSettings(){ document.getElementById('settings-modal').classList.add('active'); document.getElementById('set-hosts').value=globalOptions.hosts.join(','); document.getElementById('set-cats').value=globalOptions.categories.join(','); document.getElementById('set-types').value=globalOptions.video_types.join(','); document.getElementById('set-plats').value=globalOptions.platforms.join(','); }
    async function saveSettings(){ const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})}); await s('hosts',document.getElementById('set-hosts').value); await s('categories',document.getElementById('set-cats').value); await s('video_types',document.getElementById('set-types').value); await s('platforms',document.getElementById('set-plats').value); document.getElementById('settings-modal').classList.remove('active'); loadOptions(); showToast('é…ç½®å·²æ›´æ–°', 'success'); }
</script>
</body>
</html>