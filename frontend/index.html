<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub V14.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #1e293b; overflow: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-item { padding: 16px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: 500; border-left: 3px solid transparent; transition: all 0.2s; }
        .nav-item:hover { background: #1e293b; color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }
        
        /* ä¸»å†…å®¹åŒº */
        .main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #f1f5f9; }
        
        /* è¡¨æ ¼å®¹å™¨ (å…³é”®ï¼šå…è®¸æ¨ªå‘æ»šåŠ¨) */
        .table-wrapper { flex: 1; overflow: auto; background: white; margin: 0 20px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 1800px; /* å¼ºåˆ¶æ’‘å¼€å®½åº¦ */ }
        
        /* è¡¨å¤´å›ºå®š */
        th { position: sticky; top: 0; background: #f8fafc; font-size: 14px; font-weight: 700; color: #475569; padding: 14px; border-bottom: 2px solid #e2e8f0; text-align: left; z-index: 20; }
        td { padding: 12px 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; color: #334155; }
        tr:hover td { background: #f8fafc; }

        /* è¡Œå†…ç¼–è¾‘è¾“å…¥æ¡† */
        .t-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; outline: none; background: white; height: 36px; }
        .t-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .editing { background: #eff6ff !important; }
        .new-row { background: #f0fdf4 !important; }

        /* ç­›é€‰é¢æ¿ */
        #filter-panel { transition: max-height 0.3s ease; overflow: hidden; max-height: 0; background: white; margin: 0 20px 16px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #filter-panel.open { max-height: 500px; }

        /* ç»„ä»¶æ ·å¼ */
        .pill { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin-right: 4px; border: 1px solid transparent; white-space: nowrap; }
        .img-cell { width: 48px; height: 48px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-cell:hover::after { content:'+'; position:absolute; inset:0; background:rgba(0,0,0,0.3); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; }
        
        /* å¼¹çª— & å¤šé€‰ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .multi-pop { position: absolute; background: white; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; width: 220px; max-height: 260px; overflow-y: auto; z-index: 40; display: none; }
        .multi-pop.show { display: block; }
        .multi-opt { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .multi-opt:hover { background: #f1f5f9; color: #2563eb; }
    </style>
</head>
<body class="flex h-screen">

    <aside class="sidebar">
        <div class="h-16 flex items-center px-6 gap-3 mb-6">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">V</div>
            <h1 class="text-xl font-bold text-white tracking-tight">VideoHub</h1>
        </div>
        <div class="nav-item active" onclick="switchView('assets', this)">
            <span>ğŸ“¦</span> èµ„äº§åº“
        </div>
        <div class="nav-item" onclick="switchView('report', this)">
            <span>ğŸ“Š</span> æ•°æ®é©¾é©¶èˆ±
        </div>
    </aside>

    <main class="main-area">
        
        <header class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-6 shrink-0 z-30">
            <h2 class="text-lg font-bold text-slate-800" id="page-title">èµ„äº§ç®¡ç†</h2>
            <div class="flex items-center gap-3">
                <input id="g-search" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="å…¨å±€æœç´¢..." class="pl-4 pr-4 py-2 w-64 bg-slate-100 border-none rounded-lg text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <button onclick="toggleFilters()" class="px-3 py-2 text-slate-600 hover:text-blue-600 font-bold text-sm bg-slate-50 rounded-lg hover:bg-slate-100 border border-transparent hover:border-slate-200 transition-all">é«˜çº§ç­›é€‰</button>
                <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-slate-600">âš™ï¸</button>
            </div>
        </header>

        <div id="view-assets" class="flex flex-col flex-1 overflow-hidden">
            
            <div class="px-6 py-4 grid grid-cols-3 gap-6 shrink-0">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                    <div><div class="text-xs text-slate-400 font-bold uppercase tracking-wider">æ€»èµ„äº§</div><div class="text-3xl font-black text-slate-800 mt-1" id="st-total">-</div></div>
                    <div class="text-4xl opacity-20 grayscale">ğŸ“¦</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                    <div><div class="text-xs text-orange-400 font-bold uppercase tracking-wider">å¾…å‘å¸ƒ</div><div class="text-3xl font-black text-orange-500 mt-1" id="st-pending">-</div></div>
                    <div class="text-4xl opacity-20 grayscale">ğŸ”¥</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow cursor-pointer" onclick="openImport()">
                    <div><div class="text-xs text-blue-500 font-bold uppercase tracking-wider">å¿«æ·å…¥å£</div><div class="text-lg font-bold text-blue-600 mt-1 hover:underline">æ‰¹é‡å¯¼å…¥æ•°æ® &rarr;</div></div>
                    <div class="text-4xl opacity-20 grayscale">ğŸ“¥</div>
                </div>
            </div>

            <div id="filter-panel">
                <div class="grid grid-cols-6 gap-4 p-5">
                    <input id="s-pid" list="dl-pids" class="t-input" placeholder="ç¼–å·...">
                    <input id="s-title" class="t-input" placeholder="æ ‡é¢˜...">
                    <select id="s-cat" class="t-input"></select>
                    <select id="s-type" class="t-input"></select>
                    <select id="s-host" class="t-input"></select>
                    <select id="s-status" class="t-input"></select>
                    <div class="col-span-6 flex justify-end gap-2 border-t pt-4">
                        <button onclick="loadData(1)" class="bg-slate-800 text-white text-sm font-bold px-6 py-2 rounded-lg hover:bg-black transition-all">æ‰§è¡ŒæŸ¥è¯¢</button>
                        <button onclick="resetFilters()" class="bg-white border text-slate-600 text-sm font-bold px-6 py-2 rounded-lg hover:bg-slate-50">é‡ç½®</button>
                    </div>
                </div>
            </div>

            <div class="px-6 pb-3 flex justify-between items-end shrink-0">
                <span class="text-xs text-slate-500 font-medium" id="page-info">æ­£åœ¨åŠ è½½...</span>
                <button onclick="addNewRow()" class="bg-emerald-600 text-white text-sm font-bold px-5 py-2.5 rounded-lg shadow-lg hover:bg-emerald-700 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                    <span class="text-lg leading-none">+</span> æ–°å¢ä¸€è¡Œ
                </button>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="w-16 text-center">å›¾</th>
                            <th class="w-32" onclick="sortBy('product_id')">äº§å“ç¼–å· â†•</th>
                            <th style="min-width: 300px" onclick="sortBy('title')">è§†é¢‘æ ‡é¢˜ â†•</th>
                            <th class="w-32" onclick="sortBy('category')">ç±»å‹ â†•</th>
                            <th class="w-32" onclick="sortBy('finish_time')">å®Œæˆæ—¶é—´ â†•</th>
                            <th class="w-32" onclick="sortBy('video_type')">è§†ç±» â†•</th>
                            <th class="w-40" onclick="sortBy('host')">ä¸»æ’­(å¤šé€‰) â†•</th>
                            <th class="w-32 text-center" onclick="sortBy('status')">çŠ¶æ€ â†•</th>
                            <th class="w-40" onclick="sortBy('platform')">å¹³å°(å¤šé€‰) â†•</th>
                            <th class="w-40" onclick="sortBy('publish_time')">å‘å¸ƒæ—¶é—´ â†•</th>
                            <th class="w-48" onclick="sortBy('remark')">å¤‡æ³¨ â†•</th>
                            <th class="w-24 text-center sticky right-0 bg-slate-50 border-l shadow-sm">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            
            <div class="h-14 bg-white border-t border-slate-200 px-6 flex justify-end items-center shrink-0 gap-3">
                <button id="btn-prev" onclick="changePage(-1)" class="px-4 py-1.5 bg-slate-100 rounded text-sm font-bold hover:bg-slate-200 disabled:opacity-50 transition-colors">â—€ ä¸Šä¸€é¡µ</button>
                <button id="btn-next" onclick="changePage(1)" class="px-4 py-1.5 bg-slate-100 rounded text-sm font-bold hover:bg-slate-200 disabled:opacity-50 transition-colors">ä¸‹ä¸€é¡µ â–¶</button>
            </div>
        </div>

        <div id="view-report" class="hidden flex-1 overflow-y-auto p-8">
            <div class="flex justify-end gap-2 mb-6">
                <button onclick="loadReport('day')" class="px-4 py-1.5 bg-white border rounded-lg text-sm font-bold hover:bg-blue-50 hover:text-blue-600 transition-colors">æŒ‰æ—¥</button>
                <button onclick="loadReport('week')" class="px-4 py-1.5 bg-white border rounded-lg text-sm font-bold hover:bg-blue-50 hover:text-blue-600 transition-colors">æŒ‰å‘¨</button>
                <button onclick="loadReport('month')" class="px-4 py-1.5 bg-white border rounded-lg text-sm font-bold hover:bg-blue-50 hover:text-blue-600 transition-colors">æŒ‰æœˆ</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm h-[450px]">
                    <div id="chart-trend" class="w-full h-full"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm h-[450px]">
                    <div id="chart-plat" class="w-full h-full"></div>
                </div>
            </div>
        </div>

    </main>

    <div id="preview-modal" class="modal bg-black/95" onclick="this.classList.remove('active')"><img id="big-img" src="" class="max-h-[90vh] max-w-[90vw] object-contain"></div>
    <div id="multi-pop" class="multi-pop"></div>
    <datalist id="dl-pids"></datalist>

    <div id="import-modal" class="modal">
        <div class="bg-white rounded-xl w-[400px] p-8 text-center shadow-2xl">
            <div class="text-5xl mb-4">ğŸ“‚</div>
            <h3 class="font-bold text-xl mb-4 text-slate-800">æ‰¹é‡å¯¼å…¥æ•°æ®</h3>
            <p class="text-sm text-slate-500 mb-6">è¯·ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ è‡³ NAS <code class="bg-slate-100 px-1 rounded text-slate-700">temp_uploads</code> ç›®å½•</p>
            <button onclick="startImport()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-black transition-transform active:scale-95">å¼€å§‹æ‰«æå¹¶å¯¼å…¥</button>
            <button onclick="document.getElementById('import-modal').classList.remove('active')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">å–æ¶ˆå…³é—­</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="bg-white rounded-xl w-[450px] p-6 shadow-2xl">
            <h3 class="font-bold mb-6 text-lg text-slate-800">å…¨å±€é€‰é¡¹é…ç½®</h3>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400 mb-1 block">ä¸»æ’­</label><textarea id="set-hosts" class="t-input h-20"></textarea></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1 block">äº§å“ç±»å‹</label><input id="set-cats" class="t-input"></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1 block">è§†é¢‘ç±»å‹</label><input id="set-types" class="t-input"></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1 block">å‘å¸ƒå¹³å°</label><input id="set-plats" class="t-input"></div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-6 hover:bg-blue-700">ä¿å­˜ç”Ÿæ•ˆ</button>
            <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-2 text-slate-400 text-xs">å…³é—­</button>
        </div>
    </div>

    <script>
        let currPage=1, totalPages=1, currentSort={col:'id',order:'desc'};
        let globalOptions={}, editingId=null, globalData=[];
        let charts={};

        // --- åˆå§‹åŒ– (å¹¶å‘åŠ è½½ï¼Œç¡®ä¿æ•°æ®å¿…æ˜¾) ---
        (function init() {
            loadOptions(); // å¼‚æ­¥
            loadData(1);   // å¼‚æ­¥
            updateStats(); // å¼‚æ­¥
            
            // å…¨å±€ç‚¹å‡»å…³é—­å¤šé€‰
            document.addEventListener('click', e => {
                if(!e.target.closest('.multi-pop') && !e.target.closest('.multi-trig')) 
                    document.getElementById('multi-pop').classList.remove('show');
            });
        })();

        // --- è§†å›¾é€»è¾‘ ---
        function switchView(view, btn) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('view-assets').classList.add('hidden');
            document.getElementById('view-report').classList.add('hidden');
            document.getElementById('view-'+view).classList.remove('hidden');
            document.getElementById('page-title').innerText = view==='assets'?'èµ„äº§ç®¡ç†':'æ•°æ®é©¾é©¶èˆ±';
            if(view==='report') loadReport('day');
        }

        // --- æ•°æ®æ ¸å¿ƒ ---
        async function loadOptions() {
            try {
                const res=await fetch('/api/options'); globalOptions=await res.json();
                const fill=(id,l)=>document.getElementById(id).innerHTML=`<option value="">å…¨éƒ¨</option>`+l.map(i=>`<option value="${i}">${i}</option>`).join('');
                fill('s-cat',globalOptions.categories); fill('s-type',globalOptions.video_types);
                fill('s-host',globalOptions.hosts); fill('s-status',globalOptions.statuses);
                document.getElementById('dl-pids').innerHTML=globalOptions.product_ids.map(i=>`<option value="${i}">`).join('');
            } catch(e){ console.error(e); }
        }

        async function loadData(p) {
            currPage=p||currPage;
            const params=new URLSearchParams({
                page:currPage, size:100, sort_by:currentSort.col, order:currentSort.order,
                keyword:document.getElementById('g-search').value,
                product_id:document.getElementById('s-pid').value, title:document.getElementById('s-title').value,
                category:document.getElementById('s-cat').value, video_type:document.getElementById('s-type').value,
                host:document.getElementById('s-host').value, status:document.getElementById('s-status').value
            });
            
            try {
                const res=await fetch(`/api/videos?${params}`); const data=await res.json();
                globalData=data.items; totalPages=data.total_pages;
                document.getElementById('total-count').innerText=data.total;
                document.getElementById('page-info').innerText=`å…± ${data.total} æ¡ Â· ç¬¬ ${data.page}/${data.total_pages} é¡µ`;
                document.getElementById('btn-prev').disabled=(data.page<=1);
                document.getElementById('btn-next').disabled=(data.page>=data.total_pages);
                renderTable(data.items);
            } catch(e) { alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"); }
        }

        // --- è¡¨æ ¼æ¸²æŸ“ (è¡Œå†…æ–°å¢+å¤šé€‰) ---
        function addNewRow() {
            // æ’å…¥ç©ºè¡Œåˆ°å¤´éƒ¨
            globalData.unshift({id:'new', product_id:'', title:'', isNew:true});
            editingId='new';
            renderTable(globalData);
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.querySelector('.table-wrapper').scrollTop = 0;
        }

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const isEdit = (v.id===editingId);
                const cln = s => (s&&s!=='nan'?s:'');
                const img = (v.image_url&&!v.image_url.includes('default'))?v.image_url:'';

                if (isEdit) {
                    const sel=(k,l)=>`<select id="ed-${k}" class="t-input">${l.map(o=>`<option ${o===v[k]?'selected':''}>${o}</option>`).join('')}</select>`;
                    const mul=(k,t)=>`<input id="ed-${k}" class="t-input multi-trig cursor-pointer" value="${cln(v[k])}" readonly onclick="openMulti(this,'${t}')" placeholder="ç‚¹å‡»é€‰æ‹©">`;
                    
                    return `<tr class="editing ${v.isNew?'new-row':''}">
                        <td class="p-2"><div class="img-cell mx-auto" onclick="document.getElementById('up-${v.id}').click()">${img?`<img src="${img}" class="w-full h-full object-cover">`:'+'}</div><input type="file" id="up-${v.id}" class="hidden" onchange="upImg(this,'${v.id}')"><input type="hidden" id="ed-img" value="${cln(v.image_url)}"></td>
                        <td><input id="ed-pid" class="t-input" value="${cln(v.product_id)}" placeholder="ç¼–å·"></td>
                        <td><input id="ed-title" class="t-input font-bold" value="${cln(v.title)}" placeholder="æ ‡é¢˜"></td>
                        <td>${sel('cat',globalOptions.categories)}</td>
                        <td><input id="ed-fin" type="date" class="t-input" value="${cln(v.finish_time)}"></td>
                        <td>${sel('type',globalOptions.video_types)}</td>
                        <td>${mul('host','hosts')}</td>
                        <td>${sel('status',globalOptions.statuses)}</td>
                        <td>${mul('plat','platforms')}</td>
                        <td><input id="ed-pub" type="datetime-local" class="t-input" value="${cln(v.publish_time).replace(' ','T')}"></td>
                        <td><input id="ed-rem" class="t-input" value="${cln(v.remark)}"></td>
                        <td class="text-center sticky right-0 bg-blue-50 border-l shadow-sm">
                            <button onclick="saveRow('${v.id}')" class="text-white bg-blue-600 px-3 py-1 rounded text-xs font-bold shadow">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs ml-1 hover:text-slate-600">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }
                
                // æ­£å¸¸è¡Œ
                return `<tr class="hover:bg-slate-50 transition-colors border-b border-slate-100">
                    <td class="p-2 text-center"><div class="img-cell mx-auto bg-slate-100" onclick="showBig('${img}')"><img src="${img||'/assets/default.png'}" class="w-full h-full object-cover"></div></td>
                    <td class="font-mono text-slate-500">${cln(v.product_id)}</td>
                    <td class="font-bold text-slate-700 truncate" style="max-width:300px" title="${cln(v.title)}">${cln(v.title)}</td>
                    <td><span class="pill bg-slate-100 text-slate-600">${cln(v.category)}</span></td>
                    <td class="text-slate-400 text-xs font-mono">${cln(v.finish_time)}</td>
                    <td><span class="pill bg-slate-100 text-slate-600">${cln(v.video_type)}</span></td>
                    <td>${cln(v.host)}</td>
                    <td class="text-center"><span class="pill ${v.status==='å·²å‘å¸ƒ'?'bg-emerald-100 text-emerald-700':'bg-orange-50 text-orange-600'}">${cln(v.status)}</span></td>
                    <td>${cln(v.platform)}</td>
                    <td class="text-slate-400 text-xs font-mono">${cln(v.publish_time).replace('T',' ')}</td>
                    <td class="text-slate-400 truncate max-w-[120px] text-xs" title="${cln(v.remark)}">${cln(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-slate-50 border-l shadow-sm">
                        <button onclick="startEdit(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-red-400 text-xs hover:text-red-600">åˆ </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- æ ¸å¿ƒäº¤äº’ ---
        function startEdit(id){ editingId=id; renderTable(globalData); }
        function cancelEdit(){ editingId=null; loadData(); } // é‡æ–°åŠ è½½ä»¥æ¸…é™¤æœªä¿å­˜çš„æ–°å¢è¡Œ
        
        async function saveRow(id){
            const fd=new FormData(); if(id!=='new') fd.append('id',id);
            const map={'pid':'product_id','title':'title','cat':'category','fin':'finish_time','type':'video_type','host':'host','status':'status','plat':'platform','pub':'publish_time','rem':'remark'};
            for(let [eid,k] of Object.entries(map)) fd.append(k, document.getElementById('ed-'+eid).value.replace('T',' '));
            fd.append('image_url',document.getElementById('ed-img').value);
            
            await fetch('/api/video/save',{method:'POST',body:fd});
            editingId=null; loadData(); updateStats();
        }

        async function upImg(input,id){
            const fd=new FormData(); fd.append('file',input.files[0]);
            const res=await fetch('/api/upload',{method:'POST',body:fd}); const d=await res.json();
            document.getElementById('ed-img').value=d.url;
            globalData.find(v=>v.id==id||v.id==='new').image_url=d.url;
            renderTable(globalData); // åˆ·æ–°æ˜¾ç¤º
        }

        // --- å¤šé€‰èœå• ---
        function openMulti(input,type){
            const pop=document.getElementById('multi-pop'); const r=input.getBoundingClientRect();
            const curr=input.value.split(/[,ï¼Œ]/).map(s=>s.trim());
            pop.innerHTML=globalOptions[type].map(o=>`<div class="multi-opt" onclick="togOpt('${input.id}','${o}','${type}')"><span class="${curr.includes(o)?'text-blue-600 font-bold w-4':'w-4'}">${curr.includes(o)?'âœ“':''}</span> ${o}</div>`).join('');
            pop.style.top=(r.bottom+window.scrollY)+'px'; pop.style.left=(r.left+window.scrollX)+'px'; pop.classList.add('show');
        }
        function togOpt(eid,v,type){
            const inp=document.getElementById(eid); let vals=inp.value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s);
            if(vals.includes(v)) vals=vals.filter(i=>i!==v); else vals.push(v);
            inp.value=vals.join(','); openMulti(inp,type);
        }

        // --- ç»Ÿè®¡å›¾è¡¨ ---
        async function loadReport(dim) {
            const res=await fetch(`/api/report?dim=${dim}`); const d=await res.json();
            if(!charts.t) charts.t = echarts.init(document.getElementById('chart-trend'));
            charts.t.setOption({
                title:{text:'å…¥åº“ vs å‘å¸ƒ',left:'center'}, tooltip:{trigger:'axis'}, legend:{data:['å…¥åº“','å‘å¸ƒ'],bottom:0},
                xAxis:{type:'category',data:d.dates}, yAxis:{type:'value'},
                series:[{name:'å…¥åº“',type:'line',data:d.in,smooth:true,areaStyle:{opacity:0.1}},{name:'å‘å¸ƒ',type:'bar',data:d.out,itemStyle:{color:'#10b981'}}]
            });
            if(!charts.p) charts.p = echarts.init(document.getElementById('chart-plat'));
            charts.p.setOption({
                title:{text:'å¹³å°åˆ†å¸ƒ',left:'center'}, tooltip:{trigger:'item'},
                series:[{type:'pie',radius:['40%','70%'],data:d.plats,itemStyle:{borderRadius:5}}]
            });
            window.onresize=()=>{charts.t.resize();charts.p.resize();};
        }

        // --- æ‚é¡¹ ---
        function toggleFilters(){document.getElementById('filter-panel').classList.toggle('open');}
        function showBig(s){if(s){document.getElementById('big-img').src=s;document.getElementById('preview-modal').classList.add('active');}}
        function resetFilters(){document.querySelectorAll('#filter-panel input,select').forEach(e=>e.value='');loadData(1);}
        function changePage(d){if(currPage+d>0&&currPage+d<=totalPages)loadData(currPage+d);}
        function sortBy(c){currentSort.col=c;currentSort.order=currentSort.order==='asc'?'desc':'asc';loadData(1);}
        async function delVideo(id){if(confirm('åˆ ?')){await fetch(`/api/video/${id}`,{method:'DELETE'});loadData();updateStats();}}
        function openSettings(){document.getElementById('settings-modal').classList.add('active');
            document.getElementById('set-hosts').value=globalOptions.hosts.join(',');
            document.getElementById('set-cats').value=globalOptions.categories.join(',');
            document.getElementById('set-types').value=globalOptions.video_types.join(',');
            document.getElementById('set-plats').value=globalOptions.platforms.join(',');
        }
        async function saveSettings(){
            const s=(k,v)=>fetch('/api/settings',{method:'POST',body:new URLSearchParams({key:k,value:v})});
            await s('hosts',document.getElementById('set-hosts').value);
            await s('categories',document.getElementById('set-cats').value);
            await s('video_types',document.getElementById('set-types').value);
            await s('platforms',document.getElementById('set-plats').value);
            document.getElementById('settings-modal').classList.remove('active'); loadOptions();
        }
        function openImport(){document.getElementById('import-modal').classList.add('active');}
        async function startImport(){await fetch('/api/import/local',{method:'POST'});alert('åå°ä»»åŠ¡å·²å¯åŠ¨');document.getElementById('import-modal').classList.remove('active');}
        async function updateStats(){try{const r=await fetch('/api/stats');const d=await r.json();document.getElementById('st-total').innerText=d.total;document.getElementById('st-pending').innerText=d.pending;}catch{}}
    </script>
</body>
</html>