<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background: #f8fafc; color: #334155; }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        th { font-size: 13px; font-weight: 700; color: #475569; padding: 12px 16px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .table-input { width: 100%; border: 1px solid transparent; background: transparent; padding: 4px 6px; border-radius: 4px; font-size: 14px; transition: all 0.2s; }
        .table-input:focus, .editing .table-input { background: white; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); outline: none; }
        
        /* å›¾ç‰‡ä¸Šä¼ åŒº */
        .img-zone { position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .img-zone:hover { transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .img-zone::after { content: 'æ›¿æ¢'; position: absolute; inset: 0; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; font-size: 12px; font-weight: bold; }
        .img-zone:hover::after { opacity: 1; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .badge { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-wait { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .badge-done { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        
        /* æ¨¡æ€æ¡† */
        #settings-modal, #add-modal { transition: opacity 0.2s ease; }
        .modal-active { display: flex !important; opacity: 1 !important; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">V</div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">VideoHub <span class="text-slate-400 font-normal text-sm">Pro</span></h1>
        </div>
        
        <button onclick="openSettings()" class="flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50 px-3 py-1.5 rounded-lg transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-sm font-medium">å…¨å±€é…ç½®</span>
        </button>
    </div>

    <div class="bg-white border-b border-slate-200 px-6 py-6 z-20">
        <div class="max-w-[2000px] mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-slate-50 border border-slate-100 p-5 rounded-2xl flex justify-between items-center group hover:border-blue-200 transition-all">
                <div>
                    <div class="text-slate-400 text-xs font-bold uppercase mb-1">æ€»è§†é¢‘èµ„äº§</div>
                    <div class="text-4xl font-black text-slate-800 group-hover:text-blue-600 transition-colors" id="st-total">--</div>
                </div>
                <div class="text-4xl opacity-80">ğŸ“¦</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-5 rounded-2xl flex justify-between items-center group hover:border-orange-200 transition-all">
                <div>
                    <div class="text-orange-600/70 text-xs font-bold uppercase mb-1">å¾…å‘å¸ƒåº“å­˜</div>
                    <div class="text-4xl font-black text-orange-500" id="st-pending">--</div>
                </div>
                <div class="text-4xl opacity-80">ğŸ”¥</div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 p-5 rounded-2xl flex justify-between items-center group hover:border-emerald-200 transition-all">
                <div>
                    <div class="text-emerald-600/70 text-xs font-bold uppercase mb-1">æœ¬æœˆåŠ³æ¨¡</div>
                    <div class="text-4xl font-black text-emerald-600" id="st-host">--</div>
                </div>
                <div class="text-4xl opacity-80">ğŸ†</div>
            </div>
        </div>
    </div>

    <div class="flex-1 p-6 overflow-hidden max-w-[2000px] mx-auto w-full flex flex-col">
        
        <div class="flex flex-wrap items-center gap-3 mb-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm shrink-0">
            <input id="q-key" onkeydown="if(event.key==='Enter') loadData(1)" placeholder="ğŸ” æœç´¢ ç¼–å· / æ ‡é¢˜ / å¤‡æ³¨" class="pl-3 pr-3 py-2 w-64 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            
            <select id="q-host" onchange="loadData(1)" class="filter-select"></select>
            <select id="q-status" onchange="loadData(1)" class="filter-select"></select>
            <select id="q-cat" onchange="loadData(1)" class="filter-select"></select>

            <div class="flex items-center gap-2 border-l border-slate-200 pl-3 ml-1 bg-slate-50 p-1 rounded-lg">
                <input type="date" id="q-start" onchange="loadData(1)" class="bg-transparent text-sm text-slate-600 outline-none">
                <span class="text-slate-300">-</span>
                <input type="date" id="q-end" onchange="loadData(1)" class="bg-transparent text-sm text-slate-600 outline-none">
            </div>

            <div class="ml-auto flex gap-2">
                <button onclick="resetFilters()" class="px-3 py-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg text-sm font-medium transition-colors flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    é‡ç½®
                </button>
                <button onclick="loadData(1)" class="px-5 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 shadow-md shadow-blue-200 transition-all">æŸ¥è¯¢</button>
                <button onclick="scanLocal()" class="px-4 py-2 bg-slate-800 text-white font-bold text-sm rounded-lg hover:bg-slate-900 shadow-md transition-all ml-2">å¯¼å…¥ (NAS)</button>
                <button onclick="openAddModal()" class="px-4 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 shadow-md transition-all">æ‰‹åŠ¨æ–°å¢</button>
            </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col flex-1 overflow-hidden">
            <div class="overflow-auto flex-1">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="w-16 text-center">å›¾</th>
                            <th class="w-24">ç¼–å·</th>
                            <th class="w-auto">æ ‡é¢˜</th> <th class="w-20">ç±»å‹</th>
                            <th class="w-20">ä¸»æ’­</th>
                            <th class="w-24 text-center">çŠ¶æ€</th>
                            <th class="w-28">å¹³å°</th>
                            <th class="w-32">å‘å¸ƒæ—¶é—´</th>
                            <th class="w-32">å¤‡æ³¨</th>
                            <th class="w-24 text-center sticky right-0 bg-slate-50 border-l border-slate-200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            
            <div class="border-t border-slate-200 px-4 py-3 flex justify-between items-center bg-slate-50 shrink-0 text-sm font-medium text-slate-500">
                <span>å…± <span id="total-count" class="text-slate-800 font-bold">0</span> æ¡ Â· ç¬¬ <span id="curr-page" class="text-slate-800 font-bold">1</span> é¡µ</span>
                <div class="space-x-2">
                    <button onclick="changePage(-1)" class="px-3 py-1.5 bg-white border border-slate-200 rounded-md hover:border-slate-300 hover:text-blue-600 disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button onclick="changePage(1)" class="px-3 py-1.5 bg-white border border-slate-200 rounded-md hover:border-slate-300 hover:text-blue-600 disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-[500px] shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="text-lg font-bold text-slate-800">ç³»ç»Ÿå…¨å±€é…ç½®</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ä¸»æ’­åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                    <textarea id="set-hosts" class="w-full p-3 border border-slate-200 rounded-lg text-sm h-20 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">è§†é¢‘åˆ†ç±»</label>
                    <input id="set-cats" class="w-full p-3 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">å‘å¸ƒå¹³å°</label>
                    <input id="set-plats" class="w-full p-3 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex justify-end pt-4">
                    <button onclick="saveSettings()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-black">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-[600px] shadow-2xl p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">æ‰‹åŠ¨å½•å…¥æ–°èµ„äº§</h3>
            <form id="addForm" class="grid grid-cols-2 gap-4">
                <div class="col-span-2"><input name="title" placeholder="è§†é¢‘æ ‡é¢˜ (å¿…å¡«)" class="w-full p-2 border border-slate-300 rounded text-sm" required></div>
                <div><input name="product_id" placeholder="äº§å“ç¼–å· (å¿…å¡«)" class="w-full p-2 border border-slate-300 rounded text-sm" required></div>
                <div><select name="host" class="w-full p-2 border border-slate-300 rounded text-sm" id="add-host"></select></div>
                <div><select name="category" class="w-full p-2 border border-slate-300 rounded text-sm" id="add-cat"></select></div>
                <div><select name="status" class="w-full p-2 border border-slate-300 rounded text-sm" id="add-status"></select></div>
                <div class="col-span-2 pt-4 flex justify-end gap-3 border-t border-slate-100">
                    <button type="button" onclick="closeAddModal()" class="px-4 py-2 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .filter-select { padding: 8px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #475569; outline: none; min-width: 100px; cursor: pointer; }
        .filter-select:hover { border-color: #cbd5e1; }
    </style>

    <script>
        let currPage = 1, totalPages = 1;
        let globalOptions = {};
        let editingId = null;
        let globalData = []; // å­˜å‚¨å½“å‰é¡µæ•°æ®

        // åˆå§‹åŒ–
        (async function init() {
            await loadSettings(); 
            await loadData(1);
            updateStats();
        })();

        async function loadSettings() {
            const res = await fetch('/api/settings');
            globalOptions = await res.json();
            
            // å¡«å……ç­›é€‰æ¡†
            fillSelect('q-host', globalOptions.hosts, 'å…¨éƒ¨ä¸»æ’­');
            fillSelect('q-status', globalOptions.statuses, 'å…¨éƒ¨çŠ¶æ€');
            fillSelect('q-cat', globalOptions.categories, 'å…¨éƒ¨åˆ†ç±»');

            // å¡«å……æ–°å¢å¼¹çª—çš„ä¸‹æ‹‰æ¡†
            fillSelect('add-host', globalOptions.hosts, 'é€‰æ‹©ä¸»æ’­');
            fillSelect('add-cat', globalOptions.categories, 'é€‰æ‹©åˆ†ç±»');
            fillSelect('add-status', globalOptions.statuses, 'é€‰æ‹©çŠ¶æ€');
        }

        function fillSelect(id, items, def) {
            const el = document.getElementById(id);
            if(el) el.innerHTML = `<option value="">${def}</option>` + items.map(i => `<option value="${i.trim()}">${i.trim()}</option>`).join('');
        }

        async function loadData(p) {
            currPage = p || currPage;
            const params = new URLSearchParams({
                page: currPage, size: 100,
                keyword: document.getElementById('q-key').value,
                host: document.getElementById('q-host').value,
                status: document.getElementById('q-status').value,
                category: document.getElementById('q-cat').value,
                pub_start: document.getElementById('q-start').value,
                pub_end: document.getElementById('q-end').value
            });

            const res = await fetch(`/api/videos?${params}`);
            const data = await res.json();
            globalData = data.items;
            totalPages = data.total_pages;

            document.getElementById('total-count').innerText = data.total;
            document.getElementById('curr-page').innerText = data.page;
            
            renderTable(data.items);
        }

        function renderTable(items) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = items.map(v => {
                const isEdit = (v.id === editingId);
                // å›¾ç‰‡URLå¤„ç†ï¼šå¦‚æœä¸ºç©ºæˆ–nanï¼Œæ˜¾ç¤ºé»˜è®¤å›¾
                const imgUrl = (v.image_url && v.image_url.length > 5 && v.image_url !== 'nan') ? v.image_url : '/assets/default.png';
                const makeSel = (key, val, opts) => `<select id="ed-${key}-${v.id}" class="table-input bg-white border border-blue-200">${opts.map(o => `<option ${o.trim()===val?'selected':''}>${o.trim()}</option>`).join('')}</select>`;
                
                let stClass = "bg-slate-100 text-slate-500 border border-slate-200";
                if(v.status === 'å¾…å‘å¸ƒ') stClass = "badge-wait";
                if(v.status === 'å·²å‘å¸ƒ') stClass = "badge-done";

                if (isEdit) {
                    return `
                    <tr class="bg-blue-50/30 editing border-l-2 border-blue-500">
                        <td class="p-2 text-center text-xs text-slate-400">å›¾</td>
                        <td><input id="ed-pid-${v.id}" class="table-input" value="${clean(v.product_id)}"></td>
                        <td><input id="ed-title-${v.id}" class="table-input font-bold text-slate-700" value="${clean(v.title)}"></td>
                        <td>${makeSel('cat', v.category, globalOptions.categories)}</td>
                        <td>${makeSel('host', v.host, globalOptions.hosts)}</td>
                        <td class="text-center">${makeSel('status', v.status, globalOptions.statuses)}</td>
                        <td>${makeSel('plat', v.platform, globalOptions.platforms)}</td>
                        <td><input id="ed-pub-${v.id}" type="datetime-local" class="table-input" value="${fmtDate(v.publish_time)}"></td>
                        <td><input id="ed-remark-${v.id}" class="table-input text-xs" value="${clean(v.remark)}"></td>
                        <td class="text-center bg-white/50 sticky right-0 border-l border-slate-200/50">
                            <button onclick="saveRow(${v.id})" class="text-white bg-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-700 mr-1">ä¿å­˜</button>
                            <button onclick="cancelEdit()" class="text-slate-400 text-xs hover:text-slate-600">å–æ¶ˆ</button>
                        </td>
                    </tr>`;
                }

                return `
                <tr class="group border-b border-slate-50 last:border-0 hover:bg-blue-50/20">
                    <td class="p-2 text-center">
                        <div class="w-10 h-10 rounded-lg bg-slate-100 border border-slate-200 overflow-hidden relative img-zone mx-auto"
                             onpaste="handlePaste(event, ${v.id})"
                             ondragover="event.preventDefault()" 
                             ondrop="handleDrop(event, ${v.id})"
                             title="ç²˜è´´æˆ–æ‹–æ‹½å›¾ç‰‡ä»¥æ›¿æ¢">
                            <img src="${imgUrl}" class="w-full h-full object-cover">
                        </div>
                    </td>
                    <td class="font-mono text-xs text-slate-500">${clean(v.product_id)}</td>
                    <td class="font-bold text-slate-700 text-sm break-all pr-2" title="${clean(v.title)}">${clean(v.title)}</td>
                    <td class="text-xs text-slate-500">${clean(v.category)}</td>
                    <td class="text-xs font-bold text-slate-600">${clean(v.host)}</td>
                    <td class="text-center"><span class="badge ${stClass}">${clean(v.status)}</span></td>
                    <td class="text-xs text-slate-500">${clean(v.platform)}</td>
                    <td class="text-xs text-slate-400 font-mono">${(v.publish_time||'').replace('T',' ')}</td>
                    <td class="text-xs text-slate-400 truncate max-w-[150px]">${clean(v.remark)}</td>
                    <td class="text-center sticky right-0 bg-white group-hover:bg-blue-50/20 border-l border-slate-100">
                        <button onclick="editRow(${v.id})" class="text-blue-600 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button>
                        <button onclick="delVideo(${v.id})" class="text-slate-400 hover:text-red-500 text-xs">åˆ é™¤</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        function clean(v) { return (v && v!=='nan') ? v : ''; }
        function fmtDate(s) { return s ? s.replace(' ', 'T').substring(0, 16) : ''; }

        function editRow(id) { editingId = id; renderTable(globalData); }
        function cancelEdit() { editingId = null; renderTable(globalData); }
        
        async function saveRow(id) {
            const fd = new FormData();
            fd.append('id', id);
            // ä»ç¼–è¾‘æ¡†å–å€¼
            ['pid', 'title', 'cat', 'host', 'status', 'plat', 'pub', 'remark'].forEach(key => {
                const el = document.getElementById(`ed-${key}-${id}`);
                if(el) fd.append(key === 'pid' ? 'product_id' : (key === 'cat' ? 'category' : (key === 'plat' ? 'platform' : (key === 'pub' ? 'publish_time' : key))), el.value.replace('T', ' '));
            });
            await fetch('/api/video/save', {method:'POST', body:fd});
            cancelEdit();
            loadData();
            updateStats();
        }

        // å›¾ç‰‡ç²˜è´´/æ‹–æ‹½é€»è¾‘ (ä¿®å¤ç‰ˆ)
        async function uploadImg(file, id) {
            // 1. ä¸Šä¼ å›¾ç‰‡æ¢å– URL
            const fd = new FormData();
            fd.append('file', file);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const data = await res.json();
            
            // 2. è·å–å½“å‰è¡Œçš„æ—§æ•°æ®ï¼Œé˜²æ­¢å…¶ä»–å­—æ®µä¸¢å¤±
            const oldRow = globalData.find(v => v.id === id);
            if (!oldRow) return;

            // 3. æ„é€ å…¨é‡æ›´æ–°è¯·æ±‚
            const updateFd = new FormData();
            updateFd.append('id', id);
            updateFd.append('product_id', oldRow.product_id); // å¿…å¡«
            updateFd.append('title', oldRow.title);           // å¿…å¡«
            updateFd.append('image_url', data.url);           // æ›´æ–°å›¾ç‰‡
            
            // è¡¥å……éå¿…å¡«å­—æ®µ
            ['host', 'status', 'category', 'video_type', 'platform', 'finish_time', 'publish_time', 'remark'].forEach(k => {
                updateFd.append(k, clean(oldRow[k]));
            });
            
            await fetch('/api/video/save', {method:'POST', body:updateFd});
            alert("å›¾ç‰‡æ›´æ–°æˆåŠŸï¼");
            loadData(); // åˆ·æ–°æ˜¾ç¤º
        }

        async function handleDrop(e, id) { e.preventDefault(); if(e.dataTransfer.files.length) uploadImg(e.dataTransfer.files[0], id); }
        async function handlePaste(e, id) { if(e.clipboardData.files.length) uploadImg(e.clipboardData.files[0], id); }

        function resetFilters() {
            document.getElementById('q-key').value = '';
            document.getElementById('q-host').value = '';
            document.getElementById('q-status').value = '';
            document.getElementById('q-cat').value = '';
            document.getElementById('q-start').value = '';
            document.getElementById('q-end').value = '';
            loadData(1);
        }

        // è®¾ç½®é¢æ¿
        function openSettings() {
            document.getElementById('set-hosts').value = globalOptions.hosts.join(',');
            document.getElementById('set-cats').value = globalOptions.categories.join(',');
            document.getElementById('set-plats').value = globalOptions.platforms.join(',');
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        async function saveSettings() {
            await fetch('/api/settings', {method:'POST', body: new URLSearchParams({key:'hosts', value:document.getElementById('set-hosts').value})});
            await fetch('/api/settings', {method:'POST', body: new URLSearchParams({key:'categories', value:document.getElementById('set-cats').value})});
            await fetch('/api/settings', {method:'POST', body: new URLSearchParams({key:'platforms', value:document.getElementById('set-plats').value})});
            closeSettings();
            loadSettings();
            alert("é…ç½®å·²æ›´æ–°");
        }

        // æ–°å¢å¼¹çª—
        function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            await fetch('/api/video/save', {method:'POST', body:fd});
            closeAddModal();
            loadData();
            updateStats();
        };

        async function delVideo(id) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { await fetch(`/api/video/${id}`, {method:'DELETE'}); loadData(); updateStats(); }}
        async function scanLocal() { if(confirm("æ‰«æå¯¼å…¥ï¼Ÿ")) { fetch('/api/import/local', {method:'POST'}); alert("åå°å¯¼å…¥ä¸­ï¼Œè¯·ç¨ååˆ·æ–°"); }}
        async function updateStats() { try { const res = await fetch('/api/stats'); const s = await res.json(); document.getElementById('st-total').innerText = s.total; document.getElementById('st-pending').innerText = s.pending; document.getElementById('st-host').innerText = s.host; } catch(e){} }
        function changePage(d) { if(currPage+d>0 && currPage+d<=totalPages) loadData(currPage+d); }
    </script>
</body>
</html>